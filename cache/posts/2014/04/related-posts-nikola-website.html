<p>The one thing I missed in Nikola was the lack of <strong>Related Posts generation</strong>. I solved this during <a href="http://baptiste-wicht.com/posts/2014/03/migrated-from-wordpress-to-nikola.html">the migration from WordPress to Nikola</a>, by using simple algorithms to generate related posts for each blog post and then display them in the form of a simple widget. </p>
<p>For example, you can see the related posts of this post on the left, just under my Google+ badge. </p>
<p>Here is the workflow that is used: 
 * A simple C++ tool generate a list of related posts in HTML for each posts
 * The generated HTML code is included in the MAKO template using Python</p>
<p>In this article, I'll show how the related posts are generated and how to include them in your template.</p>
<h1>Related Post Generation</h1>
<p>It is important to note that it is necessary to cleanup the content of the files before using it: 
 * First, it is necessary to remove all HTML that may be present in the Markdown files. I remove only the HTML tags, not their content. For instance, in <em>&lt;strong&gt;test&lt;/strong&gt;</em>, test would be counted, but not strong. The only exception to that, is that the content of preformatted parts (typically some or console output) is completely removed.
 * It is also necessary to cleanup Markdown, for instance, parentheses and square brackets are removed, but not their content. Same goes for Markdown syntax for bold, italics, ...
 * Finally, I also remove punctuation. </p>
<p>My related posts algorithm is very simple. </p>
<p>First, I compute the Term Frequency (TF) of each word in each post. The number of times a word is present in a document is represented by <em>tf(w,d)</em>. I decided to give a bigger importance to words in the title and the tags, but that is just a matter of choice. </p>
<p>After that, I compute the Inverse Document Frequency (IDF) of each word. This measure allows to filter words like: a, the, and, has, is, ... These words are not really representative of the content of a blog post. The formula for idf is very simple: <em>idf(w) = log(N / (1+ n(w)))</em>. <em>n(w)</em> is the number of posts where the word is present. It is a measure of rarity of a word on the complete posts set. </p>
<p>Once we have the two values, we can easily compute the TF-IDF vectors of each blog post. The TF-IDF for a word is simply: <em>tf_idf(w,d) = tf(w, d) * idf(w)</em>. </p>
<p>Finally, we can derive the matrix of Cosine similarities between the TF-IDF vectors. The idea of the algorithm is simple: each document is represented by a vector and then the distance between two vectors indicates how related two posts are. The formula for the Cosine similarity is also simple: <em>cs(d1, d2) = dot(d1, d2) / ||d1|| * || d2||</em>. <em>d1</em> and <em>d2</em> are two TF-IDF vectors. Once the cosine similarities between each document is computed, we can just take the N most related documents as the "Related Posts" for each blog post. </p>
<p>With this list, the C++ program simply generates an HTML file that will be included in each post by Nikola template. This process is <strong>very fast</strong>. I have around 200 posts on this blog and the generation takes about 1 second. </p>
<h1>Include in template</h1>
<p>Once the HTML files are generate, they are included into the website by altering the template and adding their content directly into the web page. Here is the code I use in <em>base.tmpl</em>.</p>
<pre class="code literal-block"><span class="cp">%</span><span class="k">if</span> <span class="n">post</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">post</span><span class="o">.</span><span class="n">source_link</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;/stories/&#39;</span><span class="p">):</span><span class="x"></span>
<span class="x">    &lt;div class=&quot;left-sidebar-widget&quot;&gt;</span>
<span class="x">        &lt;h3&gt;Related posts&lt;/h3&gt;</span>
<span class="x">        &lt;div class=&quot;left-sidebar-widget-content&quot;&gt;</span>
<span class="x">            </span><span class="cp">&lt;%</span>
                <span class="kn">import</span> <span class="nn">os</span>
                <span class="n">related_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
                <span class="n">related_path</span> <span class="o">=</span> <span class="n">related_dir</span> <span class="o">+</span> <span class="n">post</span><span class="o">.</span><span class="n">source_link</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot;.related.html&quot;</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">related_path</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="n">related_text</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">related_text</span> <span class="o">=</span> <span class="s">&quot;Not generated&quot;</span>
            <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">            </span><span class="cp">${</span><span class="n">related_text</span><span class="cp">}</span><span class="x"></span>
<span class="x">        &lt;/div&gt;</span>
<span class="x">    &lt;/div&gt;</span>
<span class="cp">%</span><span class="k">endif</span><span class="x"></span>
</pre>


<p>You could also display it in <em>post.tmpl</em> as a simple list. </p>
<p>There is a limitation with this code: it only works if the source file has the same name than the slug, otherwise the file is not found. If someone has a solution to get the path to the source file and not the slug version, I'd be glad to have it ;)</p>
<h1>Conclusion</h1>
<p>The code for the generator is available on the <a href="https://github.com/wichtounet/wichtounet.github.io/tree/master/src/related">Github repository of my website</a>. </p>
<p>I wrote it in C++ because I don't like Python a lot and because I'm not good at it and it would have taken me a lot more time to include it in Nikola. If I have time and I'm motivated enough, I'll try to integrate that in Nikola. </p>
<p>I hope that could be useful for some people. </p>