<p>I recently started a bit of work on my compiler (eddic) again. I started by adapting it to build on CLang with libc++. There was some minor adaptions to make it compile, but nothing really fancy. It now compiles and runs fine on LLVM/Clang 3.4 with the last version of libc++. I'm gonna use some features of C++14 in it and I plan to refactor some parts to make it more <em>STL-correct</em>. I also plan to use only CLang on eddic right now, since C++14 support of GCC is not released right now. </p>
<p>I decided it was a good time to try again the CLang static analyzer. </p>
<h2>Installation</h2>
<p>If, like me, you're using Gentoo, the static analyzer is directly installed with the <em>sys-devel/clang</em> package, unless you disabled the <em>static-analyzer</em> USE flag. </p>
<p>If your distribution does not ship the static analyzer directly with CLang, you'll have to install it manually. To install it from sources, I advise you to follow the <a href="http://clang-analyzer.llvm.org/installation.html">Official Installations instruction</a>. </p>
<h2>Usage</h2>
<p>The usage of CLang static analyzer can be a bit disturbing at first. Most static analysis tools generally takes the sources directly and do their stuff. But that is not how Clang Static Analyzer works. It works as a kind of monitor in top of building the program, using <em>scan-build</em>. When you are analyzing a program, you are also building the program. </p>
<p>For instance, if you are compiling a source file like that: </p>
<pre class="code literal-block"><span class="n">clang</span> <span class="p">[</span><span class="n">clang</span><span class="o">-</span><span class="n">options</span><span class="p">]</span> <span class="n">source_file</span><span class="p">.</span><span class="n">cpp</span>
</pre>


<p>you can perform static analysis like that: </p>
<pre class="code literal-block"><span class="n">scan</span><span class="o">-</span><span class="n">build</span> <span class="p">[</span><span class="n">scan</span><span class="o">-</span><span class="n">build</span><span class="o">-</span><span class="n">options</span><span class="p">]</span> <span class="n">clang</span> <span class="p">[</span><span class="n">clang</span><span class="o">-</span><span class="n">options</span><span class="p">]</span> <span class="n">source_file</span><span class="p">.</span><span class="n">cpp</span>
</pre>


<p>scan-build works by replacing calls to the compiler by calls to <em>ccc-analyzer </em>. This works generally well, but there are some cases where that things get a bit more complicated. That is the case of CMake where the paths to the compiler are hardcoded in the generated makefiles. </p>
<p>For that, you have to run <em>cmake</em> and <em>make</em> with <em>scan-build</em>: </p>
<pre class="code literal-block"><span class="n">export</span> <span class="n">CCC_CC</span><span class="o">=</span><span class="n">clang</span>
<span class="n">export</span> <span class="n">CCC_CXX</span><span class="o">=</span><span class="n">clang</span><span class="o">++</span>
<span class="n">scan</span><span class="o">-</span><span class="n">build</span> <span class="n">cmake</span> <span class="o">-</span><span class="n">DCMAKE_CXX_COMPILER</span><span class="o">=</span><span class="n">clang</span><span class="o">++</span> <span class="o">-</span><span class="n">DCMAKE_C_COMPILER</span><span class="o">=</span><span class="n">clang</span> <span class="p">.</span>
<span class="n">scan</span><span class="o">-</span><span class="n">build</span> <span class="n">make</span>
</pre>


<p>This can take a very long time. On eddic, it is about three times slower than a normal compilation. An important point to note about performance, is that you can run compilations in parallel (-j option of make) and that it is supported by scan-build quite well. </p>
<p>Once analysis is performed, the found bugs are put into an HTML report. By default, the HTML report is created in <em>/tmp/</em>, but you can specificy the folder with -o option of scan-build. </p>
<p>You can enable or disable checker with the -enable-checker and -disable-checker options of scan-build. </p>
<h2>Results on eddic</h2>
<p>Several versions of Clang ago, I tried the static analyzer on eddic, but it failed on several source files without producing any results. Moreover, at this time, I don't think there was any nice HTML report at this time. </p>
<p>I ran it again on eddic with the last versions. Here is a picture of the generated report: </p>
<p><img alt="CLang Static Analyzer eddic results" src="/images/eddic_results.png" /></p>
<p>As you can see, 14 bugs have been found. Unfortunately, none of them is a real bug on my code, but they are not all false positives neither. For instance, here is some unreachable code report: </p>
<p><img alt="CLang Static Analyzer eddic bug" src="/images/eddic_results_bug.png" /></p>
<p>It is indeed an unreachable statement, but it is expected, since it is an assert to ensure that the code is unreachable. But that proves that the analysis works ;) </p>
<p>Even if it didn't found anything, this time it worked much better than the last time I checked and the HTML results are just really good. </p>
<p>I hope you found this article interesting. If you happen to have interesting results on your codebase with the CLang static analyzer, I'd be glad to hear about them ;)</p>