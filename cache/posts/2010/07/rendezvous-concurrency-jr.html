<p>In this post, we'll see a new feature of JR : the rendezvous.</p>
<p>Like asynchronous message passing, this synchronization method involves two processes : a caller and a receiver. But this time, the invocation is synchronous, the caller delays until the operation completes. The rendezvous does not create a new thread to the receiver. The receiver must invoke an input statement (the implementation of rendezvous) and wait for the message. Like asynchronous message passing, this is achieved using operations as message queue.</p>
<!-- TEASER_END -->

<p>The rendezvous can simplify this kind of operations :</p>
<pre class="code literal-block"><span class="kt">int</span> <span class="n">x</span><span class="o">;</span>
<span class="kt">int</span> <span class="n">y</span><span class="o">;</span>
<span class="n">send</span> <span class="nf">op_command</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="mi">3</span><span class="o">);</span>
<span class="n">receive</span><span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="n">y</span><span class="o">);</span>
</pre>


<p>To make a rendezvous, we'use the input statement. I think it's the harder (but also most complete) statement of the JR programming language. Here is the general form :</p>
<pre class="code literal-block"><span class="n">inni</span> <span class="n">op_command</span> <span class="o">{</span>
<span class="c1">//Code block</span>
<span class="o">}</span>
<span class="o">[]</span> <span class="n">op_command</span> <span class="o">{</span>
<span class="c1">//Code block</span>
<span class="o">}..</span>
</pre>


<p>An op_command specifiy an operation to wait for. An op_command is of this form :</p>
<pre class="code literal-block"><span class="n">return_type</span> <span class="nf">op_exp</span><span class="o">(</span><span class="n">args</span><span class="o">)</span> <span class="n">st</span> <span class="n">synch</span> <span class="n">by</span> <span class="n">sched</span>
</pre>


<p>Explanations :</p>
<ul>
    <li>return_type : Indicate the return type of the operation we are waiting for</li>
    <li>op_exp : The name of the operation or the capability</li>
    <li>args : The arguments of the operation</li>
    <li>st synch : Add a condition to the operations. This condition indicates which messages are acceptable</li>
    <li>by sched : Dictate the order of servicing the messages. Must be numerical. The message with the lowest value of scheduling expression will be serviced in first.</li>
</ul>

<p>If there is no synchronization expression and no scheduling expression, the first serviced invocation is the oldest. If there is a synchronization expression, the first serviced invocation is the oldest selectable expression and if there is a scheduling expression, the first serviced is the first selectable invocation that minimizes the scheduling expression. If there is no selectable message, the input statement delays until there is one.</p>
<p>You can also add an else statement to the input statement :</p>
<pre class="code literal-block"><span class="n">inni</span> <span class="n">op_command</span> <span class="o">{</span>
<span class="c1">//Code block</span>
<span class="o">}</span> <span class="o">...</span>
<span class="o">[]</span> <span class="k">else</span> <span class="o">{</span>
<span class="c1">//Code block</span>
<span class="o">}</span>
</pre>


<p>The else block will be executed if there is no selectable message. So an input statement with an else statement will never delays.</p>
<p>Lets imagine a simple example. The server return the sum of 2 numbers after receiving a message. If we write this simple program using asynchronous message, it'll give us something like that :</p>
<pre class="code literal-block"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Calculator</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="n">op</span> <span class="kt">void</span> <span class="nf">request</span><span class="o">(</span><span class="kt">int</span> <span class="n">x</span><span class="o">,</span> <span class="kt">int</span> <span class="n">y</span><span class="o">);</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="n">op</span> <span class="kt">void</span> <span class="nf">response</span><span class="o">(</span><span class="kt">int</span> <span class="n">sum</span><span class="o">,</span> <span class="kt">int</span> <span class="n">sub</span><span class="o">);</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">...</span> <span class="n">args</span><span class="o">){}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="n">process</span> <span class="n">Client</span> <span class="o">{</span>
        <span class="n">send</span> <span class="nf">request</span><span class="o">(</span><span class="mi">33</span><span class="o">,</span> <span class="mi">22</span><span class="o">);</span>

        <span class="kt">int</span> <span class="n">sum</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">sub</span><span class="o">;</span>
        <span class="n">receive</span> <span class="nf">response</span><span class="o">(</span><span class="n">sum</span><span class="o">,</span> <span class="n">sub</span><span class="o">);</span>

        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">&quot;Sum %d Sub %d&quot;</span><span class="o">,</span> <span class="n">sum</span><span class="o">,</span> <span class="n">sub</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="n">process</span> <span class="n">Server</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">x</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">y</span><span class="o">;</span>
        <span class="n">receive</span> <span class="nf">request</span><span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="n">y</span><span class="o">);</span>
        <span class="n">send</span> <span class="nf">response</span><span class="o">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="o">,</span> <span class="n">x</span> <span class="o">-</span> <span class="n">y</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre>


<p>It little bit complicated for a thing as simple, isn't it ? Let's rewrite it with input statement :</p>
<pre class="code literal-block"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CalculatorInni</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="n">op</span> <span class="kt">int</span> <span class="nf">compute</span><span class="o">(</span><span class="kt">int</span> <span class="n">x</span><span class="o">,</span> <span class="kt">int</span> <span class="n">y</span><span class="o">);</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">...</span> <span class="n">args</span><span class="o">){}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="n">process</span> <span class="n">Client</span> <span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">&quot;Sum %d&quot;</span><span class="o">,</span> <span class="n">compute</span><span class="o">(</span><span class="mi">33</span><span class="o">,</span> <span class="mi">22</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="n">process</span> <span class="n">Server</span> <span class="o">{</span>
        <span class="n">inni</span> <span class="kt">int</span> <span class="nf">compute</span><span class="o">(</span><span class="kt">int</span> <span class="n">x</span><span class="o">,</span> <span class="kt">int</span> <span class="n">y</span><span class="o">){</span>
            <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre>


<p>Easier, shorter and clearer, isn't it ?</p>
<p>The Client invoke the compute operation and get the return value directly because it's synchronous. If you have an operation with a return value, you doesn't have to use the call statement, it's implicit. If you have a void operation, you can use the call statement (but if you don't, it's the same by default) before the operation :</p>
<pre class="code literal-block"><span class="n">call</span> <span class="nf">op_command</span><span class="o">(</span><span class="n">args</span><span class="o">);</span>
</pre>


<p>And the Server has only to use the input statement to return the sum of the numbers.</p>
<p>As you've perhaps seen, the receive is only an abbreviation to the simplest form of input statement. So if you write :</p>
<pre class="code literal-block"><span class="kt">int</span> <span class="n">x</span><span class="o">;</span>
<span class="kt">int</span> <span class="n">y</span><span class="o">;</span>
<span class="n">receive</span> <span class="nf">op_command</span><span class="o">(</span><span class="n">x</span>
</pre>


<p>It's the same as if you write :</p>
<pre class="code literal-block"><span class="n">inni</span> <span class="kt">void</span> <span class="nf">op_command</span><span class="o">(</span><span class="kt">int</span> <span class="n">a</span><span class="o">,</span> <span class="kt">int</span> <span class="n">b</span><span class="o">){</span>
      <span class="n">x</span> <span class="o">=</span> <span class="n">a</span><span class="o">;</span>
      <span class="n">y</span> <span class="o">=</span> <span class="n">b</span><span class="o">;</span>
<span class="o">}</span>
</pre>


<p>But in this case, it's easier to use the receive statement.</p>
<p>The input statement can also be used to service a group of operations in an array :</p>
<pre class="code literal-block"><span class="n">cap</span> <span class="nf">void</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">operations</span> <span class="o">=</span> <span class="k">new</span> <span class="n">cap</span> <span class="kt">void</span> <span class="o">(</span><span class="kt">int</span><span class="o">)[</span><span class="mi">12</span><span class="o">];</span>

<span class="c1">//Fill the array</span>
<span class="n">inni</span> <span class="o">((</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&amp;</span><span class="n">amp</span><span class="o">;</span><span class="n">lt</span><span class="o">;</span> <span class="mi">12</span><span class="o">;</span> <span class="n">i</span><span class="o">++))</span> <span class="n">operations</span><span class="o">[</span><span class="n">i</span><span class="o">](</span><span class="kt">int</span> <span class="n">x</span><span class="o">)</span> <span class="o">{</span>
   <span class="c1">//Code b</span>
<span class="o">}</span>
</pre>


<p>More than return, we could also use two new statements in an input statement :</p>
<ul>
    <li>reply : return a value to the caller but doesn't break the input statement, so you can still make operations in the input statement but you cannot return a value anymore.</li>
    <li>forward : delegate the answer to an other operation. So this is the other operation who will answer to the caller, the input statement continues its execution but cannot return a value anymore.</li>
</ul>

<p>Now that we know how to use input statement, we can simplify the ResourceAllocator of the next post. We can do a lot more easier, with two operations and input statements :</p>
<pre class="code literal-block"><span class="kn">import</span> <span class="nn">java.util.*</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ResourceAllocator</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">N</span> <span class="o">=</span> <span class="mi">25</span><span class="o">;</span> <span class="c1">//Number of clients</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">I</span> <span class="o">=</span> <span class="mi">25</span><span class="o">;</span> <span class="c1">//Number of iterations</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">...</span> <span class="n">args</span><span class="o">){}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="n">op</span> <span class="n">Resource</span> <span class="nf">request</span><span class="o">();</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="n">op</span> <span class="kt">void</span> <span class="nf">release</span><span class="o">(</span><span class="n">Resource</span><span class="o">);</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="n">process</span> <span class="nf">Client</span><span class="o">((</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&amp;</span><span class="n">amp</span><span class="o">;</span><span class="n">lt</span><span class="o">;</span> <span class="n">N</span><span class="o">;</span> <span class="n">i</span><span class="o">++)){</span>
        <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">a</span> <span class="o">&amp;</span><span class="n">amp</span><span class="o">;</span><span class="n">lt</span><span class="o">;</span> <span class="n">I</span><span class="o">;</span> <span class="n">a</span><span class="o">++){</span>
            <span class="n">Resource</span> <span class="n">resource</span> <span class="o">=</span> <span class="n">request</span><span class="o">();</span>

            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">&quot;Client %d use resource %d \n&quot;</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="n">resource</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>

            <span class="n">call</span> <span class="nf">release</span><span class="o">(</span><span class="n">resource</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="n">process</span> <span class="n">Server</span><span class="o">{</span>
        <span class="n">Queue</span> <span class="n">resources</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LinkedList</span><span class="o">();</span>

        <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&amp;</span><span class="n">amp</span><span class="o">;</span><span class="n">lt</span><span class="o">;=</span> <span class="mi">5</span><span class="o">;</span> <span class="n">i</span><span class="o">++){</span>
            <span class="n">resources</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">Resource</span><span class="o">(</span><span class="n">i</span><span class="o">));</span>
        <span class="o">}</span>

        <span class="k">while</span><span class="o">(</span><span class="kc">true</span><span class="o">){</span>
            <span class="n">inni</span> <span class="n">Resource</span> <span class="nf">request</span><span class="o">()</span> <span class="n">st</span> <span class="o">!</span><span class="n">resources</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">()</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">resources</span><span class="o">.</span><span class="na">poll</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="o">[]</span> <span class="kt">void</span> <span class="n">release</span><span class="o">(</span><span class="n">Resource</span> <span class="n">resource</span><span class="o">){</span>
                <span class="n">resources</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">resource</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">Resource</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">id</span><span class="o">;</span>

        <span class="kd">private</span> <span class="nf">Resource</span><span class="o">(</span><span class="kt">int</span> <span class="n">id</span><span class="o">){</span>
            <span class="kd">super</span><span class="o">();</span>

            <span class="k">this</span><span class="o">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">id</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">private</span> <span class="kt">int</span> <span class="nf">getId</span><span class="o">(){</span>
            <span class="k">return</span> <span class="n">id</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre>


<p>Clearer, not ?</p>
<p>The last improvement we can do is to use a send instead of a call in the Client. We doesn't need to wait for release in client and the input statement can service send invocations as well as call but the send  invocations cannot return something.</p>
<p>So we've now covered the rendezvous synchronization system in the JR system. In the next, and last, post about JR programming language, we'll see how to distribute our processes on several virtual machines.</p>