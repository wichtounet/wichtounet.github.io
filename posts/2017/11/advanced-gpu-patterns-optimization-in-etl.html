<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="Optimization of advanced patterns for GPU performance in Expression Templates Library (ETL)">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Advanced GPU Patterns Optimization in ETL | Blog blog("Baptiste Wicht");</title>
<link href="../../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" hreflang="en" href="../../../rss.xml">
<link rel="canonical" href="https://baptiste-wicht.com/posts/2017/11/advanced-gpu-patterns-optimization-in-etl.html">
<!--[if lt IE 9]><script src="../../../assets/js/html5.js"></script><![endif]--><meta name="author" content="Baptiste Wicht">
<link rel="prev" href="initial-support-for-long-short-term-memory-lstm-in-dll.html" title="Initial support for Long Short Term Memory (LSTM) in DLL" type="text/html">
<link rel="next" href="../../2018/01/expression-templates-library-121-faster-gpu-and-new-features.html" title="Expression Templates Library 1.2.1: Faster GPU and new features" type="text/html">
<meta property="og:site_name" content='Blog blog("Baptiste Wicht");'>
<meta property="og:title" content="Advanced GPU Patterns Optimization in ETL">
<meta property="og:url" content="https://baptiste-wicht.com/posts/2017/11/advanced-gpu-patterns-optimization-in-etl.html">
<meta property="og:description" content="Optimization of advanced patterns for GPU performance in Expression Templates Library (ETL)">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2017-11-26T15:44:29+01:00">
<meta property="article:tag" content="C++">
<meta property="article:tag" content="dll">
<meta property="article:tag" content="etl">
<meta property="article:tag" content="GPU">
<meta property="article:tag" content="Optimization">
<meta property="article:tag" content="Performance">
<meta property="article:tag" content="projects">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://baptiste-wicht.com/">

                <span id="blog-title">Blog blog("Baptiste Wicht");</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="../../../stories/about.html">About</a>
                </li>
<li>
<a href="../../../stories/publications.html">Publications</a>
                </li>
<li>
<a href="../../../stories/projects.html">Projects</a>
                </li>
<li>
<a href="../../../categories/index.html">Tags</a>
                </li>
<li>
<a href="../../../archive.html">Archives</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right">
<li>
    <a href="advanced-gpu-patterns-optimization-in-etl.rst" id="sourcelink">Source</a>
    </li>

                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="#" class="u-url">Advanced GPU Patterns Optimization in ETL</a></h1>

        <div class="metadata">
            <p class="byline author vcard p-author h-card"><span class="byline-name fn p-name" itemprop="author">
                    Baptiste Wicht
            </span></p>
            <p class="dateline">
            <a href="#" rel="bookmark">
            <time class="published dt-published" datetime="2017-11-26T15:44:29+01:00" itemprop="datePublished" title="2017-11-26 15:44">2017-11-26 15:44</time></a>
            </p>
                <p class="commentline">
    
    <a href="advanced-gpu-patterns-optimization-in-etl.html#disqus_thread" data-disqus-identifier="cache/posts/2017/11/advanced-gpu-patterns-optimization-in-etl.html">Comments</a>


            
        </p>
<p class="sourceline"><a href="advanced-gpu-patterns-optimization-in-etl.rst" class="sourcelink">Source</a></p>

        </div>
        

    </header><div class="e-content entry-content" itemprop="articleBody text">
    <p>The GPU performance of my Expression Templates Library (ETL) is pretty good when
most of the time is spent inside expensive operations such as Matrix-Matrix
Multiplication or convolutions. However, when most of the time is spent in
linear kernels, performance is not great because this will invoke a lot of CUDA
kernels. Indeed, the way it is done is that each sub expressions compute its
result in a temporary GPU vector (or matrix) and these temporaries are passed
through the expressions. For instance, this expression:</p>
<div class="code"><pre class="code C++"><a id="rest_code_c76c32b2a7244611a2951e5eee230afd-1" name="rest_code_c76c32b2a7244611a2951e5eee230afd-1" href="advanced-gpu-patterns-optimization-in-etl.html#rest_code_c76c32b2a7244611a2951e5eee230afd-1"></a><span class="n">yy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.1</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1.2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">y</span>
</pre></div>
<p>will be executed on the GPU as something like this:</p>
<div class="code"><pre class="code C++"><a id="rest_code_283b3f5fc9074df3918db72a89c538de-1" name="rest_code_283b3f5fc9074df3918db72a89c538de-1" href="advanced-gpu-patterns-optimization-in-etl.html#rest_code_283b3f5fc9074df3918db72a89c538de-1"></a><span class="n">t1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.1</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x</span>
<a id="rest_code_283b3f5fc9074df3918db72a89c538de-2" name="rest_code_283b3f5fc9074df3918db72a89c538de-2" href="advanced-gpu-patterns-optimization-in-etl.html#rest_code_283b3f5fc9074df3918db72a89c538de-2"></a><span class="n">t2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">y</span>
<a id="rest_code_283b3f5fc9074df3918db72a89c538de-3" name="rest_code_283b3f5fc9074df3918db72a89c538de-3" href="advanced-gpu-patterns-optimization-in-etl.html#rest_code_283b3f5fc9074df3918db72a89c538de-3"></a><span class="n">yy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">t1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">t2</span>
</pre></div>
<p>that will results in three GPU kernels being invoked. In the CPU case, the
complete expression will be executed as one CPU kernel, that is constructed with
Expression Templates. Unfortunately, a CUDA kernel cannot be constructed in the
same way since the CUDA compiler does not support general template
metaprogramming. That's why I've implemented by using small kernels for each
expression.</p>
<p>Fortunately, we can do better with a bit more meta-programming. Indeed, there
are some patterns that are repeated a lot and that easily be implemented in CUDA
kernels. I've started detecting a few of these patterns and for each of them
a single CUDA kernel is executed. For instance, each of the following
expressions can be executed with a single kernel:</p>
<div class="code"><pre class="code C++"><a id="rest_code_1f74fb00ca1e4efa89f7ca3cf34615ca-1" name="rest_code_1f74fb00ca1e4efa89f7ca3cf34615ca-1" href="advanced-gpu-patterns-optimization-in-etl.html#rest_code_1f74fb00ca1e4efa89f7ca3cf34615ca-1"></a><span class="n">yy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.1</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">y</span>
<a id="rest_code_1f74fb00ca1e4efa89f7ca3cf34615ca-2" name="rest_code_1f74fb00ca1e4efa89f7ca3cf34615ca-2" href="advanced-gpu-patterns-optimization-in-etl.html#rest_code_1f74fb00ca1e4efa89f7ca3cf34615ca-2"></a><span class="n">yy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1.1</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">y</span>
<a id="rest_code_1f74fb00ca1e4efa89f7ca3cf34615ca-3" name="rest_code_1f74fb00ca1e4efa89f7ca3cf34615ca-3" href="advanced-gpu-patterns-optimization-in-etl.html#rest_code_1f74fb00ca1e4efa89f7ca3cf34615ca-3"></a><span class="n">yy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.1</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1.2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">y</span>
<a id="rest_code_1f74fb00ca1e4efa89f7ca3cf34615ca-4" name="rest_code_1f74fb00ca1e4efa89f7ca3cf34615ca-4" href="advanced-gpu-patterns-optimization-in-etl.html#rest_code_1f74fb00ca1e4efa89f7ca3cf34615ca-4"></a><span class="n">yy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.1</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">y</span>
<a id="rest_code_1f74fb00ca1e4efa89f7ca3cf34615ca-5" name="rest_code_1f74fb00ca1e4efa89f7ca3cf34615ca-5" href="advanced-gpu-patterns-optimization-in-etl.html#rest_code_1f74fb00ca1e4efa89f7ca3cf34615ca-5"></a><span class="n">yy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="mf">1.1</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
</pre></div>
<p>This results in significantly performance improvement for these expressions!</p>
<p>I have tested these new improvements in my Deep Learning Library (DLL) project
(not yet merged) and it resulted in <strong>25% faster momentum computation</strong> and
<strong>17% faster Nesterov Adam (NADAM)</strong>.</p>
<p>I'm going to continue to investigate which kernels need to be made faster for
DLL and try to improve the overall performance. Currently, the GPU performance
of DLL is very good for large convolutional networks, but could be improved for
small fully-connected networks. Indeed, in that case, quite some time is spent
outside the matrix-matrix multiplication and inside serial expressions for which
GPU could be improved. Once I'm done with my optimizations, I'll probably post
again on the blog with the latest results.</p>
<p>All these new optimizations are now in the <strong>master</strong> branch of the ETL
project if you want to check it out. You can access the project
<a class="reference external" href="https://github.com/wichtounet/etl">on Github</a>.</p>
    <h3>Related articles</h3>
    

    <li><a href="../../2018/01/expression-templates-library-121-faster-gpu-and-new-features.html">Expression Templates Library 1.2.1: Faster GPU and new features</a></li>
<li><a href="../10/expression-templates-library-etl-1-2-complete-gpu-support.html">Expression Templates Library (ETL) 1.2 - Complete GPU support</a></li>
<li><a href="../05/update-on-expression-templates-library-etl.html">Update on Expression Templates Library (ETL)</a></li>
<li><a href="../../2016/09/expression-templates-library-etl-10.html">Expression Templates Library (ETL) 1.0</a></li>
<li><a href="../08/expression-templates-library-etl-11.html">Expression Templates Library (ETL) 1.1</a></li>
<li><a href="../../2012/02/local-optimization-on-three-address-code.html">Local optimization of Three-Address-Code</a></li>


    </div>
    <aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../../../categories/c%2B%2B.html" rel="tag">C++</a></li>
            <li><a class="tag p-category" href="../../../categories/dll.html" rel="tag">dll</a></li>
            <li><a class="tag p-category" href="../../../categories/etl.html" rel="tag">etl</a></li>
            <li><a class="tag p-category" href="../../../categories/gpu.html" rel="tag">GPU</a></li>
            <li><a class="tag p-category" href="../../../categories/optimization.html" rel="tag">Optimization</a></li>
            <li><a class="tag p-category" href="../../../categories/performance.html" rel="tag">Performance</a></li>
            <li><a class="tag p-category" href="../../../categories/projects.html" rel="tag">projects</a></li>
        </ul>
<ul class="pager hidden-print">
<li class="previous">
                <a href="initial-support-for-long-short-term-memory-lstm-in-dll.html" rel="prev" title="Initial support for Long Short Term Memory (LSTM) in DLL">Previous post</a>
            </li>
            <li class="next">
                <a href="../../2018/01/expression-templates-library-121-faster-gpu-and-new-features.html" rel="next" title="Expression Templates Library 1.2.1: Faster GPU and new features">Next post</a>
            </li>
        </ul></nav></aside><section class="comments hidden-print"><h2>Comments</h2>
        
    
        <div id="disqus_thread"></div>
        <script>
        var disqus_shortname ="blogwichtounet",
            disqus_url="https://baptiste-wicht.com/posts/2017/11/advanced-gpu-patterns-optimization-in-etl.html",
        disqus_title="Advanced GPU Patterns Optimization in ETL",
        disqus_identifier="cache/posts/2017/11/advanced-gpu-patterns-optimization-in-etl.html",
        disqus_config = function () {
            this.language = "en";
        };
        (function() {
            var dsq = document.createElement('script'); dsq.async = true;
            dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
</noscript>
    <a href="https://disqus.com" class="dsq-brlink" rel="nofollow">Comments powered by <span class="logo-disqus">Disqus</span></a>


        </section></article><script>var disqus_shortname="blogwichtounet";(function(){var a=document.createElement("script");a.async=true;a.src="https://"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2023         <a href="mailto:baptistewicht@gmail.com">Baptiste Wicht</a> - Powered by         <a href="http://getnikola.com" rel="nofollow">Nikola</a>         - License: 
<a rel="license" href="http://creativecommons.org/licenses/by/4.0/"><img alt="Creative Commons License" style="padding-left:5px;border-width:0" src="../../../assets/img/cc.png"></a>
            
        </footer>
</div>
</div>


            <script src="../../../assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script>
</body>
</html>
