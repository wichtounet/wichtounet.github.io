<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " lang=en> <head><meta charset=utf-8><meta name=viewport content="width=device-width"><title>Asynchronous Message Passing in JR | @Blog("Baptiste Wicht")</title><link href=../../../assets/css/all-nocdn.css rel=stylesheet type=text/css><link rel=alternate type=application/rss+xml title=RSS href=../../../rss.xml><link rel=canonical href=http://baptiste-wicht.com/posts/2010/07/asynchronous-message-passing-jr.html><script type=text/javascript>
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-2175227-7']);
  _gaq.push(['_trackPageview']);
  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script><meta name=author content="Baptiste Wicht"><meta name=og:title content="Asynchronous Message Passing in JR"><meta name=og:url content=http://baptiste-wicht.com/posts/2010/07/asynchronous-message-passing-jr.html><meta name=og:description content="We've now covered the basic synchronization systems (semaphore, monitors) and we know how to declare operations and capabilities . It's time to go to an other form of synchronization : Message Passing"><meta name=og:site_name content=@Blog( baptiste wicht><meta name=og:type content=article><link href=../../../favicon.ico rel=icon type=image/x-icon></head><body><div class=social_container> <div class=social_container_gplus> <a target=_blank title="Share on Google+" href="https://plusone.google.com/_/+1/confirm?hl=en&amp;url=http://baptiste-wicht.com/posts/2010/07/asynchronous-message-passing-jr.html"><img src=../../../assets/img/google_plus.png></a> </div> <div class=social_container_facebook> <a target=_blank title="Share on Facebook" href="http://www.facebook.com/sharer/sharer.php?u=#url"><img src=../../../assets/img/facebook.png></a> </div> <div class=social_container_twitter> <a target=_blank title="Tweet on Twitter" href="http://twitter.com/home?status=#url"><img src=../../../assets/img/twitter.svg></a> </div></div><nav class="navbar navbar-inverse navbar-fixed-top" role=navigation> <div class=container-fluid> <div class=navbar-header> <button type=button class=navbar-toggle data-toggle=collapse data-target=.navbar-ex1-collapse> <span class=sr-only>Toggle navigation</span> <span class=icon-bar></span> <span class=icon-bar></span> <span class=icon-bar></span> </button> <a class=navbar-brand href=http://baptiste-wicht.com/> <span id=blog-title>@Blog("Baptiste Wicht")</span> </a> </div> <div class="collapse navbar-collapse navbar-ex1-collapse"> <ul class="nav navbar-nav"> <li><a href=../../../stories/about.html>About</a> </li><li><a href=../../../stories/publications.html>Publications</a> </li><li><a href=../../../stories/donate.html>Donate</a> </li><li><a href=../../../stories/contact.html>Contact</a> </li><li><a href=../../../stories/faq.html>FAQ</a> </li><li><a href=../../../stories/legal.html>Legal</a> </li><li><a href=../../../categories/index.html>Tags</a> </li><li><a href=../../../archive.html>Archives</a> </li><li><a href=http://feeds.feedburner.com/BaptisteWicht>RSS</a> </li></ul> <span class="navbar-form pull-left"> <form action=../../../stories/search.html> <input type=text name=q id=tipue_search_input> </form> </span> <ul class="nav navbar-nav navbar-right"> <li> <a target=_blank title="Follow @wichtounet on Twitter" href=https://twitter.com/wichtounet> <img src=../../../assets/img/twitter.svg alt="Follow @wichtounet on Twitter"> </a> </li> <li> <a target=_blank title="Follow +BaptisteWicht on Google+" href=https://plus.google.com/+BaptisteWicht> <img src=../../../assets/img/google_plus.svg alt="Follow +BaptisteWicht on Google+"> </a> </li> </ul> </div> </div></nav><div class=body-container> <div class=left-sidebar> <div class=left-sidebar-widget> <div class=left-sidebar-widget-content> <div class=g-person data-width=275 data-href=//plus.google.com/u/0/103113673902796202116 data-theme=dark data-layout=landscape data-rel=author></div> </div> </div> <div class=left-sidebar-widget> <h3>Related posts</h3> <div class=left-sidebar-widget-content> <ol><li><a href=../06/jr-operations-and-capabilities.html>JR Operations and Capabilities</a></li><li><a href=rendezvous-concurrency-jr.html>Rendezvous, concurrency method, in JR</a></li><li><a href=../01/jr-introduction.html>Introduction to JR programming language</a></li><li><a href=../04/java-7-new-io-features-asynchronous-operations-multicasting-random-access-with-jsr-203-nio-2.html>Java 7 : New I/O features (Asynchronous operations, multicasting, random access) with JSR 203 (NIO.2)</a></li><li><a href=../06/monitor-programming-in-jr.html>Monitor programming in JR</a></li></ol> </div> </div> <div class=left-sidebar-widget> <h3>Recent comments</h3> <div class=left-sidebar-widget-content> <div id=recentcomments class=dsq-widget> <script type=text/javascript src="http://blogwichtounet.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=0&amp;avatar_size=28&amp;excerpt_length=50"></script> </div> </div> </div> <div class=left-sidebar-widget> <h3>Blogroll</h3> <div class=left-sidebar-widget-content> <ul> <li><a target=_blank href=http://www.asjava.com/>AsJava.com : Java Tutorial</a></li> <li><a target=_blank href=http://www.mkyong.com/>Mkyong : Java Tutorials</a></li> </ul> </div> </div> </div> <div class=container> <div class=body-content> <div class=row><article class="post-text h-entry hentry postpage" itemscope=itemscope itemtype=http://schema.org/Article> <header> <h1 class="p-name entry-title" itemprop="headline name"><a href=# class=u-url>Asynchronous Message Passing in JR</a></h1> <div class=metadata> <p class="byline author vcard"><span class="byline-name fn">Baptiste Wicht</span></p> <p class=dateline><a href=# rel=bookmark><time class="published dt-published" datetime=2010-07-02T07:02:09+02:00 itemprop=datePublished title="Publication date">2010-07-02 07:02</time></a></p> <p class=commentline> <a href=asynchronous-message-passing-jr.html#disqus_thread data-disqus-identifier=cache/posts/2010/07/asynchronous-message-passing-jr.html>Comments</a> </p><p class=sourceline><a href=asynchronous-message-passing-jr.wp id=sourcelink>Source</a></p> </div> </header> <div class="e-content entry-content" itemprop="articleBody text"> <p>We've now covered the basic synchronization systems (<a href=http://www.baptiste-wicht.com/2010/01/jr-introduction/ target=_blank>semaphore</a>, <a href=http://www.baptiste-wicht.com/2010/06/monitor-programming-in-jr/ target=_blank>monitors</a>) and we know how to <a href=http://www.baptiste-wicht.com/2010/06/jr-operations-and-capabilities/ target=_blank>declare operations and capabilities</a> . It's time to go to an other form of synchronization : <strong>Message Passing</strong>. In this post, we'll focus in <strong>Asynchronous Message Passing</strong>, we'll cover later, the synchronous message passing system with RendezVous.</p><p>When we use message passing, the threads doesn't share datas anymore, they share channels. You can see channels like an abstraction of a network between several processes. The processes will send messages to other and the other will wait for receive a message. Normally, with that form of synchronization, the channels are the only objects shared between the threads. So you doesn't need to share memory. That makes possible to distribute the processes across several virtual machines or computers, of course, this also works on a simple computer, like any other program. In message passing, we often see models with several clients and a server that manage the messages. </p><p>In Java, you will do that with Socket or RMI but in JR, this system is really easily integrated. We'll use operations as messages queues and send/receive operations in the queue to respectively send a message to the queue and receive a message from the queue. The operations must not be implemented to achieve asynchronous message passing. If the operations is implemented, this will make a remote procedure call, but we'll not cover that system for now. And because, it's asynchronous, the operations cannot have a return type. The operations visibility is the same as the method visibility. So if an operation is static in class A, a send statement on this operation can be serviced by any process who has the visibility to access this operation. </p><p>So we will need that kind of operations :</p><pre class="code literal-block"><span class=kd>private</span> <span class=kd>static</span> <span class=n>op</span> <span class=kt>void</span> <span class=nf>channel</span><span class=o>(</span><span class=kt>int</span><span class=o>);</span>
</pre><p>To send a message to a channel, you just have to use the send keyword followed by the name of the operations with the arguments :</p><pre class="code literal-block"><span class=n>send</span> <span class=nf>channel</span><span class=o>(</span><span class=mi>12</span><span class=o>);</span>
</pre><p>The send operation does not block, when the same is sended, the send operation is released.</p><p>To receive a message, you have to use the receive keyword, followed by the variables name in which put the values of the arguments :</p><pre class="code literal-block"><span class=kt>int</span> <span class=n>x</span><span class=o>;</span>
<span class=n>receive</span> <span class=nf>channel</span><span class=o>(</span><span class=n>x</span><span class=o>);</span>
</pre><p>The variables must have been declared before used in the receive statement. It's a little weird when we start, but it's really practical to assign them in one operation even if we have a lot of parameters. When we the process are on the same virtual machines, the parameters are passed like for any method in Java, by value. If we put all that together in processes :</p><pre class="code literal-block"><span class=kd>public</span> <span class=kd>class</span> <span class=nc>AMP1</span> <span class=o>{</span>
    <span class=kd>private</span> <span class=kd>static</span> <span class=n>op</span> <span class=kt>void</span> <span class=nf>channel</span><span class=o>(</span><span class=kt>int</span><span class=o>);</span>

    <span class=kd>private</span> <span class=kd>static</span> <span class=n>process</span> <span class=n>p1</span><span class=o>{</span>
        <span class=n>send</span> <span class=nf>channel</span><span class=o>(</span><span class=mi>12</span><span class=o>);</span>
    <span class=o>}</span>

    <span class=kd>private</span> <span class=kd>static</span> <span class=n>process</span> <span class=n>p2</span><span class=o>{</span>
        <span class=kt>int</span> <span class=n>x</span><span class=o>;</span>      
        <span class=n>receive</span> <span class=nf>channel</span><span class=o>(</span><span class=n>x</span><span class=o>);</span>
        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>x</span><span class=o>);</span>
    <span class=o>}</span>

    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>...</span> <span class=n>args</span><span class=o>){}</span>
<span class=o>}</span>
</pre><p>The messages are received in the order they are sent for each sender. But it's possible that a message sent by Thread 1 before an other message sent by Thread 2 will be received after the one of Thread 2. Normally this would never appears when working in a simple computer, but that could appear often when working with several computers. So don't make any assumptions on the order your messages will be received. </p><p>With all that, we can solve the producer-consumer problem really easily : </p><pre class="code literal-block"><span class=kd>public</span> <span class=kd>class</span> <span class=nc>ProducerConsumer</span> <span class=o>{</span>
    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>N</span> <span class=o>=</span> <span class=mi>12</span><span class=o>;</span> <span class=c1>//Number of producers and consumers</span>

    <span class=kd>private</span> <span class=kd>static</span> <span class=n>op</span> <span class=kt>void</span> <span class=nf>deposit</span><span class=o>(</span><span class=n>String</span><span class=o>);</span> <span class=c1>//The channel</span>

    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>...</span> <span class=n>args</span><span class=o>){}</span>

    <span class=kd>private</span> <span class=kd>static</span> <span class=n>process</span> <span class=nf>Producer</span><span class=o>((</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>N</span><span class=o>;</span> <span class=n>i</span><span class=o>++)){</span>
        <span class=n>send</span> <span class=nf>deposit</span><span class=o>(</span><span class=s>"Producer"</span> <span class=o>+</span> <span class=n>i</span><span class=o>);</span>
    <span class=o>}</span>

    <span class=kd>private</span> <span class=kd>static</span> <span class=n>process</span> <span class=nf>Consumer</span><span class=o>((</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>N</span><span class=o>;</span> <span class=n>i</span><span class=o>++)){</span>
        <span class=n>String</span> <span class=n>data</span><span class=o>;</span>
        <span class=n>receive</span> <span class=nf>deposit</span><span class=o>(</span><span class=n>data</span><span class=o>);</span>
        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>"Consumer"</span> <span class=o>+</span> <span class=n>i</span> <span class=o>+</span> <span class=s>" : "</span> <span class=o>+</span> <span class=n>data</span><span class=o>);</span>
    <span class=o>}</span>
<span class=o>}</span>
</pre><p>No need to great explanations. A Producer send a message with the informations it has produced and doesn't wait for the receive. And a Consumer wait for a deposit (a send) with a receive statement and print the result when it has received the message. </p><p>Like you can invoke operations with capabilities, you can also send messages through a capability. It's very easy to share channels because this is only a variable. We often send the channels in a message for an answer. </p><p>Let's imagine a simple problem. We have N clients that needs resources shared by all the clients. We need something to manage the resources. So we'll use a kind of server to achieve that. So we can start with something really simple for the clients : </p><pre class="code literal-block"><span class=n>op</span> <span class=kt>void</span> <span class=nf>request</span><span class=o>();</span>
<span class=n>op</span> <span class=kt>void</span> <span class=nf>resource</span><span class=o>(</span><span class=n>Resource</span><span class=o>);</span>
<span class=n>op</span> <span class=kt>void</span> <span class=nf>release</span><span class=o>(</span><span class=n>Resource</span><span class=o>);</span>
<span class=n>send</span> <span class=nf>request</span><span class=o>();</span>
<span class=n>receive</span> <span class=nf>resource</span><span class=o>(</span><span class=n>resource</span><span class=o>);</span>

<span class=c1>//Use resources</span>
<span class=n>send</span> <span class=nf>release</span><span class=o>(</span><span class=n>resource</span><span class=o>);</span>
</pre><p>That seems good, but there are some problems : </p><ul><li>How can the server distinguish the clients ? If it sends a message to resource any client can take it, we need a way to create a channel between one client and the server (also called private channels). For this we'll use a capability as a channel. </li><li>If the server wait for request messages, it cannot wait for release messages and vice-versa. A solution is to have two process in the servers, but with that, you must synchronize the two process. A better solution is to create an operation that give informations about the type of request. </li></ul><p>So here, is the new version of client : </p><pre class="code literal-block"><span class=kd>enum</span> <span class=n>Type</span> <span class=o>{</span><span class=n>REQUEST</span><span class=o>,</span> <span class=n>RELEASE</span><span class=o>};</span>
<span class=n>op</span> <span class=kt>void</span> <span class=nf>request</span><span class=o>(</span><span class=n>Type</span><span class=o>,</span> <span class=n>cap</span> <span class=kt>void</span> <span class=o>(</span><span class=n>Resource</span><span class=o>),</span> <span class=n>Resource</span><span class=o>);</span>
<span class=n>cap</span> <span class=nf>void</span> <span class=o>(</span><span class=n>Resource</span><span class=o>)</span> <span class=n>channel</span> <span class=o>=</span> <span class=k>new</span> <span class=n>op</span> <span class=kt>void</span> <span class=o>(</span><span class=n>Resource</span><span class=o>);</span>

<span class=n>send</span> <span class=nf>request</span><span class=o>(</span><span class=n>Type</span><span class=o>.</span><span class=na>REQUEST</span><span class=o>,</span> <span class=n>channel</span><span class=o>,</span> <span class=kc>null</span><span class=o>);</span>
<span class=n>Resource</span> <span class=n>resource</span><span class=o>;</span>
<span class=n>receive</span> <span class=nf>channel</span><span class=o>(</span><span class=n>resource</span><span class=o>);</span>
<span class=n>send</span> <span class=nf>request</span><span class=o>(</span><span class=n>Type</span><span class=o>.</span><span class=na>RELEASE</span><span class=o>,</span> <span class=n>noop</span><span class=o>,</span> <span class=n>resoure</span><span class=o>);</span> 
</pre><p>and now the server : </p><pre class="code literal-block"><span class=n>cap</span> <span class=nf>void</span> <span class=o>(</span><span class=n>Resource</span><span class=o>)</span> <span class=n>client</span><span class=o>;</span>

<span class=n>Type</span> <span class=n>type</span><span class=o>;</span>
<span class=n>Resource</span> <span class=n>resource</span><span class=o>;</span>

<span class=n>Queue</span><span class=o>&lt;</span><span class=n>Resource</span><span class=o>&gt;</span> <span class=n>resources</span> <span class=o>=</span> <span class=k>new</span> <span class=n>LinkedQueue</span><span class=o>&lt;</span><span class=n>Resource</span><span class=o>&gt;();</span>

<span class=c1>//Fill the queue of resources</span>

<span class=n>Queue</span><span class=o>&lt;</span><span class=n>cap</span> <span class=nf>void</span> <span class=o>(</span><span class=kt>int</span><span class=o>)&gt;</span> <span class=n>clients</span> <span class=o>=</span> <span class=k>new</span> <span class=n>LinkedQueue</span><span class=o>&lt;</span><span class=n>cap</span> <span class=kt>void</span> <span class=kt>int</span><span class=o>&gt;();</span>

<span class=k>while</span><span class=o>(</span><span class=kc>true</span><span class=o>){</span>
    <span class=n>receive</span> <span class=nf>request</span><span class=o>(</span><span class=n>type</span><span class=o>,</span> <span class=n>client</span><span class=o>,</span> <span class=n>resource</span><span class=o>);</span>

    <span class=k>if</span><span class=o>(</span><span class=n>type</span> <span class=o>==</span> <span class=n>Type</span><span class=o>.</span><span class=na>REQUEST</span><span class=o>){</span>
        <span class=k>if</span><span class=o>(</span><span class=n>resources</span><span class=o>.</span><span class=na>isEmpty</span><span class=o>()){</span>
            <span class=n>clients</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>client</span><span class=o>);</span>
        <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
            <span class=n>send</span> <span class=nf>client</span><span class=o>(</span><span class=n>resource</span><span class=o>.</span><span class=na>pop</span><span class=o>());</span>
        <span class=o>}</span>
    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
        <span class=k>if</span><span class=o>(</span><span class=n>clients</span><span class=o>.</span><span class=na>isEmpty</span><span class=o>()){</span>
            <span class=n>resources</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>resource</span><span class=o>);</span>
        <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
            <span class=n>send</span> <span class=n>clients</span><span class=o>.</span><span class=na>pop</span><span class=o>()(</span><span class=n>resource</span><span class=o>);</span>
        <span class=o>}</span>   
    <span class=o>}</span>
<span class=o>}</span>
</pre><p>Really easy no ? And that code can be distributed with only minor changes. And it works for any number of process your want. You will find the complete code of this problem joined to this post. </p><p>We have now covered the complete informations about Asynchronous Message Passing in JR. I hope you found that article interesting. The next post will be about the RendezVous in JR. RendezVous are a very powerful way to achieve synchronization also with message passing, but synchronous. </p><p><a href=../../../wp-content/uploads/2010/07/ResourceAllocator.jr_.tar.gz>The complete source</a></p> </div> <aside class=postpromonav> <nav> <ul itemprop=keywords class=tags> <li><a class="tag p-category" href=../../../categories/concurrency.html rel=tag>Concurrency</a></li> <li><a class="tag p-category" href=../../../categories/jr.html rel=tag>JR</a></li> <li><a class="tag p-category" href=../../../categories/java.html rel=tag>Java</a></li> </ul> <ul class=pager> <li class=previous> <a href=../06/jr-operations-and-capabilities.html rel=prev title="JR Operations and Capabilities">Previous post</a> </li> <li class=next> <a href=tip-how-to-solve-agent-admitted-failure-to-sign-using-the-key-error.html rel=next title="Tip : How to solve “agent admitted failure to sign using the key” error ?">Next post</a> </li> </ul> </nav> </aside> <section class=comments> <h2>Comments</h2> <div id=disqus_thread></div> <script>
        var disqus_shortname ="blogwichtounet",
            disqus_url="http://baptiste-wicht.com/posts/2010/07/asynchronous-message-passing-jr.html",
        disqus_title="Asynchronous Message Passing in JR",
        disqus_identifier="cache/posts/2010/07/asynchronous-message-passing-jr.html",
        disqus_config = function () {
            this.language = "en";
        };
        (function() {
            var dsq = document.createElement('script'); dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script> <noscript>Please enable JavaScript to view the <a href=//disqus.com/?ref_noscript rel=nofollow>comments powered by Disqus.</a></noscript> <a href=//disqus.com class=dsq-brlink rel=nofollow>Comments powered by <span class=logo-disqus>Disqus</span></a> </section></article> <script>var disqus_shortname="blogwichtounet";(function(){var a=document.createElement("script");a.async=true;a.src="//"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script> </div> </div> </div></div><footer> Contents © 2014 <a href=mailto:baptistewicht@gmail.com>Baptiste Wicht</a> - Powered by <a href=http://getnikola.com rel=nofollow>Nikola</a><a rel=license href=http://creativecommons.org/licenses/by/4.0/><img alt="Creative Commons License" style=padding-left:5px;border-width:0 src=../../../assets/img/cc.png></a> <ul class=footer_inline_ul> <li> <a href=asynchronous-message-passing-jr.wp id=sourcelink>Source</a> </li> </ul></footer> <script src=../../../assets/js/all-nocdn.js></script><script type=text/javascript src=https://apis.google.com/js/platform.js></script></body></html>