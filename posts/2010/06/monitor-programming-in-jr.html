<!DOCTYPE html>
<html lang=en><head><link href=favicon.ico rel=icon type=image/x-icon><meta name=viewport content="width=device-width, initial-scale=1.0"><meta charset=utf-8><meta name=viewport content="width=device-width, initial-scale=1.0"><meta name=author content="Baptiste Wicht"><title>Monitor programming in JR | @Blog("Baptiste Wicht")</title><link href=../../../assets/css/all-nocdn.css rel=stylesheet type=text/css><link rel=canonical href=http://wichtounet.github.io/posts/2010/06/monitor-programming-in-jr.html><link rel=alternate type=application/rss+xml title=RSS href=../../../rss.xml><script type=text/javascript>
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-2175227-7']);
  _gaq.push(['_trackPageview']);
  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script></head><body><div class=social_container> <div class=social_container_gplus> <a target=_blank title="Share on Google+" href="https://plusone.google.com/_/+1/confirm?hl=en&amp;url=http://wichtounet.github.io/posts/2010/06/monitor-programming-in-jr.html"><img src=../../../assets/img/google_plus.png></a> </div> <div class=social_container_facebook> <a target=_blank title="Share on Facebook" href="http://www.facebook.com/sharer/sharer.php?u=#url"><img src=../../../assets/img/facebook.png></a> </div> <div class=social_container_twitter> <a target=_blank title="Tweet on Twitter" href="http://twitter.com/home?status=#url"><img src=../../../assets/img/twitter.svg></a> </div></div><nav class="navbar navbar-inverse navbar-fixed-top" role=navigation> <div class=container-fluid> <div class=navbar-header> <button type=button class=navbar-toggle data-toggle=collapse data-target=.navbar-ex1-collapse> <span class=sr-only>Toggle navigation</span> <span class=icon-bar></span> <span class=icon-bar></span> <span class=icon-bar></span> </button> <a class=navbar-brand href=http://wichtounet.github.io/>@Blog("Baptiste Wicht")</a> </div> <div class="collapse navbar-collapse navbar-ex1-collapse"> <ul class="nav navbar-nav"> <li><a href=../../../stories/about.html>About</a> </li><li><a href=../../../stories/publications.html>Publications</a> </li><li><a href=../../../stories/donate.html>Donate</a> </li><li><a href=../../../stories/contact.html>Contact</a> </li><li><a href=../../../stories/faq.html>FAQ</a> </li><li><a href=../../../stories/legal.html>Legal</a> </li><li><a href=../../../categories/index.html>Tags</a> </li><li><a href=../../../archive.html>Archives</a> </li><li><a href=http://feeds.feedburner.com/BaptisteWicht>RSS</a> </li></ul> <span class="navbar-form pull-left"> <form action=../../../stories/search.html> <input type=text name=q id=tipue_search_input> </form> </span> <ul class="nav navbar-nav navbar-right"> <li> <a target=_blank title="Follow @wichtounet on Twitter" href=https://twitter.com/wichtounewichtounet> <img src=../../../assets/img/twitter.svg alt="Follow @wichtounet on Twitter"> </a> </li> <li> <a target=_blank title="Follow +BaptisteWicht on Google+" href=https://plus.google.com/+BaptisteWicht> <img src=../../../assets/img/google_plus.svg alt="Follow +BaptisteWicht on Google+"> </a> </li> </ul> </div> </div></nav><div class=body-container> <div class=left-sidebar> <div class=left-sidebar-widget> <div class=left-sidebar-widget-content> <div class=g-person data-width=275 data-href=//plus.google.com/u/0/103113673902796202116 data-theme=dark data-layout=landscape data-rel=author></div> </div> </div> <div class=left-sidebar-widget> <h3>Related posts</h3> <div class=left-sidebar-widget-content> <ol><li><a href=../09/java-concurrency-part-5-monitors-locks-and-conditions.html>Java Concurrency - Part 5 : Monitors (Locks and Conditions)</a></li><li><a href=../01/jr-introduction.html>Introduction to JR programming language</a></li><li><a href=../01/install-jr-windows.html>Install the JR environment on Windows</a></li><li><a href=jr-operations-and-capabilities.html>JR Operations and Capabilities</a></li><li><a href=how-to-choose-a-monitor.html>How to choose a monitor for your computer ? </a></li></ol> </div> </div> <div class=left-sidebar-widget> <h3>Recent comments</h3> <div class=left-sidebar-widget-content> <div id=recentcomments class=dsq-widget> <script type=text/javascript src="http://blogwichtounet.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=0&amp;avatar_size=28&amp;excerpt_length=50"></script> </div> </div> </div> <div class=left-sidebar-widget> <h3>Popular posts</h3> <div class=left-sidebar-widget-content> <div id=popularthreads class=dsq-widget> <script type=text/javascript src="http://blogwichtounet.disqus.com/popular_threads_widget.js?num_items=5&amp;days_back=90"></script> </div> </div> </div> <div class=left-sidebar-widget> <h3>Blogroll</h3> <div class=left-sidebar-widget-content> <ul> <li><a target=_blank href=http://www.asjava.com/>AsJava.com : Java Tutorial</a></li> <li><a target=_blank href=http://www.mkyong.com/>Mkyong : Java Tutorials</a></li> </ul> </div> </div> </div> <div class=container> <div class=body-content> <div class=row> <article class="postbox post-text"> <div class=h-entry itemscope=itemscope itemtype=http://schema.org/Article> <h1 class=p-name itemprop="headline name">Monitor programming in JR</h1> <hr> <small> Posted: <time class="published dt-published" datetime=2010-06-28T06:30:35+02:00 itemprop=datePublished>2010-06-28 06:30</time>   |   More posts about <span itemprop=keywords> <a class="tag p-category" href=../../../categories/concurrency.html><span class="badge badge-info">Concurrency</span></a> <a class="tag p-category" href=../../../categories/java.html><span class="badge badge-info">Java</span></a> <a class="tag p-category" href=../../../categories/jr.html><span class="badge badge-info">JR</span></a> </span> </small> <hr> <div class=e-content itemprop="articleBody text"> <div><p>Like I promised, I will restart to write articles now that the evaluation period is over. </p><p>After seeing <a href=http://www.baptiste-wicht.com/2010/01/jr-introduction/>how to develop using the JR programming language</a>, we'll see now how to use monitors in JR.</p><p>Monitors provide a higher-level abstraction than semaphores and produce a better code with several advantages :</p><ul> <li>All the synchronization code is centralized in one location and the users of this code doesn't need to know how it's implemented.</li> <li>The code doesn't depends on the number of processes, it works for as much process as you want</li> <li>You doesn't need to release something like a mutex, so you cannot forget to do it</li></ul><p>The mutual exclusion is implicit with monitors. Only one process is allowed in the monitor, so all the method are automatically guarded with synchronization code. The synchronization between threads is made using signaling system, with condition variables. A condition variable is a kind of queue of process who are waiting on the same condition. You have several operations available on a condition, the most important is to signal a process waiting to be awaken and to wait on a condition. There are some similitudes between signal/wait operations and P and V of semaphores, but this is a little different. The signal operation does nothing if the queue is empty and the wait operation put always the thread in the waiting queue. The process queue is served in a first come, first served mode. </p><p>Now we'll see how to use them in JR. </p><p>In JR, you doesn't have directly the possibility to create monitors, but there is a preprocessor that transform a file with both JR and monitors operations into a plain JR file. This processor is called <em>m2jr</em> (monitor to JR) and is directly available in the JR distribution. So you only have to use the m2jr command to translate a .m file (conventional monitor extension file) into several JR files (one for the monitor and one for the condition variables). This file is normal JR with several comments to make the debugs easier (corresponding between lines in m and JR).</p><p>All the keywords of the m2jr language start with _ (underscore). To declare a monitor, it's as easily as use the _monitor keyword : </p><div class=code><pre><span class=n>_monitor</span> <span class=n>MonitorTest</span> <span class=o>{</span>
    <span class=c1>//...</span>
<span class=o>}</span>
</pre></div><p>To add methods to the monitor, you just have to create method prefixed with _proc : </p><div class=code><pre><span class=n>_monitor</span> <span class=n>MonitorTest</span> <span class=o>{</span>
    <span class=n>_proc</span> <span class=kt>void</span> <span class=nf>testA</span><span class=o>(){</span>
        <span class=c1>//Some code</span>
    <span class=o>}</span>
<span class=o>}</span>
</pre></div><p>Only with that the mutual exclusion is guaranteed. Only one process is allowed into the monitor. If you want methods with a return type, you must use _return instead of return : </p><div class=code><pre><span class=n>_monitor</span> <span class=n>MonitorTest</span> <span class=o>{</span>
    <span class=n>_proc</span> <span class=kt>void</span> <span class=nf>testA</span><span class=o>(){</span>
        <span class=c1>//Some code</span>
    <span class=o>}</span>

    <span class=n>_proc</span> <span class=kt>int</span> <span class=nf>testB</span><span class=o>(){</span>
        <span class=n>_return</span> <span class=mi>1</span><span class=o>;</span>
    <span class=o>}</span>
<span class=o>}</span>
</pre></div><p>To declare condition variables, the keyword is _condvar. You don't have to initialize them, just declare them : </p><div class=code><pre><span class=n>_monitor</span> <span class=n>MonitorTest</span> <span class=o>{</span>
    <span class=n>_condvar</span> <span class=n>condVar1</span><span class=o>;</span>
    <span class=n>_condvar</span> <span class=n>condVar2</span><span class=o>;</span>
<span class=o>}</span>
</pre></div><p>To use global variables, you must prefix them with _var : </p><div class=code><pre><span class=n>_monitor</span> <span class=n>MonitorTest</span> <span class=o>{</span>
    <span class=n>_var</span> <span class=n>var1</span><span class=o>;</span>
    <span class=n>_var</span> <span class=n>var2</span><span class=o>;</span>
<span class=o>}</span>
</pre></div><p>And to make operations on condition variables, you have to use _signal and _wait methods inside a proc method : </p><div class=code><pre><span class=n>_monitor</span> <span class=n>MonitorTest</span> <span class=o>{</span>
    <span class=n>_condvar</span> <span class=n>a</span><span class=o>;</span>
    <span class=n>_condvar</span> <span class=n>b</span><span class=o>;</span>

    <span class=n>_proc</span> <span class=kt>void</span> <span class=nf>test</span><span class=o>(){</span>
        <span class=n>_wait</span><span class=o>(</span><span class=n>a</span><span class=o>);</span>
        <span class=c1>//Some computations</span>
        <span class=n>_signal</span><span class=o>(</span><span class=n>b</span><span class=o>);</span>
    <span class=o>}</span>
<span class=o>}</span>
</pre></div><p>And you compile that to JR using the simple commmand : </p><p><code>m2jr MonitorTest.m</code></p><p>That will create two files (MonitorTest.jr and c_m_condvar.jr). Of course, you can use this monitor in a normal JR class, you don't have to compile classes who use monitors with m2jr, only with the JR compiler. There is just a single thing to worry about. m2jr generates a constructor that take a String in every monitors class, you when you instantiate the monitor, you have to provide a String representing its name as the first parameter. And if you want to create a new constructor in a monitor, you just have to call super with a String. We'll see an example later. </p><p>Before going further, we must have more informations about the signal operations. When writing monitors, you have the choice between several philosophies for the signaling operation : </p><ul> <li><strong>Signal &amp; Continue</strong> (SC) : The process who signal keep the mutual exclusion and the signaled will be awaken but need to acquire the mutual exclusion before going. </li> <li><strong>Signal &amp; Wait</strong> (SW) : The signaler is blocked and must wait for mutual exclusion to continue and the signaled thread is directly awaken and can start continue its operations. </li> <li><strong>Signal &amp; Urgent Wait</strong> (SU) : Like SW but the signaler thread has the guarantee than it would go just after the signaled thread</li> <li><strong>Signal &amp; Exit</strong> (SX) : The signaler exits from the method directly after the signal and the signaled thread can start directly. This philosophy is not often used. </li></ul><p>By default, m2jr make the compilation with SC, but you can configure it to use other philosophies. Just add the abbreviation of the philosophy (lower case) as an option to the m2jr compiler. By example, to compile using Signal &amp; Exit : </p><p><code>m2jr -sx MonitorTest.m</code></p><p>The main differences, is that the SC create a <em>signal stealers</em> problem. You will quickly understand with an example. With what we know now, we can create a monitor to manage a bounded buffer : </p><div class=code><pre><span class=n>_monitor</span> <span class=n>BoundedBuffer</span> <span class=o>{</span>
    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>N</span> <span class=o>=</span> <span class=mi>5</span><span class=o>;</span> <span class=c1>//Size of the buffer</span>

    <span class=n>_var</span> <span class=n>String</span><span class=o>[]</span> <span class=n>buffer</span> <span class=o>=</span> <span class=k>new</span> <span class=n>String</span><span class=o>[</span><span class=n>N</span><span class=o>];</span>
    <span class=n>_var</span> <span class=kt>int</span> <span class=n>front</span><span class=o>;</span>
    <span class=n>_var</span> <span class=kt>int</span> <span class=n>rear</span><span class=o>;</span>
    <span class=n>_var</span> <span class=kt>int</span> <span class=n>count</span><span class=o>;</span>

    <span class=n>_condvar</span> <span class=n>notFull</span><span class=o>;</span>
    <span class=n>_condvar</span> <span class=n>notEmpty</span><span class=o>;</span>  

    <span class=n>_proc</span> <span class=kt>void</span> <span class=nf>deposit</span><span class=o>(</span><span class=n>String</span> <span class=n>data</span><span class=o>){</span>
        <span class=k>while</span><span class=o>(</span><span class=n>count</span> <span class=o>==</span> <span class=n>N</span><span class=o>){</span>
            <span class=n>_wait</span><span class=o>(</span><span class=n>notFull</span><span class=o>);</span>
        <span class=o>}</span>

        <span class=n>buffer</span><span class=o>[</span><span class=n>rear</span><span class=o>]</span> <span class=o>=</span> <span class=n>data</span><span class=o>;</span>
        <span class=n>rear</span> <span class=o>=</span> <span class=o>(</span><span class=n>rear</span> <span class=o>+</span> <span class=mi>1</span><span class=o>)</span> <span class=o>%</span> <span class=n>N</span><span class=o>;</span>
        <span class=n>count</span><span class=o>++;</span>

        <span class=n>_signal</span><span class=o>(</span><span class=n>notEmpty</span><span class=o>);</span>
    <span class=o>}</span>

    <span class=n>_proc</span> <span class=n>String</span> <span class=nf>fetch</span><span class=o>(){</span>
        <span class=k>while</span><span class=o>(</span><span class=n>count</span> <span class=o>==</span> <span class=mi>0</span><span class=o>){</span>
            <span class=n>_wait</span><span class=o>(</span><span class=n>notEmpty</span><span class=o>);</span>
        <span class=o>}</span>

        <span class=n>String</span> <span class=n>result</span> <span class=o>=</span> <span class=n>buffer</span><span class=o>[</span><span class=n>front</span><span class=o>];</span>
        <span class=n>front</span> <span class=o>=</span> <span class=o>(</span><span class=n>front</span> <span class=o>+</span> <span class=mi>1</span><span class=o>)</span> <span class=o>%</span> <span class=n>N</span><span class=o>;</span>
        <span class=n>count</span><span class=o>--;</span>

        <span class=n>_signal</span><span class=o>(</span><span class=n>notFull</span><span class=o>);</span>

        <span class=n>_return</span> <span class=n>result</span><span class=o>;</span>
     <span class=o>}</span>
<span class=o>}</span>
</pre></div><p>A thing that some of you will certainly find weird is the loop around the wait operation. Is to avoid the signal stealers problem. If there were not while loop, imagine that situation in SC : </p><ol> <li>The thread 1 try to make a fetch(), there is no data, so it wait for the notEmpty condition variable</li> <li>The thread 2 make a deposit(), that awake the thread 1, but it needs to acquire again the mutual exclusion. </li> <li>Before the thread 2 has acquired the mutual exclusion, the thread 3 make a fetch(), there is enough data, so thread 3 make a fetch and get the data. So now, it's empty. </li> <li>The thread 2 acquire the right to go into the monitor and get a data. But wait a minute, there is no data and it will fetch a null data or perhaps an old data still fetched depending on the current state of the buffer </li></ol><p>To avoid that situation, you just have to wrap the wait in a while loop instead of a if and that's done ! Or you can also use SW instead of SC. </p><p>With that monitor, we can easily solve the producer and consumer problem : </p><div class=code><pre><span class=kd>public</span> <span class=kd>class</span> <span class=nc>ProducerConsumer</span> <span class=o>{</span>
    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>N</span> <span class=o>=</span> <span class=mi>12</span><span class=o>;</span> <span class=c1>//Number of producers and consumers</span>

    <span class=kd>private</span> <span class=kd>static</span> <span class=n>BoundedBuffer</span> <span class=n>bb</span> <span class=o>=</span> <span class=k>new</span> <span class=n>BoundedBuffer</span><span class=o>(</span><span class=s>"Bounded Buffer monitor"</span><span class=o>);</span> <span class=c1>//The monitor</span>

    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>...</span> <span class=n>args</span><span class=o>){}</span>

    <span class=kd>private</span> <span class=kd>static</span> <span class=n>process</span> <span class=nf>Producer</span><span class=o>((</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&amp;</span><span class=n>lt</span><span class=o>;</span> <span class=n>N</span><span class=o>;</span> <span class=n>i</span><span class=o>++)){</span>
        <span class=n>bb</span><span class=o>.</span><span class=na>deposit</span><span class=o>(</span><span class=s>"Producer"</span> <span class=o>+</span> <span class=n>i</span><span class=o>);</span>
    <span class=o>}</span>

    <span class=kd>private</span> <span class=kd>static</span> <span class=n>process</span> <span class=nf>Consumer</span><span class=o>((</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&amp;</span><span class=n>lt</span><span class=o>;</span> <span class=n>N</span><span class=o>;</span> <span class=n>i</span><span class=o>++)){</span>
        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>"Consumer"</span> <span class=o>+</span> <span class=n>i</span> <span class=o>+</span> <span class=s>" : "</span> <span class=o>+</span> <span class=n>bb</span><span class=o>.</span><span class=na>fetch</span><span class=o>());</span>
    <span class=o>}</span>
<span class=o>}</span>
</pre></div><p>That will provide output like that : </p><pre>Consumer10 : Producer0
Consumer0 : Producer1
Consumer1 : Producer2
Consumer2 : Producer4
Consumer3 : Producer5
Consumer4 : Producer3
Consumer8 : Producer7
Consumer11 : Producer10
Consumer6 : Producer8
Consumer5 : Producer6
Consumer7 : Producer11
Consumer9 : Producer9</pre><p>So it works well. </p><p>More than signal and wait operations, m2jr provide also others operations on condition variables : </p><ul> <li>_signal_all : Awake all the process of the waiting queue. This operation is only provided in Signal &amp; Continue mode. </li> <li>_empty : Test if the condition variable has any process waiting on it</li> <li>_wait(condvar, int priority) : Enqueue the process with the given priority. If you use that, the queue is now managed as a priority queue. You cannot use both wait without priority and wait with priority on the same condition variable </li> <li>_minrank : Return the min priority on the given condition variable. If the condition variable has no waiters, the returned given number doesn't seem anything. </li></ul><p>With all that stuff, you can create monitors to solve almost all concurrency problems like barber shop, philosopher dinner, kwai cross or a lot of others problem. </p><p>I hope you found that post interesting. The next post about JR will be about operations and capabilities.</p></div> </div> </div> <ul class=pager> <li class=previous> <a href=wordpress-3-0-installed.html rel=prev>← Previous post</a> </li> <li class=next> <a href=jr-operations-and-capabilities.html rel=next>Next post →</a> </li> </ul> <div id=disqus_thread></div> <script>
        var disqus_shortname ="blogwichtounet",
            disqus_url="http://wichtounet.github.io/posts/2010/06/monitor-programming-in-jr.html",
        disqus_title="Monitor programming in JR",
        disqus_identifier="cache/posts/2010/06/monitor-programming-in-jr.html",
        disqus_config = function () {
            this.language = "en";
        };
        (function() {
            var dsq = document.createElement('script'); dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script> <noscript>Please enable JavaScript to view the <a href=http://disqus.com/?ref_noscript rel=nofollow>comments powered by Disqus.</a></noscript> <a href=http://disqus.com class=dsq-brlink rel=nofollow>Comments powered by <span class=logo-disqus>Disqus</span></a> </article> </div> </div> </div></div><footer> Contents © 2014 <a href=mailto:baptistewicht@gmail.com>Baptiste Wicht</a> - Powered by <a href=http://getnikola.com rel=nofollow>Nikola</a><a rel=license href=http://creativecommons.org/licenses/by/4.0/><img alt="Creative Commons License" style=padding-left:5px;border-width:0 src=../../../assets/img/cc.png></a> <ul class=footer_inline_ul> <li> <a href=monitor-programming-in-jr.wp id=sourcelink>Source</a> </li> </ul></footer> <script src=../../../assets/js/all-nocdn.js type=text/javascript></script><script type=text/javascript src=https://apis.google.com/js/platform.js></script></body></html>