<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " lang=en> <head><meta charset=utf-8><meta name=viewport content="width=device-width"><title>How to write correct benchmarks | @Blog("Baptiste Wicht")</title><link href=../../../assets/css/all-nocdn.css rel=stylesheet type=text/css><link rel=alternate type=application/rss+xml title=RSS href=../../../rss.xml><link rel=canonical href=http://baptiste-wicht.com/posts/2010/04/write-corrects-benchmarks.html><script type=text/javascript>
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-2175227-7']);
  _gaq.push(['_trackPageview']);
  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script><meta name=author content="Baptiste Wicht"><meta name=og:title content="How to write correct benchmarks"><meta name=og:url content=http://baptiste-wicht.com/posts/2010/04/write-corrects-benchmarks.html><meta name=og:description content="Several months ago, I wrote an article to compare the performances of short indexes for loops. I wrote that code to achieve my goal :
package com.wicht.old;

public class TestShortInt {
    public sta"><meta name=og:site_name content=@Blog( baptiste wicht><meta name=og:type content=article><link href=../../../favicon.ico rel=icon type=image/x-icon></head><body><div class=social_container> <div class=social_container_gplus> <a target=_blank title="Share on Google+" href="https://plusone.google.com/_/+1/confirm?hl=en&amp;url=http://baptiste-wicht.com/posts/2010/04/write-corrects-benchmarks.html"><img src=../../../assets/img/google_plus.png></a> </div> <div class=social_container_facebook> <a target=_blank title="Share on Facebook" href="http://www.facebook.com/sharer/sharer.php?u=#url"><img src=../../../assets/img/facebook.png></a> </div> <div class=social_container_twitter> <a target=_blank title="Tweet on Twitter" href="http://twitter.com/home?status=#url"><img src=../../../assets/img/twitter.svg></a> </div></div><nav class="navbar navbar-inverse navbar-fixed-top" role=navigation> <div class=container-fluid> <div class=navbar-header> <button type=button class=navbar-toggle data-toggle=collapse data-target=.navbar-ex1-collapse> <span class=sr-only>Toggle navigation</span> <span class=icon-bar></span> <span class=icon-bar></span> <span class=icon-bar></span> </button> <a class=navbar-brand href=http://baptiste-wicht.com/> <span id=blog-title>@Blog("Baptiste Wicht")</span> </a> </div> <div class="collapse navbar-collapse navbar-ex1-collapse"> <ul class="nav navbar-nav"> <li><a href=../../../stories/about.html>About</a> </li><li><a href=../../../stories/publications.html>Publications</a> </li><li><a href=../../../stories/donate.html>Donate</a> </li><li><a href=../../../stories/contact.html>Contact</a> </li><li><a href=../../../stories/faq.html>FAQ</a> </li><li><a href=../../../stories/legal.html>Legal</a> </li><li><a href=../../../categories/index.html>Tags</a> </li><li><a href=../../../archive.html>Archives</a> </li><li><a href=http://feeds.feedburner.com/BaptisteWicht>RSS</a> </li></ul> <span class="navbar-form pull-left"> <form action=../../../stories/search.html> <input type=text name=q id=tipue_search_input> </form> </span> <ul class="nav navbar-nav navbar-right"> <li> <a target=_blank title="Follow @wichtounet on Twitter" href=https://twitter.com/wichtounet> <img src=../../../assets/img/twitter.svg alt="Follow @wichtounet on Twitter"> </a> </li> <li> <a target=_blank title="Follow +BaptisteWicht on Google+" href=https://plus.google.com/+BaptisteWicht> <img src=../../../assets/img/google_plus.svg alt="Follow +BaptisteWicht on Google+"> </a> </li> </ul> </div> </div></nav><div class=body-container> <div class=left-sidebar> <div class=left-sidebar-widget> <div class=left-sidebar-widget-content> <div class=g-person data-width=275 data-href=//plus.google.com/u/0/103113673902796202116 data-theme=dark data-layout=landscape data-rel=author></div> </div> </div> <div class=left-sidebar-widget> <h3>Related posts</h3> <div class=left-sidebar-widget-content> <ol><li><a href=../09/my-java-benchmarks-on-github.html>My Java Benchmarks on GitHub</a></li><li><a href=../08/java-file-copy-benchmarks-update.html>Java File Copy Benchmarks Update</a></li><li><a href=../01/dont-use-shorts-in-loop.html>Tip : Don’t use shorts for loop indexes !</a></li><li><a href=../08/generate-graphs-benchmarks-easily.html>Generate graphs benchmarks easily</a></li><li><a href=../08/file-copy-benchmark-updates-once-again.html>Java File Copy Benchmark Updates (once again)</a></li></ol> </div> </div> <div class=left-sidebar-widget> <h3>Recent comments</h3> <div class=left-sidebar-widget-content> <div id=recentcomments class=dsq-widget> <script type=text/javascript src="http://blogwichtounet.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=0&amp;avatar_size=28&amp;excerpt_length=50"></script> </div> </div> </div> <div class=left-sidebar-widget> <h3>Blogroll</h3> <div class=left-sidebar-widget-content> <ul> <li><a target=_blank href=http://www.asjava.com/>AsJava.com : Java Tutorial</a></li> <li><a target=_blank href=http://www.mkyong.com/>Mkyong : Java Tutorials</a></li> </ul> </div> </div> </div> <div class=container> <div class=body-content> <div class=row><article class="post-text h-entry hentry postpage" itemscope=itemscope itemtype=http://schema.org/Article> <header> <h1 class="p-name entry-title" itemprop="headline name"><a href=# class=u-url>How to write correct benchmarks</a></h1> <div class=metadata> <p class="byline author vcard"><span class="byline-name fn">Baptiste Wicht</span></p> <p class=dateline><a href=# rel=bookmark><time class="published dt-published" datetime=2010-04-26T06:49:45+02:00 itemprop=datePublished title="Publication date">2010-04-26 06:49</time></a></p> <p class=commentline> <a href=write-corrects-benchmarks.html#disqus_thread data-disqus-identifier=cache/posts/2010/04/write-corrects-benchmarks.html>Comments</a> </p><p class=sourceline><a href=write-corrects-benchmarks.wp id=sourcelink>Source</a></p> </div> </header> <div class="e-content entry-content" itemprop="articleBody text"> <p>Several months ago, I wrote an article to <a href=http://www.baptiste-wicht.com/2010/01/dont-use-shorts-in-loop/>compare the performances of short indexes for loops</a>. I wrote that code to achieve my goal :</p><pre class="code literal-block"><span class=kn>package</span> <span class=n>com</span><span class=o>.</span><span class=na>wicht</span><span class=o>.</span><span class=na>old</span><span class=o>;</span>

<span class=kd>public</span> <span class=kd>class</span> <span class=nc>TestShortInt</span> <span class=o>{</span>
    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>){</span>
        <span class=kt>long</span> <span class=n>startTime</span> <span class=o>=</span> <span class=n>System</span><span class=o>.</span><span class=na>nanoTime</span><span class=o>();</span>

        <span class=kt>int</span> <span class=n>resultInt</span> <span class=o>=</span> <span class=mi>0</span><span class=o>;</span>

        <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&amp;</span><span class=n>amp</span><span class=o>;</span><span class=n>lt</span><span class=o>;</span> <span class=mi>100000</span><span class=o>;</span> <span class=n>i</span><span class=o>++){</span>
            <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>j</span> <span class=o>=</span> <span class=mi>0</span><span class=o>;</span> <span class=n>j</span> <span class=o>&amp;</span><span class=n>amp</span><span class=o>;</span><span class=n>lt</span><span class=o>;</span> <span class=mi>32760</span><span class=o>;</span> <span class=n>j</span><span class=o>++){</span>
                <span class=n>resultInt</span> <span class=o>+=</span> <span class=n>i</span> <span class=o>*</span> <span class=n>j</span><span class=o>;</span>
            <span class=o>}</span>
        <span class=o>}</span>

        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>"Temp pour int : "</span> <span class=o>+</span> <span class=o>(</span><span class=n>System</span><span class=o>.</span><span class=na>nanoTime</span><span class=o>()</span> <span class=o>-</span> <span class=n>startTime</span><span class=o>)</span> <span class=o>/</span> <span class=mi>1000000</span> <span class=o>+</span> <span class=s>" ms"</span><span class=o>);</span>

        <span class=n>startTime</span> <span class=o>=</span> <span class=n>System</span><span class=o>.</span><span class=na>nanoTime</span><span class=o>();</span>

        <span class=kt>int</span> <span class=n>resultShort</span> <span class=o>=</span> <span class=mi>0</span><span class=o>;</span>

        <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>k</span> <span class=o>=</span> <span class=mi>0</span><span class=o>;</span> <span class=n>k</span> <span class=o>&amp;</span><span class=n>amp</span><span class=o>;</span><span class=n>lt</span><span class=o>;</span> <span class=mi>100000</span><span class=o>;</span> <span class=n>k</span><span class=o>++){</span>
            <span class=k>for</span> <span class=o>(</span><span class=kt>short</span> <span class=n>f</span> <span class=o>=</span> <span class=mi>0</span><span class=o>;</span> <span class=n>f</span> <span class=o>&amp;</span><span class=n>amp</span><span class=o>;</span><span class=n>lt</span><span class=o>;</span> <span class=mi>32760</span><span class=o>;</span> <span class=n>f</span><span class=o>++){</span>
                <span class=n>resultShort</span> <span class=o>+=</span> <span class=n>k</span> <span class=o>*</span> <span class=n>f</span><span class=o>;</span>
            <span class=o>}</span>
        <span class=o>}</span>

        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>"Temp pour short : "</span> <span class=o>+</span> <span class=o>(</span><span class=n>System</span><span class=o>.</span><span class=na>nanoTime</span><span class=o>()</span> <span class=o>-</span> <span class=n>startTime</span><span class=o>)</span> <span class=o>/</span> <span class=mi>1000000</span> <span class=o>+</span> <span class=s>" ms"</span><span class=o>);</span>

        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>resultInt</span><span class=o>);</span>
        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>resultShort</span><span class=o>);</span>
    <span class=o>}</span>
<span class=o>}</span>
</pre><p>And i found as a result that short was two times slower than int and I was convinced of these results until a week ago.</p><p>At this time, a reader (Jean) criticized the results of my tests and gave me links to several articles about <strong>micro-benchmarking</strong>. I've read these articles and understand why my results were incorrect.</p><p>In fact, my test doesn't pay attention to several things that can change results of tests :</p><ul> <li><strong>JVM warmup</strong> : Due to several parameters, the code is first often slow and becomes faster and faster when the execution time grows until it goes to steady-state.</li> <li><strong>Class loading</strong> : The first time you launch a benchmark, all the used classes must be loaded, increasing the execution time.</li> <li><strong>Just In Time Compiler</strong> : When the JVM identify a hot part of the code</li> <li><strong>Garbage Collector</strong> : A garbage collection can happen during the benchmark and with that the time can increase a lot.</li></ul><p>Due to all these factors, the first runs (perhaps 10 seconds of run) are slower than the other and than can make your benchmarks completely false.</p><p>So, how can we do to have good benchmarks results ?</p><p>It's really difficult, but we can have help using a benchmark framework introduced by Brent Boyer, a software developer from Elliptic Group. This framework take care of all the previously introduced factors and made good benchmarks.</p><p>The use of this framework is really simple, you just have to create a new instance of the Benchmark class passing to it a Callable or a Runnable and the test is directly launched. Here is the example with the test of short and int in loop indexes :</p><pre class="code literal-block"><span class=kd>public</span> <span class=kd>class</span> <span class=nc>ShortIndexesLoop</span> <span class=o>{</span>
    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
        <span class=n>Callable</span> <span class=n>callableInt</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Callable</span><span class=o>(){</span>
            <span class=kd>public</span> <span class=n>Long</span> <span class=nf>call</span><span class=o>()</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
                <span class=kt>long</span> <span class=n>result</span> <span class=o>=</span> <span class=mi>0</span><span class=o>;</span>

                <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>f</span> <span class=o>=</span> <span class=mi>0</span><span class=o>;</span> <span class=n>f</span> <span class=o>&amp;</span><span class=n>amp</span><span class=o>;</span><span class=n>lt</span><span class=o>;</span> <span class=mi>32760</span><span class=o>;</span> <span class=n>f</span><span class=o>++){</span>
                      <span class=n>result</span> <span class=o>+=</span> <span class=mi>444</span><span class=o>;</span>
                  <span class=o>}</span>

                <span class=k>return</span> <span class=n>result</span><span class=o>;</span>
            <span class=o>}</span>
        <span class=o>};</span>

        <span class=n>Callable</span> <span class=n>callableShort</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Callable</span><span class=o>(){</span>
            <span class=kd>public</span> <span class=n>Long</span> <span class=nf>call</span><span class=o>()</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
                <span class=kt>long</span> <span class=n>result</span> <span class=o>=</span> <span class=mi>0</span><span class=o>;</span>

                <span class=k>for</span> <span class=o>(</span><span class=kt>short</span> <span class=n>f</span> <span class=o>=</span> <span class=mi>0</span><span class=o>;</span> <span class=n>f</span> <span class=o>&amp;</span><span class=n>amp</span><span class=o>;</span><span class=n>lt</span><span class=o>;</span> <span class=mi>32760</span><span class=o>;</span> <span class=n>f</span><span class=o>++){</span>
                      <span class=n>result</span> <span class=o>+=</span> <span class=mi>444</span><span class=o>;</span>
                  <span class=o>}</span>

                <span class=k>return</span> <span class=n>result</span><span class=o>;</span>
            <span class=o>}</span>
        <span class=o>};</span>

        <span class=k>try</span> <span class=o>{</span>
            <span class=n>Benchmark</span> <span class=n>intBenchmark</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Benchmark</span><span class=o>(</span><span class=n>callableInt</span><span class=o>);</span>

            <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>"Result with int "</span><span class=o>);</span>
            <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>intBenchmark</span><span class=o>.</span><span class=na>toString</span><span class=o>());</span>

            <span class=n>Benchmark</span> <span class=n>shortBenchmark</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Benchmark</span><span class=o>(</span><span class=n>callableShort</span><span class=o>);</span>

            <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>"Result short "</span><span class=o>);</span>
            <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>shortBenchmark</span><span class=o>.</span><span class=na>toString</span><span class=o>());</span>
        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Exception</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
            <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
        <span class=o>}</span>
    <span class=o>}</span>
<span class=o>}</span>
</pre><p>To get the results, you can use Benchmark.toString() or Benchmark.toStringFull() for more statistics. You can also directly access some stats like standard deviation using Benchmark.getSd() or directly with Benchmark.getStats() to get all the stats.</p><p>Here is the result with the preceding code :</p><pre>Result int
first = 807.056 us, mean = 46.032 us (CI deltas: -261.393 ns, +408.932 ns), sd = 230.929 us (CI deltas: -68.201 us, +105.262 us)
Result short
first = 721.912 us, mean = 48.234 us (CI deltas: -198.625 ns, +254.774 ns), sd = 160.196 us (CI deltas: -32.764 us, +37.882 us)</pre><p>As you can see, the short version is only 104.78% slower than the int. That show that the first results were completely false.</p><p>Here is the full results of the int version :</p><pre>action statistics: first = 807.056 us, mean = 46.032 us (CI deltas: -261.393 ns, +408.932 ns), sd = 230.929 us (CI deltas: -68.201 us, +105.262 us) WARNING: EXECUTION TIMES HAVE EXTREME OUTLIERS, SD VALUES MAY BE INACCURATE
    ----------
    --the action statistics were calculated from block statistics
    --each block measured 32768 task executions
    --the user says that task internally performs m = 1 actions
    --then the number of actions per block measurement is a = 32768
    --block statistics: mean = 1.508 s (CI deltas: -8.565 ms, +13.400 ms), sd = 41.803 ms (CI deltas: -12.346 ms, +19.054 ms)
    --the forumla used to convert block statistics to action statistics (mean scales as 1/a, sd scales as 1/sqrt(a)) assumes that the action execution times are iid
    ----------
    --each confidence interval (CI) is reported as either +- deltas from the point estimate, or as a closed interval ([x, y])
    --each confidence interval has confidence level = 0.95
    ----------
    --EXECUTION TIMES APPEAR TO HAVE OUTLIERS
    --this was determined using the boxplot algorithm with median = 1.498 s, interquantileRange = 34.127 ms
    --3 are EXTREME (on the high side): #57 = 1.621 s, #58 = 1.647 s, #59 = 1.688 s
    --2 are mild (on the high side): #55 = 1.570 s, #56 = 1.582 s
    ----------
    --block sd values MAY NOT REFLECT TASK'S INTRINSIC VARIATION
    --guesstimate: environmental noise explains at least 55.89418621876822% of the measured sd
    ----------
    --action sd values ALMOST CERTAINLY GROSSLY INFLATED by outliers
    --they cause at least 98.95646276911543% of the measured VARIANCE according to a equi-valued outlier model
    --model quantities: a = 32768.0, muB = 1.5083895562166663, sigmaB = 0.04180264914581472, muA = 4.603239612477619E-5, sigmaA = 2.3092919283255957E-4, tMin = 0.0, muGMin = 2.3016198062388096E-5, sigmaG = 5.754049515597024E-6, cMax1 = 1252, cMax2 = 322, cMax = 322, cOutMin = 322, varOutMin = 0.0017292260645147487, muG(cOutMin) = 2.3034259031465023E-5, U(cOutMin) = 0.002363416110812895</pre><p>Like you can perhaps see when you use this framework, it gives you some warnings when by example you have extreme outliers that can make the standard deviation completely false.</p><p>You can download this framework on <a href=http://www.ellipticgroup.com/html/benchmarkingArticle.html>the web page of the Elliptic Group</a>. I found it really powerful and easy to use and I'll use it everytime I have to do a benchmark.</p><p>To conclude, I must also say that even if you use that kind of framework, you can make very bad benchmarks if you don't test the right part of the code. Here are two really interesting articles from Brent Boyer :</p><ul> <li><a href=http://www.ibm.com/developerworks/java/library/j-benchmark1.html target=_blank>Robust Java benchmarking, Part 1: Issues</a></li> <li><a href=http://www.ibm.com/developerworks/java/library/j-benchmark2/index.html target=_blank>Robust Java benchmarking, Part 2: Statistics and solutions</a></li></ul> </div> <aside class=postpromonav> <nav> <ul itemprop=keywords class=tags> <li><a class="tag p-category" href=../../../categories/benchmarks.html rel=tag>Benchmarks</a></li> <li><a class="tag p-category" href=../../../categories/java.html rel=tag>Java</a></li> <li><a class="tag p-category" href=../../../categories/libraries.html rel=tag>Libraries</a></li> <li><a class="tag p-category" href=../../../categories/performances.html rel=tag>Performances</a></li> <li><a class="tag p-category" href=../../../categories/tools.html rel=tag>Tools</a></li> </ul> <ul class=pager> <li class=previous> <a href=maven-3-0-beta-1-is-here.html rel=prev title="Maven 3.0 Beta 1 is here !">Previous post</a> </li> <li class=next> <a href=closest-pair-of-point-plane-sweep-algorithm.html rel=next title="Find closest pair of point with Plane Sweep Algorithm in O(n ln n)">Next post</a> </li> </ul> </nav> </aside> <section class=comments> <h2>Comments</h2> <div id=disqus_thread></div> <script>
        var disqus_shortname ="blogwichtounet",
            disqus_url="http://baptiste-wicht.com/posts/2010/04/write-corrects-benchmarks.html",
        disqus_title="How to write correct benchmarks",
        disqus_identifier="cache/posts/2010/04/write-corrects-benchmarks.html",
        disqus_config = function () {
            this.language = "en";
        };
        (function() {
            var dsq = document.createElement('script'); dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script> <noscript>Please enable JavaScript to view the <a href=//disqus.com/?ref_noscript rel=nofollow>comments powered by Disqus.</a></noscript> <a href=//disqus.com class=dsq-brlink rel=nofollow>Comments powered by <span class=logo-disqus>Disqus</span></a> </section></article> <script>var disqus_shortname="blogwichtounet";(function(){var a=document.createElement("script");a.async=true;a.src="//"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script> </div> </div> </div></div><footer> Contents © 2014 <a href=mailto:baptistewicht@gmail.com>Baptiste Wicht</a> - Powered by <a href=http://getnikola.com rel=nofollow>Nikola</a><a rel=license href=http://creativecommons.org/licenses/by/4.0/><img alt="Creative Commons License" style=padding-left:5px;border-width:0 src=../../../assets/img/cc.png></a> <ul class=footer_inline_ul> <li> <a href=write-corrects-benchmarks.wp id=sourcelink>Source</a> </li> </ul></footer> <script src=../../../assets/js/all-nocdn.js></script><script type=text/javascript src=https://apis.google.com/js/platform.js></script></body></html>