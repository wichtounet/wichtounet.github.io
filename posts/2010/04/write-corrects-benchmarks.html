<!DOCTYPE html><html lang="en">
<head>
    <link href="favicon.ico" rel="icon" type="image/x-icon">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="author" content="Baptiste Wicht">
    <title>How to write correct benchmarks | @Blog("Baptiste Wicht")</title>
    
            <link href="../../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
      <link rel="canonical" href="http://wichtounet.github.io/posts/2010/04/write-corrects-benchmarks.html">
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js" type="text/javascript"></script>
    <![endif]-->
            <link rel="alternate" type="application/rss+xml" title="RSS" href="../../../rss.xml">

    





<!--
    <link rel="stylesheet" type="text/css" href="/assets/css/tipuesearch.css">
-->
    
</head>
<body>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container-fluid"><!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="http://wichtounet.github.io/">@Blog("Baptiste Wicht")</a>
        </div><!-- /.navbar-header -->
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                
                <li><a href="../../../stories/about.html">About</a>
                </li><li><a href="../../../stories/publications.html">Publications</a>
                </li><li><a href="../../../stories/donate.html">Donate</a>
                </li><li><a href="../../../stories/contact.html">Contact</a>
                </li><li><a href="../../../stories/faq.html">FAQ</a>
                </li><li><a href="../../../stories/legal.html">Legal</a>
                </li><li><a href="../../../archive.html">Archives</a>
                </li><li><a href="../../../categories/index.html">Tags</a>
                </li><li><a href="../../../rss.xml">RSS</a>

            </li></ul>
            <!--
            <span class="navbar-form pull-left">
                <input type="text" id="tipue_search_input">
            </span>
            -->
            <ul class="nav navbar-nav navbar-right">
                
                
            </ul>
        </div><!-- /.navbar-collapse -->
    </div><!-- /.container-fluid -->
</nav>

<!-- End of Menubar -->

<div class="body-container">

    <!-- Sidebar -->

    <div class="left-sidebar">
            <div class="left-sidebar-widget">
                <div class="left-sidebar-widget-content">
                    <div class="g-person" data-width="275" data-href="//plus.google.com/u/0/103113673902796202116" data-theme="dark" data-layout="landscape" data-rel="author"></div>
                </div>
            </div>
        
        <div class="left-sidebar-widget">
            <h3>Recent comments</h3>
            <div class="left-sidebar-widget-content">
                <div id="recentcomments" class="dsq-widget">
                    <script type="text/javascript" src="http://blogwichtounet.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=0&amp;avatar_size=28&amp;excerpt_length=150"></script>
                </div>
            </div>
        </div>
        
        <div class="left-sidebar-widget">
            <h3>Blogroll</h3>
            <div class="left-sidebar-widget-content">
                <ul>
                    <li><a target="_blank" href="http://www.asjava.com/">AsJava.com : Java Tutorial</a></li>
                    <li><a target="_blank" href="http://www.mkyong.com/">Mkyong : Java Tutorials</a></li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Content -->

    <div class="container">
            <div class="body-content" style="margin-top: -75px;">

            <!-- <div id="tipue_search_content" style="margin-left: auto; margin-right: auto; padding: 20px;"></div> -->

            <div class="row">
                
    <article class="postbox post-text">
    <div class="h-entry" itemscope="itemscope" itemtype="http://schema.org/Article">
    
    <h1 class="p-name" itemprop="headline name">How to write correct benchmarks</h1>

    <hr>
    <small>
        Posted: <time class="published dt-published" datetime="2010-04-26T06:49:45+00:00" itemprop="datePublished">2010-04-26 06:49</time>
        

        
          |  
        More posts about 
    <span itemprop="keywords">
        <a class="tag p-category" href="../../../categories/benchmarks.html"><span class="badge badge-info">Benchmarks</span></a>
        <a class="tag p-category" href="../../../categories/java.html"><span class="badge badge-info">Java</span></a>
        <a class="tag p-category" href="../../../categories/java.html"><span class="badge badge-info">Java</span></a>
        <a class="tag p-category" href="../../../categories/libraries.html"><span class="badge badge-info">Libraries</span></a>
        <a class="tag p-category" href="../../../categories/performances.html"><span class="badge badge-info">Performances</span></a>
        <a class="tag p-category" href="../../../categories/tools.html"><span class="badge badge-info">Tools</span></a>
    </span>


    </small>
    <hr>
    <div class="e-content" itemprop="articleBody text">
    <div><p></p><p>Several months ago, I wrote an article to <a href="http://www.baptiste-wicht.com/2010/01/dont-use-shorts-in-loop/">compare the performances of short indexes for loops</a>. I wrote that code to achieve my goal :
[java]package com.wicht.old;</p>
<p>public class TestShortInt {
    public static void main(String[] args){
        long startTime = System.nanoTime();</p>
<div class="code"><pre>    <span class="kt">int</span> <span class="n">resultInt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="n">lt</span><span class="p">;</span> <span class="mi">100000</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="n">lt</span><span class="p">;</span> <span class="mi">32760</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">){</span>
            <span class="n">resultInt</span> <span class="o">+=</span> <span class="n">i</span> <span class="o">*</span> <span class="n">j</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">System</span><span class="p">.</span><span class="n">out</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">"Temp pour int : "</span> <span class="o">+</span> <span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="n">nanoTime</span><span class="p">()</span> <span class="o">-</span> <span class="n">startTime</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000000</span> <span class="o">+</span> <span class="s">" ms"</span><span class="p">);</span>

    <span class="n">startTime</span> <span class="o">=</span> <span class="n">System</span><span class="p">.</span><span class="n">nanoTime</span><span class="p">();</span>

    <span class="kt">int</span> <span class="n">resultShort</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="n">lt</span><span class="p">;</span> <span class="mi">100000</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">){</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">short</span> <span class="n">f</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">f</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="n">lt</span><span class="p">;</span> <span class="mi">32760</span><span class="p">;</span> <span class="n">f</span><span class="o">++</span><span class="p">){</span>
            <span class="n">resultShort</span> <span class="o">+=</span> <span class="n">k</span> <span class="o">*</span> <span class="n">f</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">System</span><span class="p">.</span><span class="n">out</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">"Temp pour short : "</span> <span class="o">+</span> <span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="n">nanoTime</span><span class="p">()</span> <span class="o">-</span> <span class="n">startTime</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000000</span> <span class="o">+</span> <span class="s">" ms"</span><span class="p">);</span>

    <span class="n">System</span><span class="p">.</span><span class="n">out</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">resultInt</span><span class="p">);</span>
    <span class="n">System</span><span class="p">.</span><span class="n">out</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">resultShort</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>


<p>}[/java]</p>
<p>And i found as a result that short was two times slower than int and I was convinced of these results until a week ago.</p>
<p>At this time, a reader (Jean) criticized the results of my tests and gave me links to several articles about <strong>micro-benchmarking</strong>. I've read these articles and understand why my results were incorrect.</p>
<p>In fact, my test doesn't pay attention to several things that can change results of tests :</p>
<p></p><ul>
    <li><strong>JVM warmup</strong> : Due to several parameters, the code is first often slow and becomes faster and faster when the execution time grows until it goes to steady-state.</li>
    <li><strong>Class loading</strong> : The first time you launch a benchmark, all the used classes must be loaded, increasing the execution time.</li>
    <li><strong>Just In Time Compiler</strong> : When the JVM identify a hot part of the code</li>
    <li><strong>Garbage Collector</strong> : A garbage collection can happen during the benchmark and with that the time can increase a lot.</li>
</ul>
<p>Due to all these factors, the first runs (perhaps 10 seconds of run) are slower than the other and than can make your benchmarks completely false.</p>
<p>So, how can we do to have good benchmarks results ?</p>
<p>It's really difficult, but we can have help using a benchmark framework introduced by Brent Boyer, a software developer from Elliptic Group. This framework take care of all the previously introduced factors and made good benchmarks.</p>
<p>The use of this framework is really simple, you just have to create a new instance of the Benchmark class passing to it a Callable or a Runnable and the test is directly launched. Here is the example with the test of short and int in loop indexes :</p>
<p>[java]public class ShortIndexesLoop {
    public static void main(String[] args) {
        Callable callableInt = new Callable(){
            public Long call() throws Exception {
                long result = 0;</p>
<div class="code"><pre>            <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">f</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">f</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="n">lt</span><span class="p">;</span> <span class="mi">32760</span><span class="p">;</span> <span class="n">f</span><span class="o">++</span><span class="p">){</span>
                  <span class="n">result</span> <span class="o">+=</span> <span class="mi">444</span><span class="p">;</span>
              <span class="p">}</span>

            <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">};</span>

    <span class="n">Callable</span> <span class="n">callableShort</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Callable</span><span class="p">(){</span>
        <span class="n">public</span> <span class="n">Long</span> <span class="n">call</span><span class="p">()</span> <span class="n">throws</span> <span class="n">Exception</span> <span class="p">{</span>
            <span class="kt">long</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

            <span class="k">for</span> <span class="p">(</span><span class="kt">short</span> <span class="n">f</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">f</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="n">lt</span><span class="p">;</span> <span class="mi">32760</span><span class="p">;</span> <span class="n">f</span><span class="o">++</span><span class="p">){</span>
                  <span class="n">result</span> <span class="o">+=</span> <span class="mi">444</span><span class="p">;</span>
              <span class="p">}</span>

            <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">};</span>

    <span class="n">try</span> <span class="p">{</span>
        <span class="n">Benchmark</span> <span class="n">intBenchmark</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Benchmark</span><span class="p">(</span><span class="n">callableInt</span><span class="p">);</span>

        <span class="n">System</span><span class="p">.</span><span class="n">out</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">"Result with int "</span><span class="p">);</span>
        <span class="n">System</span><span class="p">.</span><span class="n">out</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">intBenchmark</span><span class="p">.</span><span class="n">toString</span><span class="p">());</span>

        <span class="n">Benchmark</span> <span class="n">shortBenchmark</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Benchmark</span><span class="p">(</span><span class="n">callableShort</span><span class="p">);</span>

        <span class="n">System</span><span class="p">.</span><span class="n">out</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">"Result short "</span><span class="p">);</span>
        <span class="n">System</span><span class="p">.</span><span class="n">out</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">shortBenchmark</span><span class="p">.</span><span class="n">toString</span><span class="p">());</span>
    <span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">e</span><span class="p">.</span><span class="n">printStackTrace</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>}[/java]</p>
<p>To get the results, you can use Benchmark.toString() or Benchmark.toStringFull() for more statistics. You can also directly access some stats like standard deviation using Benchmark.getSd() or directly with Benchmark.getStats() to get all the stats.</p>
<p>Here is the result with the preceding code :</p>
<pre>Result int

first = 807.056 us, mean = 46.032 us (CI deltas: -261.393 ns, +408.932 ns), sd = 230.929 us (CI deltas: -68.201 us, +105.262 us)

Result short

first = 721.912 us, mean = 48.234 us (CI deltas: -198.625 ns, +254.774 ns), sd = 160.196 us (CI deltas: -32.764 us, +37.882 us)</pre>

<p>As you can see, the short version is only 104.78% slower than the int. That show that the first results were completely false.</p>
<p>Here is the full results of the int version :</p>
<pre>action statistics: first = 807.056 us, mean = 46.032 us (CI deltas: -261.393 ns, +408.932 ns), sd = 230.929 us (CI deltas: -68.201 us, +105.262 us) WARNING: EXECUTION TIMES HAVE EXTREME OUTLIERS, SD VALUES MAY BE INACCURATE
    ----------
    --the action statistics were calculated from block statistics
    --each block measured 32768 task executions
    --the user says that task internally performs m = 1 actions
    --then the number of actions per block measurement is a = 32768
    --block statistics: mean = 1.508 s (CI deltas: -8.565 ms, +13.400 ms), sd = 41.803 ms (CI deltas: -12.346 ms, +19.054 ms)
    --the forumla used to convert block statistics to action statistics (mean scales as 1/a, sd scales as 1/sqrt(a)) assumes that the action execution times are iid
    ----------
    --each confidence interval (CI) is reported as either +- deltas from the point estimate, or as a closed interval ([x, y])
    --each confidence interval has confidence level = 0.95
    ----------
    --EXECUTION TIMES APPEAR TO HAVE OUTLIERS
    --this was determined using the boxplot algorithm with median = 1.498 s, interquantileRange = 34.127 ms
    --3 are EXTREME (on the high side): #57 = 1.621 s, #58 = 1.647 s, #59 = 1.688 s
    --2 are mild (on the high side): #55 = 1.570 s, #56 = 1.582 s
    ----------
    --block sd values MAY NOT REFLECT TASK'S INTRINSIC VARIATION
    --guesstimate: environmental noise explains at least 55.89418621876822% of the measured sd
    ----------
    --action sd values ALMOST CERTAINLY GROSSLY INFLATED by outliers
    --they cause at least 98.95646276911543% of the measured VARIANCE according to a equi-valued outlier model
    --model quantities: a = 32768.0, muB = 1.5083895562166663, sigmaB = 0.04180264914581472, muA = 4.603239612477619E-5, sigmaA = 2.3092919283255957E-4, tMin = 0.0, muGMin = 2.3016198062388096E-5, sigmaG = 5.754049515597024E-6, cMax1 = 1252, cMax2 = 322, cMax = 322, cOutMin = 322, varOutMin = 0.0017292260645147487, muG(cOutMin) = 2.3034259031465023E-5, U(cOutMin) = 0.002363416110812895</pre>

<p>Like you can perhaps see when you use this framework, it gives you some warnings when by example you have extreme outliers that can make the standard deviation completely false.</p>
<p>You can download this framework on <a href="http://www.ellipticgroup.com/html/benchmarkingArticle.html">the web page of the Elliptic Group</a>. I found it really powerful and easy to use and I'll use it everytime I have to do a benchmark.</p>
<p>To conclude, I must also say that even if you use that kind of framework, you can make very bad benchmarks if you don't test the right part of the code. Here are two really interesting articles from Brent Boyer :</p>
<ul>
    <li><a href="http://www.ibm.com/developerworks/java/library/j-benchmark1.html" target="_blank">Robust Java benchmarking, Part 1: Issues</a></li>
    <li><a href="http://www.ibm.com/developerworks/java/library/j-benchmark2/index.html" target="_blank">Robust Java benchmarking, Part 2: Statistics and solutions</a></li>
</ul>

<p></p></div>
    </div>
    </div>
    
        <ul class="pager">
            <li class="previous">
                <a href="maven-3-0-beta-1-is-here.html" rel="prev">← Previous post</a>
            </li>
            <li class="next">
                <a href="closest-pair-of-point-plane-sweep-algorithm.html" rel="next">Next post →</a>
            </li>
        </ul>

        
        
        <div id="disqus_thread"></div>
        <script>
        var disqus_shortname ="blogwichtounet",
            disqus_url="http://wichtounet.github.io/posts/2010/04/write-corrects-benchmarks.html",
        disqus_title="How to write correct benchmarks",
        disqus_identifier="cache/posts/2010/04/write-corrects-benchmarks.html",
        disqus_config = function () {
            this.language = "en";
        };
        (function() {
            var dsq = document.createElement('script'); dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink" rel="nofollow">Comments powered by <span class="logo-disqus">Disqus</span></a>


    

    </article>

            </div>
        </div>
    </div>
</div>

<!-- Footer -->

<footer>
    Contents © 2014         <a href="mailto:baptistewicht@gmail.com">Baptiste Wicht</a> - Powered by         <a href="http://getnikola.com" rel="nofollow">Nikola</a>         
<a rel="license" href="http://creativecommons.org/licenses/by/4.0/"><img alt="Creative Commons License" style="border-width:0" src="http://i.creativecommons.org/l/by/4.0/88x31.png"></a>
        <ul class="footer_inline_ul">
            
    <li>
    <a href="write-corrects-benchmarks.wp" id="sourcelink">Source</a>
    </li>

        </ul>
</footer>


            <script src="../../../assets/js/all-nocdn.js" type="text/javascript"></script>


    
<script type="text/javascript" src="https://apis.google.com/js/platform.js"></script>


    
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5327566b264df4ee"></script>
<script type="text/javascript">
  addthis.layers({
    'theme' : 'dark',
    'share' : {
      'position' : 'right',
      //'services' : 'google_plusone,facebook_like,tweet',
      'services' : 'google_plusone_share,facebook,twitter'
    }, 
    'follow' : {
      'services' : [
        {'service': 'twitter', 'id': 'wichtounet'},
        {'service': 'google_follow', 'id': '+BaptisteWicht'}
      ]
    }   
  });
</script>



<!-- Search -->

<!--
    <script type="text/javascript" src="/assets/js/tipuesearch_set.js"></script>
    <script type="text/javascript" src="/assets/js/tipuesearch.js"></script>
    <script type="text/javascript">
        $(document).ready(function() {
            $('#tipue_search_input').tipuesearch({
            'mode': 'json',
            'contentLocation': '/assets/js/tipuesearch_content.json',
            'showUrl': false
            });
            });
    </script>
-->

<script type="text/javascript">jQuery("a.image-reference").colorbox({rel:"gal",maxWidth:"100%",maxHeight:"100%",scalePhotos:true});</script>






</body>
</html>