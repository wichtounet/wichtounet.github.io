<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Java 7 : More concurrency | Blog blog("Baptiste Wicht");</title>
<link href="../../../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" hreflang="en" href="../../../../rss.xml">
<link rel="canonical" href="https://baptiste-wicht.com/posts/2010/04/java-7-more-concurrency/">
<!--[if lt IE 9]><script src="../../../../assets/js/html5.js"></script><![endif]--><meta name="author" content="Baptiste Wicht">
<link rel="prev" href="../links-of-the-week-2/" title="Links of the Week" type="text/html">
<link rel="next" href="../substance-6-0-is-out/" title="Substance 6.0 is out" type="text/html">
<meta property="og:site_name" content='Blog blog("Baptiste Wicht");'>
<meta property="og:title" content="Java 7 : More concurrency">
<meta property="og:url" content="https://baptiste-wicht.com/posts/2010/04/java-7-more-concurrency/">
<meta property="og:description" content="With Java 7 (Dolphin), we'll have some concurrency and collections updates with the JSR166y, extension of the JSR166 of Doug Lea.
In this post, we'll see the most important news :

    Fork/Join Frame">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2010-04-14T06:40:29+02:00">
<meta property="article:tag" content="Concurrency">
<meta property="article:tag" content="Java">
<meta property="article:tag" content="Java 7">
<link href="../../../../favicon.ico" rel="icon" type="image/x-icon">
<link rel="publisher" href="https://plus.google.com/+BaptisteWicht">
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-2175227-7', 'auto');
  var metas = document.getElementsByTagName('meta'), tagsList = [];
  for (var i=0; i<metas.length; i++) {
    if (metas[i].getAttribute('property') == 'article:tag') {
      tagsList.push( metas[i].getAttribute('content'));
    }
  }
  ga('set', 'dimension1', tagsList.join('|'));
  ga('send', 'pageview');
</script>
</head>
<body>

<!-- Menubar -->

<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<div class="container-fluid">
<!-- This keeps the margins nice -->
    <div class="row">
        <div class="col-sm-3 col-lg-2">
            <nav class="navbar navbar-inverse navbar-fixed-side"><div class="navbar-header">
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="https://baptiste-wicht.com/">
                        <span id="blog-title">Blog blog("Baptiste Wicht");</span>
                    </a>
                </div>
<!-- /.navbar-header -->

                <div class="collapse navbar-collapse navbar-ex1-collapse">
                    <ul class="nav navbar-nav">
<li>
<a href="../../../../stories/about.html">About</a>
                </li>
<li>
<a href="../../../../stories/publications.html">Publications</a>
                </li>
<li>
<a href="../../../../stories/projects.html">Projects</a>
                </li>
<li>
<a href="../../../../categories/index.html">Tags</a>
                </li>
<li>
<a href="../../../../archive.html">Archives</a>
                </li>
<li>
<a href="http://feeds.feedburner.com/BaptisteWicht">RSS</a>



                            </li>
<li class="navbar-content">
                                <h3>Related posts</h3>
                            </li>
                            

                            <li><a href="../../09/java-concurrency-part-7-executors-and-thread-pools.html">Java Concurrency - Part 7 : Executors and thread pools</a></li>
<li><a href="../../05/java-concurrency-part-1-threads.html">Java Concurrency - Part 1 : Threads</a></li>
<li><a href="../../08/java-concurrency-in-practice-book-review.html">Java Concurrency in Practice - Book Review</a></li>
<li><a href="../java-7-updates-project-coin.html">Java 7 : Languages updates from Project Coin</a></li>
<li><a href="../../../2012/04/c11-concurrency-tutorial-advanced-locking-and-condition-variables.html">C++11 Concurrency Tutorial - Part 3: Advanced locking and condition variables</a></li>
<li><a href="../../05/java-7-add-public-defender-methods-to-java-interfaces.html">Java 7 : Add "public defender methods" to Java interfaces</a></li>


                            <li class="navbar-block">

                        <li class="wicht-navbar-right">
                            <a target="_blank" title="Follow @wichtounet on Twitter" href="https://twitter.com/wichtounet">
                                <img src="../../../../assets/img/twitter.png" alt="Follow @wichtounet on Twitter"></a>
                        </li>

                        <li class="wicht-navbar-right">
                            <a target="_blank" title="Follow +BaptisteWicht on Google+" href="https://plus.google.com/+BaptisteWicht">
                                <img src="../../../../assets/img/google_plus.png" alt="Follow +BaptisteWicht on Google+"></a>
                        </li>


                    </ul>
</div>
<!-- /.navbar-collapse -->
            </nav>
</div> <!-- col -->
        <div class="col-sm-9 col-lg-10">
            <div id="content"></div>
            
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="." class="u-url">Java 7 : More concurrency</a></h1>

        <div class="metadata">
            <p class="byline author vcard p-author h-card"><span class="byline-name fn p-name" itemprop="author">
                    Baptiste Wicht
            </span></p>
            <p class="dateline">
            <a href="." rel="bookmark">
            <time class="published dt-published" datetime="2010-04-14T06:40:29+02:00" itemprop="datePublished" title="2010-04-14 06:40">2010-04-14 06:40</time></a>
            </p>
                <p class="commentline">
    
    <a href="#disqus_thread" data-disqus-identifier="cache/posts/2010/04/java-7-more-concurrency.html">Comments</a>


            
        </p>
<p class="sourceline"><a href="index.wp" class="sourcelink">Source</a></p>

        </div>
        

    </header><div class="e-content entry-content" itemprop="articleBody text">
    <p>With <strong>Java 7</strong> (Dolphin), we'll have some <strong>concurrency </strong>and <strong>collections </strong>updates with the <strong>JSR166y</strong>, extension of the JSR166 of Doug Lea.</p>
<p>In this post, we'll see the most important news :</p>
<ul>
<li>Fork/Join Framework</li>
    <li>TrasnferQueue<e></e>
</li>
    <li>ThreadLocalRandom</li>
</ul>
<!-- TEASER_END --><h4>Fork/Join Framework</h4>

<p>The most important improvement is a new <strong>Fork/Join</strong> Framework. Fork/Join is basically the parralel version of the divide-and-conquer algorithm resolution. Here is the typical form of that problems (taken from Doug Lea) :</p>
<div class="code"><pre class="code literal-block"><span class="n">Result</span><span class="w"> </span><span class="nf">solve</span><span class="p">(</span><span class="n">Problem</span><span class="w"> </span><span class="n">problem</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">problem</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">small</span><span class="p">)</span>
<span class="w">        </span><span class="n">directly</span><span class="w"> </span><span class="n">solve</span><span class="w"> </span><span class="n">problem</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">split</span><span class="w"> </span><span class="n">problem</span><span class="w"> </span><span class="n">into</span><span class="w"> </span><span class="n">independent</span><span class="w"> </span><span class="n">parts</span>
<span class="w">        </span><span class="n">fork</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">subtasks</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">solve</span><span class="w"> </span><span class="n">each</span><span class="w"> </span><span class="n">part</span>
<span class="w">        </span><span class="n">join</span><span class="w"> </span><span class="n">all</span><span class="w"> </span><span class="n">subtasks</span>
<span class="w">        </span><span class="n">compose</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">subresults</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>Java 7 provide a new class <strong>ForkJoinPool </strong>to run <strong>ForkJoinTask</strong>. A ForkJoinTask is lighter than a thread. If you have a lot of ForkJoinTask, you can host them with a smallest number of threads. Two implementations of ForkJoinTask are provided :</p>
<ul>
<li>
<strong>RecursiveAction </strong>: A recursive resultless ForkJoinTask</li>
    <li>
<strong>RecursiveTask</strong><e> : A recursive ForkJoinTask that return an object of type E</e>
</li>
</ul>
<p>Of course, you can also directly use the ForkJoinTask class but the recursive actions are enough in almost all the cases.</p>
<p>From a ForkJoinTask you can invoke other task (fork them) using <em>invokeAll </em>methods.</p>
<p>So, now that we have covered the main concepts of this framework, we could start with a little example (directly taken from Javadoc <strong>build 87</strong>). We'll use divide and conquer to increment all the elements of an array. To know if the problem is small enough to solve it directly, we'll use a threshold representing the number of elements that we can increment directly. If we have more elements than the threshold, we will fork in two task otherwise, we'll compute directly the incrementation on the array. So here is our task :</p>
<div class="code"><pre class="code literal-block"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">IncrementTask</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">RecursiveAction</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">long</span><span class="o">[]</span><span class="w"> </span><span class="n">array</span><span class="p">;</span>
<span class="w">   </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">low</span><span class="p">;</span>
<span class="w">   </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">high</span><span class="p">;</span>

<span class="w">   </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">THRESHOLD</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5000</span><span class="p">;</span>

<span class="w">   </span><span class="kd">public</span><span class="w"> </span><span class="nf">IncrementTask</span><span class="p">(</span><span class="kt">long</span><span class="o">[]</span><span class="w"> </span><span class="n">array</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">low</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">high</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">super</span><span class="p">();</span>

<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="na">array</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">array</span><span class="p">;</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="na">low</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">low</span><span class="p">;</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="na">high</span><span class="o">=</span><span class="w"> </span><span class="n">high</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>

<span class="w">   </span><span class="nd">@Override</span>
<span class="w">   </span><span class="kd">protected</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">compute</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">high</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">low</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">THRESHOLD</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">           </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">low</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">high</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">){</span>
<span class="w">              </span><span class="n">array</span><span class="o">[</span><span class="n">i</span><span class="o">]++</span><span class="p">;</span>
<span class="w">           </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">           </span><span class="kt">int</span><span class="w"> </span><span class="n">mid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">low</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">high</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>

<span class="w">           </span><span class="n">invokeAll</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">IncrementTask</span><span class="p">(</span><span class="n">array</span><span class="p">,</span><span class="w"> </span><span class="n">low</span><span class="p">,</span><span class="w"> </span><span class="n">mid</span><span class="p">),</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IncrementTask</span><span class="p">(</span><span class="n">array</span><span class="p">,</span><span class="w"> </span><span class="n">mid</span><span class="p">,</span><span class="w"> </span><span class="n">high</span><span class="p">));</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">   </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>And you can launch that on an array using ForkJoinPool :</p>
<div class="code"><pre class="code literal-block"><span class="n">RecursiveAction</span><span class="w"> </span><span class="n">mainTask</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IncrementTask</span><span class="w"> </span><span class="p">(</span><span class="n">anArray</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">anArray</span><span class="p">.</span><span class="na">length</span><span class="p">);</span>
<span class="n">ForkJoinPool</span><span class="w"> </span><span class="n">mainPool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ForkJoinPool</span><span class="p">();</span>
<span class="n">mainPool</span><span class="p">.</span><span class="na">invoke</span><span class="p">(</span><span class="n">mainTask</span>
</pre></div>

<p>All the elements of the array will be incremented. Depending on the size of the array and of the threshold, the problem will be divided in several sub problems and all these task will be managed by the ForkJoinPool.</p>
<p>You can also make action that return something. By example, we can compute the sum of all the elements of an array :</p>
<div class="code"><pre class="code literal-block"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">SumTask</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">RecursiveTask</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">long</span><span class="o">[]</span><span class="w"> </span><span class="n">array</span><span class="p">;</span>
<span class="w">   </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">low</span><span class="p">;</span>
<span class="w">   </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">high</span><span class="p">;</span>

<span class="w">   </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">THRESHOLD</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5000</span><span class="p">;</span>

<span class="w">   </span><span class="kd">public</span><span class="w"> </span><span class="nf">SumTask</span><span class="p">(</span><span class="kt">long</span><span class="o">[]</span><span class="w"> </span><span class="n">array</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">low</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">high</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">super</span><span class="p">();</span>

<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="na">array</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">array</span><span class="p">;</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="na">low</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">low</span><span class="p">;</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="na">high</span><span class="o">=</span><span class="w"> </span><span class="n">high</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>

<span class="w">   </span><span class="nd">@Override</span>
<span class="w">   </span><span class="kd">protected</span><span class="w"> </span><span class="n">Long</span><span class="w"> </span><span class="nf">compute</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">high</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">low</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">THRESHOLD</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="kt">long</span><span class="w"> </span><span class="n">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">          </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">low</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">high</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">){</span>
<span class="w">              </span><span class="n">sum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">array</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">;</span>
<span class="w">           </span><span class="p">}</span>

<span class="w">           </span><span class="k">return</span><span class="w"> </span><span class="n">sum</span><span class="p">;</span>
<span class="w">       </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">           </span><span class="kt">int</span><span class="w"> </span><span class="n">mid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">low</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">high</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>

<span class="w">          </span><span class="n">RecursiveTask</span><span class="w"> </span><span class="n">left</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SumTask</span><span class="p">(</span><span class="n">array</span><span class="p">,</span><span class="w"> </span><span class="n">low</span><span class="p">,</span><span class="w"> </span><span class="n">mid</span><span class="p">);</span>
<span class="w">          </span><span class="n">RecursiveTask</span><span class="w"> </span><span class="n">right</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SumTask</span><span class="p">(</span><span class="n">array</span><span class="p">,</span><span class="w"> </span><span class="n">mid</span><span class="p">,</span><span class="w"> </span><span class="n">high</span><span class="p">);</span>

<span class="w">          </span><span class="n">right</span><span class="p">.</span><span class="na">fork</span><span class="p">();</span>

<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="n">left</span><span class="p">.</span><span class="na">compute</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">right</span><span class="p">.</span><span class="na">join</span><span class="p">();</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">   </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>And you can use it like that :</p>
<div class="code"><pre class="code literal-block"><span class="n">RecursiveTask</span><span class="w"> </span><span class="n">sumTask</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SumTask</span><span class="p">(</span><span class="n">anArray</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">anArray</span><span class="p">.</span><span class="na">length</span><span class="p">);</span>
<span class="n">ForkJoinPool</span><span class="w"> </span><span class="n">mainPool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ForkJoinPool</span><span class="p">();</span>
<span class="n">Long</span><span class="w"> </span><span class="n">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mainPool</span><span class="p">.</span><span class="na">invoke</span><span class="p">(</span><span class="n">sumTask</span><span class="p">);</span>
</pre></div>

<p>I think it's a clean way to solve big problems with divide-and-conquer.</p>
<p>You can also imagine others ways to divide the problems. An example is to compute the <em>THRESOLD</em> left elements in the task and create a new task to compute the right elements. With that, we create less tasks, but it depends on the context and on the problems. In practive, you'll have  normally more complex problems but if you can find a way to divide the problems, you can use that new framework and have a very clean code.</p>
<h4>TransferQueue<e></e>
</h4>

<p>A new interesting collection. This collection is a blocking queue especially made for producers/consumers. With that kind of queue, the producers can await for receipt of by the consumers with a new transfer(E) method or like normal queue without waiting for receipt with the <em>put</em>(E) method. It's also possible to make a transfer with timeout with the tryTransfer method. There is no change in the consumer part, you always use take() to get an element and waiting for an element. You've also access to the number of waiting consumer with the <em>getWaitingConsumerCount</em>().</p>
<p>The implementation to use is the <strong>LinkedTransferQueue<e></e></strong> based on linked nodes. The elements are ordered with FIFO. Here are some methods you can use with that new collection :</p>
<div class="code"><pre class="code literal-block"><span class="n">TransferQueue</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">transfer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">LinkedTransferQueue</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="p">();</span>

<span class="n">transfer</span><span class="p">.</span><span class="na">transfer</span><span class="p">(</span><span class="s">"Hello"</span><span class="p">);</span><span class="w"> </span><span class="c1">//Wait for a consumer</span>

<span class="k">if</span><span class="p">(</span><span class="n">transfer</span><span class="p">.</span><span class="na">tryTransfer</span><span class="p">(</span><span class="s">"World"</span><span class="p">)){</span><span class="c1">//Don't wait for a consumer</span>
<span class="w">    </span><span class="c1">//The element has been transfered to a consumer</span>
<span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">//There were no waiting consumer. The element has not been enqueued.</span>
<span class="p">}</span>

<span class="kt">boolean</span><span class="w"> </span><span class="n">transfered</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">transfer</span><span class="p">.</span><span class="na">tryTransfer</span><span class="p">(</span><span class="s">"Goodbye"</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">SECONDS</span><span class="p">);</span>

<span class="k">while</span><span class="p">(</span><span class="n">transfer</span><span class="p">.</span><span class="na">hasWaitingConsumer</span><span class="p">()){</span>
<span class="w">    </span><span class="c1">//There is at least one consumer waiting for a transfer</span>
<span class="p">}</span>
</pre></div>

<p>It's also an interesting stuff. Useful by example in the case of message passing.</p>
<h4>ThreadLocalRandom</h4>

<p>A really simple but useful enhancement is the add of the <strong>ThreadLocalRandom</strong> class. This class is a random number generator linked to the current <strong>Thread</strong>. It seems that if you use this generator from two different thread, you will have two different random generators. The generator is initialized with a generated seed that you cannot modify (<em>setSeed()</em> throws an <em>UnsupportedOperationException</em>).</p>
<p>You can use that class like that :</p>
<div class="code"><pre class="code literal-block"><span class="kt">long</span><span class="w"> </span><span class="n">l</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ThreadLocalRandom</span><span class="p">.</span><span class="na">current</span><span class="p">().</span><span class="na">nextLong</span><span class="p">(</span><span class="mi">22L</span><span class="p">);</span>
</pre></div>

<p>If you always use this form, you have the guarantee that the random generator will never be shared between two threads. Moreover, this new class provide  methods to generate a bounded numbers. By example, to generate a pseudo-random number between 10, inclusive and 33, exclusive, you can type :</p>
<div class="code"><pre class="code literal-block"><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ThreadLocalRandom</span><span class="p">.</span><span class="na">current</span><span class="p">().</span><span class="na">nextInt</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">33</span><span class="p">);</span>
</pre></div>

<p>This is a little improvement but really useful, i think.</p>
<p>So here we are. I've covered the main features added on Java 7 for concurrency. I hope you find that stuff interesting and that discovering this features will help you to make concurrent programming in Java 7.</p>
    </div>
    <aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../../../../categories/concurrency/" rel="tag">Concurrency</a></li>
            <li><a class="tag p-category" href="../../../../categories/java/" rel="tag">Java</a></li>
            <li><a class="tag p-category" href="../../../../categories/java-7/" rel="tag">Java 7</a></li>
        </ul>
<ul class="pager hidden-print">
<li class="previous">
                <a href="../links-of-the-week-2/" rel="prev" title="Links of the Week">Previous post</a>
            </li>
            <li class="next">
                <a href="../substance-6-0-is-out/" rel="next" title="Substance 6.0 is out">Next post</a>
            </li>
        </ul></nav></aside><section class="comments hidden-print"><h2>Comments</h2>
        
    
        <div id="disqus_thread"></div>
        <script>
        var disqus_shortname ="blogwichtounet",
            disqus_url="https://baptiste-wicht.com/posts/2010/04/java-7-more-concurrency/",
        disqus_title="Java 7 : More concurrency",
        disqus_identifier="cache/posts/2010/04/java-7-more-concurrency.html",
        disqus_config = function () {
            this.language = "en";
        };
        (function() {
            var dsq = document.createElement('script'); dsq.async = true;
            dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
</noscript>
    <a href="https://disqus.com" class="dsq-brlink" rel="nofollow">Comments powered by <span class="logo-disqus">Disqus</span></a>


        </section></article><script>var disqus_shortname="blogwichtounet";(function(){var a=document.createElement("script");a.async=true;a.src="https://"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script>
</div> <!-- col -->
    </div>
<!-- row  -->
</div>
<!-- container-fluid -->

<!-- End of Menubar -->

<!-- Footer -->

<footer>
    Contents © 2023         <a href="mailto:baptistewicht@gmail.com">Baptiste Wicht</a> - Powered by         <a href="http://getnikola.com" rel="nofollow">Nikola</a>         - License: 
<a rel="license" href="http://creativecommons.org/licenses/by/4.0/"><img alt="Creative Commons License" style="padding-left:5px;border-width:0" src="../../../../assets/img/cc.png"></a>
        <ul class="footer_inline_ul">
<li>
    <a href="index.wp" id="sourcelink">Source</a>
    </li>

        </ul></footer><!-- Late loading stuff  --><script src="../../../../assets/js/all-nocdn.js"></script><!-- Google platform JS -->
</body>
</html>
