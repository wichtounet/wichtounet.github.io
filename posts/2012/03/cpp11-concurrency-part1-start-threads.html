<!DOCTYPE html><html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="author" content="Baptiste Wicht">
    <title>C++11 Concurrency - Part 1 : Start Threads | @Blog("Baptiste Wicht")</title>
    
            <link href="../../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
      <link rel="canonical" href="http://www.baptiste-wicht.com/posts/2012/03/cpp11-concurrency-part1-start-threads.html">
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js" type="text/javascript"></script>
    <![endif]-->
            <link rel="alternate" type="application/rss+xml" title="RSS" href="../../../rss.xml">

    





    
</head>
<body>
<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container-fluid"><!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="http://www.baptiste-wicht.com/">@Blog("Baptiste Wicht")</a>
        </div><!-- /.navbar-header -->
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                
                <li><a href="../../../stories/about.html">About</a>
                </li><li><a href="../../../stories/publications.html">Publications</a>
                </li><li><a href="../../../stories/donate.html">Donate</a>
                </li><li><a href="../../../stories/faq.html">FAQ</a>
                </li><li><a href="../../../stories/legal.html">Legal</a>
                </li><li><a href="../../../archive.html">Archives</a>
                </li><li><a href="../../../categories/index.html">Tags</a>
                </li><li><a href="../../../rss.xml">RSS</a>

            </li></ul>

            <ul class="nav navbar-nav navbar-right">
                
                
                    
    <li>
    <a href="cpp11-concurrency-part1-start-threads.wp" id="sourcelink">Source</a>
    </li>

            </ul>
        </div><!-- /.navbar-collapse -->
    </div><!-- /.container-fluid -->
</nav>

<!-- End of Menubar -->

<div class="container">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
    <article class="postbox post-text">
    <div class="h-entry" itemscope="itemscope" itemtype="http://schema.org/Article">
    
    <h1 class="p-name" itemprop="headline name">C++11 Concurrency - Part 1 : Start Threads</h1>

    <hr>
    <small>
        Posted: <time class="published dt-published" datetime="2012-03-21T09:16:18+00:00" itemprop="datePublished">2012-03-21 09:16</time>
        

        
          |  
        More posts about 
    <span itemprop="keywords">
        <a class="tag p-category" href="../../../categories/c.html"><span class="badge badge-info">C++</span></a>
        <a class="tag p-category" href="../../../categories/c.html"><span class="badge badge-info">C++</span></a>
        <a class="tag p-category" href="../../../categories/c11.html"><span class="badge badge-info">C++11</span></a>
        <a class="tag p-category" href="../../../categories/c11-concurrency-tutorial.html"><span class="badge badge-info">C++11 Concurrency Tutorial</span></a>
        <a class="tag p-category" href="../../../categories/concurrency.html"><span class="badge badge-info">Concurrency</span></a>
    </span>


    </small>
    <hr>
    <div class="e-content" itemprop="articleBody text">
    <div><p></p><p>C++11 introduced a new thread library. This library includes utilities for starting and managing threads. It also contains utilities for synchronization like mutexes and other locks, atomic variables and other utilities. In this serie of posts, I will try to explain most of the features provided by this new library.</p>
<p>To compile the samples of this article, you will need a compiler with C++11 support. In my case, I used GCC 4.6.1 (you need to pass the "-std=c++0x" or "-std=c++11" option to get the C++11 support activated).</p>
<p></p><h4>Starting threads</h4>
<p>Starting a new thread is very easy. When you create an instance of a <strong>std::thread</strong>, it will automatically be started. When you create a thread you have to give it the code it will execute. The first choice for that, is to pass it a function pointer. Let's start with the very common Hello World:</p>
<p>[cpp]#include &lt;thread&gt;</p>
<h2>include &lt;iostream&gt;</h2>
<p>void hello(){
    std::cout &lt;&lt; "Hello from thread " &lt;&lt; std::endl;
}</p>
<p>int main(){
    std::thread t1(hello);
    t1.join();</p>
<div class="code"><pre><span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</pre></div>


<p>}[/cpp]</p>
<p>All the threads utilities are located in the <strong>thread</strong> header. An interesting thing in this first example is the call to the <strong>join()</strong> function. Calling this function forces the current thread to wait for the other one (in this case, the main thread has to wait for the thread t1 to finish). If you omit this call, the result is undefined. The program can print <em>Hello from thread</em> and a new line, can print just <em>Hello from thread</em> without new line or can print nothing. That's because the main thread can return from the main function before the t1 thread finishes its execution.</p>
<h4>Distinguishing threads</h4>

<p>Each thread has a single id allowing us to distinguish each of them. The std::thread class has a <strong>get_id()</strong> function returning an unique id for this thread. You can get a reference to the current thread with the <strong>std::this_thread</strong> variable. The next example starts with threads and each of them prints its id:</p>
<p>[cpp]#include &lt;thread&gt;</p>
<h2>include &lt;iostream&gt;</h2>
<h2>include &lt;vector&gt;</h2>
<p>void hello(){
    std::cout &lt;&lt; "Hello from thread " &lt;&lt; std::this_thread::get_id() &lt;&lt; std::endl;
}</p>
<p>int main(){
    std::vector&lt;std::thread&gt; threads;</p>
<div class="code"><pre><span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span> <span class="mi">5</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">){</span>
    <span class="n">threads</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="p">(</span><span class="n">hello</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">for</span><span class="p">(</span><span class="k">auto</span><span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span> <span class="kr">thread</span> <span class="o">:</span> <span class="n">threads</span><span class="p">){</span>
    <span class="kr">thread</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</pre></div>


<p>}[/cpp]</p>
<p>Starting each thread one after one and then storing them into a vector is a common way to handle several threads. With that, you can easily change the number of threads. Even with a very little sample like this one, the results is not predictable. The theoretic case:</p>
<blockquote>Hello from thread 140276650997504

Hello from thread 140276667782912

Hello from thread 140276659390208

Hello from thread 140276642604800

Hello from thread 140276676175616</blockquote>

<p>Is, in my case, also the less common. You can also get results like this one:</p>
<blockquote>Hello from thread Hello from thread Hello from thread 139810974787328Hello from thread 139810983180032Hello from thread

139810966394624

139810991572736

139810958001920</blockquote>

<p>Or a lot of another results. This is because of interleaving. You have no way to control the order of execution of threads. A thread can be preempted at any moment and the appends to the out stream are made one after one (first the append of the string, then append the id and finally the new line), so a thread can print its first part and then be interrupted to print its second part after all the others threads.</p>
<h4>Start a thread with a lambda</h4>

<p>When the code that has to be executed by each thread is very small, you don't necessary want to create a function for that. In that case, you can use a lambda to define the executed by a thread. We can rewrite the code of the last sample using lambda easily:</p>
<p>[cpp]#include &lt;thread&gt;</p>
<h2>include &lt;iostream&gt;</h2>
<h2>include &lt;vector&gt;</h2>
<p>int main(){
    std::vector&lt;std::thread&gt; threads;</p>
<div class="code"><pre><span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span> <span class="mi">5</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">){</span>
    <span class="n">threads</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="p">([](){</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span><span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span> <span class="s">"Hello from thread "</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span><span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span> <span class="n">std</span><span class="o">::</span><span class="n">this_thread</span><span class="o">::</span><span class="n">get_id</span><span class="p">()</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span><span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="p">}));</span>
<span class="p">}</span>

<span class="k">for</span><span class="p">(</span><span class="k">auto</span><span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span> <span class="kr">thread</span> <span class="o">:</span> <span class="n">threads</span><span class="p">){</span>
    <span class="kr">thread</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</pre></div>


<p>}[/cpp]</p>
<p>Here we just used a lambda expression instead of the function pointer. Of course, this produces the exact same result as the previous sample.</p>
<h4>Next</h4>

<p>In the next post of this series, we will see how to protect code using locks.</p>
<p>The source code for each sample is available <a title="Source code for this blog post" href="https://github.com/wichtounet/articles/tree/master/src/threads/part1">on Github</a>.</p></div>
    </div>
    </div>
    
        <ul class="pager">
            <li class="previous">
                <a href="introduction-64-bit-intel-assembly-language-programming-linux-book-review.html" rel="prev">← Previous post</a>
            </li>
            <li class="next">
                <a href="eddic-0-9-1-enhanced-floating-point-support.html" rel="next">Next post →</a>
            </li>
        </ul>

        
        
        <div id="disqus_thread"></div>
        <script>
        var disqus_shortname ="nikolademo",
            disqus_url="http://www.baptiste-wicht.com/posts/2012/03/cpp11-concurrency-part1-start-threads.html",
        disqus_title="C++11 Concurrency - Part 1 : Start Threads",
        disqus_identifier="cache/posts/2012/03/cpp11-concurrency-part1-start-threads.html",
        disqus_config = function () {
            this.language = "en";
        };
        (function() {
            var dsq = document.createElement('script'); dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink" rel="nofollow">Comments powered by <span class="logo-disqus">Disqus</span></a>


    

    </article>

        </div>
        <!--End of body content-->

        <footer>
            Contents © 2014         <a href="mailto:baptistewicht@gmail.com">Baptiste Wicht</a> - Powered by         <a href="http://getnikola.com" rel="nofollow">Nikola</a>         
        </footer>
    </div>
</div>


            <script src="../../../assets/js/all-nocdn.js" type="text/javascript"></script>


    
<!-- Social buttons -->
<div id="addthisbox" class="addthis_toolbox addthis_peekaboo_style addthis_default_style addthis_label_style addthis_32x32_style">
<a class="addthis_button_more">Share</a>
<ul><li><a class="addthis_button_facebook"></a>
</li><li><a class="addthis_button_google_plusone_share"></a>
</li><li><a class="addthis_button_linkedin"></a>
</li><li><a class="addthis_button_twitter"></a>
</li></ul>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-4f7088a56bb93798"></script>
<!-- End of social buttons -->


    <script type="text/javascript">jQuery("a.image-reference").colorbox({rel:"gal",maxWidth:"100%",maxHeight:"100%",scalePhotos:true});</script>
    

</body>
</html>