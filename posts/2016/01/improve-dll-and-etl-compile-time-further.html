<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Improve DLL and ETL Compile Time further | Blog blog("Baptiste Wicht");</title>
<link href="../../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" hreflang="en" href="../../../rss.xml">
<link rel="canonical" href="https://baptiste-wicht.com/posts/2016/01/improve-dll-and-etl-compile-time-further.html">
<!--[if lt IE 9]><script src="../../../assets/js/html5.js"></script><![endif]--><meta name="author" content="Baptiste Wicht">
<link rel="prev" href="../../2015/11/detect-overflows-and-more-in-java-with-cojac.html" title="Detect overflows and more in Java with COJAC" type="text/html">
<link rel="next" href="../02/use-templight-and-templar-to-debug-cpp-templates.html" title="Use templight and Templar to debug C++ templates" type="text/html">
<meta property="og:site_name" content='Blog blog("Baptiste Wicht");'>
<meta property="og:title" content="Improve DLL and ETL Compile Time further">
<meta property="og:url" content="https://baptiste-wicht.com/posts/2016/01/improve-dll-and-etl-compile-time-further.html">
<meta property="og:description" content="For a while, the compilation time of my matrix/vector computation library (ETL), based on Expression Templates has become more and more problematic. I've already worked on this problem here and there,">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2016-01-29T17:02:34+01:00">
<meta property="article:tag" content="C++">
<meta property="article:tag" content="Compilers">
<meta property="article:tag" content="dll">
<meta property="article:tag" content="etl">
<meta property="article:tag" content="gcc">
<meta property="article:tag" content="Performances">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://baptiste-wicht.com/">

                <span id="blog-title">Blog blog("Baptiste Wicht");</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="../../../stories/about.html">About</a>
                </li>
<li>
<a href="../../../stories/publications.html">Publications</a>
                </li>
<li>
<a href="../../../stories/projects.html">Projects</a>
                </li>
<li>
<a href="../../../categories/index.html">Tags</a>
                </li>
<li>
<a href="../../../archive.html">Archives</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right">
<li>
    <a href="improve-dll-and-etl-compile-time-further.rst" id="sourcelink">Source</a>
    </li>

                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="#" class="u-url">Improve DLL and ETL Compile Time further</a></h1>

        <div class="metadata">
            <p class="byline author vcard p-author h-card"><span class="byline-name fn p-name" itemprop="author">
                    Baptiste Wicht
            </span></p>
            <p class="dateline">
            <a href="#" rel="bookmark">
            <time class="published dt-published" datetime="2016-01-29T17:02:34+01:00" itemprop="datePublished" title="2016-01-29 17:02">2016-01-29 17:02</time></a>
            </p>
                <p class="commentline">
    
    <a href="improve-dll-and-etl-compile-time-further.html#disqus_thread" data-disqus-identifier="cache/posts/2016/01/improve-dll-and-etl-compile-time-further.html">Comments</a>


            
        </p>
<p class="sourceline"><a href="improve-dll-and-etl-compile-time-further.rst" class="sourcelink">Source</a></p>

        </div>
        

    </header><div class="e-content entry-content" itemprop="articleBody text">
    <p>For a while, the compilation time of my matrix/vector computation library (ETL), based on Expression Templates has become more and more problematic. I've already worked on this problem <a class="reference external" href="http://baptiste-wicht.com/posts/2015/06/how-i-improved-a-bit-compile-time-of-etl.html">here</a> and <a class="reference external" href="http://baptiste-wicht.com/posts/2015/06/improve-etl-compile-time-with-precompiled-headers.html">there</a>, using some general techniques (pragmas, precompiled headers, header removals and so on). On this post, I'll talk about two major improvements I have been able to do directly in the code.</p>
<section id="use-of-static-if"><h2>Use of static_if</h2>
<p>Remember <a class="reference external" href="http://baptiste-wicht.com/posts/2015/07/simulate-static_if-with-c11c14.html">static_if</a> ? I was able to use it to really reduce the compile time of DLL.</p>
<p>I wrote a script to time each test case of the DLL project to find the test cases that took the longest to compile. Once I found the best candidate, I isolated the functions that took the longest to compile. It was quite tedious and I did it by hand, primarily by commenting parts of the code and going deeper and deeper in the code. I was quite suprised to find that a single function call (template function of course ;) ) was responsible for 60% of the compilation time of my candidate test case. The function was instantiating a whole bunch of expression templates (to compute the free energy of several models). The function itself was not really optimizable, but what was really interesting is that this function was only used in some very rare cases and that these cases were known at compile-time :) This was a perfect case to use a static_if. And once the call was inside the static_if, the test case was indeed about 60% faster. <strong>This reduced the overall compilation time of DLL by about 30%</strong>!</p>
<p>This could also of course also have been achieved by using two functions, one with the call, one empty and selected by SFINAE (Substitution Failure Is Not An Error). I prefer the statif_if version since this really shows the intent and hides SFINAE behind nicer syntax.</p>
<p>I was also able to use static_if at other places in the DLL code to avoid instantiating some templates, but the improvements were much less dramatic (about 1% of the total compilation time). I was very lucky to find a single function that accounted for so much compile time. After some more tests, I concluded that much of the compilation time of DLL was spent compiling the Expression Templates from my ETL library so I decided to delve into ETL code directly.</p>
</section><section id="removal-of-std-async"><h2>Removal of std::async</h2>
<p>The second improvement was very surprising. I was working on improving the compilation of ETL and found out that the sum and average reductions of matrices were dramatically slow, about an order of magnitude slower than standard operations on matrices. In parallel (but the two facts are linked), I also found out another weird fact when splitting a file into 10 parts (the file was comprised of 10 test cases). Compiling the 10 parts separarely (and sequentially, not multiple threads) was about 40% faster than compiling the complete file. There was no swapping so it was not a memory issue. This is not expected. Generally, it is faster to compile a big file than to compile its parts separately. The advantage of smaller files is that you can compile them in parallel and that incremental builds are faster (only compile a small part).</p>
<p>By elimination, I found out that most of the time was spent inside the function that was dispatching in parallel the work for accumulating the sum of a matrix. Here is the function:</p>
<div class="code"><pre class="code cpp"><a id="rest_code_ddfc6b221d3949bcbf28cfaee3b994b4-1" name="rest_code_ddfc6b221d3949bcbf28cfaee3b994b4-1" href="improve-dll-and-etl-compile-time-further.html#rest_code_ddfc6b221d3949bcbf28cfaee3b994b4-1"></a><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">T</span><span class="p">,</span><span class="w"> </span><span class="k">typename</span><span class="w"> </span><span class="nc">Functor</span><span class="p">,</span><span class="w"> </span><span class="k">typename</span><span class="w"> </span><span class="nc">AccFunctor</span><span class="o">&gt;</span>
<a id="rest_code_ddfc6b221d3949bcbf28cfaee3b994b4-2" name="rest_code_ddfc6b221d3949bcbf28cfaee3b994b4-2" href="improve-dll-and-etl-compile-time-further.html#rest_code_ddfc6b221d3949bcbf28cfaee3b994b4-2"></a><span class="kr">inline</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">dispatch_1d_acc</span><span class="p">(</span><span class="kt">bool</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">Functor</span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">functor</span><span class="p">,</span><span class="w"> </span><span class="n">AccFunctor</span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">acc_functor</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span><span class="w"> </span><span class="n">first</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span><span class="w"> </span><span class="n">last</span><span class="p">){</span>
<a id="rest_code_ddfc6b221d3949bcbf28cfaee3b994b4-3" name="rest_code_ddfc6b221d3949bcbf28cfaee3b994b4-3" href="improve-dll-and-etl-compile-time-further.html#rest_code_ddfc6b221d3949bcbf28cfaee3b994b4-3"></a><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">p</span><span class="p">){</span>
<a id="rest_code_ddfc6b221d3949bcbf28cfaee3b994b4-4" name="rest_code_ddfc6b221d3949bcbf28cfaee3b994b4-4" href="improve-dll-and-etl-compile-time-further.html#rest_code_ddfc6b221d3949bcbf28cfaee3b994b4-4"></a><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">future</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">futures</span><span class="p">(</span><span class="n">threads</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<a id="rest_code_ddfc6b221d3949bcbf28cfaee3b994b4-5" name="rest_code_ddfc6b221d3949bcbf28cfaee3b994b4-5" href="improve-dll-and-etl-compile-time-further.html#rest_code_ddfc6b221d3949bcbf28cfaee3b994b4-5"></a>
<a id="rest_code_ddfc6b221d3949bcbf28cfaee3b994b4-6" name="rest_code_ddfc6b221d3949bcbf28cfaee3b994b4-6" href="improve-dll-and-etl-compile-time-further.html#rest_code_ddfc6b221d3949bcbf28cfaee3b994b4-6"></a><span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">last</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">first</span><span class="p">;</span>
<a id="rest_code_ddfc6b221d3949bcbf28cfaee3b994b4-7" name="rest_code_ddfc6b221d3949bcbf28cfaee3b994b4-7" href="improve-dll-and-etl-compile-time-further.html#rest_code_ddfc6b221d3949bcbf28cfaee3b994b4-7"></a><span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">batch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">threads</span><span class="p">;</span>
<a id="rest_code_ddfc6b221d3949bcbf28cfaee3b994b4-8" name="rest_code_ddfc6b221d3949bcbf28cfaee3b994b4-8" href="improve-dll-and-etl-compile-time-further.html#rest_code_ddfc6b221d3949bcbf28cfaee3b994b4-8"></a>
<a id="rest_code_ddfc6b221d3949bcbf28cfaee3b994b4-9" name="rest_code_ddfc6b221d3949bcbf28cfaee3b994b4-9" href="improve-dll-and-etl-compile-time-further.html#rest_code_ddfc6b221d3949bcbf28cfaee3b994b4-9"></a><span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">threads</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">t</span><span class="p">){</span>
<a id="rest_code_ddfc6b221d3949bcbf28cfaee3b994b4-10" name="rest_code_ddfc6b221d3949bcbf28cfaee3b994b4-10" href="improve-dll-and-etl-compile-time-further.html#rest_code_ddfc6b221d3949bcbf28cfaee3b994b4-10"></a><span class="w">            </span><span class="n">futures</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">async</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">launch</span><span class="o">::</span><span class="n">async</span><span class="p">,</span><span class="w"> </span><span class="n">functor</span><span class="p">,</span><span class="w"> </span><span class="n">first</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">batch</span><span class="p">,</span><span class="w"> </span><span class="n">first</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">batch</span><span class="p">);</span>
<a id="rest_code_ddfc6b221d3949bcbf28cfaee3b994b4-11" name="rest_code_ddfc6b221d3949bcbf28cfaee3b994b4-11" href="improve-dll-and-etl-compile-time-further.html#rest_code_ddfc6b221d3949bcbf28cfaee3b994b4-11"></a><span class="w">        </span><span class="p">}</span>
<a id="rest_code_ddfc6b221d3949bcbf28cfaee3b994b4-12" name="rest_code_ddfc6b221d3949bcbf28cfaee3b994b4-12" href="improve-dll-and-etl-compile-time-further.html#rest_code_ddfc6b221d3949bcbf28cfaee3b994b4-12"></a>
<a id="rest_code_ddfc6b221d3949bcbf28cfaee3b994b4-13" name="rest_code_ddfc6b221d3949bcbf28cfaee3b994b4-13" href="improve-dll-and-etl-compile-time-further.html#rest_code_ddfc6b221d3949bcbf28cfaee3b994b4-13"></a><span class="w">        </span><span class="n">acc_functor</span><span class="p">(</span><span class="n">functor</span><span class="p">(</span><span class="n">first</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">threads</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">batch</span><span class="p">,</span><span class="w"> </span><span class="n">last</span><span class="p">));</span>
<a id="rest_code_ddfc6b221d3949bcbf28cfaee3b994b4-14" name="rest_code_ddfc6b221d3949bcbf28cfaee3b994b4-14" href="improve-dll-and-etl-compile-time-further.html#rest_code_ddfc6b221d3949bcbf28cfaee3b994b4-14"></a>
<a id="rest_code_ddfc6b221d3949bcbf28cfaee3b994b4-15" name="rest_code_ddfc6b221d3949bcbf28cfaee3b994b4-15" href="improve-dll-and-etl-compile-time-further.html#rest_code_ddfc6b221d3949bcbf28cfaee3b994b4-15"></a><span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">fut</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">futures</span><span class="p">){</span>
<a id="rest_code_ddfc6b221d3949bcbf28cfaee3b994b4-16" name="rest_code_ddfc6b221d3949bcbf28cfaee3b994b4-16" href="improve-dll-and-etl-compile-time-further.html#rest_code_ddfc6b221d3949bcbf28cfaee3b994b4-16"></a><span class="w">            </span><span class="n">acc_functor</span><span class="p">(</span><span class="n">fut</span><span class="p">.</span><span class="n">get</span><span class="p">());</span>
<a id="rest_code_ddfc6b221d3949bcbf28cfaee3b994b4-17" name="rest_code_ddfc6b221d3949bcbf28cfaee3b994b4-17" href="improve-dll-and-etl-compile-time-further.html#rest_code_ddfc6b221d3949bcbf28cfaee3b994b4-17"></a><span class="w">        </span><span class="p">}</span>
<a id="rest_code_ddfc6b221d3949bcbf28cfaee3b994b4-18" name="rest_code_ddfc6b221d3949bcbf28cfaee3b994b4-18" href="improve-dll-and-etl-compile-time-further.html#rest_code_ddfc6b221d3949bcbf28cfaee3b994b4-18"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="rest_code_ddfc6b221d3949bcbf28cfaee3b994b4-19" name="rest_code_ddfc6b221d3949bcbf28cfaee3b994b4-19" href="improve-dll-and-etl-compile-time-further.html#rest_code_ddfc6b221d3949bcbf28cfaee3b994b4-19"></a><span class="w">        </span><span class="n">acc_functor</span><span class="p">(</span><span class="n">functor</span><span class="p">(</span><span class="n">first</span><span class="p">,</span><span class="w"> </span><span class="n">last</span><span class="p">));</span>
<a id="rest_code_ddfc6b221d3949bcbf28cfaee3b994b4-20" name="rest_code_ddfc6b221d3949bcbf28cfaee3b994b4-20" href="improve-dll-and-etl-compile-time-further.html#rest_code_ddfc6b221d3949bcbf28cfaee3b994b4-20"></a><span class="w">    </span><span class="p">}</span>
<a id="rest_code_ddfc6b221d3949bcbf28cfaee3b994b4-21" name="rest_code_ddfc6b221d3949bcbf28cfaee3b994b4-21" href="improve-dll-and-etl-compile-time-further.html#rest_code_ddfc6b221d3949bcbf28cfaee3b994b4-21"></a><span class="p">}</span>
</pre></div>
<p>There isn't anything really fancy about this function. This takes one functor that will be done in parallel and one function for accumulation.  It dispatches all the work in batch and then accumulates the results. I tried several things to optimize the compilation time of this function, but nothing worked. The line that was consuming all the time was the std::async line. This function was using std::async because the thread pool that I'm generally using does not support returning values from parallel functors. I decided to use a workaround and use my thread pool and I came out with this version:</p>
<div class="code"><pre class="code cpp"><a id="rest_code_042d3557a79841a796b2cd1fc1425d21-1" name="rest_code_042d3557a79841a796b2cd1fc1425d21-1" href="improve-dll-and-etl-compile-time-further.html#rest_code_042d3557a79841a796b2cd1fc1425d21-1"></a><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">T</span><span class="p">,</span><span class="w"> </span><span class="k">typename</span><span class="w"> </span><span class="nc">Functor</span><span class="p">,</span><span class="w"> </span><span class="k">typename</span><span class="w"> </span><span class="nc">AccFunctor</span><span class="o">&gt;</span>
<a id="rest_code_042d3557a79841a796b2cd1fc1425d21-2" name="rest_code_042d3557a79841a796b2cd1fc1425d21-2" href="improve-dll-and-etl-compile-time-further.html#rest_code_042d3557a79841a796b2cd1fc1425d21-2"></a><span class="kr">inline</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">dispatch_1d_acc</span><span class="p">(</span><span class="kt">bool</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">Functor</span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">functor</span><span class="p">,</span><span class="w"> </span><span class="n">AccFunctor</span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">acc_functor</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span><span class="w"> </span><span class="n">first</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span><span class="w"> </span><span class="n">last</span><span class="p">){</span>
<a id="rest_code_042d3557a79841a796b2cd1fc1425d21-3" name="rest_code_042d3557a79841a796b2cd1fc1425d21-3" href="improve-dll-and-etl-compile-time-further.html#rest_code_042d3557a79841a796b2cd1fc1425d21-3"></a><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">p</span><span class="p">){</span>
<a id="rest_code_042d3557a79841a796b2cd1fc1425d21-4" name="rest_code_042d3557a79841a796b2cd1fc1425d21-4" href="improve-dll-and-etl-compile-time-further.html#rest_code_042d3557a79841a796b2cd1fc1425d21-4"></a><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">futures</span><span class="p">(</span><span class="n">threads</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<a id="rest_code_042d3557a79841a796b2cd1fc1425d21-5" name="rest_code_042d3557a79841a796b2cd1fc1425d21-5" href="improve-dll-and-etl-compile-time-further.html#rest_code_042d3557a79841a796b2cd1fc1425d21-5"></a><span class="w">        </span><span class="n">cpp</span><span class="o">::</span><span class="n">default_thread_pool</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">pool</span><span class="p">(</span><span class="n">threads</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<a id="rest_code_042d3557a79841a796b2cd1fc1425d21-6" name="rest_code_042d3557a79841a796b2cd1fc1425d21-6" href="improve-dll-and-etl-compile-time-further.html#rest_code_042d3557a79841a796b2cd1fc1425d21-6"></a>
<a id="rest_code_042d3557a79841a796b2cd1fc1425d21-7" name="rest_code_042d3557a79841a796b2cd1fc1425d21-7" href="improve-dll-and-etl-compile-time-further.html#rest_code_042d3557a79841a796b2cd1fc1425d21-7"></a><span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">last</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">first</span><span class="p">;</span>
<a id="rest_code_042d3557a79841a796b2cd1fc1425d21-8" name="rest_code_042d3557a79841a796b2cd1fc1425d21-8" href="improve-dll-and-etl-compile-time-further.html#rest_code_042d3557a79841a796b2cd1fc1425d21-8"></a><span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">batch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">threads</span><span class="p">;</span>
<a id="rest_code_042d3557a79841a796b2cd1fc1425d21-9" name="rest_code_042d3557a79841a796b2cd1fc1425d21-9" href="improve-dll-and-etl-compile-time-further.html#rest_code_042d3557a79841a796b2cd1fc1425d21-9"></a>
<a id="rest_code_042d3557a79841a796b2cd1fc1425d21-10" name="rest_code_042d3557a79841a796b2cd1fc1425d21-10" href="improve-dll-and-etl-compile-time-further.html#rest_code_042d3557a79841a796b2cd1fc1425d21-10"></a><span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">sub_functor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="n">futures</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">functor</span><span class="p">](</span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span><span class="w"> </span><span class="n">t</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span><span class="w"> </span><span class="n">first</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span><span class="w"> </span><span class="n">last</span><span class="p">){</span>
<a id="rest_code_042d3557a79841a796b2cd1fc1425d21-11" name="rest_code_042d3557a79841a796b2cd1fc1425d21-11" href="improve-dll-and-etl-compile-time-further.html#rest_code_042d3557a79841a796b2cd1fc1425d21-11"></a><span class="w">            </span><span class="n">futures</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">functor</span><span class="p">(</span><span class="n">first</span><span class="p">,</span><span class="w"> </span><span class="n">last</span><span class="p">);</span>
<a id="rest_code_042d3557a79841a796b2cd1fc1425d21-12" name="rest_code_042d3557a79841a796b2cd1fc1425d21-12" href="improve-dll-and-etl-compile-time-further.html#rest_code_042d3557a79841a796b2cd1fc1425d21-12"></a><span class="w">        </span><span class="p">};</span>
<a id="rest_code_042d3557a79841a796b2cd1fc1425d21-13" name="rest_code_042d3557a79841a796b2cd1fc1425d21-13" href="improve-dll-and-etl-compile-time-further.html#rest_code_042d3557a79841a796b2cd1fc1425d21-13"></a>
<a id="rest_code_042d3557a79841a796b2cd1fc1425d21-14" name="rest_code_042d3557a79841a796b2cd1fc1425d21-14" href="improve-dll-and-etl-compile-time-further.html#rest_code_042d3557a79841a796b2cd1fc1425d21-14"></a><span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">threads</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">t</span><span class="p">){</span>
<a id="rest_code_042d3557a79841a796b2cd1fc1425d21-15" name="rest_code_042d3557a79841a796b2cd1fc1425d21-15" href="improve-dll-and-etl-compile-time-further.html#rest_code_042d3557a79841a796b2cd1fc1425d21-15"></a><span class="w">            </span><span class="n">pool</span><span class="p">.</span><span class="n">do_task</span><span class="p">(</span><span class="n">sub_functor</span><span class="p">,</span><span class="w"> </span><span class="n">t</span><span class="p">,</span><span class="w"> </span><span class="n">first</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">batch</span><span class="p">,</span><span class="w"> </span><span class="n">first</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">batch</span><span class="p">);</span>
<a id="rest_code_042d3557a79841a796b2cd1fc1425d21-16" name="rest_code_042d3557a79841a796b2cd1fc1425d21-16" href="improve-dll-and-etl-compile-time-further.html#rest_code_042d3557a79841a796b2cd1fc1425d21-16"></a><span class="w">        </span><span class="p">}</span>
<a id="rest_code_042d3557a79841a796b2cd1fc1425d21-17" name="rest_code_042d3557a79841a796b2cd1fc1425d21-17" href="improve-dll-and-etl-compile-time-further.html#rest_code_042d3557a79841a796b2cd1fc1425d21-17"></a>
<a id="rest_code_042d3557a79841a796b2cd1fc1425d21-18" name="rest_code_042d3557a79841a796b2cd1fc1425d21-18" href="improve-dll-and-etl-compile-time-further.html#rest_code_042d3557a79841a796b2cd1fc1425d21-18"></a><span class="w">        </span><span class="n">acc_functor</span><span class="p">(</span><span class="n">functor</span><span class="p">(</span><span class="n">first</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">threads</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">batch</span><span class="p">,</span><span class="w"> </span><span class="n">last</span><span class="p">));</span>
<a id="rest_code_042d3557a79841a796b2cd1fc1425d21-19" name="rest_code_042d3557a79841a796b2cd1fc1425d21-19" href="improve-dll-and-etl-compile-time-further.html#rest_code_042d3557a79841a796b2cd1fc1425d21-19"></a>
<a id="rest_code_042d3557a79841a796b2cd1fc1425d21-20" name="rest_code_042d3557a79841a796b2cd1fc1425d21-20" href="improve-dll-and-etl-compile-time-further.html#rest_code_042d3557a79841a796b2cd1fc1425d21-20"></a><span class="w">        </span><span class="n">pool</span><span class="p">.</span><span class="n">wait</span><span class="p">();</span>
<a id="rest_code_042d3557a79841a796b2cd1fc1425d21-21" name="rest_code_042d3557a79841a796b2cd1fc1425d21-21" href="improve-dll-and-etl-compile-time-further.html#rest_code_042d3557a79841a796b2cd1fc1425d21-21"></a>
<a id="rest_code_042d3557a79841a796b2cd1fc1425d21-22" name="rest_code_042d3557a79841a796b2cd1fc1425d21-22" href="improve-dll-and-etl-compile-time-further.html#rest_code_042d3557a79841a796b2cd1fc1425d21-22"></a><span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">fut</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">futures</span><span class="p">){</span>
<a id="rest_code_042d3557a79841a796b2cd1fc1425d21-23" name="rest_code_042d3557a79841a796b2cd1fc1425d21-23" href="improve-dll-and-etl-compile-time-further.html#rest_code_042d3557a79841a796b2cd1fc1425d21-23"></a><span class="w">            </span><span class="n">acc_functor</span><span class="p">(</span><span class="n">fut</span><span class="p">);</span>
<a id="rest_code_042d3557a79841a796b2cd1fc1425d21-24" name="rest_code_042d3557a79841a796b2cd1fc1425d21-24" href="improve-dll-and-etl-compile-time-further.html#rest_code_042d3557a79841a796b2cd1fc1425d21-24"></a><span class="w">        </span><span class="p">}</span>
<a id="rest_code_042d3557a79841a796b2cd1fc1425d21-25" name="rest_code_042d3557a79841a796b2cd1fc1425d21-25" href="improve-dll-and-etl-compile-time-further.html#rest_code_042d3557a79841a796b2cd1fc1425d21-25"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="rest_code_042d3557a79841a796b2cd1fc1425d21-26" name="rest_code_042d3557a79841a796b2cd1fc1425d21-26" href="improve-dll-and-etl-compile-time-further.html#rest_code_042d3557a79841a796b2cd1fc1425d21-26"></a><span class="w">        </span><span class="n">acc_functor</span><span class="p">(</span><span class="n">functor</span><span class="p">(</span><span class="n">first</span><span class="p">,</span><span class="w"> </span><span class="n">last</span><span class="p">));</span>
<a id="rest_code_042d3557a79841a796b2cd1fc1425d21-27" name="rest_code_042d3557a79841a796b2cd1fc1425d21-27" href="improve-dll-and-etl-compile-time-further.html#rest_code_042d3557a79841a796b2cd1fc1425d21-27"></a><span class="w">    </span><span class="p">}</span>
<a id="rest_code_042d3557a79841a796b2cd1fc1425d21-28" name="rest_code_042d3557a79841a796b2cd1fc1425d21-28" href="improve-dll-and-etl-compile-time-further.html#rest_code_042d3557a79841a796b2cd1fc1425d21-28"></a><span class="p">}</span>
</pre></div>
<p>I simply preallocate space for all the threads and create a new functor calling the input functor and saving its result inside the vector. It is less nice, but it works well. And it compiles MUCH faster. This <strong>reduced the compilation time</strong> of my biggest test case <strong>by a factor of 8</strong> (from 344 seconds to 44 seconds). This is really crazy. It also fixed the problem where splitting the test case was faster than big file (it is now twice faster to compile the big files than compiling all the small files separately). <strong>This reduced the total compilation time of dll by about 400%</strong>.</p>
<p>As of now, I still have no idea why this makes such a big difference. I have looked at the std::async code, but I haven't found a valid reason for this slowdown. If someone has any idea, I'd be very glad to discuss in the comments below.</p>
</section><section id="improving-the-template-instantiation-tree"><h2>Improving the template instantiation tree</h2>
<p>I recently discovered the templight tool that is a profiler for templates (pretty cool). After some time, I was able to build it and use it on ETL. For now, I haven't been able to reduce compile time a lot, but I have been able to reduce the template instantiation tree a lot seeing that some instantiations were completely useless and I optimized the code to remove them.</p>
<p>I won't be go into much details here because I plan to write a post on this subject in the coming days.</p>
</section><section id="conclusion"><h2>Conclusion</h2>
<p>In conclusion, I would say that it is pretty hard to improve the compile time of complex C++ programs once you have gone through all the standard methods. However, I was very happy to found that <strong>two optimizations in the source code reduced the overall compilation of DLL by almost 500%</strong>. I will continue working on this, but for now, the compilation time is much more reasonable.</p>
<p>I hope the two main facts in this article were interesting. If you have similar experience, comments or ideas for further improvements, I'd be glad to discuss them with you in the comments :)</p>
</section><h3>Related articles</h3>
    

    <li><a href="../../2015/06/how-i-improved-a-bit-compile-time-of-etl.html">How I improved (a bit) compile time of ETL ?</a></li>
<li><a href="../../2017/09/cpp11-concurrency-tutorial-futures.html">C++11 Concurrency Tutorial - Part 5: Futures</a></li>
<li><a href="../../2015/06/continuous-performance-management-with-cpm-for-cpp.html">Continuous Performance Management with CPM for C++</a></li>
<li><a href="../../2017/08/simplify-your-type-traits-with-c++14-variable-templates.html">Simplify your type traits with C++14 variable templates</a></li>
<li><a href="../12/pvs-studio-on-cpp-library-review.html">PVS-Studio on C++ Library Review</a></li>
<li><a href="../../2017/10/expression-templates-library-etl-1-2-complete-gpu-support.html">Expression Templates Library (ETL) 1.2 - Complete GPU support</a></li>


    </div>
    <aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../../../categories/c%2B%2B.html" rel="tag">C++</a></li>
            <li><a class="tag p-category" href="../../../categories/compilers.html" rel="tag">Compilers</a></li>
            <li><a class="tag p-category" href="../../../categories/dll.html" rel="tag">dll</a></li>
            <li><a class="tag p-category" href="../../../categories/etl.html" rel="tag">etl</a></li>
            <li><a class="tag p-category" href="../../../categories/gcc.html" rel="tag">gcc</a></li>
            <li><a class="tag p-category" href="../../../categories/performances.html" rel="tag">Performances</a></li>
        </ul>
<ul class="pager hidden-print">
<li class="previous">
                <a href="../../2015/11/detect-overflows-and-more-in-java-with-cojac.html" rel="prev" title="Detect overflows and more in Java with COJAC">Previous post</a>
            </li>
            <li class="next">
                <a href="../02/use-templight-and-templar-to-debug-cpp-templates.html" rel="next" title="Use templight and Templar to debug C++ templates">Next post</a>
            </li>
        </ul></nav></aside><section class="comments hidden-print"><h2>Comments</h2>
        
    
        <div id="disqus_thread"></div>
        <script>
        var disqus_shortname ="blogwichtounet",
            disqus_url="https://baptiste-wicht.com/posts/2016/01/improve-dll-and-etl-compile-time-further.html",
        disqus_title="Improve DLL and ETL Compile Time further",
        disqus_identifier="cache/posts/2016/01/improve-dll-and-etl-compile-time-further.html",
        disqus_config = function () {
            this.language = "en";
        };
        (function() {
            var dsq = document.createElement('script'); dsq.async = true;
            dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
</noscript>
    <a href="https://disqus.com" class="dsq-brlink" rel="nofollow">Comments powered by <span class="logo-disqus">Disqus</span></a>


        </section></article><script>var disqus_shortname="blogwichtounet";(function(){var a=document.createElement("script");a.async=true;a.src="https://"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents Â© 2025         <a href="mailto:baptistewicht@gmail.com">Baptiste Wicht</a> - Powered by         <a href="http://getnikola.com" rel="nofollow">Nikola</a>         - License: 
<a rel="license" href="http://creativecommons.org/licenses/by/4.0/"><img alt="Creative Commons License" style="padding-left:5px;border-width:0" src="../../../assets/img/cc.png"></a>
            
        </footer>
</div>
</div>


            <script src="../../../assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script>
</body>
</html>
