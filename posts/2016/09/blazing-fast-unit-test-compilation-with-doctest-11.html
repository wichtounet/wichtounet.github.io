<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Blazing fast unit test compilation with doctest 1.1 | Blog blog("Baptiste Wicht");</title>
<link href="../../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" hreflang="en" href="../../../rss.xml">
<link rel="canonical" href="https://baptiste-wicht.com/posts/2016/09/blazing-fast-unit-test-compilation-with-doctest-11.html">
<!--[if lt IE 9]><script src="../../../assets/js/html5.js"></script><![endif]--><meta name="author" content="Baptiste Wicht">
<link rel="prev" href="short-review-of-bullseye-coverage.html" title="Short review of Bullseye Coverage" type="text/html">
<link rel="next" href="../11/zapcc-a-faster-cpp-compiler.html" title="zapcc - a faster C++ compiler" type="text/html">
<meta property="og:site_name" content='Blog blog("Baptiste Wicht");'>
<meta property="og:title" content="Blazing fast unit test compilation with doctest 1.1">
<meta property="og:url" content="https://baptiste-wicht.com/posts/2016/09/blazing-fast-unit-test-compilation-with-doctest-11.html">
<meta property="og:description" content="You may remember my quest for faster compilation times. I had made several changes to the Catch test framework macros in order to save some compilation at the expense of my test code looking a bit les">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2016-09-21T21:45:13+02:00">
<meta property="article:tag" content="C++">
<meta property="article:tag" content="Catch">
<meta property="article:tag" content="Compilers">
<meta property="article:tag" content="doctest">
<meta property="article:tag" content="etl">
<meta property="article:tag" content="gcc">
<meta property="article:tag" content="Performances">
<meta property="article:tag" content="Tests">
<meta property="article:tag" content="time">
<link href="../../../favicon.ico" rel="icon" type="image/x-icon">
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-2175227-7', 'auto');
  var metas = document.getElementsByTagName('meta'), tagsList = [];
  for (var i=0; i<metas.length; i++) {
    if (metas[i].getAttribute('property') == 'article:tag') {
      tagsList.push( metas[i].getAttribute('content'));
    }
  }
  ga('set', 'dimension1', tagsList.join('|'));
  ga('send', 'pageview');
</script>
</head>
<body>

<!-- Menubar -->

<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<div class="container-fluid">
<!-- This keeps the margins nice -->
    <div class="row">
        <div class="col-sm-3 col-lg-2">
            <nav class="navbar navbar-inverse navbar-fixed-side"><div class="navbar-header">
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="https://baptiste-wicht.com/">
                        <span id="blog-title">Blog blog("Baptiste Wicht");</span>
                    </a>
                </div>
<!-- /.navbar-header -->

                <div class="collapse navbar-collapse navbar-ex1-collapse">
                    <ul class="nav navbar-nav">
<li>
<a href="../../../stories/about.html">About</a>
                </li>
<li>
<a href="../../../stories/publications.html">Publications</a>
                </li>
<li>
<a href="../../../stories/projects.html">Projects</a>
                </li>
<li>
<a href="../../../categories/index.html">Tags</a>
                </li>
<li>
<a href="../../../archive.html">Archives</a>


                            </li>
<li class="navbar-content">
                                <h3>Related posts</h3>
                            </li>
                            

                            <li><a href="../../2017/08/compiler-benchmark-gcc-clang-cpp-library-etl.html">Compiler benchmark GCC and Clang on C++ library (ETL)</a></li>
<li><a href="../../2018/02/decrease-dll-neural-network-compilation-time-with-c++17.html">Decrease DLL neural network compilation time with C++17</a></li>
<li><a href="../../2017/03/partial-type-erasing-deep-learning-library-dll-improve-compilation-time.html">Partial type erasing in Deep Learning Library (DLL) to improve compilation time</a></li>
<li><a href="../11/zapcc-a-faster-cpp-compiler.html">zapcc - a faster C++ compiler</a></li>
<li><a href="../../2017/09/how-i-made-deep-learning-library-38-faster-to-compile-optimization-and-cpp17-if-constexpr.html">How I made my Deep Learning Library 38% faster to compile (Optimization and C++17 if constexpr)</a></li>
<li><a href="../../2017/03/release-zapcc-10-fast-cpp-compiler.html">Release of zapcc 1.0 - Fast C++ compiler</a></li>


                            <li class="navbar-block">

                        <li class="wicht-navbar-right">
                            <a target="_blank" title="Follow @wichtounet on Twitter" href="https://twitter.com/wichtounet">
                                <img src="../../../assets/img/twitter.png" alt="Follow @wichtounet on Twitter"></a>
                        </li>

                    </ul>
</div>
<!-- /.navbar-collapse -->
            </nav>
</div> <!-- col -->
        <div class="col-sm-9 col-lg-10">
            <div id="content"></div>
            
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="#" class="u-url">Blazing fast unit test compilation with doctest 1.1</a></h1>

        <div class="metadata">
            <p class="byline author vcard p-author h-card"><span class="byline-name fn p-name" itemprop="author">
                    Baptiste Wicht
            </span></p>
            <p class="dateline">
            <a href="#" rel="bookmark">
            <time class="published dt-published" datetime="2016-09-21T21:45:13+02:00" itemprop="datePublished" title="2016-09-21 21:45">2016-09-21 21:45</time></a>
            </p>
                <p class="commentline">
    
    <a href="blazing-fast-unit-test-compilation-with-doctest-11.html#disqus_thread" data-disqus-identifier="cache/posts/2016/09/blazing-fast-unit-test-compilation-with-doctest-11.html">Comments</a>


            
        </p>
<p class="sourceline"><a href="blazing-fast-unit-test-compilation-with-doctest-11.rst" class="sourcelink">Source</a></p>

        </div>
        

    </header><div class="e-content entry-content" itemprop="articleBody text">
    <p>You may remember <a class="reference external" href="http://baptiste-wicht.com/posts/2016/06/reduce-compilation-time-by-another-16-with-catch.html">my quest for faster compilation times</a>. I had made several changes to the Catch test framework macros in order to save some compilation at the expense of my test code looking a bit less nice:</p>
<div class="code"><pre class="code cpp"><a id="rest_code_2cb655aa7b1545fb8d1b6ed76d6b2256-1" name="rest_code_2cb655aa7b1545fb8d1b6ed76d6b2256-1" href="blazing-fast-unit-test-compilation-with-doctest-11.html#rest_code_2cb655aa7b1545fb8d1b6ed76d6b2256-1"></a><span class="n">REQUIRE</span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">9</span><span class="p">);</span><span class="w"> </span><span class="c1">//Before</span>
<a id="rest_code_2cb655aa7b1545fb8d1b6ed76d6b2256-2" name="rest_code_2cb655aa7b1545fb8d1b6ed76d6b2256-2" href="blazing-fast-unit-test-compilation-with-doctest-11.html#rest_code_2cb655aa7b1545fb8d1b6ed76d6b2256-2"></a><span class="n">REQUIRE_EQUALS</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span><span class="p">);</span><span class="w"> </span><span class="c1">//After</span>
</pre></div>
<p>The first line is a little bit better, but using several optimizations, I was
able to dramatically change the compilation time of the test cases of ETL. In
the end, I don't think that the difference between the two lines justifies the
high overhead in compilation times.</p>
<section id="doctest"><h2>doctest</h2>
<p><a class="reference external" href="https://github.com/onqtam/doctest">doctest</a> is a framework quite similar to
Catch but that claims to be much lighter. I tested doctest 1.0 early on, but at
this point it was actually slower than Catch and especially slower than my
versions of the macro.</p>
<p>Today, doctest 1.1 was released with promises of being even lighter than before
and providing several new ways of speeding up compilation. If you want the
results directly, you can take a look at the next section.</p>
<p>First of all, this new version improved the basic macros to make expression
decomposition faster. When you use the standard REQUIRE macro, the expression is
composed by using several template techniques and operator overloading. This is
really slow to compile. By removing the need for this decomposition, the fast
Catch macros are much faster to compile.</p>
<p>Moreover, doctest 1.1 also introduces CHECK_EQ that does not any expression
decomposition. This is close to what I did in my macros expect that it is
directly integrated into the framework and preserves all its features. It is
also possible to bypass the expression checking code by using FAST_CHECK_EQ
macro. In that case, the exceptions are not captured. Finally, a new
configuration option is introduced (DOCTEST_CONFIG_SUPER_FAST_ASSERTS) that
removes some features related to automatic debugger breaks. Since I don't use
the debugger features and I don't need to capture exception everywhere (it's
sufficient for me that the test fails completely if an exception is thrown), I'm
more than eager to use these new features.</p>
</section><section id="results"><h2>Results</h2>
<p>For evaluation, I have compiled the complete test suite of ETL, with 1 thread,
using gcc 4.9.3 with various different options, starting from Catch to doctest
1.1 with all compilation time features. Here are the results, in seconds:</p>
<table>
<thead><tr>
<th class="head"><p>Version</p></th>
<th class="head"><p>Time</p></th>
<th class="head"><p>VS Catch</p></th>
<th class="head"><p>VS Fast Catch</p></th>
<th class="head"><p>VS doctest 1.0</p></th>
</tr></thead>
<tbody>
<tr>
<td><p>Catch</p></td>
<td><p>724.22</p></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td><p>Fast Catch</p></td>
<td><p>464.52</p></td>
<td><p>-36%</p></td>
<td></td>
<td></td>
</tr>
<tr>
<td><p>doctest 1.0</p></td>
<td><p>871.54</p></td>
<td><p>+20%</p></td>
<td><p>+87%</p></td>
<td></td>
</tr>
<tr>
<td><p>doctest 1.1</p></td>
<td><p>614.67</p></td>
<td><p>-16%</p></td>
<td><p>+32%</p></td>
<td><p>-30%</p></td>
</tr>
<tr>
<td><p>REQUIRE_EQ</p></td>
<td><p>493.97</p></td>
<td><p>-32%</p></td>
<td><p>+6%</p></td>
<td><p>-43%</p></td>
</tr>
<tr>
<td><p>FAST_REQUIRE_EQ</p></td>
<td><p>439.09</p></td>
<td><p>-39%</p></td>
<td><p>-6%</p></td>
<td><p>-50%</p></td>
</tr>
<tr>
<td><p>SUPER_FAST_ASSERTS</p></td>
<td><p>411.11</p></td>
<td><p>-43%</p></td>
<td><p>-12%</p></td>
<td><p>-53%</p></td>
</tr>
</tbody>
</table>
<p>As you can see, doctest 1.1 is much faster to compile than doctest 1.0! This is
really great news. Moreover, it is already 16% faster than Catch. When all the
features are used, doctest is 12% faster than my stripped down versions of Catch
macros (and 43% faster than Catch standard macros). This is really cool! It
means that I don't have to do any change in the code (no need to strip macros
myself) and I can gain a lot of compilation time compared to the bare Catch
framework.</p>
<p>I really think the author of doctest did a great job with the new version.
Although this was not of as much interest for me, there are also a lot of
other changes in the new version. You can consult the
<a class="reference external" href="https://github.com/onqtam/doctest/blob/master/CHANGELOG.md">changelog</a> if you want more information.</p>
</section><section id="conclusion"><h2>Conclusion</h2>
<p>Overall, doctest 1.1 is much faster to compile than doctest 1.0. Moreover, it
offers very fast macros for test assertions that are much faster to compile
than Catch versions and even faster than the versions I created myself to reduce
compilation time. I really thing this is a great advance for doctest. When
compiling with all the optimizations, doctest 1.1 saves me 50 seconds in
compilation time compared to the fast version of Catch macro and more than
5 minutes compared to the standard version of Catch macros.</p>
<p>I'll probably start using doctest on my development machine. For now, I'll keep
Catch as well since I need it to generate the unit test reports in XML format
for Sonarqube. Once this feature appears in doctest, I'll probably drop Catch
from ETL and DLL</p>
<p>If you need blazing fast compilation times for your unit tests, doctest 1.1 is
probably the way to go.</p>
</section>
</div>
    <aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../../../categories/c%2B%2B.html" rel="tag">C++</a></li>
            <li><a class="tag p-category" href="../../../categories/catch.html" rel="tag">Catch</a></li>
            <li><a class="tag p-category" href="../../../categories/compilers.html" rel="tag">Compilers</a></li>
            <li><a class="tag p-category" href="../../../categories/doctest.html" rel="tag">doctest</a></li>
            <li><a class="tag p-category" href="../../../categories/etl.html" rel="tag">etl</a></li>
            <li><a class="tag p-category" href="../../../categories/gcc.html" rel="tag">gcc</a></li>
            <li><a class="tag p-category" href="../../../categories/performances.html" rel="tag">Performances</a></li>
            <li><a class="tag p-category" href="../../../categories/tests.html" rel="tag">Tests</a></li>
            <li><a class="tag p-category" href="../../../categories/time.html" rel="tag">time</a></li>
        </ul>
<ul class="pager hidden-print">
<li class="previous">
                <a href="short-review-of-bullseye-coverage.html" rel="prev" title="Short review of Bullseye Coverage">Previous post</a>
            </li>
            <li class="next">
                <a href="../11/zapcc-a-faster-cpp-compiler.html" rel="next" title="zapcc - a faster C++ compiler">Next post</a>
            </li>
        </ul></nav></aside><section class="comments hidden-print"><h2>Comments</h2>
        
    
        <div id="disqus_thread"></div>
        <script>
        var disqus_shortname ="blogwichtounet",
            disqus_url="https://baptiste-wicht.com/posts/2016/09/blazing-fast-unit-test-compilation-with-doctest-11.html",
        disqus_title="Blazing fast unit test compilation with doctest 1.1",
        disqus_identifier="cache/posts/2016/09/blazing-fast-unit-test-compilation-with-doctest-11.html",
        disqus_config = function () {
            this.language = "en";
        };
        (function() {
            var dsq = document.createElement('script'); dsq.async = true;
            dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
</noscript>
    <a href="https://disqus.com" class="dsq-brlink" rel="nofollow">Comments powered by <span class="logo-disqus">Disqus</span></a>


        </section></article><script>var disqus_shortname="blogwichtounet";(function(){var a=document.createElement("script");a.async=true;a.src="https://"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script>
</div> <!-- col -->
    </div>
<!-- row  -->
</div>
<!-- container-fluid -->

<!-- End of Menubar -->

<!-- Footer -->

<footer>
    Contents Â© 2023         <a href="mailto:baptistewicht@gmail.com">Baptiste Wicht</a> - Powered by         <a href="http://getnikola.com" rel="nofollow">Nikola</a>         - License: 
<a rel="license" href="http://creativecommons.org/licenses/by/4.0/"><img alt="Creative Commons License" style="padding-left:5px;border-width:0" src="../../../assets/img/cc.png"></a>
        <ul class="footer_inline_ul">
<li>
    <a href="blazing-fast-unit-test-compilation-with-doctest-11.rst" id="sourcelink">Source</a>
    </li>

        </ul></footer><!-- Late loading stuff  --><script src="../../../assets/js/all-nocdn.js"></script><!-- Google platform JS -->
</body>
</html>
