<!DOCTYPE html>
<html lang=en><head><link href=favicon.ico rel=icon type=image/x-icon><meta name=viewport content="width=device-width, initial-scale=1.0"><meta charset=utf-8><meta name=viewport content="width=device-width, initial-scale=1.0"><meta name=author content="Baptiste Wicht"><title>Thor OS: Boot Process | @Blog("Baptiste Wicht")</title><link href=../../../assets/css/all-nocdn.css rel=stylesheet type=text/css><link rel=canonical href=http://baptiste-wicht.com/posts/2013/12/thor-os-boot-process.html><link rel=alternate type=application/rss+xml title=RSS href=../../../rss.xml><script type=text/javascript>
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-2175227-7']);
  _gaq.push(['_trackPageview']);
  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script></head><body><div class=social_container> <div class=social_container_gplus> <a target=_blank title="Share on Google+" href="https://plusone.google.com/_/+1/confirm?hl=en&amp;url=http://baptiste-wicht.com/posts/2013/12/thor-os-boot-process.html"><img src=../../../assets/img/google_plus.png></a> </div> <div class=social_container_facebook> <a target=_blank title="Share on Facebook" href="http://www.facebook.com/sharer/sharer.php?u=#url"><img src=../../../assets/img/facebook.png></a> </div> <div class=social_container_twitter> <a target=_blank title="Tweet on Twitter" href="http://twitter.com/home?status=#url"><img src=../../../assets/img/twitter.svg></a> </div></div><nav class="navbar navbar-inverse navbar-fixed-top" role=navigation> <div class=container-fluid> <div class=navbar-header> <button type=button class=navbar-toggle data-toggle=collapse data-target=.navbar-ex1-collapse> <span class=sr-only>Toggle navigation</span> <span class=icon-bar></span> <span class=icon-bar></span> <span class=icon-bar></span> </button> <a class=navbar-brand href=http://baptiste-wicht.com/>@Blog("Baptiste Wicht")</a> </div> <div class="collapse navbar-collapse navbar-ex1-collapse"> <ul class="nav navbar-nav"> <li><a href=../../../stories/about.html>About</a> </li><li><a href=../../../stories/publications.html>Publications</a> </li><li><a href=../../../stories/donate.html>Donate</a> </li><li><a href=../../../stories/contact.html>Contact</a> </li><li><a href=../../../stories/faq.html>FAQ</a> </li><li><a href=../../../stories/legal.html>Legal</a> </li><li><a href=../../../categories/index.html>Tags</a> </li><li><a href=../../../archive.html>Archives</a> </li><li><a href=http://feeds.feedburner.com/BaptisteWicht>RSS</a> </li></ul> <span class="navbar-form pull-left"> <form action=../../../stories/search.html> <input type=text name=q id=tipue_search_input> </form> </span> <ul class="nav navbar-nav navbar-right"> <li> <a target=_blank title="Follow @wichtounet on Twitter" href=https://twitter.com/wichtounet> <img src=../../../assets/img/twitter.svg alt="Follow @wichtounet on Twitter"> </a> </li> <li> <a target=_blank title="Follow +BaptisteWicht on Google+" href=https://plus.google.com/+BaptisteWicht> <img src=../../../assets/img/google_plus.svg alt="Follow +BaptisteWicht on Google+"> </a> </li> </ul> </div> </div></nav><div class=body-container> <div class=left-sidebar> <div class=left-sidebar-widget> <div class=left-sidebar-widget-content> <div class=g-person data-width=275 data-href=//plus.google.com/u/0/103113673902796202116 data-theme=dark data-layout=landscape data-rel=author></div> </div> </div> <div class=left-sidebar-widget> <h3>Related posts</h3> <div class=left-sidebar-widget-content> <ol><li><a href=new-hobby-project-thor-os-64bit-operating-system-c.html>New hobby project: Thor-OS, 64bit Operating System in C++</a></li><li><a href=../../2011/11/dynamic-memory-allocation-intel-assembly-linux.html>Dynamic memory allocation in Intel Assembly on Linux</a></li><li><a href=../../2012/08/memory-manager-intel-assembly-64-linux.html>Memory Manager in 64bits Intel Assembly on Linux</a></li><li><a href=../../2012/04/linux-kernel-tip-do-not-disable-system-v-ipc-for-x-org-and-chrome.html>Linux Kernel Tip : Do not disable System V IPC for X.Org and Chrome</a></li><li><a href=../../2010/08/presentation-usage-h2-database-engine.html>Presentation and use of H2 Database Engine</a></li></ol> </div> </div> <div class=left-sidebar-widget> <h3>Recent comments</h3> <div class=left-sidebar-widget-content> <div id=recentcomments class=dsq-widget> <script type=text/javascript src="http://blogwichtounet.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=0&amp;avatar_size=28&amp;excerpt_length=50"></script> </div> </div> </div> <div class=left-sidebar-widget> <h3>Blogroll</h3> <div class=left-sidebar-widget-content> <ul> <li><a target=_blank href=http://www.asjava.com/>AsJava.com : Java Tutorial</a></li> <li><a target=_blank href=http://www.mkyong.com/>Mkyong : Java Tutorials</a></li> </ul> </div> </div> </div> <div class=container> <div class=body-content> <div class=row> <article class="postbox post-text"> <div class=h-entry itemscope=itemscope itemtype=http://schema.org/Article> <h1 class=p-name itemprop="headline name">Thor OS: Boot Process</h1> <hr> <small> Posted: <time class="published dt-published" datetime=2013-12-23T09:18:01+01:00 itemprop=datePublished>2013-12-23 09:18</time> | More posts about <span itemprop=keywords> <a class="tag p-category" href=../../../categories/assembly.html><span class="badge badge-info">Assembly</span></a> <a class="tag p-category" href=../../../categories/c.html><span class="badge badge-info">C++</span></a> <a class="tag p-category" href=../../../categories/operating-systems.html><span class="badge badge-info">Operating Systems</span></a> <a class="tag p-category" href=../../../categories/osdev.html><span class="badge badge-info">osdev</span></a> <a class="tag p-category" href=../../../categories/thor.html><span class="badge badge-info">thor</span></a> </span> </small> <hr> <div class=e-content itemprop="articleBody text"> <div><p>Some time ago, I started a hobby project: <a title="New hobby project: Thor-OS, 64bit Operating System in C++" href=http://www.baptiste-wicht.com/2013/12/new-hobby-project-thor-os-64bit-operating-system-c/>writing a new operating system</a>. I'm not trying to create a concurrent to Linux, I'm just trying to learn some more stuff about operating systems. I'm gonna try to write some posts about this kernel on this blog.</p><p>In this post, I'll describe the boot process I've written for this operating system.</p><h3>Bootloader Step</h3><p>The first step is of course the bootloader. The bootloader is in the MBR and is loaded by the system at 0x7C00.</p><p>I'm doing the bootloading in two stages. The first stage (one sector) print some messages and then load the second stage (one sector) from floppy at 0x900. The goal of doing it in two stages is just to be able to overwrite the bootloader memory by the stage. The second stage loads the kernel into memory from floppy. The kernel is loaded at 0x1000 and then run directly.</p><p>The bootloader stages are written in assembly.</p><h3>Real mode</h3><p>When the processor, it boots in real mode (16 bits) and you have to setup plenty of things before you can go into long mode (64 bits). So the first steps of the kernel are running in 16 bits. The kernel is mostly written in C++ with some inline assembly.</p><p>Here are all the things that are done in this mode:</p><ol> <li>The memory is inspected using BIOS E820 function. It is necessary to do that at this point since BIOS function calls are not available after going to protected mode. This function gives a map of the available memory. The map is used later by the dynamic memory allocator.</li> <li>The interrupts are disabled and a fake Interrupt Descriptor Table is configured to make sure no interrupt are thrown in protected mode</li> <li>The Global Descriptor Table is setup. This table describes the different portion of the memory and what each process can do with each portion of the memory. I have three descriptors: a 32bit code segment, a data segment and a 64bit code segment.</li> <li>Protected mode is activated by setting PE bit of CR0 control register.</li> <li>Disable paging</li> <li>Jump to the next step. It is necessary to use a far jump so that the code segment is changed.</li></ol><h3>Protected Mode</h3><p>At this point, the processor is running in protected mode (32 bits). BIOS interrupts are not available anymore.</p><p>Again, several steps are necessary:</p><ol> <li>To be able to use all memory, Physical Address Extensions are activated.</li> <li>Long Mode is enabled by setting the EFER.LME bit.</li> <li>Paging is setup, the first MiB of memory is mapped to the exact same virtual addresses.</li> <li>The address of the Page-Map Level 4 Table is set in the CR0 register.</li> <li>Finally paging is activated.</li> <li>Jump to the real mode kernel, again by using a far jump to change code segment.</li></ol><h3>Real Mode</h3><p>The kernel finally runs in 64 bits.</p><p>There are still some initialization steps that needs to be done:</p><ol> <li>SSE extensions are enabled.</li> <li>The final Interrupt Descriptor Table is setup.</li> <li>ISRs are created for each possible processor exception</li> <li>The IRQs are installed in the IDT</li> <li>Interrupts are enabled</li></ol><p>At this point, is kernel is fully loaded and starts initialization stuff like loading drivers, preparing memory, setting up timers...</p><p>If you want more information about this process, you can read the different source files involved (stage1.asm, stage2.asm, boot_16.cpp, boot_32.cpp and kernel.cpp) and if you have any question, you can comment on this post.</p></div> </div> </div> <ul class=pager> <li class=previous> <a href=new-hobby-project-thor-os-64bit-operating-system-c.html rel=prev>← Previous post</a> </li> <li class=next> <a href=zabbix-low-level-discovery-cores-cpus-hard-disk.html rel=next>Next post →</a> </li> </ul> <div id=disqus_thread></div> <script>
        var disqus_shortname ="blogwichtounet",
            disqus_url="http://baptiste-wicht.com/posts/2013/12/thor-os-boot-process.html",
        disqus_title="Thor OS: Boot Process",
        disqus_identifier="cache/posts/2013/12/thor-os-boot-process.html",
        disqus_config = function () {
            this.language = "en";
        };
        (function() {
            var dsq = document.createElement('script'); dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script> <noscript>Please enable JavaScript to view the <a href=http://disqus.com/?ref_noscript rel=nofollow>comments powered by Disqus.</a></noscript> <a href=http://disqus.com class=dsq-brlink rel=nofollow>Comments powered by <span class=logo-disqus>Disqus</span></a> </article> </div> </div> </div></div><footer> Contents © 2014 <a href=mailto:baptistewicht@gmail.com>Baptiste Wicht</a> - Powered by <a href=http://getnikola.com rel=nofollow>Nikola</a><a rel=license href=http://creativecommons.org/licenses/by/4.0/><img alt="Creative Commons License" style=padding-left:5px;border-width:0 src=../../../assets/img/cc.png></a> <ul class=footer_inline_ul> <li> <a href=thor-os-boot-process.wp id=sourcelink>Source</a> </li> </ul></footer> <script src=../../../assets/js/all-nocdn.js type=text/javascript></script><script type=text/javascript src=https://apis.google.com/js/platform.js></script></body></html>