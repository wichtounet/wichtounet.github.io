<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="How I decreased the compilation of DLL neural networks using C++17.">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Decrease DLL neural network compilation time with C++17 | Blog blog("Baptiste Wicht");</title>
<link href="../../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" hreflang="en" href="../../../rss.xml">
<link rel="canonical" href="https://baptiste-wicht.com/posts/2018/02/decrease-dll-neural-network-compilation-time-with-c%2B%2B17.html">
<!--[if lt IE 9]><script src="../../../assets/js/html5.js"></script><![endif]--><meta name="author" content="Baptiste Wicht">
<link rel="prev" href="c%2B%2B17-migration-of-expression-templates-library-etl.html" title="C++17 Migration of Expression Templates Library (ETL)" type="text/html">
<link rel="next" href="../03/i-got-rid-of-vivaldi-browser-for-google-chrome.html" title="I got rid of Vivaldi browser for Google Chrome" type="text/html">
<meta property="og:site_name" content='Blog blog("Baptiste Wicht");'>
<meta property="og:title" content="Decrease DLL neural network compilation time with C++17">
<meta property="og:url" content="https://baptiste-wicht.com/posts/2018/02/decrease-dll-neural-network-compilation-time-with-c%2B%2B17.html">
<meta property="og:description" content="How I decreased the compilation of DLL neural networks using C++17.">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2018-02-07T11:39:02+01:00">
<meta property="article:tag" content="C++">
<meta property="article:tag" content="C++17">
<meta property="article:tag" content="clang">
<meta property="article:tag" content="Compilers">
<meta property="article:tag" content="Deep Learning">
<meta property="article:tag" content="dll">
<meta property="article:tag" content="etl">
<meta property="article:tag" content="gcc">
<meta property="article:tag" content="Machine Learning">
<meta property="article:tag" content="Performance">
<meta property="article:tag" content="projects">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://baptiste-wicht.com/">

                <span id="blog-title">Blog blog("Baptiste Wicht");</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="../../../stories/about.html">About</a>
                </li>
<li>
<a href="../../../stories/publications.html">Publications</a>
                </li>
<li>
<a href="../../../stories/projects.html">Projects</a>
                </li>
<li>
<a href="../../../categories/index.html">Tags</a>
                </li>
<li>
<a href="../../../archive.html">Archives</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right">
<li>
    <a href="decrease-dll-neural-network-compilation-time-with-c%2B%2B17.rst" id="sourcelink">Source</a>
    </li>

                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="decrease-dll-neural-network-compilation-time-with-c%2B%2B17.html" class="u-url">Decrease DLL neural network compilation time with C++17</a></h1>

        <div class="metadata">
            <p class="byline author vcard p-author h-card"><span class="byline-name fn p-name" itemprop="author">
                    Baptiste Wicht
            </span></p>
            <p class="dateline">
            <a href="decrease-dll-neural-network-compilation-time-with-c%2B%2B17.html" rel="bookmark">
            <time class="published dt-published" datetime="2018-02-07T11:39:02+01:00" itemprop="datePublished" title="2018-02-07 11:39">2018-02-07 11:39</time></a>
            </p>
                <p class="commentline">
    
    <a href="decrease-dll-neural-network-compilation-time-with-c%2B%2B17.html#disqus_thread" data-disqus-identifier="cache/posts/2018/02/decrease-dll-neural-network-compilation-time-with-c++17.html">Comments</a>


            
        </p>
<p class="sourceline"><a href="decrease-dll-neural-network-compilation-time-with-c%2B%2B17.rst" class="sourcelink">Source</a></p>

        </div>
        

    </header><div class="e-content entry-content" itemprop="articleBody text">
    <p>Just last week, <a class="reference external" href="https://baptiste-wicht.com/posts/2018/02/c%2B%2B17-migration-of-expression-templates-library-etl.html">I've migrated my Expression Templates Library (ETL) library to C++17</a>,
it is now also done in my Deep Learning Library (DLL) library. In ETL, this
resulted in a <em>much nicer code overall</em>, but no real improvement in compilation
time.</p>
<p>The objective of the migration of DLL was two-fold. First, I also wanted to
simplify some code, especially with <code>if constexpr</code>. But I also especially
wanted to try to reduce the compilation time. In the past,
<a class="reference external" href="https://baptiste-wicht.com/posts/2017/09/how-i-made-deep-learning-library-38-faster-to-compile-optimization-and-cpp17-if-constexpr.html">I've already tried a few changes with C++17</a>, with good results on the compilation of the entire test suite.
While this is very good, this is not very representative of users of the library.
Indeed, normally you'll have only one network in your source file not several.
The new changes will especially help in the case of many networks, but less in
the case of a single network per source file.</p>
<p>This time, I decided to test the compilation on the examples. I've tested the
eight official examples from the DLL library:</p>
<ol class="arabic simple" start="0">
<li><p>mnist_dbn: A fully-connected Deep Belief Network (DBN) on the MNIST data set
with three layers</p></li>
<li><p>char_cnn: A special CNN with embeddings and merge and group layers for text
recognition</p></li>
<li><p>imagenet_cnn: A 12 layers Convolutional Neural Network (CNN) for Imagenet</p></li>
<li><p>mnist_ae: A simple two-layers auto-encoder for MNIST</p></li>
<li><p>mnist_cnn: A simple 6 layers CNN for MNIST</p></li>
<li><p>mnist_deep_ae: A deep auto-encoder for MNIST, only fully-connected</p></li>
<li><p>mnist_lstm: A Recurrent Neural Network (RNN) with Long Short Term Memory
(LSTM) cells</p></li>
<li><p>mnist_mlp: A simple fully-connected network for MNIST, with dropout</p></li>
<li><p>mnist_rnn: A simple RNN with simple cells for MNIST</p></li>
</ol>
<p>This is really representative of what users can do with the library and I think
it's a much better for compilation time.</p>
<p>For reference, you can find <a class="reference external" href="https://github.com/wichtounet/dll/tree/master/examples/src">the source code of all the examples online</a>.</p>
<section id="results"><h2>Results</h2>
<p>Let's start with the results. I've tested this at different stages of the
migration with clang 5 and GCC 7.2. I tested the following steps:</p>
<ol class="arabic simple">
<li><p>The original C++14 version</p></li>
<li><p>Simply compiling in c++17 mode (-std=c++17)</p></li>
<li><p>Using the C++17 version of the ETL library</p></li>
<li><p>Upgrading DLL to C++17 (without ETL)</p></li>
<li><p>ETL and DLL in C++17 versions</p></li>
</ol>
<p>I've compiled each example independently in release_debug mode. Here are the
results for G++ 7.2:</p>
<table class="align-center">
<thead><tr>
<th class="head"><p>Example</p></th>
<th class="head"><p>0</p></th>
<th class="head"><p>1</p></th>
<th class="head"><p>2</p></th>
<th class="head"><p>3</p></th>
<th class="head"><p>4</p></th>
<th class="head"><p>5</p></th>
<th class="head"><p>6</p></th>
<th class="head"><p>7</p></th>
<th class="head"><p>8</p></th>
</tr></thead>
<tbody>
<tr>
<td><p>C++14</p></td>
<td><p>37.818</p></td>
<td><p>32.944</p></td>
<td><p>33.511</p></td>
<td><p>15.403</p></td>
<td><p>29.998</p></td>
<td><p>16.911</p></td>
<td><p>24.745</p></td>
<td><p>18.974</p></td>
<td><p>19.006</p></td>
</tr>
<tr>
<td><p>-std=c++17</p></td>
<td><p>38.358</p></td>
<td><p>32.409</p></td>
<td><p>32.707</p></td>
<td><p>15.810</p></td>
<td><p>30.042</p></td>
<td><p>16.896</p></td>
<td><p>24.635</p></td>
<td><p>19.134</p></td>
<td><p>19.027</p></td>
</tr>
<tr>
<td><p>ETL C++17</p></td>
<td><p>36.045</p></td>
<td><p>31.000</p></td>
<td><p>30.942</p></td>
<td><p>15.322</p></td>
<td><p>28.840</p></td>
<td><p>16.747</p></td>
<td><p>24.151</p></td>
<td><p>18.208</p></td>
<td><p>18.939</p></td>
</tr>
<tr>
<td><p>DLL C++17</p></td>
<td><p>35.251</p></td>
<td><p>32.577</p></td>
<td><p>32.854</p></td>
<td><p>15.653</p></td>
<td><p>29.758</p></td>
<td><p>16.851</p></td>
<td><p>24.606</p></td>
<td><p>19.098</p></td>
<td><p>19.146</p></td>
</tr>
<tr>
<td><p>Final C++17</p></td>
<td><p>32.289</p></td>
<td><p>31.133</p></td>
<td><p>30.939</p></td>
<td><p>15.232</p></td>
<td><p>28.753</p></td>
<td><p>16.526</p></td>
<td><p>24.326</p></td>
<td><p>18.116</p></td>
<td><p>17.819</p></td>
</tr>
<tr>
<td><p>Final Improvement</p></td>
<td><p>14.62%</p></td>
<td><p>5.49%</p></td>
<td><p>7.67%</p></td>
<td><p>1.11%</p></td>
<td><p>4.15%</p></td>
<td><p>2.27%</p></td>
<td><p>1.69%</p></td>
<td><p>4.52%</p></td>
<td><p>6.24%</p></td>
</tr>
</tbody>
</table>
<p>The difference by just enabling c++17 is not significant. On the other hand,
some significant gain can be obtained by using the C++17 version of ETL,
especially for the DBN version and for the CNN versions. Except for the DBN
case, the migration of DLL to C++17 did not bring any significant advantage.
When everything is combined, the gains are more important :) In the best case,
the example is 14.6% faster to compile.</p>
<p>Let's see if it's the same with clang++ 5.0:</p>
<table class="align-center">
<thead><tr>
<th class="head"><p>Example</p></th>
<th class="head"><p>0</p></th>
<th class="head"><p>1</p></th>
<th class="head"><p>2</p></th>
<th class="head"><p>3</p></th>
<th class="head"><p>4</p></th>
<th class="head"><p>5</p></th>
<th class="head"><p>6</p></th>
<th class="head"><p>7</p></th>
<th class="head"><p>8</p></th>
</tr></thead>
<tbody>
<tr>
<td><p>C++14</p></td>
<td><p>40.690</p></td>
<td><p>34.753</p></td>
<td><p>35.488</p></td>
<td><p>16.146</p></td>
<td><p>31.926</p></td>
<td><p>17.708</p></td>
<td><p>29.806</p></td>
<td><p>19.207</p></td>
<td><p>20.858</p></td>
</tr>
<tr>
<td><p>-std=c++17</p></td>
<td><p>40.502</p></td>
<td><p>34.664</p></td>
<td><p>34.990</p></td>
<td><p>16.027</p></td>
<td><p>31.510</p></td>
<td><p>17.630</p></td>
<td><p>29.465</p></td>
<td><p>19.161</p></td>
<td><p>20.860</p></td>
</tr>
<tr>
<td><p>ETL C++17</p></td>
<td><p>37.386</p></td>
<td><p>33.008</p></td>
<td><p>33.896</p></td>
<td><p>15.519</p></td>
<td><p>30.269</p></td>
<td><p>16.995</p></td>
<td><p>28.897</p></td>
<td><p>18.383</p></td>
<td><p>19.809</p></td>
</tr>
<tr>
<td><p>DLL C++17</p></td>
<td><p>37.252</p></td>
<td><p>34.592</p></td>
<td><p>35.250</p></td>
<td><p>16.131</p></td>
<td><p>31.782</p></td>
<td><p>17.606</p></td>
<td><p>29.595</p></td>
<td><p>19.126</p></td>
<td><p>20.782</p></td>
</tr>
<tr>
<td><p>Final C++17</p></td>
<td><p>34.470</p></td>
<td><p>33.154</p></td>
<td><p>33.881</p></td>
<td><p>15.415</p></td>
<td><p>30.279</p></td>
<td><p>17.078</p></td>
<td><p>28.808</p></td>
<td><p>18.497</p></td>
<td><p>19.761</p></td>
</tr>
<tr>
<td><p>Final Improvement</p></td>
<td><p>15.28%</p></td>
<td><p>4.60%</p></td>
<td><p>4.52%</p></td>
<td><p>4.52%</p></td>
<td><p>5.15%</p></td>
<td><p>3.55%</p></td>
<td><p>3.34%</p></td>
<td><p>3.69%</p></td>
<td><p>5.25%</p></td>
</tr>
</tbody>
</table>
<p>First of all, as I have seen time after time, clang is still slower than GCC.
It's a not a big difference, but still significant. Overall, the gains are a bit
higher on clang than on GCC, but not by much. Interestingly, the migration of
DLL to C++17 is less interesting in terms of compilation time for clang. It
seems even to slow down compilation on some examples. On the other hand, the
migration of ETL is more important than on GCC.</p>
<p>Overall, every example is faster to compile using both libraries in C++17, but
we don't have spectacular speed-ups. With clang, we have speedups from 3.3% to
15.3%. With GCC, we have speedup  from 1.1% to 14.6%. It's not very high, but
I'm already satisfied with these results.</p>
</section><section id="c-17-in-dll"><h2>C++17 in DLL</h2>
<p>Overall, the migration of DLL to C++17 was quite similar to that of ETL. You can
take a look at my <a class="reference external" href="https://baptiste-wicht.com/posts/2018/02/c%2B%2B17-migration-of-expression-templates-library-etl.html">previous article</a>
if you want more details on C++17 features I've used.</p>
<p>I've <em>replaced a lot of SFINAE functions</em> with <code>if constexpr</code>. I've also
replaced a lot of <code>statif_if</code> with <code>if constexpr</code>. There was a large
number of these in DLL's code. I also enabled all the <code>constexpr</code> that
were commented for this exact time :)</p>
<p>I was also thinking that I could replace a lot of meta-programming stuff with
<em>fold expressions</em>. While I was able to replace a few of them, most of them were
harder to replace with fold expressions. Indeed, the variadic pack is often
hidden behind another class and therefore the pack is not directly usable from
the network class or the group and merge layers classes. I didn't want to start
a big refactoring just to use a C++17 feature, the current state of this code is
fine.</p>
<p>I made some use of structured bindings as well, but again not as much as I was
thinking. In fact, a lot of time, I'm assigning the elements of a pair or tuple
to existing variables not declaring new variables and unfortunately, you can
only use structured bindings with <code>auto</code> declaration.</p>
<p>Overall, the <em>code is significantly better now</em>, but there was less impact than
there was on ETL. It's also a smaller code base, so maybe this is normal and my
expectations were too high ;)</p>
</section><section id="conclusion"><h2>Conclusion</h2>
<p>The trunk of DLL is now a C++17 library :) I think this improve the quality of
the code by a nice margin! Even though, there is still some work to be done to
improve the code, especially for the DBN pretraining code, the quality is quite
good now. Moreover, the switch to C++17 made the compilation of neural networks
using the DLL library <em>faster to compile</em>, from 1.1% in the worst case to 15.3% in
the best case! I don't know when I will release the next version of DLL, but it
will take some time. I'll especially have to polish the RNN support and add
a sequence to sequence loss before I will release the 1.1 version of DLL.</p>
<p>I'm quite satisfied with C++17 even if I would have liked a bit more features to
play with! I'm already a big fan of <code>if constexpr</code>, this can make the code
much nicer and fold expressions are much more intuitive than their previous
recursive template counterpart.</p>
<p>I may also consider migrating some parts of the cpp-utils library, but if I do,
it will only be through the use of conditionals in order not to break the other
projects that are based on the library.</p>
</section><h3>Related articles</h3>
    

    <li><a href="../../2017/08/compiler-benchmark-gcc-clang-cpp-library-etl.html">Compiler benchmark GCC and Clang on C++ library (ETL)</a></li>
<li><a href="../../2017/09/how-i-made-deep-learning-library-38-faster-to-compile-optimization-and-cpp17-if-constexpr.html">How I made my Deep Learning Library 38% faster to compile (Optimization and C++17 if constexpr)</a></li>
<li><a href="../../2017/03/partial-type-erasing-deep-learning-library-dll-improve-compilation-time.html">Partial type erasing in Deep Learning Library (DLL) to improve compilation time</a></li>
<li><a href="../../2016/11/zapcc-a-faster-cpp-compiler.html">zapcc - a faster C++ compiler</a></li>
<li><a href="../../2016/12/zapcc-cpp-compilation-speed-against-gcc-54-and-clang-39.html">zapcc C++ compilation speed against gcc 5.4 and clang 3.9</a></li>
<li><a href="../../2017/03/release-zapcc-10-fast-cpp-compiler.html">Release of zapcc 1.0 - Fast C++ compiler</a></li>


    </div>
    <aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../../../categories/c%2B%2B.html" rel="tag">C++</a></li>
            <li><a class="tag p-category" href="../../../categories/c%2B%2B17.html" rel="tag">C++17</a></li>
            <li><a class="tag p-category" href="../../../categories/clang.html" rel="tag">clang</a></li>
            <li><a class="tag p-category" href="../../../categories/compilers.html" rel="tag">Compilers</a></li>
            <li><a class="tag p-category" href="../../../categories/deep-learning.html" rel="tag">Deep Learning</a></li>
            <li><a class="tag p-category" href="../../../categories/dll.html" rel="tag">dll</a></li>
            <li><a class="tag p-category" href="../../../categories/etl.html" rel="tag">etl</a></li>
            <li><a class="tag p-category" href="../../../categories/gcc.html" rel="tag">gcc</a></li>
            <li><a class="tag p-category" href="../../../categories/machine-learning.html" rel="tag">Machine Learning</a></li>
            <li><a class="tag p-category" href="../../../categories/performance.html" rel="tag">Performance</a></li>
            <li><a class="tag p-category" href="../../../categories/projects.html" rel="tag">projects</a></li>
        </ul>
<ul class="pager hidden-print">
<li class="previous">
                <a href="c%2B%2B17-migration-of-expression-templates-library-etl.html" rel="prev" title="C++17 Migration of Expression Templates Library (ETL)">Previous post</a>
            </li>
            <li class="next">
                <a href="../03/i-got-rid-of-vivaldi-browser-for-google-chrome.html" rel="next" title="I got rid of Vivaldi browser for Google Chrome">Next post</a>
            </li>
        </ul></nav></aside><section class="comments hidden-print"><h2>Comments</h2>
        
    
        <div id="disqus_thread"></div>
        <script>
        var disqus_shortname ="blogwichtounet",
            disqus_url="https://baptiste-wicht.com/posts/2018/02/decrease-dll-neural-network-compilation-time-with-c%2B%2B17.html",
        disqus_title="Decrease DLL neural network compilation time with C++17",
        disqus_identifier="cache/posts/2018/02/decrease-dll-neural-network-compilation-time-with-c++17.html",
        disqus_config = function () {
            this.language = "en";
        };
        (function() {
            var dsq = document.createElement('script'); dsq.async = true;
            dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
</noscript>
    <a href="https://disqus.com" class="dsq-brlink" rel="nofollow">Comments powered by <span class="logo-disqus">Disqus</span></a>


        </section></article><script>var disqus_shortname="blogwichtounet";(function(){var a=document.createElement("script");a.async=true;a.src="https://"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2023         <a href="mailto:baptistewicht@gmail.com">Baptiste Wicht</a> - Powered by         <a href="http://getnikola.com" rel="nofollow">Nikola</a>         - License: 
<a rel="license" href="http://creativecommons.org/licenses/by/4.0/"><img alt="Creative Commons License" style="padding-left:5px;border-width:0" src="../../../assets/img/cc.png"></a>
            
        </footer>
</div>
</div>


            <script src="../../../assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script>
</body>
</html>
