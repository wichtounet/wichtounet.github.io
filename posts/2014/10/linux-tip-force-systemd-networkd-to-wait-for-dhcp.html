<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " lang="en">
<head>
<meta charset="utf-8">
<base href="http://baptiste-wicht.com/posts/2014/10/linux-tip-force-systemd-networkd-to-wait-for-dhcp.html">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Linux tip: Force systemd networkd to wait for DHCP | @Blog("Baptiste Wicht")</title>
<link href="../../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta content="#5670d4" name="theme-color">
<link rel="alternate" type="application/rss+xml" title="RSS" href="../../../rss.xml">
<link rel="canonical" href="http://baptiste-wicht.com/posts/2014/10/linux-tip-force-systemd-networkd-to-wait-for-dhcp.html">
<!--[if lt IE 9]><script src="../../../assets/js/html5.js"></script><![endif]--><script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-2175227-7']);
  _gaq.push(['_trackPageview']);
  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script><meta name="author" content="Baptiste Wicht">
<link rel="prev" href="../09/budgetwarrior-041-expense-templates-and-year-projection.html" title="budgetwarrior 0.4.1 - Expense templates and year projection" type="text/html">
<link rel="next" href="sonarqube-inspections-for-cpp-projects.html" title="SonarQube inspections for C++ projects" type="text/html">
<meta property="og:site_name" content='@Blog("Baptiste Wicht")'>
<meta property="og:title" content="Linux tip: Force systemd networkd to wait for DHCP">
<meta property="og:url" content="http://baptiste-wicht.com/posts/2014/10/linux-tip-force-systemd-networkd-to-wait-for-dhcp.html">
<meta property="og:description" content="Recently, I started using systemd-networkd to manage my network. It works really
good for static address configuration, but I experienced some problem with DHCP.
There is DHCP client support integrate">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2014-10-01T20:18:55+02:00">
<meta property="article:tag" content="Gentoo">
<meta property="article:tag" content="Linux">
<meta property="article:tag" content="Network">
<meta property="article:tag" content="systemd">
<meta property="article:tag" content="Tips">
<link href="../../../favicon.ico" rel="icon" type="image/x-icon">
<link href="../../../assets/css/tx3-tag-cloud.css" rel="stylesheet" type="text/css">
</head>
<body>

<!-- Menubar -->

<div class="container-fluid">
<!-- This keeps the margins nice -->
    <div class="row">
        <div class="col-sm-3 col-lg-2">
            <nav class="navbar navbar-inverse navbar-fixed-side"><div class="navbar-header">
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="http://baptiste-wicht.com/">
                        <span id="blog-title">@Blog("Baptiste Wicht")</span>
                    </a>
                </div>
<!-- /.navbar-header -->

                <div class="collapse navbar-collapse navbar-ex1-collapse">
                    <ul class="nav navbar-nav">
<li>
                            <div class="g-person" data-width="275" data-href="//plus.google.com/u/0/103113673902796202116" data-theme="dark" data-layout="landscape" data-rel="author"></div>
                        </li>

                        
                <li>
<a href="../../../stories/about.html">About</a>
                </li>
<li>
<a href="../../../stories/publications.html">Publications</a>
                </li>
<li>
<a href="../../../categories/index.html">Tags</a>
                </li>
<li>
<a href="../../../archive.html">Archives</a>
                </li>
<li>
<a href="http://feeds.feedburner.com/BaptisteWicht">RSS</a>



                            </li>
<li class="navbar-content">
                                <h3>Related posts</h3>
                            </li>
                            

                            <li><a href="../../2010/07/osgi-hello-world-services.html">OSGi - Simple Hello World with services</a></li>
<li><a href="../../2013/07/home-server-adventure-step-1.html">Home Server Adventure - Step 1</a></li>
<li><a href="../../2016/04/simplify-deep-learning-library-usage-on-linux-and-windows.html">Simplify Deep Learning Library usage on Linux and Windows!</a></li>
<li><a href="../../2010/07/osgi-spring-dynamic-modules-hello-world.html">OSGI and Spring Dynamic Modules - Simple Hello World</a></li>
<li><a href="../../2012/04/switching-gentoo-linux.html">Switching to Gentoo Linux</a></li>


                            <li class="navbar-block">

                        <li class="wicht-navbar-right">
                            <a target="_blank" title="Follow @wichtounet on Twitter" href="https://twitter.com/wichtounet">
                                <img src="../../../assets/img/twitter.svg" alt="Follow @wichtounet on Twitter"></a>
                        </li>

                        <li class="wicht-navbar-right">
                            <a target="_blank" title="Follow +BaptisteWicht on Google+" href="https://plus.google.com/+BaptisteWicht">
                                <img src="../../../assets/img/google_plus.svg" alt="Follow +BaptisteWicht on Google+"></a>
                        </li>


                    </ul>
</div>
<!-- /.navbar-collapse -->
            </nav>
</div> <!-- col -->
        <div class="col-sm-9 col-lg-10">
            
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="#" class="u-url">Linux tip: Force systemd networkd to wait for DHCP</a></h1>

        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn">
                    Baptiste Wicht
            </span></p>
            <p class="dateline"><a href="#" rel="bookmark"><time class="published dt-published" datetime="2014-10-01T20:18:55+02:00" itemprop="datePublished" title="2014-10-01 20:18">2014-10-01 20:18</time></a></p>
                <p class="commentline">
        
    <a href="linux-tip-force-systemd-networkd-to-wait-for-dhcp.html#disqus_thread" data-disqus-identifier="cache/posts/2014/10/linux-tip-force-systemd-networkd-to-wait-for-dhcp.html">Comments</a>


            
        </p>
<p class="sourceline"><a href="linux-tip-force-systemd-networkd-to-wait-for-dhcp.rst" id="sourcelink">Source</a></p>

        </div>
        

    </header><div class="e-content entry-content" itemprop="articleBody text">
    <div>
<p>Recently, I started using systemd-networkd to manage my network. It works really
good for static address configuration, but I experienced some problem with DHCP.
There is DHCP client support integrated into systemd, so I wanted to use this
instead of using another DHCP client.</p>
<p>(If you are not familiar with systemd-networkd, you can have a look at the last
section of this article)</p>
<p>The problem with that is that services are not waiting for DHCP leases to be
obtained. Most services (sshd for instance), are waiting for network.target,
however, network.target does not wait for the DHCP lease to be obtained from the
server. If you configured ssh on a specific IP and this IP is obtained with
DHCP, it will fail at startup. The same is true for NFS mounts for instance.</p>
<div class="section" id="force-services-to-wait-for-the-network-to-be-configured">
<h2>Force services to wait for the network to be configured</h2>
<p>The solution is to make services like sshd waits for network-online.target
instead of network.target. There is a simple way in systemd to override default
service files. For a X.service, systemd will also parse all the
/etc/systemd/X.service.d/*.conf files.</p>
<p>For instance, to make sshd be started only after DHCP is finished</p>
<p>/etc/systemd/system/sshd.service.d/network.conf:</p>
<pre class="literal-block">
[Unit]
Wants=network-online.target
After=network-online.target
</pre>
<p>However, by default, network-online.target does not wait for anything. You'll
have to enable another service to make it work:</p>
<pre class="literal-block">
systemctl enable systemd-networkd-wait-online
</pre>
<p>And another note, at least on Gentoo, I had to use systemd-216 for it to work:</p>
<pre class="literal-block">
emerge -a "=sys-apps/systemd-216"
</pre>
<p>And after this, it worked like a charm at startup.</p>
</div>
<div class="section" id="force-nfs-mounts-to-wait-for-the-network">
<h2>Force NFS mounts to wait for the network</h2>
<p>There is no service file for nfs mounts, but there is a target remote-fs.target
that groups the remote file systems mounts. You can override its configuration
in the same as a service:</p>
<p>/etc/systemd/system/remote-fs.target.d/network.conf:</p>
<pre class="literal-block">
[Unit]
Wants=network-online.target
After=network-online.target
</pre>
</div>
<div class="section" id="conclusion">
<h2>Conclusion</h2>
<p>Here we are, I hope this tip will be useful to some of you ;)</p>
</div>
<div class="section" id="appendix-configure-interface-with-dhcp-with-systemd">
<h2>Appendix. Configure interface with DHCP with systemd</h2>
<p>To configure an interface with DHCP, you have to create a .network file in
/etc/systemd/network/. For instance, here is my
/etc/systemd/network/local.network file:</p>
<pre class="code text"><a name="rest_code_ea8e501d185b4808b39a670e0a90864d-1"></a>[Match]
<a name="rest_code_ea8e501d185b4808b39a670e0a90864d-2"></a>Name=enp3s0
<a name="rest_code_ea8e501d185b4808b39a670e0a90864d-3"></a>
<a name="rest_code_ea8e501d185b4808b39a670e0a90864d-4"></a>[Network]
<a name="rest_code_ea8e501d185b4808b39a670e0a90864d-5"></a>DHCP=v4
</pre>
<p>and you have to enable systemd-networkd:</p>
<pre class="literal-block">
systemctl enable systemd-networkd
</pre>
</div>
</div>
    </div>
    <aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../../../categories/gentoo.html" rel="tag">Gentoo</a></li>
            <li><a class="tag p-category" href="../../../categories/linux.html" rel="tag">Linux</a></li>
            <li><a class="tag p-category" href="../../../categories/network.html" rel="tag">Network</a></li>
            <li><a class="tag p-category" href="../../../categories/systemd.html" rel="tag">systemd</a></li>
            <li><a class="tag p-category" href="../../../categories/tips.html" rel="tag">Tips</a></li>
        </ul>
<ul class="pager hidden-print">
<li class="previous">
                <a href="../09/budgetwarrior-041-expense-templates-and-year-projection.html" rel="prev" title="budgetwarrior 0.4.1 - Expense templates and year projection">Previous post</a>
            </li>
            <li class="next">
                <a href="sonarqube-inspections-for-cpp-projects.html" rel="next" title="SonarQube inspections for C++ projects">Next post</a>
            </li>
        </ul></nav></aside><section class="comments hidden-print"><h2>Comments</h2>
        
        
        <div id="disqus_thread"></div>
        <script>
        var disqus_shortname ="blogwichtounet",
            disqus_url="http://baptiste-wicht.com/posts/2014/10/linux-tip-force-systemd-networkd-to-wait-for-dhcp.html",
        disqus_title="Linux tip: Force systemd networkd to wait for DHCP",
        disqus_identifier="cache/posts/2014/10/linux-tip-force-systemd-networkd-to-wait-for-dhcp.html",
        disqus_config = function () {
            this.language = "en";
        };
        (function() {
            var dsq = document.createElement('script'); dsq.async = true;
            dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
</noscript>
    <a href="https://disqus.com" class="dsq-brlink" rel="nofollow">Comments powered by <span class="logo-disqus">Disqus</span></a>


        </section></article><script>var disqus_shortname="blogwichtounet";(function(){var a=document.createElement("script");a.async=true;a.src="https://"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script>
</div> <!-- col -->
    </div>
<!-- row  -->
</div>
<!-- container-fluid -->

<!-- End of Menubar -->

<!-- Footer -->

<footer>
    Contents © 2016         <a href="mailto:baptistewicht@gmail.com">Baptiste Wicht</a> - Powered by         <a href="http://getnikola.com" rel="nofollow">Nikola</a>         
<a rel="license" href="http://creativecommons.org/licenses/by/4.0/"><img alt="Creative Commons License" style="padding-left:5px;border-width:0" src="../../../assets/img/cc.png"></a>
        <ul class="footer_inline_ul">
<li>
    <a href="linux-tip-force-systemd-networkd-to-wait-for-dhcp.rst" id="sourcelink">Source</a>
    </li>

        </ul></footer><!-- Late loading stuff  --><script src="../../../assets/js/all-nocdn.js"></script><!-- Google platform JS --><script type="text/javascript" src="https://apis.google.com/js/platform.js"></script><script type="text/javascript" src="../../../assets/js/jquery.tx3-tag-cloud.js"></script>
</body>
</html>
