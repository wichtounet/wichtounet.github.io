<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " lang=en> <head><meta charset=utf-8><meta name=viewport content="width=device-width"><title>How to speed up RAID (5-6) growing with mdadm ? | @Blog("Baptiste Wicht")</title><link href=../../../assets/css/all-nocdn.css rel=stylesheet type=text/css><link rel=alternate type=application/rss+xml title=RSS href=../../../rss.xml><link rel=canonical href=http://baptiste-wicht.com/posts/2015/03/how-to-speed-up-raid-5-6-growing-with-mdadm.html><script type=text/javascript>
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-2175227-7']);
  _gaq.push(['_trackPageview']);
  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script><meta name=author content="Baptiste Wicht"><meta name=og:title content="How to speed up RAID (5-6) growing with mdadm ?"><meta name=og:url content=http://baptiste-wicht.com/posts/2015/03/how-to-speed-up-raid-5-6-growing-with-mdadm.html><meta name=og:description content="Yesterday, I added my 11th disk to my RAID 6 array. As the last time it took my more than 20 hours, I spent some time investigating how to speed things up and this post contains some tips on how to ac"><meta name=og:site_name content=@Blog( baptiste wicht><meta name=og:type content=article><link href=../../../favicon.ico rel=icon type=image/x-icon></head><body><div class=social_container> <div class=social_container_gplus> <a target=_blank title="Share on Google+" href="https://plusone.google.com/_/+1/confirm?hl=en&amp;url=http://baptiste-wicht.com/posts/2015/03/how-to-speed-up-raid-5-6-growing-with-mdadm.html"><img src=../../../assets/img/google_plus.png></a> </div> <div class=social_container_facebook> <a target=_blank title="Share on Facebook" href="http://www.facebook.com/sharer/sharer.php?u=#url"><img src=../../../assets/img/facebook.png></a> </div> <div class=social_container_twitter> <a target=_blank title="Tweet on Twitter" href="http://twitter.com/home?status=#url"><img src=../../../assets/img/twitter.svg></a> </div></div><nav class="navbar navbar-inverse navbar-fixed-top" role=navigation> <div class=container-fluid> <div class=navbar-header> <button type=button class=navbar-toggle data-toggle=collapse data-target=.navbar-ex1-collapse> <span class=sr-only>Toggle navigation</span> <span class=icon-bar></span> <span class=icon-bar></span> <span class=icon-bar></span> </button> <a class=navbar-brand href=http://baptiste-wicht.com/> <span id=blog-title>@Blog("Baptiste Wicht")</span> </a> </div> <div class="collapse navbar-collapse navbar-ex1-collapse"> <ul class="nav navbar-nav"> <li><a href=../../../stories/about.html>About</a> </li><li><a href=../../../stories/publications.html>Publications</a> </li><li><a href=../../../stories/donate.html>Donate</a> </li><li><a href=../../../stories/contact.html>Contact</a> </li><li><a href=../../../stories/faq.html>FAQ</a> </li><li><a href=../../../stories/legal.html>Legal</a> </li><li><a href=../../../categories/index.html>Tags</a> </li><li><a href=../../../archive.html>Archives</a> </li><li><a href=http://feeds.feedburner.com/BaptisteWicht>RSS</a> </li></ul> <span class="navbar-form pull-left"> <form action=../../../stories/search.html> <input type=text name=q id=tipue_search_input> </form> </span> <ul class="nav navbar-nav navbar-right"> <li> <a target=_blank title="Follow @wichtounet on Twitter" href=https://twitter.com/wichtounet> <img src=../../../assets/img/twitter.svg alt="Follow @wichtounet on Twitter"> </a> </li> <li> <a target=_blank title="Follow +BaptisteWicht on Google+" href=https://plus.google.com/+BaptisteWicht> <img src=../../../assets/img/google_plus.svg alt="Follow +BaptisteWicht on Google+"> </a> </li> </ul> </div> </div></nav><div class=body-container> <div class=left-sidebar> <div class=left-sidebar-widget> <div class=left-sidebar-widget-content> <div class=g-person data-width=275 data-href=//plus.google.com/u/0/103113673902796202116 data-theme=dark data-layout=landscape data-rel=author></div> </div> </div> <div class=left-sidebar-widget> <h3>Related posts</h3> <div class=left-sidebar-widget-content> Not generated </div> </div> <div class=left-sidebar-widget> <h3>Recent comments</h3> <div class=left-sidebar-widget-content> <div id=recentcomments class=dsq-widget> <script type=text/javascript src="http://blogwichtounet.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=0&amp;avatar_size=28&amp;excerpt_length=50"></script> </div> </div> </div> <div class=left-sidebar-widget> <h3>Blogroll</h3> <div class=left-sidebar-widget-content> <ul> <li><a target=_blank href=http://www.asjava.com/>AsJava.com : Java Tutorial</a></li> <li><a target=_blank href=http://www.mkyong.com/>Mkyong : Java Tutorials</a></li> </ul> </div> </div> </div> <div class=container> <div class=body-content> <div class=row><article class="post-text h-entry hentry postpage" itemscope=itemscope itemtype=http://schema.org/Article> <header> <h1 class="p-name entry-title" itemprop="headline name"><a href=# class=u-url>How to speed up RAID (5-6) growing with mdadm ?</a></h1> <div class=metadata> <p class="byline author vcard"><span class="byline-name fn">Baptiste Wicht</span></p> <p class=dateline><a href=# rel=bookmark><time class="published dt-published" datetime=2015-03-07T15:01:56+01:00 itemprop=datePublished title="Publication date">2015-03-07 15:01</time></a></p> <p class=commentline> <a href=how-to-speed-up-raid-5-6-growing-with-mdadm.html#disqus_thread data-disqus-identifier=cache/posts/2015/03/how-to-speed-up-raid-5-6-growing-with-mdadm.html>Comments</a> </p><p class=sourceline><a href=how-to-speed-up-raid-5-6-growing-with-mdadm.rst id=sourcelink>Source</a></p> </div> </header> <div class="e-content entry-content" itemprop="articleBody text"> <p>Yesterday, I added my 11th disk to my RAID 6 array. As the last time it took my more than 20 hours, I spent some time investigating how to speed things up and this post contains some tips on how to achieve good grow performances. With these tips, I have been able to reach a speed of about 55K in average during reshape. It did finish in about 13 hours.</p><p>First, take into account that some of these tips may depend on your configuration. In my case, this server is only used for this RAID, so I don't care if the CPU is used a lot during rebuild or if other processes are suffering from the load. This may not be the case with your configuration. Moreover, I speak only of hard disks, if you use SSD RAID, there are probably better way of tuning the rebuild (or perhaps it is fast enough). Finally, you have know that a RAID reshape is going to be slow, there is no way you'll grow a 10+ RAID array in one hour. G</p><p>In the examples, I use /dev/md0 as the raid array, you'll have to change this to your array name.</p><p>The first 3 tips can be used even after the rebuild has started and you should the differences in real-time. But, these 3 tips will also be erased after each reboot.</p><div class=section id=increase-speed-limits><h2>Increase speed limits</h2><p>The easiest thing to do is to increase the system speed limits on raid. You can see the current limits on your system by using these commands:</p><pre class="code bash literal-block">
sysctl dev.raid.speed_limit_min
sysctl dev.raid.speed_limit_max
</pre><p>These values are set in Kibibytes per second (KiB/s).</p><p>You can put them to high values:</p><pre class="code bash literal-block">
sysctl -w dev.raid.speed_limit_min<span class=o>=</span>100000
sysctl -w dev.raid.speed_limit_max<span class=o>=</span>500000
</pre><p>At least with these values, you won't be limited by the system.</p></div><div class=section id=increase-stripe-cache-size><h2>Increase stripe cache size</h2><p>By allowing the array to use more memory for its stripe cache, you may improve the performances. In some cases, it can improve performances by up to 6 times. By default, the size of the stripe cache is 256, in pages. By default, Linux uses 4096B pages. If you use 256 pages for the stripe cache and you have 10 disks, the cache would use 10*256*4096=10MiB of RAM. In my case, I have increased it to 4096:</p><pre class="code bash literal-block">
<span class=nb>echo </span>4096 &gt; /sys/block/md0/md/stripe_cache_size
</pre><p>The maximum value is 32768. If you have many disks, this may well take all your available memory. I don't think values higher than 4096 will improve performance, but feel free to try it ;)</p></div><div class=section id=increase-read-ahead><h2>Increase read-ahead</h2><p>If configured too low, the read-ahead of your array may make things slower.</p><p>You can see get the current read-ahead value with this command:</p><pre class="code bash literal-block">
blockdev --getra /dev/md0
</pre><p>These values are in 512B sector. You can set it to 32MB to be sure:</p><pre class="code bash literal-block">
blockdev --setra 65536 /dev/md0
</pre><p>This can improve the performances, but don't expect this to be a game-changer unless it was configured really low at the first place.</p></div><div class=section id=bonus-speed-up-standard-resync-with-a-write-intent-bitmap><h2>Bonus: Speed up standard resync with a write-intent bitmap</h2><p>Although it won't speed up the growing of your array, this is something that you should do after the rebuild has finished. Write-intent bitmaps is a kind of map of what needs to be resynced. This is of great help in several cases:</p><ul class=simple><li>When the computer crash (power shutdown for instance)</li><li>If a disk is disconnected, then reconnected.</li></ul><p>In these case, it may totally avoid the need of a rebuild which is great in my opinion. Moreover, it does not take any space on the array since it uses space that is not usable by the array.</p><p>Here is how to enable it:</p><pre class="code bash literal-block">
mdadm --grow --bitmap<span class=o>=</span>internal /dev/md0
</pre><p>However, it may cause some write performance degradation. In my case, I haven't seen any noticeable degradation, but if it is the case, you may want to disable it:</p><pre class="code bash literal-block">
mdadm --grow --bitmap<span class=o>=</span>none /dev/md0
</pre></div><div class=section id=bonus-monitor-rebuild-process><h2>Bonus: Monitor rebuild process</h2><p>If you want to monitor the build process, you can use the watch command:</p><pre class="code bash literal-block">
watch cat /proc/mdstat
</pre><p>With that you'll see the rebuild going in real-time.</p><p>You can also monitor the I/O statistics:</p><pre class="code bash literal-block">
watch iostat -k 1 2
</pre></div><div class=section id=bonus-how-to-grow-a-raid-5-6-array><h2>Bonus: How to grow a RAID 5-6 array</h2><p>As a sidenote, this section indicates how to grow an array. If you want to add the disk /dev/sdl to the array /dev/md0, you'll first have to add it:</p><pre class="code bash literal-block">
mdadm --add /dev/md0 /dev/sdl
</pre><p>This will add the disk as a spare disk. If you had 5 disks before, you'll want to grow it to 6:</p><pre class="code bash literal-block">
mdadm --grow --backup-file<span class=o>=</span>/root/grow_md0_backup_file --raid-devices<span class=o>=</span>6 /dev/md0
</pre><p>The backup file must be on another disk of course. The backup file is optional but improves the chance of success if you have a power shutdown or another form of unexpected shutdown. If you know what you're doing, you can grow it without backup-file:</p><pre class="code bash literal-block">
mdadm --grow --raid-devices<span class=o>=</span>6 /dev/md0
</pre><p>This command will return almost instantly, but the actual reshape won't likely be finished for hours (maybe days). kkkkkkkkkkkkk</p><p>Once the rebuild is finished, you'll still have to extend the partitions with resize2fs. If you use LVM on top of the array, you'll have to resize the Physical Volume (PV) first:</p><pre class="code bash literal-block">
pvresize /dev/md0
</pre><p>and then extend the Logical Volume (s) (LV). For instance, if you want to add 1T to a LV named /dev/vgraid/work:</p><pre class="code bash literal-block">
vgextend -r -L+1T /dev/vgraid/work
</pre><p>The -r option will automatically resize the underlying filesystem. Otherwise, you'd still have to resize it with resize2fs.</p></div><div class=section id=conclusion><h2>Conclusion</h2><p>These are the changes I have found that speed up the reshape process. There are others that you may test in your case. For instance, in some systems disabling NCQ on each disk may help.</p><p>I hope that these tips will help you doing fast rebuilds in your RAID array :)</p></div> </div> <aside class=postpromonav> <nav> <ul itemprop=keywords class=tags> <li><a class="tag p-category" href=../../../categories/gentoo.html rel=tag>Gentoo</a></li> <li><a class="tag p-category" href=../../../categories/hardware.html rel=tag>Hardware</a></li> <li><a class="tag p-category" href=../../../categories/home-server.html rel=tag>Home Server</a></li> <li><a class="tag p-category" href=../../../categories/lvm.html rel=tag>LVM</a></li> <li><a class="tag p-category" href=../../../categories/linux.html rel=tag>Linux</a></li> </ul> <ul class=pager> <li class=previous> <a href=named-optional-template-parameters-compile-time.html rel=prev title="Named Optional Template parameters to configure a class at compile-time">Previous post</a> </li> </ul> </nav> </aside> <section class=comments> <h2>Comments</h2> <div id=disqus_thread></div> <script>
        var disqus_shortname ="blogwichtounet",
            disqus_url="http://baptiste-wicht.com/posts/2015/03/how-to-speed-up-raid-5-6-growing-with-mdadm.html",
        disqus_title="How to speed up RAID (5-6) growing with mdadm ?",
        disqus_identifier="cache/posts/2015/03/how-to-speed-up-raid-5-6-growing-with-mdadm.html",
        disqus_config = function () {
            this.language = "en";
        };
        (function() {
            var dsq = document.createElement('script'); dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script> <noscript>Please enable JavaScript to view the <a href=//disqus.com/?ref_noscript rel=nofollow>comments powered by Disqus.</a></noscript> <a href=//disqus.com class=dsq-brlink rel=nofollow>Comments powered by <span class=logo-disqus>Disqus</span></a> </section></article> <script>var disqus_shortname="blogwichtounet";(function(){var a=document.createElement("script");a.async=true;a.src="//"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script> </div> </div> </div></div><footer> Contents © 2015 <a href=mailto:baptistewicht@gmail.com>Baptiste Wicht</a> - Powered by <a href=http://getnikola.com rel=nofollow>Nikola</a><a rel=license href=http://creativecommons.org/licenses/by/4.0/><img alt="Creative Commons License" style=padding-left:5px;border-width:0 src=../../../assets/img/cc.png></a> <ul class=footer_inline_ul> <li> <a href=how-to-speed-up-raid-5-6-growing-with-mdadm.rst id=sourcelink>Source</a> </li> </ul></footer> <script src=../../../assets/js/all-nocdn.js></script><script type=text/javascript src=https://apis.google.com/js/platform.js></script></body></html>