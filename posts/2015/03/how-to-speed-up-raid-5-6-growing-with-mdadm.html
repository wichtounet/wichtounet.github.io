<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>How to speed up RAID (5-6) growing with mdadm ? | Blog blog("Baptiste Wicht");</title>
<link href="../../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" hreflang="en" href="../../../rss.xml">
<link rel="canonical" href="https://baptiste-wicht.com/posts/2015/03/how-to-speed-up-raid-5-6-growing-with-mdadm.html">
<!--[if lt IE 9]><script src="../../../assets/js/html5.js"></script><![endif]--><meta name="author" content="Baptiste Wicht">
<link rel="prev" href="named-optional-template-parameters-compile-time.html" title="Named Optional Template parameters to configure a class at compile-time" type="text/html">
<link rel="next" href="../05/sonar-cpp-community-plugin-review.html" title="Sonar C++ Community Plugin Review" type="text/html">
<meta property="og:site_name" content='Blog blog("Baptiste Wicht");'>
<meta property="og:title" content="How to speed up RAID (5-6) growing with mdadm ?">
<meta property="og:url" content="https://baptiste-wicht.com/posts/2015/03/how-to-speed-up-raid-5-6-growing-with-mdadm.html">
<meta property="og:description" content="Yesterday, I added my 11th disk to my RAID 6 array. As the last time it took my more than 20 hours, I spent some time investigating how to speed things up and this post contains some tips on how to ac">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2015-03-07T15:01:56+01:00">
<meta property="article:tag" content="Gentoo">
<meta property="article:tag" content="Hardware">
<meta property="article:tag" content="Home Server">
<meta property="article:tag" content="Linux">
<meta property="article:tag" content="LVM">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://baptiste-wicht.com/">

                <span id="blog-title">Blog blog("Baptiste Wicht");</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="../../../stories/about.html">About</a>
                </li>
<li>
<a href="../../../stories/publications.html">Publications</a>
                </li>
<li>
<a href="../../../stories/projects.html">Projects</a>
                </li>
<li>
<a href="../../../categories/index.html">Tags</a>
                </li>
<li>
<a href="../../../archive.html">Archives</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right">
<li>
    <a href="how-to-speed-up-raid-5-6-growing-with-mdadm.rst" id="sourcelink">Source</a>
    </li>

                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="#" class="u-url">How to speed up RAID (5-6) growing with mdadm ?</a></h1>

        <div class="metadata">
            <p class="byline author vcard p-author h-card"><span class="byline-name fn p-name" itemprop="author">
                    Baptiste Wicht
            </span></p>
            <p class="dateline">
            <a href="#" rel="bookmark">
            <time class="published dt-published" datetime="2015-03-07T15:01:56+01:00" itemprop="datePublished" title="2015-03-07 15:01">2015-03-07 15:01</time></a>
            </p>
                <p class="commentline">
    
    <a href="how-to-speed-up-raid-5-6-growing-with-mdadm.html#disqus_thread" data-disqus-identifier="cache/posts/2015/03/how-to-speed-up-raid-5-6-growing-with-mdadm.html">Comments</a>


            
        </p>
<p class="sourceline"><a href="how-to-speed-up-raid-5-6-growing-with-mdadm.rst" class="sourcelink">Source</a></p>

        </div>
        

    </header><div class="e-content entry-content" itemprop="articleBody text">
    <p>Yesterday, I added my 11th disk to my RAID 6 array. As the last time it took my more than 20 hours, I spent some time investigating how to speed things up and this post contains some tips on how to achieve good grow performances. With these tips, I have been able to reach a speed of about 55K in average during reshape. It did finish in about 13 hours.</p>
<p>First, take into account that some of these tips may depend on your configuration. In my case, this server is only used for this RAID, so I don't care if the CPU is used a lot during rebuild or if other processes are suffering from the load. This may not be the case with your configuration. Moreover, I speak only of hard disks, if you use SSD RAID, there are probably better way of tuning the rebuild (or perhaps it is fast enough). Finally, you have know that a RAID reshape is going to be slow, there is no way you'll grow a 10+ RAID array in one hour. G</p>
<p>In the examples, I use /dev/md0 as the raid array, you'll have to change this to your array name.</p>
<p>The first 3 tips can be used even after the rebuild has started and you should see the differences in real-time. But, these 3 tips will also be erased after each reboot.</p>
<section id="increase-speed-limits"><h2>Increase speed limits</h2>
<p>The easiest thing to do is to increase the system speed limits on raid. You can see the current limits on your system by using these commands:</p>
<div class="code"><pre class="code bash"><a id="rest_code_d3aabb3c4e6545fd850790a9bdd79d65-1" name="rest_code_d3aabb3c4e6545fd850790a9bdd79d65-1" href="how-to-speed-up-raid-5-6-growing-with-mdadm.html#rest_code_d3aabb3c4e6545fd850790a9bdd79d65-1"></a>sysctl<span class="w"> </span>dev.raid.speed_limit_min
<a id="rest_code_d3aabb3c4e6545fd850790a9bdd79d65-2" name="rest_code_d3aabb3c4e6545fd850790a9bdd79d65-2" href="how-to-speed-up-raid-5-6-growing-with-mdadm.html#rest_code_d3aabb3c4e6545fd850790a9bdd79d65-2"></a>sysctl<span class="w"> </span>dev.raid.speed_limit_max
</pre></div>
<p>These values are set in Kibibytes per second (KiB/s).</p>
<p>You can put them to high values:</p>
<div class="code"><pre class="code bash"><a id="rest_code_222c0f29ee19488f828df8173e26885d-1" name="rest_code_222c0f29ee19488f828df8173e26885d-1" href="how-to-speed-up-raid-5-6-growing-with-mdadm.html#rest_code_222c0f29ee19488f828df8173e26885d-1"></a>sysctl<span class="w"> </span>-w<span class="w"> </span>dev.raid.speed_limit_min<span class="o">=</span><span class="m">100000</span>
<a id="rest_code_222c0f29ee19488f828df8173e26885d-2" name="rest_code_222c0f29ee19488f828df8173e26885d-2" href="how-to-speed-up-raid-5-6-growing-with-mdadm.html#rest_code_222c0f29ee19488f828df8173e26885d-2"></a>sysctl<span class="w"> </span>-w<span class="w"> </span>dev.raid.speed_limit_max<span class="o">=</span><span class="m">500000</span>
</pre></div>
<p>At least with these values, you won't be limited by the system.</p>
</section><section id="increase-stripe-cache-size"><h2>Increase stripe cache size</h2>
<p>By allowing the array to use more memory for its stripe cache, you may improve the performances. In some cases, it can improve performances by up to 6 times. By default, the size of the stripe cache is 256, in pages. By default, Linux uses 4096B pages. If you use 256 pages for the stripe cache and you have 10 disks, the cache would use 10*256*4096=10MiB of RAM. In my case, I have increased it to 4096:</p>
<div class="code"><pre class="code bash"><a id="rest_code_16fd903ab68a4d6890504caf78732702-1" name="rest_code_16fd903ab68a4d6890504caf78732702-1" href="how-to-speed-up-raid-5-6-growing-with-mdadm.html#rest_code_16fd903ab68a4d6890504caf78732702-1"></a><span class="nb">echo</span><span class="w"> </span><span class="m">4096</span><span class="w"> </span>&gt;<span class="w"> </span>/sys/block/md0/md/stripe_cache_size
</pre></div>
<p>The maximum value is 32768. If you have many disks, this may well take all your available memory. I don't think values higher than 4096 will improve performance, but feel free to try it ;)</p>
</section><section id="increase-read-ahead"><h2>Increase read-ahead</h2>
<p>If configured too low, the read-ahead of your array may make things slower.</p>
<p>You can see get the current read-ahead value with this command:</p>
<div class="code"><pre class="code bash"><a id="rest_code_0ff5d55b068545bf9860cc924d272a55-1" name="rest_code_0ff5d55b068545bf9860cc924d272a55-1" href="how-to-speed-up-raid-5-6-growing-with-mdadm.html#rest_code_0ff5d55b068545bf9860cc924d272a55-1"></a>blockdev<span class="w"> </span>--getra<span class="w"> </span>/dev/md0
</pre></div>
<p>These values are in 512B sector. You can set it to 32MB to be sure:</p>
<div class="code"><pre class="code bash"><a id="rest_code_04fbf25b7702461fb677c9cc24e22b46-1" name="rest_code_04fbf25b7702461fb677c9cc24e22b46-1" href="how-to-speed-up-raid-5-6-growing-with-mdadm.html#rest_code_04fbf25b7702461fb677c9cc24e22b46-1"></a>blockdev<span class="w"> </span>--setra<span class="w"> </span><span class="m">65536</span><span class="w"> </span>/dev/md0
</pre></div>
<p>This can improve the performances, but don't expect this to be a game-changer unless it was configured really low at the first place.</p>
</section><section id="tip-reshape-stuck-at-0k-s"><h2>Tip: Reshape stuck at 0K/s</h2>
<p>If reshape starts, but with a speed of 0K/s, you can try to issue this simple
command:</p>
<div class="code"><pre class="code bash"><a id="rest_code_608e855a226547e99e9ee101de14673b-1" name="rest_code_608e855a226547e99e9ee101de14673b-1" href="how-to-speed-up-raid-5-6-growing-with-mdadm.html#rest_code_608e855a226547e99e9ee101de14673b-1"></a><span class="nb">echo</span><span class="w"> </span>max<span class="w"> </span>&gt;<span class="w"> </span>/sys/block/md0/md/sync_max
</pre></div>
<p>And the reshape should start directly at your maximum speed.</p>
<p>The solution is the same if you are growing any type of RAID level with parity
(RAID5, RAID6, ...).</p>
</section><section id="bonus-speed-up-standard-resync-with-a-write-intent-bitmap"><h2>Bonus: Speed up standard resync with a write-intent bitmap</h2>
<p>Although it won't speed up the growing of your array, this is something that you should do after the rebuild has finished. Write-intent bitmaps is a kind of map of what needs to be resynced. This is of great help in several cases:</p>
<ul class="simple">
<li><p>When the computer crash (power shutdown for instance)</p></li>
<li><p>If a disk is disconnected, then reconnected.</p></li>
</ul>
<p>In these case, it may totally avoid the need of a rebuild which is great in my opinion. Moreover, it does not take any space on the array since it uses space that is not usable by the array.</p>
<p>Here is how to enable it:</p>
<div class="code"><pre class="code bash"><a id="rest_code_b468dbdb659b46c699408895c4083e04-1" name="rest_code_b468dbdb659b46c699408895c4083e04-1" href="how-to-speed-up-raid-5-6-growing-with-mdadm.html#rest_code_b468dbdb659b46c699408895c4083e04-1"></a>mdadm<span class="w"> </span>--grow<span class="w"> </span>--bitmap<span class="o">=</span>internal<span class="w"> </span>/dev/md0
</pre></div>
<p>However, it may cause some write performance degradation. In my case, I haven't seen any noticeable degradation, but if it is the case, you may want to disable it:</p>
<div class="code"><pre class="code bash"><a id="rest_code_abe7c02bf4184646a9e0e301ed7fe319-1" name="rest_code_abe7c02bf4184646a9e0e301ed7fe319-1" href="how-to-speed-up-raid-5-6-growing-with-mdadm.html#rest_code_abe7c02bf4184646a9e0e301ed7fe319-1"></a>mdadm<span class="w"> </span>--grow<span class="w"> </span>--bitmap<span class="o">=</span>none<span class="w"> </span>/dev/md0
</pre></div>
</section><section id="bonus-monitor-rebuild-process"><h2>Bonus: Monitor rebuild process</h2>
<p>If you want to monitor the build process, you can use the watch command:</p>
<div class="code"><pre class="code bash"><a id="rest_code_521b096a70514590baf1ad4a08761b04-1" name="rest_code_521b096a70514590baf1ad4a08761b04-1" href="how-to-speed-up-raid-5-6-growing-with-mdadm.html#rest_code_521b096a70514590baf1ad4a08761b04-1"></a>watch<span class="w"> </span>cat<span class="w"> </span>/proc/mdstat
</pre></div>
<p>With that you'll see the rebuild going in real-time.</p>
<p>You can also monitor the I/O statistics:</p>
<div class="code"><pre class="code bash"><a id="rest_code_2fd28e71618d43739d2fa998febad308-1" name="rest_code_2fd28e71618d43739d2fa998febad308-1" href="how-to-speed-up-raid-5-6-growing-with-mdadm.html#rest_code_2fd28e71618d43739d2fa998febad308-1"></a>watch<span class="w"> </span>iostat<span class="w"> </span>-k<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">2</span>
</pre></div>
</section><section id="bonus-how-to-grow-a-raid-5-6-array"><h2>Bonus: How to grow a RAID 5-6 array</h2>
<p>As a sidenote, this section indicates how to grow an array. If you  want to add the disk /dev/sdl to the array /dev/md0, you'll first have to add it:</p>
<div class="code"><pre class="code bash"><a id="rest_code_64de2c6658114491b0123e9078260c47-1" name="rest_code_64de2c6658114491b0123e9078260c47-1" href="how-to-speed-up-raid-5-6-growing-with-mdadm.html#rest_code_64de2c6658114491b0123e9078260c47-1"></a>mdadm<span class="w"> </span>--add<span class="w"> </span>/dev/md0<span class="w"> </span>/dev/sdl
</pre></div>
<p>This will add the disk as a spare disk. If you had 5 disks before, you'll want to grow it to 6:</p>
<div class="code"><pre class="code bash"><a id="rest_code_f59ddac70ab74b2b8f6093ac4ecfb200-1" name="rest_code_f59ddac70ab74b2b8f6093ac4ecfb200-1" href="how-to-speed-up-raid-5-6-growing-with-mdadm.html#rest_code_f59ddac70ab74b2b8f6093ac4ecfb200-1"></a>mdadm<span class="w"> </span>--grow<span class="w"> </span>--backup-file<span class="o">=</span>/root/grow_md0_backup_file<span class="w"> </span>--raid-devices<span class="o">=</span><span class="m">6</span><span class="w"> </span>/dev/md0
</pre></div>
<p>The backup file must be on another disk of course. The backup file is optional but improves the chance of success if you have a power shutdown or another form of unexpected shutdown. If you know what you're doing, you can grow it without backup-file:</p>
<div class="code"><pre class="code bash"><a id="rest_code_31fff0debd8d4669b8d54d2944ef61d5-1" name="rest_code_31fff0debd8d4669b8d54d2944ef61d5-1" href="how-to-speed-up-raid-5-6-growing-with-mdadm.html#rest_code_31fff0debd8d4669b8d54d2944ef61d5-1"></a>mdadm<span class="w"> </span>--grow<span class="w"> </span>--raid-devices<span class="o">=</span><span class="m">6</span><span class="w"> </span>/dev/md0
</pre></div>
<p>This command will return almost instantly, but the actual reshape won't likely be finished for hours (maybe days).</p>
<p>Once the rebuild is finished, you'll still have to extend the partitions with resize2fs. If you use LVM on top of the array, you'll have to resize the Physical Volume (PV) first:</p>
<div class="code"><pre class="code bash"><a id="rest_code_1ec955fb922d48ac842d2d87535281dd-1" name="rest_code_1ec955fb922d48ac842d2d87535281dd-1" href="how-to-speed-up-raid-5-6-growing-with-mdadm.html#rest_code_1ec955fb922d48ac842d2d87535281dd-1"></a>pvresize<span class="w"> </span>/dev/md0
</pre></div>
<p>and then extend the Logical Volume (s) (LV). For instance, if you want to add 1T to a LV named /dev/vgraid/work:</p>
<div class="code"><pre class="code bash"><a id="rest_code_79c5733bdeb241f2ae9dbb98a145cfd5-1" name="rest_code_79c5733bdeb241f2ae9dbb98a145cfd5-1" href="how-to-speed-up-raid-5-6-growing-with-mdadm.html#rest_code_79c5733bdeb241f2ae9dbb98a145cfd5-1"></a>vgextend<span class="w"> </span>-r<span class="w"> </span>-L+1T<span class="w"> </span>/dev/vgraid/work
</pre></div>
<p>The -r option will automatically resize the underlying filesystem. Otherwise, you'd still have to resize it with resize2fs.</p>
</section><section id="conclusion"><h2>Conclusion</h2>
<p>These are the changes I have found that speed up the reshape process. There are others that you may test in your case. For instance, in some systems disabling NCQ on each disk may help.</p>
<p>I hope that these tips will help you doing fast rebuilds in your RAID array :)</p>
</section><h3>Related articles</h3>
    

    <li><a href="../../2017/08/how-to-fix-mdadm-raid5-raid6-growing-stuck-at-0ks.html">How to fix mdadm RAID5 / RAID6 growing stuck at 0K/s ?</a></li>
<li><a href="../../2014/05/changing-root-hard-disk-gentoo-lvm-grub2.html">Changing root hard disk on Gentoo with LVM and Grub2</a></li>
<li><a href="../../2010/02/hardware-guide-hard-disks.html">Hardware Guide : The Hard Disks</a></li>
<li><a href="../../2014/01/home-server-adventure-step-3.html">Home Server Adventure – Step 3</a></li>
<li><a href="../../2011/06/upload-files-to-ftp-using-bash.html">Upload files to FTP using Bash</a></li>
<li><a href="../../2010/09/tip-batch-resize-images-on-ubuntu-linux.html">Tip : Batch resize images on Ubuntu Linux</a></li>


    </div>
    <aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../../../categories/gentoo.html" rel="tag">Gentoo</a></li>
            <li><a class="tag p-category" href="../../../categories/hardware.html" rel="tag">Hardware</a></li>
            <li><a class="tag p-category" href="../../../categories/home-server.html" rel="tag">Home Server</a></li>
            <li><a class="tag p-category" href="../../../categories/linux.html" rel="tag">Linux</a></li>
            <li><a class="tag p-category" href="../../../categories/lvm.html" rel="tag">LVM</a></li>
        </ul>
<ul class="pager hidden-print">
<li class="previous">
                <a href="named-optional-template-parameters-compile-time.html" rel="prev" title="Named Optional Template parameters to configure a class at compile-time">Previous post</a>
            </li>
            <li class="next">
                <a href="../05/sonar-cpp-community-plugin-review.html" rel="next" title="Sonar C++ Community Plugin Review">Next post</a>
            </li>
        </ul></nav></aside><section class="comments hidden-print"><h2>Comments</h2>
        
    
        <div id="disqus_thread"></div>
        <script>
        var disqus_shortname ="blogwichtounet",
            disqus_url="https://baptiste-wicht.com/posts/2015/03/how-to-speed-up-raid-5-6-growing-with-mdadm.html",
        disqus_title="How to speed up RAID (5-6) growing with mdadm ?",
        disqus_identifier="cache/posts/2015/03/how-to-speed-up-raid-5-6-growing-with-mdadm.html",
        disqus_config = function () {
            this.language = "en";
        };
        (function() {
            var dsq = document.createElement('script'); dsq.async = true;
            dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
</noscript>
    <a href="https://disqus.com" class="dsq-brlink" rel="nofollow">Comments powered by <span class="logo-disqus">Disqus</span></a>


        </section></article><script>var disqus_shortname="blogwichtounet";(function(){var a=document.createElement("script");a.async=true;a.src="https://"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2023         <a href="mailto:baptistewicht@gmail.com">Baptiste Wicht</a> - Powered by         <a href="http://getnikola.com" rel="nofollow">Nikola</a>         - License: 
<a rel="license" href="http://creativecommons.org/licenses/by/4.0/"><img alt="Creative Commons License" style="padding-left:5px;border-width:0" src="../../../assets/img/cc.png"></a>
            
        </footer>
</div>
</div>


            <script src="../../../assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script>
</body>
</html>
