<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>C++17 Fold Expressions | Blog blog("Baptiste Wicht");</title>
<link href="../../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" hreflang="en" href="../../../rss.xml">
<link rel="canonical" href="https://baptiste-wicht.com/posts/2015/05/cpp17-fold-expressions.html">
<!--[if lt IE 9]><script src="../../../assets/js/html5.js"></script><![endif]--><meta name="author" content="Baptiste Wicht">
<link rel="prev" href="sonar-cpp-community-plugin-review.html" title="Sonar C++ Community Plugin Review" type="text/html">
<link rel="next" href="../06/continuous-performance-management-with-cpm-for-cpp.html" title="Continuous Performance Management with CPM for C++" type="text/html">
<meta property="og:site_name" content='Blog blog("Baptiste Wicht");'>
<meta property="og:title" content="C++17 Fold Expressions">
<meta property="og:url" content="https://baptiste-wicht.com/posts/2015/05/cpp17-fold-expressions.html">
<meta property="og:description" content="Variadic Templates
C++11 introduced variadic template to the languages. This new feature allows to write template functions and classes taking an arbitrary number of template parameters. This a featur">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2015-05-23T19:08:20+02:00">
<meta property="article:tag" content="C++">
<meta property="article:tag" content="C++17">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://baptiste-wicht.com/">

                <span id="blog-title">Blog blog("Baptiste Wicht");</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="../../../stories/about.html">About</a>
                </li>
<li>
<a href="../../../stories/publications.html">Publications</a>
                </li>
<li>
<a href="../../../stories/projects.html">Projects</a>
                </li>
<li>
<a href="../../../categories/index.html">Tags</a>
                </li>
<li>
<a href="../../../archive.html">Archives</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right">
<li>
    <a href="cpp17-fold-expressions.rst" id="sourcelink">Source</a>
    </li>

                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="#" class="u-url">C++17 Fold Expressions</a></h1>

        <div class="metadata">
            <p class="byline author vcard p-author h-card"><span class="byline-name fn p-name" itemprop="author">
                    Baptiste Wicht
            </span></p>
            <p class="dateline">
            <a href="#" rel="bookmark">
            <time class="published dt-published" datetime="2015-05-23T19:08:20+02:00" itemprop="datePublished" title="2015-05-23 19:08">2015-05-23 19:08</time></a>
            </p>
                <p class="commentline">
    
    <a href="cpp17-fold-expressions.html#disqus_thread" data-disqus-identifier="cache/posts/2015/05/cpp17-fold-expressions.html">Comments</a>


            
        </p>
<p class="sourceline"><a href="cpp17-fold-expressions.rst" class="sourcelink">Source</a></p>

        </div>
        

    </header><div class="e-content entry-content" itemprop="articleBody text">
    <section id="variadic-templates"><h2>Variadic Templates</h2>
<p>C++11 introduced variadic template to the languages. This new feature allows to write template functions and classes taking an arbitrary number of template parameters. This a feature I really like and I already used it quite a lot in my different libraries. Here is a very simple example computing the sum of the parameters:</p>
<div class="code"><pre class="code c++"><a id="rest_code_fd2ea946fe14466b9dc87ef195860c8a-1" name="rest_code_fd2ea946fe14466b9dc87ef195860c8a-1" href="cpp17-fold-expressions.html#rest_code_fd2ea946fe14466b9dc87ef195860c8a-1"></a><span class="k">auto</span><span class="w"> </span><span class="n">old_sum</span><span class="p">(){</span>
<a id="rest_code_fd2ea946fe14466b9dc87ef195860c8a-2" name="rest_code_fd2ea946fe14466b9dc87ef195860c8a-2" href="cpp17-fold-expressions.html#rest_code_fd2ea946fe14466b9dc87ef195860c8a-2"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="rest_code_fd2ea946fe14466b9dc87ef195860c8a-3" name="rest_code_fd2ea946fe14466b9dc87ef195860c8a-3" href="cpp17-fold-expressions.html#rest_code_fd2ea946fe14466b9dc87ef195860c8a-3"></a><span class="p">}</span>
<a id="rest_code_fd2ea946fe14466b9dc87ef195860c8a-4" name="rest_code_fd2ea946fe14466b9dc87ef195860c8a-4" href="cpp17-fold-expressions.html#rest_code_fd2ea946fe14466b9dc87ef195860c8a-4"></a>
<a id="rest_code_fd2ea946fe14466b9dc87ef195860c8a-5" name="rest_code_fd2ea946fe14466b9dc87ef195860c8a-5" href="cpp17-fold-expressions.html#rest_code_fd2ea946fe14466b9dc87ef195860c8a-5"></a><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">T1</span><span class="p">,</span><span class="w"> </span><span class="k">typename</span><span class="p">...</span><span class="w"> </span><span class="n">T</span><span class="o">&gt;</span>
<a id="rest_code_fd2ea946fe14466b9dc87ef195860c8a-6" name="rest_code_fd2ea946fe14466b9dc87ef195860c8a-6" href="cpp17-fold-expressions.html#rest_code_fd2ea946fe14466b9dc87ef195860c8a-6"></a><span class="k">auto</span><span class="w"> </span><span class="n">old_sum</span><span class="p">(</span><span class="n">T1</span><span class="w"> </span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="p">...</span><span class="w"> </span><span class="n">ts</span><span class="p">){</span>
<a id="rest_code_fd2ea946fe14466b9dc87ef195860c8a-7" name="rest_code_fd2ea946fe14466b9dc87ef195860c8a-7" href="cpp17-fold-expressions.html#rest_code_fd2ea946fe14466b9dc87ef195860c8a-7"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">old_sum</span><span class="p">(</span><span class="n">ts</span><span class="p">...);</span>
<a id="rest_code_fd2ea946fe14466b9dc87ef195860c8a-8" name="rest_code_fd2ea946fe14466b9dc87ef195860c8a-8" href="cpp17-fold-expressions.html#rest_code_fd2ea946fe14466b9dc87ef195860c8a-8"></a><span class="p">}</span>
</pre></div>
<p>What can be seen here is a typical use of variadic templates. Almost all the time, is is necessary to use recursion and several functions to unpack the parameters and process them. There is only one way to unpack the arguments, by using the ... operator that simply put comma between arguments. Even if it works well, it is a bit heavy on the code. This will likely be completely optimized to a series of addition by the compiler, but it may still happen in more complicated functions that this is not done. Moreover, the intent is not always clear with that.</p>
<p>That is why C++17 introduced an extension for the variadic template, fold expressions.</p>
</section><section id="fold-expressions"><h2>Fold expressions</h2>
<p>Fold expressions are a new way to unpack variadic parameters with operators. For now, only Clang 3.6 supports C++17 fold expression, with the -std=c++1z flag. That is the compiler I used to validate the examples of this post.</p>
<p>The syntax is bit disturbing at first but quite logical once you get used to it:</p>
<div class="code"><pre class="code c++"><a id="rest_code_1c5ad4349fde46e58672b319b43409c8-1" name="rest_code_1c5ad4349fde46e58672b319b43409c8-1" href="cpp17-fold-expressions.html#rest_code_1c5ad4349fde46e58672b319b43409c8-1"></a><span class="p">(</span><span class="w"> </span><span class="n">pack</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="p">)</span><span class="w">             </span><span class="c1">//(1)</span>
<a id="rest_code_1c5ad4349fde46e58672b319b43409c8-2" name="rest_code_1c5ad4349fde46e58672b319b43409c8-2" href="cpp17-fold-expressions.html#rest_code_1c5ad4349fde46e58672b319b43409c8-2"></a><span class="p">(</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">pack</span><span class="w"> </span><span class="p">)</span><span class="w">             </span><span class="c1">//(2)</span>
<a id="rest_code_1c5ad4349fde46e58672b319b43409c8-3" name="rest_code_1c5ad4349fde46e58672b319b43409c8-3" href="cpp17-fold-expressions.html#rest_code_1c5ad4349fde46e58672b319b43409c8-3"></a><span class="p">(</span><span class="w"> </span><span class="n">pack</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">init</span><span class="w"> </span><span class="p">)</span><span class="w">     </span><span class="c1">//(3)</span>
<a id="rest_code_1c5ad4349fde46e58672b319b43409c8-4" name="rest_code_1c5ad4349fde46e58672b319b43409c8-4" href="cpp17-fold-expressions.html#rest_code_1c5ad4349fde46e58672b319b43409c8-4"></a><span class="p">(</span><span class="w"> </span><span class="n">init</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="n">pack</span><span class="w"> </span><span class="p">)</span><span class="w">     </span><span class="c1">//(4)</span>
</pre></div>
<p>Where <em>pack</em> is an unexpanded parameter pack, <em>op</em> an operator and <em>init</em> a value. The version (1) is a right fold that is expanded like (P1 op (P2 op (P3 ... (PN-1 op PN)))). The version (2) is a left fold where the expansion is taken from the left. The (3) and (4) versions are almost the same except for an init value. Only some operators (+,*,&amp;,|,&amp;&amp;,||, ,) have defined init values and can be used with the versions (1) and (2). The other operators can only be used with an init value.</p>
<p>For instance, here is how we could write the sum functions with fold expressions:</p>
<div class="code"><pre class="code c++"><a id="rest_code_502d6868208f44fcbeb8b9ba1201a3ff-1" name="rest_code_502d6868208f44fcbeb8b9ba1201a3ff-1" href="cpp17-fold-expressions.html#rest_code_502d6868208f44fcbeb8b9ba1201a3ff-1"></a><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="p">...</span><span class="w"> </span><span class="n">T</span><span class="o">&gt;</span>
<a id="rest_code_502d6868208f44fcbeb8b9ba1201a3ff-2" name="rest_code_502d6868208f44fcbeb8b9ba1201a3ff-2" href="cpp17-fold-expressions.html#rest_code_502d6868208f44fcbeb8b9ba1201a3ff-2"></a><span class="k">auto</span><span class="w"> </span><span class="n">fold_sum_1</span><span class="p">(</span><span class="n">T</span><span class="p">...</span><span class="w"> </span><span class="n">s</span><span class="p">){</span>
<a id="rest_code_502d6868208f44fcbeb8b9ba1201a3ff-3" name="rest_code_502d6868208f44fcbeb8b9ba1201a3ff-3" href="cpp17-fold-expressions.html#rest_code_502d6868208f44fcbeb8b9ba1201a3ff-3"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(...</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">s</span><span class="p">);</span>
<a id="rest_code_502d6868208f44fcbeb8b9ba1201a3ff-4" name="rest_code_502d6868208f44fcbeb8b9ba1201a3ff-4" href="cpp17-fold-expressions.html#rest_code_502d6868208f44fcbeb8b9ba1201a3ff-4"></a><span class="p">}</span>
</pre></div>
<p>I personally think it is much better, it clearly states our intent and does not need recursion. By default, the init value used for addition is 0, but you can change it:</p>
<div class="code"><pre class="code c++"><a id="rest_code_735785ccd90349a48f59fe566e8059af-1" name="rest_code_735785ccd90349a48f59fe566e8059af-1" href="cpp17-fold-expressions.html#rest_code_735785ccd90349a48f59fe566e8059af-1"></a><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="p">...</span><span class="w"> </span><span class="n">T</span><span class="o">&gt;</span>
<a id="rest_code_735785ccd90349a48f59fe566e8059af-2" name="rest_code_735785ccd90349a48f59fe566e8059af-2" href="cpp17-fold-expressions.html#rest_code_735785ccd90349a48f59fe566e8059af-2"></a><span class="k">auto</span><span class="w"> </span><span class="n">fold_sum_2</span><span class="p">(</span><span class="n">T</span><span class="p">...</span><span class="w"> </span><span class="n">s</span><span class="p">){</span>
<a id="rest_code_735785ccd90349a48f59fe566e8059af-3" name="rest_code_735785ccd90349a48f59fe566e8059af-3" href="cpp17-fold-expressions.html#rest_code_735785ccd90349a48f59fe566e8059af-3"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">s</span><span class="p">);</span>
<a id="rest_code_735785ccd90349a48f59fe566e8059af-4" name="rest_code_735785ccd90349a48f59fe566e8059af-4" href="cpp17-fold-expressions.html#rest_code_735785ccd90349a48f59fe566e8059af-4"></a><span class="p">}</span>
</pre></div>
<p>This will yield the sum of the elements plus one.</p>
<p>This can be also very practical to print some elements for instance:</p>
<div class="code"><pre class="code c++"><a id="rest_code_2f49ff6141b645d99d2821a01d8f43f1-1" name="rest_code_2f49ff6141b645d99d2821a01d8f43f1-1" href="cpp17-fold-expressions.html#rest_code_2f49ff6141b645d99d2821a01d8f43f1-1"></a><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="p">...</span><span class="n">Args</span><span class="o">&gt;</span>
<a id="rest_code_2f49ff6141b645d99d2821a01d8f43f1-2" name="rest_code_2f49ff6141b645d99d2821a01d8f43f1-2" href="cpp17-fold-expressions.html#rest_code_2f49ff6141b645d99d2821a01d8f43f1-2"></a><span class="kt">void</span><span class="w"> </span><span class="n">print_1</span><span class="p">(</span><span class="n">Args</span><span class="o">&amp;&amp;</span><span class="p">...</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="rest_code_2f49ff6141b645d99d2821a01d8f43f1-3" name="rest_code_2f49ff6141b645d99d2821a01d8f43f1-3" href="cpp17-fold-expressions.html#rest_code_2f49ff6141b645d99d2821a01d8f43f1-3"></a><span class="w">    </span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="sc">'\n'</span><span class="p">;</span>
<a id="rest_code_2f49ff6141b645d99d2821a01d8f43f1-4" name="rest_code_2f49ff6141b645d99d2821a01d8f43f1-4" href="cpp17-fold-expressions.html#rest_code_2f49ff6141b645d99d2821a01d8f43f1-4"></a><span class="p">}</span>
</pre></div>
<p>And this can even be used when doing Template Metaprogramming, for instance here is a TMP version of the and operator:</p>
<div class="code"><pre class="code c++"><a id="rest_code_6ac41b134a9e4d6d96ddeb5d15203e23-1" name="rest_code_6ac41b134a9e4d6d96ddeb5d15203e23-1" href="cpp17-fold-expressions.html#rest_code_6ac41b134a9e4d6d96ddeb5d15203e23-1"></a><span class="k">template</span><span class="o">&lt;</span><span class="kt">bool</span><span class="p">...</span><span class="w"> </span><span class="n">B</span><span class="o">&gt;</span>
<a id="rest_code_6ac41b134a9e4d6d96ddeb5d15203e23-2" name="rest_code_6ac41b134a9e4d6d96ddeb5d15203e23-2" href="cpp17-fold-expressions.html#rest_code_6ac41b134a9e4d6d96ddeb5d15203e23-2"></a><span class="k">struct</span><span class="w"> </span><span class="nc">fold_and</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">integral_constant</span><span class="o">&lt;</span><span class="kt">bool</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">B</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">...)</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{};</span>
</pre></div>
</section><section id="conclusion"><h2>Conclusion</h2>
<p>C++17 fold expressions are a really nice additions to the language that makes working with variadic templates much easier. This already makes me wish for C++17 release :)</p>
<p>The source code for the examples are available on Github: <a class="reference external" href="https://github.com/wichtounet/articles/blob/master/src/fold_expressions.cpp">https://github.com/wichtounet/articles/blob/master/src/fold_expressions.cpp</a></p>
</section><h3>Related articles</h3>
    

    <li><a href="../../2018/02/c++17-migration-of-expression-templates-library-etl.html">C++17 Migration of Expression Templates Library (ETL)</a></li>
<li><a href="../03/named-optional-template-parameters-compile-time.html">Named Optional Template parameters to configure a class at compile-time</a></li>
<li><a href="../07/simulate-static_if-with-c11c14.html">Simulate static_if with C++11/C++14</a></li>
<li><a href="../../2017/08/simplify-your-type-traits-with-c++14-variable-templates.html">Simplify your type traits with C++14 variable templates</a></li>
<li><a href="../../2016/12/cpp-compiler-benchmark-on-expression-templates-library-etl.html">C++ Compiler benchmark on Expression Templates Library (ETL)</a></li>
<li><a href="../../2018/02/decrease-dll-neural-network-compilation-time-with-c++17.html">Decrease DLL neural network compilation time with C++17</a></li>


    </div>
    <aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../../../categories/c%2B%2B.html" rel="tag">C++</a></li>
            <li><a class="tag p-category" href="../../../categories/c%2B%2B17.html" rel="tag">C++17</a></li>
        </ul>
<ul class="pager hidden-print">
<li class="previous">
                <a href="sonar-cpp-community-plugin-review.html" rel="prev" title="Sonar C++ Community Plugin Review">Previous post</a>
            </li>
            <li class="next">
                <a href="../06/continuous-performance-management-with-cpm-for-cpp.html" rel="next" title="Continuous Performance Management with CPM for C++">Next post</a>
            </li>
        </ul></nav></aside><section class="comments hidden-print"><h2>Comments</h2>
        
    
        <div id="disqus_thread"></div>
        <script>
        var disqus_shortname ="blogwichtounet",
            disqus_url="https://baptiste-wicht.com/posts/2015/05/cpp17-fold-expressions.html",
        disqus_title="C++17 Fold Expressions",
        disqus_identifier="cache/posts/2015/05/cpp17-fold-expressions.html",
        disqus_config = function () {
            this.language = "en";
        };
        (function() {
            var dsq = document.createElement('script'); dsq.async = true;
            dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
</noscript>
    <a href="https://disqus.com" class="dsq-brlink" rel="nofollow">Comments powered by <span class="logo-disqus">Disqus</span></a>


        </section></article><script>var disqus_shortname="blogwichtounet";(function(){var a=document.createElement("script");a.async=true;a.src="https://"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents Â© 2023         <a href="mailto:baptistewicht@gmail.com">Baptiste Wicht</a> - Powered by         <a href="http://getnikola.com" rel="nofollow">Nikola</a>         - License: 
<a rel="license" href="http://creativecommons.org/licenses/by/4.0/"><img alt="Creative Commons License" style="padding-left:5px;border-width:0" src="../../../assets/img/cc.png"></a>
            
        </footer>
</div>
</div>


            <script src="../../../assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script>
</body>
</html>
