(function($){$.fn.flowr=function(options){$this=this;var ROW_CLASS_NAME="flowr-row";var MAX_LAST_ROW_GAP=25;var NO_COPY_FIELDS=["complete","data","responsive"];var DEFAULTS={data:[],padding:5,height:240,render:null,append:false,widthAttr:"width",heightAttr:"height",maxScale:1.5,maxWidth:this.width()-1,itemWidth:null,itemHeight:null,complete:null,rowClassName:ROW_CLASS_NAME,rows:-1,responsive:true};var settings=$.extend(DEFAULTS,options);if(settings.append&&$this.data("lastSettings")){lastSettings=$this.data("lastSettings");for(attr in DEFAULTS){if(NO_COPY_FIELDS.indexOf(attr)<0&&settings[attr]==DEFAULTS[attr]){settings[attr]=lastSettings[attr]}}lastRow=$this.data("lastRow");if(lastRow.data.length>0&&settings.maxWidth-lastRow.width>MAX_LAST_ROW_GAP){lastRowData=lastSettings.data.slice(lastSettings.data.length-lastRow.data.length-1);settings.data=lastRowData.concat(settings.data);$("."+settings.rowClassName+":last",$this).detach()}else{}}if(!settings.responsive&&!settings.append){$this.width($this.width())}if(!(settings.data instanceof Array)){return}if(typeof(settings.padding)!="number"){settings.padding=parseInt(settings.padding)}if(typeof(settings.itemWidth)!="function"){settings.itemWidth=function(data){return data[settings.widthAttr]}}if(typeof(settings.itemHeight)!="function"){settings.itemHeight=function(data){return data[settings.heightAttr]}}var utils={getNextRow:function(data,settings){var itemIndex=0;var itemsLength=data.length;var lineItems=[];var lineWidth=0;var maxWidth=settings.maxWidth;var paddingSize=settings.padding;requiredPadding=function(){var extraPads=arguments.length==1?arguments[0]:0;return(lineItems.length-1+extraPads)*settings.padding};while(lineWidth+requiredPadding()<settings.maxWidth&&(itemIndex<itemsLength)){var itemData=data[itemIndex];var itemWidth=settings.itemWidth.call($this,itemData);var itemHeight=settings.itemHeight.call($this,itemData);var minHeight=settings.height;var minWidth=Math.floor(itemWidth*settings.height/itemHeight);var newLineWidth=lineWidth+minWidth+requiredPadding(1);if(minWidth>settings.maxWidth){minWidth=settings.maxWidth-1;minHeight=settings.height*minHeight/minWidth}if(newLineWidth<settings.maxWidth){lineItems.push({height:minHeight,width:minWidth,itemData:itemData});lineWidth+=minWidth;itemIndex++}else{break}}testWidth=0;if(lineWidth<settings.maxWidth){var fullScaleWidth=settings.maxWidth-requiredPadding()-10;var currScaleWidth=lineWidth;var scaleFactor=fullScaleWidth/currScaleWidth;if(scaleFactor>settings.maxScale){scaleFactor=1}var newHeight=Math.round(settings.height*scaleFactor);for(i=0;i<lineItems.length;i++){var lineItem=lineItems[i];lineItem.width=Math.floor(lineItem.width*scaleFactor);lineItem.height=newHeight;testWidth+=lineItem.width}}return{data:lineItems,width:testWidth+requiredPadding()}},reorderContent:function(){var _initialWidth=$this.data("width");var _newWidth=$this.width();var _change=_initialWidth-_newWidth;if(_initialWidth!=_newWidth){$this.html("");var _settings=$this.data("lastSettings");_settings.data=$this.data("data");_settings.maxWidth=$this.width()-1;$this.flowr(_settings)}}};if(settings.responsive&&!$this.data("__responsive")){$(window).resize(function(){initialWidth=$this.data("width");newWidth=$this.width();if(initialWidth!=newWidth){var task_id=$this.data("task_id");if(task_id){task_id=clearTimeout(task_id);task_id=null}task_id=setTimeout(utils.reorderContent,80);$this.data("task_id",task_id)}});$this.data("__responsive",true)}return this.each(function(){var data=settings.data.slice(0);var rowData=null;var currentRow=0;var currentItem=0;var allData=$this.data("data")||[];for(i=0;i<data.length;i++){allData.push(data[i])}$this.data("data",allData);while((rowData=utils.getNextRow(data,settings))!=null&&rowData.data.length>0){if(settings.rows>0&&currentRow>=settings.rows){break}data.splice(0,rowData.data.length);var $row=$("<div>").addClass(settings.rowClassName);for(i=0;i<rowData.data.length;i++){var displayData=rowData.data[i];var displayObject=settings.render.call($this,displayData);displayObject=$(displayObject);displayObject.css("width",displayData.width).css("height",displayData.height).css("margin-left",i==0?"0":settings.padding+"px");$row.append(displayObject);currentItem++}$this.append($row);currentRow++;$this.data("lastRow",rowData)}$this.data("lastSettings",settings);if(typeof(settings.complete)=="function"){var completeData={renderedRows:currentRow,renderedItems:currentItem};settings.complete.call($this,completeData)}})}})(jQuery);