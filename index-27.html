<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " lang="en">
<head>
<meta charset="utf-8">
<base href="http://baptiste-wicht.com/index-27.html">
<meta name="description" content="Website about vtechnologies Java, Spring, OSGi, Hardware,...">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>@Blog("Baptiste Wicht") (old posts, page 27) | @Blog("Baptiste Wicht")</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta content="#5670d4" name="theme-color">
<link rel="alternate" type="application/rss+xml" title="RSS" href="rss.xml">
<link rel="canonical" href="http://baptiste-wicht.com/index-27.html">
<link rel="prev" href="index.html" type="text/html">
<link rel="next" href="index-26.html" type="text/html">
<!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]--><script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-2175227-7']);
  _gaq.push(['_trackPageview']);
  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script><link href="favicon.ico" rel="icon" type="image/x-icon">
</head>
<body>

<div class="social_container">
    <div class="social_container_gplus">
        <a target="_blank" title="Share on Google+" href="https://plusone.google.com/_/+1/confirm?hl=en&amp;url=http://baptiste-wicht.com/index-27.html"><img src="assets/img/google_plus.png"></a>
    </div>
    <div class="social_container_facebook">
        <a target="_blank" title="Share on Facebook" href="http://www.facebook.com/sharer/sharer.php?u=#url"><img src="assets/img/facebook.png"></a>
    </div>
    <div class="social_container_twitter">
        <a target="_blank" title="Tweet on Twitter" href="http://twitter.com/home?status=#url"><img src="assets/img/twitter.svg"></a>
    </div>
</div>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-fixed-top" role="navigation"><div class="container-fluid">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="http://baptiste-wicht.com/">
                <span id="blog-title">@Blog("Baptiste Wicht")</span>
            </a>
        </div>
<!-- /.navbar-header -->
        
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
<li>
<a href="stories/about.html">About</a>
                </li>
<li>
<a href="stories/publications.html">Publications</a>
                </li>
<li>
<a href="stories/donate.html">Donate</a>
                </li>
<li>
<a href="stories/contact.html">Contact</a>
                </li>
<li>
<a href="stories/faq.html">FAQ</a>
                </li>
<li>
<a href="stories/legal.html">Legal</a>
                </li>
<li>
<a href="categories/index.html">Tags</a>
                </li>
<li>
<a href="archive.html">Archives</a>
                </li>
<li>
<a href="http://feeds.feedburner.com/BaptisteWicht">RSS</a>

            </li>
</ul>
<span class="navbar-form pull-left">
                <form action="stories/search.html">
                    <input type="text" name="q" id="tipue_search_input">
</form>
            </span>
            
            <ul class="nav navbar-nav navbar-right">
<li>
                    <a target="_blank" title="Follow @wichtounet on Twitter" href="https://twitter.com/wichtounet">
                        <img src="assets/img/twitter.svg" alt="Follow @wichtounet on Twitter"></a>
                </li>
                <li>
                    <a target="_blank" title="Follow +BaptisteWicht on Google+" href="https://plus.google.com/+BaptisteWicht">
                        <img src="assets/img/google_plus.svg" alt="Follow +BaptisteWicht on Google+"></a>
                </li>
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container-fluid -->
</nav><!-- End of Menubar --><div class="body-container">

    <!-- Sidebar -->

    <div class="left-sidebar">
            <div class="left-sidebar-widget">
                <h3>Welcome to my blog</h3>
                <div class="left-sidebar-widget-content">
                    <div class="g-person" data-width="275" data-href="//plus.google.com/u/0/103113673902796202116" data-theme="dark" data-layout="landscape" data-rel="author"></div>
                </div>
            </div>

            <div class="left-sidebar-widget">
                <h3>Tags</h3>
                <div class="left-sidebar-widget-content">
                    <div id="tags_container">
                        <canvas width="275" height="250" id="tags_canvas"><p>Anything in here will be replaced on browsers that support the canvas element</p>
                        </canvas>
</div>
                </div>
            </div>

        
        <div class="left-sidebar-widget">
            <h3>Recent comments</h3>
            <div class="left-sidebar-widget-content">
                <div id="recentcomments" class="dsq-widget">
                    <script type="text/javascript" src="http://blogwichtounet.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=0&amp;avatar_size=28&amp;excerpt_length=50"></script>
</div>
            </div>
        </div>

        <div class="left-sidebar-widget">
            <h3>Blogroll</h3>
            <div class="left-sidebar-widget-content">
                <ul>
<li><a target="_blank" href="http://www.asjava.com/">AsJava.com : Java Tutorial</a></li>
                    <li><a target="_blank" href="http://www.mkyong.com/">Mkyong : Java Tutorials</a></li>
                </ul>
</div>
        </div>
    </div>


    <!-- Content -->

    <div class="container">
        <div class="body-content">
            <div class="row">
                
        <article class="postbox h-entry post-text"><h1 class="p-name">
<a href="posts/2015/03/how-to-speed-up-raid-5-6-growing-with-mdadm.html" class="u-url">How to speed up RAID (5-6) growing with mdadm ?</a>
        <br><small>  
             Posted: <time class="published dt-published" datetime="2015-03-07T15:01:56+01:00">2015-03-07 15:01</time></small>
</h1>
        <hr>
<div class="p-summary">
        <div>
<p>Yesterday, I added my 11th disk to my RAID 6 array. As the last time it took my more than 20 hours, I spent some time investigating how to speed things up and this post contains some tips on how to achieve good grow performances. With these tips, I have been able to reach a speed of about 55K in average during reshape. It did finish in about 13 hours.</p>
<p>First, take into account that some of these tips may depend on your configuration. In my case, this server is only used for this RAID, so I don't care if the CPU is used a lot during rebuild or if other processes are suffering from the load. This may not be the case with your configuration. Moreover, I speak only of hard disks, if you use SSD RAID, there are probably better way of tuning the rebuild (or perhaps it is fast enough). Finally, you have know that a RAID reshape is going to be slow, there is no way you'll grow a 10+ RAID array in one hour. G</p>
<p>In the examples, I use /dev/md0 as the raid array, you'll have to change this to your array name.</p>
<p>The first 3 tips can be used even after the rebuild has started and you should the differences in real-time. But, these 3 tips will also be erased after each reboot.</p>
<div class="section" id="increase-speed-limits">
<h2>Increase speed limits</h2>
<p>The easiest thing to do is to increase the system speed limits on raid. You can see the current limits on your system by using these commands:</p>
<pre class="code bash"><a name="rest_code_b329535799e74467833c09b57c59aa18-1"></a>sysctl dev.raid.speed_limit_min
<a name="rest_code_b329535799e74467833c09b57c59aa18-2"></a>sysctl dev.raid.speed_limit_max
</pre>
<p>These values are set in Kibibytes per second (KiB/s).</p>
<p>You can put them to high values:</p>
<pre class="code bash"><a name="rest_code_d07c5d3f07a94d559099ce72e105eada-1"></a>sysctl -w dev.raid.speed_limit_min<span class="o">=</span>100000
<a name="rest_code_d07c5d3f07a94d559099ce72e105eada-2"></a>sysctl -w dev.raid.speed_limit_max<span class="o">=</span>500000
</pre>
<p>At least with these values, you won't be limited by the system.</p>
</div>
<div class="section" id="increase-stripe-cache-size">
<h2>Increase stripe cache size</h2>
<p>By allowing the array to use more memory for its stripe cache, you may improve the performances. In some cases, it can improve performances by up to 6 times. By default, the size of the stripe cache is 256, in pages. By default, Linux uses 4096B pages. If you use 256 pages for the stripe cache and you have 10 disks, the cache would use 10*256*4096=10MiB of RAM. In my case, I have increased it to 4096:</p>
<pre class="code bash"><a name="rest_code_b862311bb0904d4f87b122ec0755b55f-1"></a><span class="nb">echo</span> <span class="m">4096</span> &gt; /sys/block/md0/md/stripe_cache_size
</pre>
<p>The maximum value is 32768. If you have many disks, this may well take all your available memory. I don't think values higher than 4096 will improve performance, but feel free to try it ;)</p>
</div>
<div class="section" id="increase-read-ahead">
<h2>Increase read-ahead</h2>
<p>If configured too low, the read-ahead of your array may make things slower.</p>
<p>You can see get the current read-ahead value with this command:</p>
<pre class="code bash"><a name="rest_code_fa9492a17f2342a18e0ac055afbf64c1-1"></a>blockdev --getra /dev/md0
</pre>
<p>These values are in 512B sector. You can set it to 32MB to be sure:</p>
<pre class="code bash"><a name="rest_code_15178c202fcb4397bfc5781478d525e1-1"></a>blockdev --setra <span class="m">65536</span> /dev/md0
</pre>
<p>This can improve the performances, but don't expect this to be a game-changer unless it was configured really low at the first place.</p>
</div>
<div class="section" id="bonus-speed-up-standard-resync-with-a-write-intent-bitmap">
<h2>Bonus: Speed up standard resync with a write-intent bitmap</h2>
<p>Although it won't speed up the growing of your array, this is something that you should do after the rebuild has finished. Write-intent bitmaps is a kind of map of what needs to be resynced. This is of great help in several cases:</p>
<ul class="simple">
<li>When the computer crash (power shutdown for instance)</li>
<li>If a disk is disconnected, then reconnected.</li>
</ul>
<p>In these case, it may totally avoid the need of a rebuild which is great in my opinion. Moreover, it does not take any space on the array since it uses space that is not usable by the array.</p>
<p>Here is how to enable it:</p>
<pre class="code bash"><a name="rest_code_dac008e9b91642fb9b761cebab20b17a-1"></a>mdadm --grow --bitmap<span class="o">=</span>internal /dev/md0
</pre>
<p>However, it may cause some write performance degradation. In my case, I haven't seen any noticeable degradation, but if it is the case, you may want to disable it:</p>
<pre class="code bash"><a name="rest_code_ee02b772fe644779879a6154a27597d1-1"></a>mdadm --grow --bitmap<span class="o">=</span>none /dev/md0
</pre>
</div>
<div class="section" id="bonus-monitor-rebuild-process">
<h2>Bonus: Monitor rebuild process</h2>
<p>If you want to monitor the build process, you can use the watch command:</p>
<pre class="code bash"><a name="rest_code_885e77352e904bba9109beddc10fc8ff-1"></a>watch cat /proc/mdstat
</pre>
<p>With that you'll see the rebuild going in real-time.</p>
<p>You can also monitor the I/O statistics:</p>
<pre class="code bash"><a name="rest_code_922bae3a28b64019877084efa968b8c6-1"></a>watch iostat -k <span class="m">1</span> 2
</pre>
</div>
<div class="section" id="bonus-how-to-grow-a-raid-5-6-array">
<h2>Bonus: How to grow a RAID 5-6 array</h2>
<p>As a sidenote, this section indicates how to grow an array. If you  want to add the disk /dev/sdl to the array /dev/md0, you'll first have to add it:</p>
<pre class="code bash"><a name="rest_code_9448eec63cb945b7b5da1b231c2ab394-1"></a>mdadm --add /dev/md0 /dev/sdl
</pre>
<p>This will add the disk as a spare disk. If you had 5 disks before, you'll want to grow it to 6:</p>
<pre class="code bash"><a name="rest_code_db81fdc3b3484a2fa19715eeb3b28b5f-1"></a>mdadm --grow --backup-file<span class="o">=</span>/root/grow_md0_backup_file --raid-devices<span class="o">=</span><span class="m">6</span> /dev/md0
</pre>
<p>The backup file must be on another disk of course. The backup file is optional but improves the chance of success if you have a power shutdown or another form of unexpected shutdown. If you know what you're doing, you can grow it without backup-file:</p>
<pre class="code bash"><a name="rest_code_71b58a5f2cb74515ade7f35bfaaf9ab1-1"></a>mdadm --grow --raid-devices<span class="o">=</span><span class="m">6</span> /dev/md0
</pre>
<p>This command will return almost instantly, but the actual reshape won't likely be finished for hours (maybe days). kkkkkkkkkkkkk</p>
<p>Once the rebuild is finished, you'll still have to extend the partitions with resize2fs. If you use LVM on top of the array, you'll have to resize the Physical Volume (PV) first:</p>
<pre class="code bash"><a name="rest_code_9b014f781ef64d128cfd9a0761884d8c-1"></a>pvresize /dev/md0
</pre>
<p>and then extend the Logical Volume (s) (LV). For instance, if you want to add 1T to a LV named /dev/vgraid/work:</p>
<pre class="code bash"><a name="rest_code_8c3aff1d5c9c4ab7ae272cb2c8484e1c-1"></a>vgextend -r -L+1T /dev/vgraid/work
</pre>
<p>The -r option will automatically resize the underlying filesystem. Otherwise, you'd still have to resize it with resize2fs.</p>
</div>
<div class="section" id="conclusion">
<h2>Conclusion</h2>
<p>These are the changes I have found that speed up the reshape process. There are others that you may test in your case. For instance, in some systems disabling NCQ on each disk may help.</p>
<p>I hope that these tips will help you doing fast rebuilds in your RAID array :)</p>
</div>
</div>
        </div>
            
        
    <a href="posts/2015/03/how-to-speed-up-raid-5-6-growing-with-mdadm.html#disqus_thread" data-disqus-identifier="cache/posts/2015/03/how-to-speed-up-raid-5-6-growing-with-mdadm.html">Comments</a>


        </article><article class="postbox h-entry post-text"><h1 class="p-name">
<a href="posts/2015/03/named-optional-template-parameters-compile-time.html" class="u-url">Named Optional Template parameters to configure a class at compile-time</a>
        <br><small>  
             Posted: <time class="published dt-published" datetime="2015-03-01T15:52:41+01:00">2015-03-01 15:52</time></small>
</h1>
        <hr>
<div class="p-summary">
        <div>
<p>In this post, I'll describe a technique that can be used to configure a class at compile-time when there are multiple, optional parameters, with default values to this class. I used this technique in my dll project to configure each instance of Restricted Boltzmann Machine.</p>
<p>The technique presented here will only work with C++11 because of the need for variadic template. This could be emulated without them by fixing a maximum number of parameters, but I won't go into this in this post.</p>
<div class="section" id="the-problem">
<h2>The problem</h2>
<p>For this post, we'll take the case of a single class, let's call it configurable. This class has several parameters:</p>
<ul class="simple">
<li>A of type int</li>
<li>B of type char</li>
<li>C of an enum type</li>
<li>D of type bool</li>
<li>E is a type</li>
<li>F is a template type</li>
</ul>
<p>This class could simply be written as such:</p>
<pre class="code c++"><a name="rest_code_bdc7bb845e4046648859328521d62b6f-1"></a><span class="k">enum</span> <span class="k">class</span> <span class="nc">type</span> <span class="p">{</span>
<a name="rest_code_bdc7bb845e4046648859328521d62b6f-2"></a>    <span class="n">AAA</span><span class="p">,</span>
<a name="rest_code_bdc7bb845e4046648859328521d62b6f-3"></a>    <span class="n">BBB</span><span class="p">,</span>
<a name="rest_code_bdc7bb845e4046648859328521d62b6f-4"></a>    <span class="n">CCC</span>
<a name="rest_code_bdc7bb845e4046648859328521d62b6f-5"></a><span class="p">};</span>
<a name="rest_code_bdc7bb845e4046648859328521d62b6f-6"></a>
<a name="rest_code_bdc7bb845e4046648859328521d62b6f-7"></a><span class="k">template</span><span class="o">&lt;</span><span class="kt">int</span> <span class="n">T_A</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="kt">char</span> <span class="n">T_B</span> <span class="o">=</span> <span class="sc">'b'</span><span class="p">,</span> <span class="n">type</span> <span class="n">T_C</span> <span class="o">=</span> <span class="n">type</span><span class="o">::</span><span class="n">BBB</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">T_D</span> <span class="o">=</span> <span class="nb">false</span><span class="p">,</span> <span class="k">typename</span> <span class="n">T_E</span> <span class="o">=</span> <span class="n">watcher_1</span><span class="p">,</span> <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="o">&gt;</span> <span class="k">class</span> <span class="nc">T_F</span> <span class="o">=</span> <span class="n">trainer_1</span><span class="o">&gt;</span>
<a name="rest_code_bdc7bb845e4046648859328521d62b6f-8"></a><span class="k">struct</span> <span class="n">configurable_v1</span> <span class="p">{</span>
<a name="rest_code_bdc7bb845e4046648859328521d62b6f-9"></a>    <span class="k">static</span> <span class="k">constexpr</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">A</span> <span class="o">=</span> <span class="n">T_A</span><span class="p">;</span>
<a name="rest_code_bdc7bb845e4046648859328521d62b6f-10"></a>    <span class="k">static</span> <span class="k">constexpr</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">B</span> <span class="o">=</span> <span class="n">T_B</span><span class="p">;</span>
<a name="rest_code_bdc7bb845e4046648859328521d62b6f-11"></a>    <span class="k">static</span> <span class="k">constexpr</span> <span class="k">const</span> <span class="n">type</span> <span class="n">C</span> <span class="o">=</span> <span class="n">T_C</span><span class="p">;</span>
<a name="rest_code_bdc7bb845e4046648859328521d62b6f-12"></a>    <span class="k">static</span> <span class="k">constexpr</span> <span class="k">const</span> <span class="kt">bool</span> <span class="n">D</span> <span class="o">=</span> <span class="n">T_D</span><span class="p">;</span>
<a name="rest_code_bdc7bb845e4046648859328521d62b6f-13"></a>
<a name="rest_code_bdc7bb845e4046648859328521d62b6f-14"></a>    <span class="k">using</span> <span class="n">E</span> <span class="o">=</span> <span class="n">T_E</span><span class="p">;</span>
<a name="rest_code_bdc7bb845e4046648859328521d62b6f-15"></a>
<a name="rest_code_bdc7bb845e4046648859328521d62b6f-16"></a>    <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">C</span><span class="o">&gt;</span>
<a name="rest_code_bdc7bb845e4046648859328521d62b6f-17"></a>    <span class="k">using</span> <span class="n">F</span> <span class="o">=</span> <span class="n">T_F</span><span class="o">&lt;</span><span class="n">C</span><span class="o">&gt;</span><span class="p">;</span>
<a name="rest_code_bdc7bb845e4046648859328521d62b6f-18"></a>
<a name="rest_code_bdc7bb845e4046648859328521d62b6f-19"></a>    <span class="c1">//Something useful</span>
<a name="rest_code_bdc7bb845e4046648859328521d62b6f-20"></a><span class="p">};</span>
</pre>
<p>and used simply as well:</p>
<pre class="code c++"><a name="rest_code_d973368fcef746eeb4d5c30549428c1c-1"></a><span class="k">using</span> <span class="n">configurable_v1_t</span> <span class="o">=</span> <span class="n">configurable_v1</span><span class="o">&lt;</span><span class="mi">100</span><span class="p">,</span> <span class="sc">'z'</span><span class="p">,</span> <span class="n">type</span><span class="o">::</span><span class="n">CCC</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="n">watcher_2</span><span class="p">,</span> <span class="n">trainer_2</span><span class="o">&gt;</span><span class="p">;</span>
</pre>
<p>This works well and nothing is wrong with this code. However, if you want all default values but the last one, you have to specify each and every one of the previous template parameters as well. The first disadvantage is that it is verbose and tedious. Secondly, instead of using directly the default values implicitly, you have specified them. This means that if the default values are changed by the library authors or even by you in the configurable_v1 class, either all the usages will be out of sync or you'll have to update them. And again, this is not practical. Moreover, if the author of the configurable_v1 template adds new template parameters before the last, you'll have to update all the instantiation points as well.</p>
<p>Moreover, here we only have 6 parameters, if you have more, the problem becomes even worse.</p>
</div>
<div class="section" id="the-solution">
<h2>The solution</h2>
<p>What can we do to improve over these problems ? We are going to use variadic template parameters in the configurable class and use simple classes for each possible parameters. This will be done in the configurable_v2 class. At the end you could use the class as such:</p>
<pre class="code c++"><a name="rest_code_3ac29081825a4e0da053b4b6be10388e-1"></a><span class="k">using</span> <span class="n">configurable_v2_t1</span> <span class="o">=</span> <span class="n">configurable_v2</span><span class="o">&lt;</span><span class="n">a</span><span class="o">&lt;</span><span class="mi">100</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">b</span><span class="o">&lt;</span><span class="sc">'z'</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">c</span><span class="o">&lt;</span><span class="n">type</span><span class="o">::</span><span class="n">CCC</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">e</span><span class="o">&lt;</span><span class="n">watcher_2</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">f</span><span class="o">&lt;</span><span class="n">trainer_2</span><span class="o">&gt;&gt;</span><span class="p">;</span>
<a name="rest_code_3ac29081825a4e0da053b4b6be10388e-2"></a><span class="k">using</span> <span class="n">configurable_v2_t2</span> <span class="o">=</span> <span class="n">configurable_v2</span><span class="o">&lt;</span><span class="n">f</span><span class="o">&lt;</span><span class="n">trainer_2</span><span class="o">&gt;&gt;</span><span class="p">;</span>
</pre>
<p>You can note, that on the second line, we only specified the value for the last parameter without specifiyng any other value :) This is also much more flexible since the order of the parameters has absolutely no impact. Here, for the sake of the example, the parameters are badly named, so it is not very clear what this do, but in practice, you can give better names to the parameters and make the types more clear. Here is an example from my dll library:</p>
<pre class="code c++"><a name="rest_code_6c69983278a249f4a5eb101a981131b8-1"></a><span class="k">using</span> <span class="n">rbm_t</span> <span class="o">=</span> <span class="n">dll</span><span class="o">::</span><span class="n">rbm_desc</span><span class="o">&lt;</span>
<a name="rest_code_6c69983278a249f4a5eb101a981131b8-2"></a>    <span class="mi">28</span> <span class="o">*</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span>
<a name="rest_code_6c69983278a249f4a5eb101a981131b8-3"></a>   <span class="n">dll</span><span class="o">::</span><span class="n">batch_size</span><span class="o">&lt;</span><span class="mi">25</span><span class="o">&gt;</span><span class="p">,</span>
<a name="rest_code_6c69983278a249f4a5eb101a981131b8-4"></a>   <span class="n">dll</span><span class="o">::</span><span class="n">momentum</span><span class="p">,</span>
<a name="rest_code_6c69983278a249f4a5eb101a981131b8-5"></a>   <span class="n">dll</span><span class="o">::</span><span class="n">weight_decay</span><span class="o">&lt;&gt;</span><span class="p">,</span>
<a name="rest_code_6c69983278a249f4a5eb101a981131b8-6"></a>   <span class="n">dll</span><span class="o">::</span><span class="n">visible</span><span class="o">&lt;</span><span class="n">dll</span><span class="o">::</span><span class="n">unit_type</span><span class="o">::</span><span class="n">GAUSSIAN</span><span class="o">&gt;</span><span class="p">,</span>
<a name="rest_code_6c69983278a249f4a5eb101a981131b8-7"></a>   <span class="n">dll</span><span class="o">::</span><span class="n">shuffle</span><span class="p">,</span>
<a name="rest_code_6c69983278a249f4a5eb101a981131b8-8"></a>   <span class="n">dll</span><span class="o">::</span><span class="n">weight_type</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span>
<a name="rest_code_6c69983278a249f4a5eb101a981131b8-9"></a><span class="o">&gt;::</span><span class="n">rbm_t</span><span class="p">;</span>
</pre>
<p>rbm_desc is class that is configurable with this technique, expect that the first two parameters are mandatory and not named. I personally thinks that this is quite clear, but of course I may be biased ;)</p>
<p>So let's code!</p>
<p>The class declaration is quite simple:</p>
<pre class="code c++"><a name="rest_code_58fd20091396431abbfff24fc36f26b9-1"></a><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="p">...</span> <span class="n">Args</span><span class="o">&gt;</span>
<a name="rest_code_58fd20091396431abbfff24fc36f26b9-2"></a><span class="k">struct</span> <span class="n">configurable_v2</span> <span class="p">{</span>
<a name="rest_code_58fd20091396431abbfff24fc36f26b9-3"></a>    <span class="c1">//Coming</span>
<a name="rest_code_58fd20091396431abbfff24fc36f26b9-4"></a><span class="p">}</span>
</pre>
<p>We will now have to exact values and types from Args in order to get the 4 values, the type and the template type out of Args.</p>
</div>
<div class="section" id="extracting-integral-values">
<h2>Extracting integral values</h2>
<p>We will start with the parameter <em>a</em> that holds a value of type int with a default value of 1. Here is one way of writing it:</p>
<pre class="code c++"><a name="rest_code_abd56b23a2174a16a72d29cf50986d0d-1"></a><span class="k">struct</span> <span class="n">a_id</span><span class="p">;</span>
<a name="rest_code_abd56b23a2174a16a72d29cf50986d0d-2"></a>
<a name="rest_code_abd56b23a2174a16a72d29cf50986d0d-3"></a><span class="k">template</span><span class="o">&lt;</span><span class="kt">int</span> <span class="n">value</span><span class="o">&gt;</span>
<a name="rest_code_abd56b23a2174a16a72d29cf50986d0d-4"></a><span class="k">struct</span> <span class="nl">a</span> <span class="p">:</span> <span class="n">std</span><span class="o">::</span><span class="n">integral_constant</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">value</span><span class="o">&gt;</span> <span class="p">{</span>
<a name="rest_code_abd56b23a2174a16a72d29cf50986d0d-5"></a>    <span class="k">using</span> <span class="n">type_id</span> <span class="o">=</span> <span class="n">a_id</span><span class="p">;</span>
<a name="rest_code_abd56b23a2174a16a72d29cf50986d0d-6"></a><span class="p">};</span>
</pre>
<p>So, <em>a</em> is simply an integral constant with another typedef <em>type_id</em>. Why do we need this id ? Because a is a type template, we cannot use std::is_same to compare it with other types, since its value is part of the type. If we had only int values, we could easily write a traits that indicates if the type is a specialization of a, but since will have several types, this would be a real pain to do and we would need such a traits for each possible type. Here the simple way to go is to add inner identifiers to each types.</p>
<p>We can now write a struct to extract the int value for a from <em>Args</em>. <em>Args</em> is a list of types in the form parameter_name&lt;parameter_value&gt;... . We have to find a specialization of a inside this list. If such a specialization is present, we'll take its integral constant value as the value for a, otherwise, we'll take the default values. Here is what we want to do:</p>
<pre class="code c++"><a name="rest_code_e7a8ab3b5fe245de973720a9ab9c6a28-1"></a><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="p">...</span> <span class="n">Args</span><span class="o">&gt;</span>
<a name="rest_code_e7a8ab3b5fe245de973720a9ab9c6a28-2"></a><span class="k">struct</span> <span class="n">configurable_v2</span> <span class="p">{</span>
<a name="rest_code_e7a8ab3b5fe245de973720a9ab9c6a28-3"></a>    <span class="k">static</span> <span class="k">constexpr</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">A</span> <span class="o">=</span> <span class="n">get_value_int</span><span class="o">&lt;</span><span class="n">a</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">Args</span><span class="p">...</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">;</span>
<a name="rest_code_e7a8ab3b5fe245de973720a9ab9c6a28-4"></a>
<a name="rest_code_e7a8ab3b5fe245de973720a9ab9c6a28-5"></a>    <span class="c1">//Coming</span>
<a name="rest_code_e7a8ab3b5fe245de973720a9ab9c6a28-6"></a><span class="p">}</span>
</pre>
<p>We specify directly into the class the default values (1) for a and we use the class <em>get_value_int</em> to get its value from the variadic type list. Here is the implementation:</p>
<pre class="code c++"><a name="rest_code_634dc7f1b51743c1ac36b50a1163ac16-1"></a><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">D</span><span class="p">,</span> <span class="k">typename</span><span class="p">...</span> <span class="n">Args</span><span class="o">&gt;</span>
<a name="rest_code_634dc7f1b51743c1ac36b50a1163ac16-2"></a><span class="k">struct</span> <span class="n">get_value_int</span><span class="p">;</span>
<a name="rest_code_634dc7f1b51743c1ac36b50a1163ac16-3"></a>
<a name="rest_code_634dc7f1b51743c1ac36b50a1163ac16-4"></a><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">D</span><span class="o">&gt;</span>
<a name="rest_code_634dc7f1b51743c1ac36b50a1163ac16-5"></a><span class="k">struct</span> <span class="n">get_value_int</span><span class="o">&lt;</span><span class="n">D</span><span class="o">&gt;</span> <span class="o">:</span> <span class="n">std</span><span class="o">::</span><span class="n">integral_constant</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">D</span><span class="o">::</span><span class="n">value</span><span class="o">&gt;</span> <span class="p">{};</span>
<a name="rest_code_634dc7f1b51743c1ac36b50a1163ac16-6"></a>
<a name="rest_code_634dc7f1b51743c1ac36b50a1163ac16-7"></a><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">D</span><span class="p">,</span> <span class="k">typename</span> <span class="n">T2</span><span class="p">,</span> <span class="k">typename</span><span class="p">...</span> <span class="n">Args</span><span class="o">&gt;</span>
<a name="rest_code_634dc7f1b51743c1ac36b50a1163ac16-8"></a><span class="k">struct</span> <span class="n">get_value_int</span><span class="o">&lt;</span><span class="n">D</span><span class="p">,</span> <span class="n">T2</span><span class="p">,</span> <span class="n">Args</span><span class="p">...</span><span class="o">&gt;</span> <span class="p">{</span>
<a name="rest_code_634dc7f1b51743c1ac36b50a1163ac16-9"></a>    <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">D2</span><span class="p">,</span> <span class="k">typename</span> <span class="n">T22</span><span class="p">,</span> <span class="k">typename</span> <span class="n">Enable</span> <span class="o">=</span> <span class="kt">void</span><span class="o">&gt;</span>
<a name="rest_code_634dc7f1b51743c1ac36b50a1163ac16-10"></a>    <span class="k">struct</span> <span class="nl">impl</span>
<a name="rest_code_634dc7f1b51743c1ac36b50a1163ac16-11"></a>        <span class="p">:</span> <span class="n">std</span><span class="o">::</span><span class="n">integral_constant</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">get_value_int</span><span class="o">&lt;</span><span class="n">D</span><span class="p">,</span> <span class="n">Args</span><span class="p">...</span><span class="o">&gt;::</span><span class="n">value</span><span class="o">&gt;</span> <span class="p">{};</span>
<a name="rest_code_634dc7f1b51743c1ac36b50a1163ac16-12"></a>
<a name="rest_code_634dc7f1b51743c1ac36b50a1163ac16-13"></a>    <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">D2</span><span class="p">,</span> <span class="k">typename</span> <span class="n">T22</span><span class="o">&gt;</span>
<a name="rest_code_634dc7f1b51743c1ac36b50a1163ac16-14"></a>    <span class="k">struct</span> <span class="n">impl</span> <span class="o">&lt;</span><span class="n">D2</span><span class="p">,</span> <span class="n">T22</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">enable_if_t</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">is_same</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">D2</span><span class="o">::</span><span class="n">type_id</span><span class="p">,</span> <span class="k">typename</span> <span class="n">T22</span><span class="o">::</span><span class="n">type_id</span><span class="o">&gt;::</span><span class="n">value</span><span class="o">&gt;&gt;</span>
<a name="rest_code_634dc7f1b51743c1ac36b50a1163ac16-15"></a>        <span class="o">:</span> <span class="n">std</span><span class="o">::</span><span class="n">integral_constant</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">T22</span><span class="o">::</span><span class="n">value</span><span class="o">&gt;</span> <span class="p">{};</span>
<a name="rest_code_634dc7f1b51743c1ac36b50a1163ac16-16"></a>
<a name="rest_code_634dc7f1b51743c1ac36b50a1163ac16-17"></a>    <span class="k">static</span> <span class="k">constexpr</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">value</span> <span class="o">=</span> <span class="n">impl</span><span class="o">&lt;</span><span class="n">D</span><span class="p">,</span> <span class="n">T2</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">;</span>
<a name="rest_code_634dc7f1b51743c1ac36b50a1163ac16-18"></a><span class="p">};</span>
</pre>
<p>If you are not really familiar with Template Metaprogramming (TMP), this may seems very unfamiliar or even barbaric, but I'll try to explain into details what is going on here :)</p>
<p><em>get_value_int</em> is a template that takes a type D, representing the parameter we want to extract and its default, and the list of args. It has a first partial specialization for the case when Args is empty. In which case, its value is simply the value inside D (the default value). The second partial specialization handles the case when there are at least one type (T2) inside the list of args. This separation in two partial specialization is the standard way to works with variadic template parameters. This specialization is more complicated than the first one since it uses an inner class to get the value out of the list. The inner class (impl) takes the parameter type (D2), the type that is present in the list (T22) and a special parameter (Enable) that is used for SFINAE. If you're not familiar with SFINAE (you're probably not reading this article...), it is, put simply, a mean to activate or deactivate a template class or function based on its template parameters. Here, the partial specialization of <em>impl</em> is enabled if <em>T22</em> and <em>D2</em> have the same <em>type_id</em>, in which case, the value of <em>T22</em> is taken as the return of <em>impl</em>. In the basic case, template recursion is used to continue iterating over the list of types. The fact that this has to be done into two template classes is because we cannot add a new template parameter to a partial template specialization even without a name. We cannot either add a simple <em>Enable</em> parameter to get_value_int, we cannot put before Args since then it would be necessary to give it a value in the code that uses it which is not practical neither a good practice.</p>
<p>We can now do the same for b that is of type char. Here is the parameter definition for b:</p>
<pre class="code c++"><a name="rest_code_67fe8a7be2214d4e86da6d977258f4a3-1"></a><span class="k">struct</span> <span class="n">a_id</span><span class="p">;</span>
<a name="rest_code_67fe8a7be2214d4e86da6d977258f4a3-2"></a>
<a name="rest_code_67fe8a7be2214d4e86da6d977258f4a3-3"></a><span class="k">template</span><span class="o">&lt;</span><span class="kt">int</span> <span class="n">value</span><span class="o">&gt;</span>
<a name="rest_code_67fe8a7be2214d4e86da6d977258f4a3-4"></a><span class="k">struct</span> <span class="nl">a</span> <span class="p">:</span> <span class="n">std</span><span class="o">::</span><span class="n">integral_constant</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">value</span><span class="o">&gt;</span> <span class="p">{</span>
<a name="rest_code_67fe8a7be2214d4e86da6d977258f4a3-5"></a>    <span class="k">using</span> <span class="n">type_id</span> <span class="o">=</span> <span class="n">a_id</span><span class="p">;</span>
<a name="rest_code_67fe8a7be2214d4e86da6d977258f4a3-6"></a><span class="p">};</span>
</pre>
<p>This code is highly similar to the code for a, so we can generalize a bit this with a base class:</p>
<pre class="code c++"><a name="rest_code_8c656c4237764ae78c4a467bfafcbb14-1"></a><span class="k">struct</span> <span class="n">a_id</span><span class="p">;</span>
<a name="rest_code_8c656c4237764ae78c4a467bfafcbb14-2"></a><span class="k">struct</span> <span class="n">b_id</span><span class="p">;</span>
<a name="rest_code_8c656c4237764ae78c4a467bfafcbb14-3"></a>
<a name="rest_code_8c656c4237764ae78c4a467bfafcbb14-4"></a><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">ID</span><span class="p">,</span> <span class="k">typename</span> <span class="n">T</span><span class="p">,</span> <span class="n">T</span> <span class="n">value</span><span class="o">&gt;</span>
<a name="rest_code_8c656c4237764ae78c4a467bfafcbb14-5"></a><span class="k">struct</span> <span class="nl">value_conf_t</span> <span class="p">:</span> <span class="n">std</span><span class="o">::</span><span class="n">integral_constant</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">value</span><span class="o">&gt;</span> <span class="p">{</span>
<a name="rest_code_8c656c4237764ae78c4a467bfafcbb14-6"></a>    <span class="k">using</span> <span class="n">type_id</span> <span class="o">=</span> <span class="n">ID</span><span class="p">;</span>
<a name="rest_code_8c656c4237764ae78c4a467bfafcbb14-7"></a><span class="p">};</span>
<a name="rest_code_8c656c4237764ae78c4a467bfafcbb14-8"></a>
<a name="rest_code_8c656c4237764ae78c4a467bfafcbb14-9"></a><span class="k">template</span><span class="o">&lt;</span><span class="kt">int</span> <span class="n">value</span><span class="o">&gt;</span>
<a name="rest_code_8c656c4237764ae78c4a467bfafcbb14-10"></a><span class="k">struct</span> <span class="nl">a</span> <span class="p">:</span> <span class="n">value_conf_t</span><span class="o">&lt;</span><span class="n">a_id</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">value</span><span class="o">&gt;</span> <span class="p">{};</span>
<a name="rest_code_8c656c4237764ae78c4a467bfafcbb14-11"></a>
<a name="rest_code_8c656c4237764ae78c4a467bfafcbb14-12"></a><span class="k">template</span><span class="o">&lt;</span><span class="kt">char</span> <span class="n">value</span><span class="o">&gt;</span>
<a name="rest_code_8c656c4237764ae78c4a467bfafcbb14-13"></a><span class="k">struct</span> <span class="nl">b</span> <span class="p">:</span> <span class="n">value_conf_t</span><span class="o">&lt;</span><span class="n">b_id</span><span class="p">,</span> <span class="kt">char</span><span class="p">,</span> <span class="n">value</span><span class="o">&gt;</span> <span class="p">{};</span>
</pre>
<p>This make the next  parameters easier to describe and avoids small mistakes.</p>
<p>Making <em>get_value_char</em> could be achieved by replacing each <em>int</em> by <em>char</em> but this would create a lot of duplicated code. So instead of writing <em>get_value_char</em>, we will replace <em>get_value_int</em> with a generic <em>get_value</em> that is able to extract any integral value type:</p>
<pre class="code c++"><a name="rest_code_7e2f8ae066834c3c997c2739a8011480-1"></a><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">D</span><span class="p">,</span> <span class="k">typename</span><span class="p">...</span> <span class="n">Args</span><span class="o">&gt;</span>
<a name="rest_code_7e2f8ae066834c3c997c2739a8011480-2"></a><span class="k">struct</span> <span class="n">get_value</span><span class="p">;</span>
<a name="rest_code_7e2f8ae066834c3c997c2739a8011480-3"></a>
<a name="rest_code_7e2f8ae066834c3c997c2739a8011480-4"></a><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">D</span><span class="p">,</span> <span class="k">typename</span> <span class="n">T2</span><span class="p">,</span> <span class="k">typename</span><span class="p">...</span> <span class="n">Args</span><span class="o">&gt;</span>
<a name="rest_code_7e2f8ae066834c3c997c2739a8011480-5"></a><span class="k">struct</span> <span class="n">get_value</span><span class="o">&lt;</span><span class="n">D</span><span class="p">,</span> <span class="n">T2</span><span class="p">,</span> <span class="n">Args</span><span class="p">...</span><span class="o">&gt;</span> <span class="p">{</span>
<a name="rest_code_7e2f8ae066834c3c997c2739a8011480-6"></a>    <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">D2</span><span class="p">,</span> <span class="k">typename</span> <span class="n">T22</span><span class="p">,</span> <span class="k">typename</span> <span class="n">Enable</span> <span class="o">=</span> <span class="kt">void</span><span class="o">&gt;</span>
<a name="rest_code_7e2f8ae066834c3c997c2739a8011480-7"></a>    <span class="k">struct</span> <span class="nl">impl</span>
<a name="rest_code_7e2f8ae066834c3c997c2739a8011480-8"></a>        <span class="p">:</span> <span class="n">std</span><span class="o">::</span><span class="n">integral_constant</span><span class="o">&lt;</span><span class="k">decltype</span><span class="p">(</span><span class="n">D</span><span class="o">::</span><span class="n">value</span><span class="p">),</span> <span class="n">get_value</span><span class="o">&lt;</span><span class="n">D</span><span class="p">,</span> <span class="n">Args</span><span class="p">...</span><span class="o">&gt;::</span><span class="n">value</span><span class="o">&gt;</span> <span class="p">{};</span>
<a name="rest_code_7e2f8ae066834c3c997c2739a8011480-9"></a>
<a name="rest_code_7e2f8ae066834c3c997c2739a8011480-10"></a>    <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">D2</span><span class="p">,</span> <span class="k">typename</span> <span class="n">T22</span><span class="o">&gt;</span>
<a name="rest_code_7e2f8ae066834c3c997c2739a8011480-11"></a>    <span class="k">struct</span> <span class="n">impl</span> <span class="o">&lt;</span><span class="n">D2</span><span class="p">,</span> <span class="n">T22</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">enable_if_t</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">is_same</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">D2</span><span class="o">::</span><span class="n">type_id</span><span class="p">,</span> <span class="k">typename</span> <span class="n">T22</span><span class="o">::</span><span class="n">type_id</span><span class="o">&gt;::</span><span class="n">value</span><span class="o">&gt;&gt;</span>
<a name="rest_code_7e2f8ae066834c3c997c2739a8011480-12"></a>        <span class="o">:</span> <span class="n">std</span><span class="o">::</span><span class="n">integral_constant</span><span class="o">&lt;</span><span class="k">decltype</span><span class="p">(</span><span class="n">D</span><span class="o">::</span><span class="n">value</span><span class="p">),</span> <span class="n">T22</span><span class="o">::</span><span class="n">value</span><span class="o">&gt;</span> <span class="p">{};</span>
<a name="rest_code_7e2f8ae066834c3c997c2739a8011480-13"></a>
<a name="rest_code_7e2f8ae066834c3c997c2739a8011480-14"></a>    <span class="k">static</span> <span class="k">constexpr</span> <span class="k">const</span> <span class="k">auto</span> <span class="n">value</span> <span class="o">=</span> <span class="n">impl</span><span class="o">&lt;</span><span class="n">D</span><span class="p">,</span> <span class="n">T2</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">;</span>
<a name="rest_code_7e2f8ae066834c3c997c2739a8011480-15"></a><span class="p">};</span>
<a name="rest_code_7e2f8ae066834c3c997c2739a8011480-16"></a>
<a name="rest_code_7e2f8ae066834c3c997c2739a8011480-17"></a><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">D</span><span class="o">&gt;</span>
<a name="rest_code_7e2f8ae066834c3c997c2739a8011480-18"></a><span class="k">struct</span> <span class="n">get_value</span><span class="o">&lt;</span><span class="n">D</span><span class="o">&gt;</span> <span class="o">:</span> <span class="n">std</span><span class="o">::</span><span class="n">integral_constant</span><span class="o">&lt;</span><span class="k">decltype</span><span class="p">(</span><span class="n">D</span><span class="o">::</span><span class="n">value</span><span class="p">),</span> <span class="n">D</span><span class="o">::</span><span class="n">value</span><span class="o">&gt;</span> <span class="p">{};</span>
</pre>
<p>This code is almost the same as get_value_int except that the return type is deduced from the value of the parameters. I used <em>decltype</em> and <em>auto</em> to automatically gets the correct types for the values. This is the only thing that changed.</p>
<p>With that we are ready the parameter c as well:</p>
<pre class="code c++"><a name="rest_code_63a06addad9c4da7b457390eb0ab754d-1"></a><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="p">...</span> <span class="n">Args</span><span class="o">&gt;</span>
<a name="rest_code_63a06addad9c4da7b457390eb0ab754d-2"></a><span class="k">struct</span> <span class="n">configurable_v2</span> <span class="p">{</span>
<a name="rest_code_63a06addad9c4da7b457390eb0ab754d-3"></a>    <span class="k">static</span> <span class="k">constexpr</span> <span class="k">const</span> <span class="k">auto</span> <span class="n">A</span> <span class="o">=</span> <span class="n">get_value</span><span class="o">&lt;</span><span class="n">a</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">Args</span><span class="p">...</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">;</span>
<a name="rest_code_63a06addad9c4da7b457390eb0ab754d-4"></a>    <span class="k">static</span> <span class="k">constexpr</span> <span class="k">const</span> <span class="k">auto</span> <span class="n">B</span> <span class="o">=</span> <span class="n">get_value</span><span class="o">&lt;</span><span class="n">b</span><span class="o">&lt;</span><span class="sc">'b'</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">Args</span><span class="p">...</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">;</span>
<a name="rest_code_63a06addad9c4da7b457390eb0ab754d-5"></a>    <span class="k">static</span> <span class="k">constexpr</span> <span class="k">const</span> <span class="k">auto</span> <span class="n">C</span> <span class="o">=</span> <span class="n">get_value</span><span class="o">&lt;</span><span class="n">c</span><span class="o">&lt;</span><span class="n">type</span><span class="o">::</span><span class="n">BBB</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">Args</span><span class="p">...</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">;</span>
<a name="rest_code_63a06addad9c4da7b457390eb0ab754d-6"></a>
<a name="rest_code_63a06addad9c4da7b457390eb0ab754d-7"></a>    <span class="c1">//Coming</span>
<a name="rest_code_63a06addad9c4da7b457390eb0ab754d-8"></a><span class="p">};</span>
</pre>
</div>
<div class="section" id="extracting-boolean-flags">
<h2>Extracting boolean flags</h2>
<p>The parameter d is a bit different since it is a boolean flag that puts directly the value to true. We could simply make a integral boolean value (and this would work), but here I needed a boolean flag for activating a feature deactivated by default.</p>
<p>Defining the parameter is easy:</p>
<pre class="code c++"><a name="rest_code_c693157a0dee4442989039eff91def90-1"></a><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">ID</span><span class="o">&gt;</span>
<a name="rest_code_c693157a0dee4442989039eff91def90-2"></a><span class="k">struct</span> <span class="n">basic_conf_t</span> <span class="p">{</span>
<a name="rest_code_c693157a0dee4442989039eff91def90-3"></a>    <span class="k">using</span> <span class="n">type_id</span> <span class="o">=</span> <span class="n">ID</span><span class="p">;</span>
<a name="rest_code_c693157a0dee4442989039eff91def90-4"></a><span class="p">};</span>
<a name="rest_code_c693157a0dee4442989039eff91def90-5"></a>
<a name="rest_code_c693157a0dee4442989039eff91def90-6"></a><span class="k">struct</span> <span class="n">d_id</span><span class="p">;</span>
<a name="rest_code_c693157a0dee4442989039eff91def90-7"></a><span class="k">struct</span> <span class="nl">d</span> <span class="p">:</span> <span class="n">basic_conf_t</span><span class="o">&lt;</span><span class="n">d_id</span><span class="o">&gt;</span> <span class="p">{};</span>
</pre>
<p>It is similar to the other parameters, except that it has no value. You'll see later in this article why type_id is necessary here.</p>
<p>To check if the flag is present, we'll write the is_present template:</p>
<pre class="code c++"><a name="rest_code_01b6925e904148fa95374ce58e8538ec-1"></a><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T1</span><span class="p">,</span> <span class="k">typename</span><span class="p">...</span> <span class="n">Args</span><span class="o">&gt;</span>
<a name="rest_code_01b6925e904148fa95374ce58e8538ec-2"></a><span class="k">struct</span> <span class="n">is_present</span><span class="p">;</span>
<a name="rest_code_01b6925e904148fa95374ce58e8538ec-3"></a>
<a name="rest_code_01b6925e904148fa95374ce58e8538ec-4"></a><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T1</span><span class="p">,</span> <span class="k">typename</span> <span class="n">T2</span><span class="p">,</span> <span class="k">typename</span><span class="p">...</span> <span class="n">Args</span><span class="o">&gt;</span>
<a name="rest_code_01b6925e904148fa95374ce58e8538ec-5"></a><span class="k">struct</span> <span class="n">is_present</span><span class="o">&lt;</span><span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">,</span> <span class="n">Args</span><span class="p">...</span><span class="o">&gt;</span> <span class="o">:</span> <span class="n">std</span><span class="o">::</span><span class="n">integral_constant</span><span class="o">&lt;</span><span class="kt">bool</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">is_same</span><span class="o">&lt;</span><span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="o">&gt;::</span><span class="n">value</span> <span class="o">||</span> <span class="n">is_present</span><span class="o">&lt;</span><span class="n">T1</span><span class="p">,</span> <span class="n">Args</span><span class="p">...</span><span class="o">&gt;::</span><span class="n">value</span><span class="o">&gt;</span> <span class="p">{};</span>
<a name="rest_code_01b6925e904148fa95374ce58e8538ec-6"></a>
<a name="rest_code_01b6925e904148fa95374ce58e8538ec-7"></a><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T1</span><span class="o">&gt;</span>
<a name="rest_code_01b6925e904148fa95374ce58e8538ec-8"></a><span class="k">struct</span> <span class="n">is_present</span><span class="o">&lt;</span><span class="n">T1</span><span class="o">&gt;</span> <span class="o">:</span> <span class="n">std</span><span class="o">::</span><span class="n">false_type</span> <span class="p">{};</span>
</pre>
<p>This time, the template is much easier. We simply need to iterate through all the types from the variadic template parameter and test if the type is present somewhere. Again, you can see that we used two partial template specialization to handle the different cases.</p>
<p>With this we can now get the value for D:</p>
<pre class="code c++"><a name="rest_code_d0796f65c88147daa9750f946e461ad4-1"></a><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="p">...</span> <span class="n">Args</span><span class="o">&gt;</span>
<a name="rest_code_d0796f65c88147daa9750f946e461ad4-2"></a><span class="k">struct</span> <span class="n">configurable_v2</span> <span class="p">{</span>
<a name="rest_code_d0796f65c88147daa9750f946e461ad4-3"></a>    <span class="k">static</span> <span class="k">constexpr</span> <span class="k">const</span> <span class="k">auto</span> <span class="n">A</span> <span class="o">=</span> <span class="n">get_value</span><span class="o">&lt;</span><span class="n">a</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">Args</span><span class="p">...</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">;</span>
<a name="rest_code_d0796f65c88147daa9750f946e461ad4-4"></a>    <span class="k">static</span> <span class="k">constexpr</span> <span class="k">const</span> <span class="k">auto</span> <span class="n">B</span> <span class="o">=</span> <span class="n">get_value</span><span class="o">&lt;</span><span class="n">b</span><span class="o">&lt;</span><span class="sc">'b'</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">Args</span><span class="p">...</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">;</span>
<a name="rest_code_d0796f65c88147daa9750f946e461ad4-5"></a>    <span class="k">static</span> <span class="k">constexpr</span> <span class="k">const</span> <span class="k">auto</span> <span class="n">C</span> <span class="o">=</span> <span class="n">get_value</span><span class="o">&lt;</span><span class="n">c</span><span class="o">&lt;</span><span class="n">type</span><span class="o">::</span><span class="n">BBB</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">Args</span><span class="p">...</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">;</span>
<a name="rest_code_d0796f65c88147daa9750f946e461ad4-6"></a>    <span class="k">static</span> <span class="k">constexpr</span> <span class="k">const</span> <span class="k">auto</span> <span class="n">D</span> <span class="o">=</span> <span class="n">is_present</span><span class="o">&lt;</span><span class="n">d</span><span class="p">,</span> <span class="n">Args</span><span class="p">...</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">;</span>
<a name="rest_code_d0796f65c88147daa9750f946e461ad4-7"></a>
<a name="rest_code_d0796f65c88147daa9750f946e461ad4-8"></a>    <span class="c1">//Coming</span>
<a name="rest_code_d0796f65c88147daa9750f946e461ad4-9"></a><span class="p">};</span>
</pre>
</div>
<div class="section" id="extracting-types">
<h2>Extracting types</h2>
<p>The next parameter does not hold a value, but a type. It won't be an integral constant, but it will define a typedef value with the configured type:</p>
<pre class="code c++"><a name="rest_code_080c95c1bddf4fa4953ca4a49c3d89aa-1"></a><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">ID</span><span class="p">,</span> <span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
<a name="rest_code_080c95c1bddf4fa4953ca4a49c3d89aa-2"></a><span class="k">struct</span> <span class="n">type_conf_t</span> <span class="p">{</span>
<a name="rest_code_080c95c1bddf4fa4953ca4a49c3d89aa-3"></a>    <span class="k">using</span> <span class="n">type_id</span> <span class="o">=</span> <span class="n">ID</span><span class="p">;</span>
<a name="rest_code_080c95c1bddf4fa4953ca4a49c3d89aa-4"></a>    <span class="k">using</span> <span class="n">value</span> <span class="o">=</span> <span class="n">T</span><span class="p">;</span>
<a name="rest_code_080c95c1bddf4fa4953ca4a49c3d89aa-5"></a><span class="p">};</span>
<a name="rest_code_080c95c1bddf4fa4953ca4a49c3d89aa-6"></a>
<a name="rest_code_080c95c1bddf4fa4953ca4a49c3d89aa-7"></a><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
<a name="rest_code_080c95c1bddf4fa4953ca4a49c3d89aa-8"></a><span class="k">struct</span> <span class="nl">e</span> <span class="p">:</span> <span class="n">type_conf_t</span><span class="o">&lt;</span><span class="n">e_id</span><span class="p">,</span> <span class="n">T</span><span class="o">&gt;</span> <span class="p">{};</span>
</pre>
<p>You may think that the extracting will be very different, but in fact it very similar. And here it is:</p>
<pre class="code c++"><a name="rest_code_0ffa96805fe143d3980763f74aa9e1e6-1"></a><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">D</span><span class="p">,</span> <span class="k">typename</span><span class="p">...</span> <span class="n">Args</span><span class="o">&gt;</span>
<a name="rest_code_0ffa96805fe143d3980763f74aa9e1e6-2"></a><span class="k">struct</span> <span class="n">get_type</span><span class="p">;</span>
<a name="rest_code_0ffa96805fe143d3980763f74aa9e1e6-3"></a>
<a name="rest_code_0ffa96805fe143d3980763f74aa9e1e6-4"></a><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">D</span><span class="p">,</span> <span class="k">typename</span> <span class="n">T2</span><span class="p">,</span> <span class="k">typename</span><span class="p">...</span> <span class="n">Args</span><span class="o">&gt;</span>
<a name="rest_code_0ffa96805fe143d3980763f74aa9e1e6-5"></a><span class="k">struct</span> <span class="n">get_type</span><span class="o">&lt;</span><span class="n">D</span><span class="p">,</span> <span class="n">T2</span><span class="p">,</span> <span class="n">Args</span><span class="p">...</span><span class="o">&gt;</span> <span class="p">{</span>
<a name="rest_code_0ffa96805fe143d3980763f74aa9e1e6-6"></a>    <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">D2</span><span class="p">,</span> <span class="k">typename</span> <span class="n">T22</span><span class="p">,</span> <span class="k">typename</span> <span class="n">Enable</span> <span class="o">=</span> <span class="kt">void</span><span class="o">&gt;</span>
<a name="rest_code_0ffa96805fe143d3980763f74aa9e1e6-7"></a>    <span class="k">struct</span> <span class="n">impl</span> <span class="p">{</span>
<a name="rest_code_0ffa96805fe143d3980763f74aa9e1e6-8"></a>        <span class="k">using</span> <span class="n">value</span> <span class="o">=</span> <span class="k">typename</span> <span class="n">get_type</span><span class="o">&lt;</span><span class="n">D</span><span class="p">,</span> <span class="n">Args</span><span class="p">...</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">;</span>
<a name="rest_code_0ffa96805fe143d3980763f74aa9e1e6-9"></a>    <span class="p">};</span>
<a name="rest_code_0ffa96805fe143d3980763f74aa9e1e6-10"></a>
<a name="rest_code_0ffa96805fe143d3980763f74aa9e1e6-11"></a>    <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">D2</span><span class="p">,</span> <span class="k">typename</span> <span class="n">T22</span><span class="o">&gt;</span>
<a name="rest_code_0ffa96805fe143d3980763f74aa9e1e6-12"></a>    <span class="k">struct</span> <span class="n">impl</span> <span class="o">&lt;</span><span class="n">D2</span><span class="p">,</span> <span class="n">T22</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">enable_if_t</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">is_same</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">D2</span><span class="o">::</span><span class="n">type_id</span><span class="p">,</span> <span class="k">typename</span> <span class="n">T22</span><span class="o">::</span><span class="n">type_id</span><span class="o">&gt;::</span><span class="n">value</span><span class="o">&gt;&gt;</span> <span class="p">{</span>
<a name="rest_code_0ffa96805fe143d3980763f74aa9e1e6-13"></a>        <span class="k">using</span> <span class="n">value</span> <span class="o">=</span> <span class="k">typename</span> <span class="n">T22</span><span class="o">::</span><span class="n">value</span><span class="p">;</span>
<a name="rest_code_0ffa96805fe143d3980763f74aa9e1e6-14"></a>    <span class="p">};</span>
<a name="rest_code_0ffa96805fe143d3980763f74aa9e1e6-15"></a>
<a name="rest_code_0ffa96805fe143d3980763f74aa9e1e6-16"></a>    <span class="k">using</span> <span class="n">value</span> <span class="o">=</span> <span class="k">typename</span> <span class="n">impl</span><span class="o">&lt;</span><span class="n">D</span><span class="p">,</span> <span class="n">T2</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">;</span>
<a name="rest_code_0ffa96805fe143d3980763f74aa9e1e6-17"></a><span class="p">};</span>
<a name="rest_code_0ffa96805fe143d3980763f74aa9e1e6-18"></a>
<a name="rest_code_0ffa96805fe143d3980763f74aa9e1e6-19"></a><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">D</span><span class="o">&gt;</span>
<a name="rest_code_0ffa96805fe143d3980763f74aa9e1e6-20"></a><span class="k">struct</span> <span class="n">get_type</span><span class="o">&lt;</span><span class="n">D</span><span class="o">&gt;</span> <span class="p">{</span>
<a name="rest_code_0ffa96805fe143d3980763f74aa9e1e6-21"></a>    <span class="k">using</span> <span class="n">value</span> <span class="o">=</span> <span class="k">typename</span> <span class="n">D</span><span class="o">::</span><span class="n">value</span><span class="p">;</span>
<a name="rest_code_0ffa96805fe143d3980763f74aa9e1e6-22"></a><span class="p">};</span>
</pre>
<p>Every integral constant has been replaced with alias declaration (with <em>using</em>) and we need to use the <em>typename</em> disambiguator in from of X::value, but that's it :) We could probably have created an integral_type struct to simplify it a bit further, but I don't think that would change a lot. The code of the class follows the same changes:</p>
<pre class="code c++"><a name="rest_code_293e936a939b4c7ea49896011e394b14-1"></a><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="p">...</span> <span class="n">Args</span><span class="o">&gt;</span>
<a name="rest_code_293e936a939b4c7ea49896011e394b14-2"></a><span class="k">struct</span> <span class="n">configurable_v2</span> <span class="p">{</span>
<a name="rest_code_293e936a939b4c7ea49896011e394b14-3"></a>    <span class="k">static</span> <span class="k">constexpr</span> <span class="k">const</span> <span class="k">auto</span> <span class="n">A</span> <span class="o">=</span> <span class="n">get_value</span><span class="o">&lt;</span><span class="n">a</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">Args</span><span class="p">...</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">;</span>
<a name="rest_code_293e936a939b4c7ea49896011e394b14-4"></a>    <span class="k">static</span> <span class="k">constexpr</span> <span class="k">const</span> <span class="k">auto</span> <span class="n">B</span> <span class="o">=</span> <span class="n">get_value</span><span class="o">&lt;</span><span class="n">b</span><span class="o">&lt;</span><span class="sc">'b'</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">Args</span><span class="p">...</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">;</span>
<a name="rest_code_293e936a939b4c7ea49896011e394b14-5"></a>    <span class="k">static</span> <span class="k">constexpr</span> <span class="k">const</span> <span class="k">auto</span> <span class="n">C</span> <span class="o">=</span> <span class="n">get_value</span><span class="o">&lt;</span><span class="n">c</span><span class="o">&lt;</span><span class="n">type</span><span class="o">::</span><span class="n">BBB</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">Args</span><span class="p">...</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">;</span>
<a name="rest_code_293e936a939b4c7ea49896011e394b14-6"></a>    <span class="k">static</span> <span class="k">constexpr</span> <span class="k">const</span> <span class="k">auto</span> <span class="n">D</span> <span class="o">=</span> <span class="n">is_present</span><span class="o">&lt;</span><span class="n">d</span><span class="p">,</span> <span class="n">Args</span><span class="p">...</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">;</span>
<a name="rest_code_293e936a939b4c7ea49896011e394b14-7"></a>
<a name="rest_code_293e936a939b4c7ea49896011e394b14-8"></a>    <span class="k">using</span> <span class="n">E</span> <span class="o">=</span> <span class="k">typename</span> <span class="n">get_type</span><span class="o">&lt;</span><span class="n">e</span><span class="o">&lt;</span><span class="n">watcher_1</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">Args</span><span class="p">...</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">;</span>
<a name="rest_code_293e936a939b4c7ea49896011e394b14-9"></a>
<a name="rest_code_293e936a939b4c7ea49896011e394b14-10"></a>    <span class="c1">//Coming</span>
<a name="rest_code_293e936a939b4c7ea49896011e394b14-11"></a><span class="p">};</span>
</pre>
</div>
<div class="section" id="extracting-template-types">
<h2>Extracting template types</h2>
<p>The last parameter is not a type but a template, so there are some slight changes necessary to extract them. First, let's take a look at the parameter definition:</p>
<pre class="code c++"><a name="rest_code_e86d59074a0d409395051e18b3127dfd-1"></a><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">ID</span><span class="p">,</span> <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="o">&gt;</span> <span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span>
<a name="rest_code_e86d59074a0d409395051e18b3127dfd-2"></a><span class="k">struct</span> <span class="n">template_type_conf_t</span> <span class="p">{</span>
<a name="rest_code_e86d59074a0d409395051e18b3127dfd-3"></a>    <span class="k">using</span> <span class="n">type_id</span> <span class="o">=</span> <span class="n">ID</span><span class="p">;</span>
<a name="rest_code_e86d59074a0d409395051e18b3127dfd-4"></a>
<a name="rest_code_e86d59074a0d409395051e18b3127dfd-5"></a>    <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">C</span><span class="o">&gt;</span>
<a name="rest_code_e86d59074a0d409395051e18b3127dfd-6"></a>    <span class="k">using</span> <span class="n">value</span> <span class="o">=</span> <span class="n">T</span><span class="o">&lt;</span><span class="n">C</span><span class="o">&gt;</span><span class="p">;</span>
<a name="rest_code_e86d59074a0d409395051e18b3127dfd-7"></a><span class="p">};</span>
<a name="rest_code_e86d59074a0d409395051e18b3127dfd-8"></a>
<a name="rest_code_e86d59074a0d409395051e18b3127dfd-9"></a><span class="k">template</span><span class="o">&lt;</span><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="o">&gt;</span> <span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span>
<a name="rest_code_e86d59074a0d409395051e18b3127dfd-10"></a><span class="k">struct</span> <span class="nl">f</span> <span class="p">:</span> <span class="n">template_type_conf_t</span><span class="o">&lt;</span><span class="n">f_id</span><span class="p">,</span> <span class="n">T</span><span class="o">&gt;</span> <span class="p">{};</span>
</pre>
<p>Here instead of taking a simple type, we take a type template with one template parameter. This design has a great limitations. It won't be possible to use it for template that takes more than one template parameter. You have to create an extract template for each possible combination that you want to handle. In my case, I only had the case of a template with one template parameter, but if you have several combination, you'll have to write more code. It is quite simple code, since the adaptations are minor, but it is still tedious. Here is the <em>get_template_type</em> template:</p>
<pre class="code c++"><a name="rest_code_c0519b7d11734536a6a06b65736638b0-1"></a><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">D</span><span class="p">,</span> <span class="k">typename</span><span class="p">...</span> <span class="n">Args</span><span class="o">&gt;</span>
<a name="rest_code_c0519b7d11734536a6a06b65736638b0-2"></a><span class="k">struct</span> <span class="n">get_template_type</span><span class="p">;</span>
<a name="rest_code_c0519b7d11734536a6a06b65736638b0-3"></a>
<a name="rest_code_c0519b7d11734536a6a06b65736638b0-4"></a><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">D</span><span class="p">,</span> <span class="k">typename</span> <span class="n">T2</span><span class="p">,</span> <span class="k">typename</span><span class="p">...</span> <span class="n">Args</span><span class="o">&gt;</span>
<a name="rest_code_c0519b7d11734536a6a06b65736638b0-5"></a><span class="k">struct</span> <span class="n">get_template_type</span><span class="o">&lt;</span><span class="n">D</span><span class="p">,</span> <span class="n">T2</span><span class="p">,</span> <span class="n">Args</span><span class="p">...</span><span class="o">&gt;</span> <span class="p">{</span>
<a name="rest_code_c0519b7d11734536a6a06b65736638b0-6"></a>    <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">D2</span><span class="p">,</span> <span class="k">typename</span> <span class="n">T22</span><span class="p">,</span> <span class="k">typename</span> <span class="n">Enable</span> <span class="o">=</span> <span class="kt">void</span><span class="o">&gt;</span>
<a name="rest_code_c0519b7d11734536a6a06b65736638b0-7"></a>    <span class="k">struct</span> <span class="n">impl</span> <span class="p">{</span>
<a name="rest_code_c0519b7d11734536a6a06b65736638b0-8"></a>        <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">C</span><span class="o">&gt;</span>
<a name="rest_code_c0519b7d11734536a6a06b65736638b0-9"></a>        <span class="k">using</span> <span class="n">value</span> <span class="o">=</span> <span class="k">typename</span> <span class="n">get_template_type</span><span class="o">&lt;</span><span class="n">D</span><span class="p">,</span> <span class="n">Args</span><span class="p">...</span><span class="o">&gt;::</span><span class="k">template</span> <span class="n">value</span><span class="o">&lt;</span><span class="n">C</span><span class="o">&gt;</span><span class="p">;</span>
<a name="rest_code_c0519b7d11734536a6a06b65736638b0-10"></a>    <span class="p">};</span>
<a name="rest_code_c0519b7d11734536a6a06b65736638b0-11"></a>
<a name="rest_code_c0519b7d11734536a6a06b65736638b0-12"></a>    <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">D2</span><span class="p">,</span> <span class="k">typename</span> <span class="n">T22</span><span class="o">&gt;</span>
<a name="rest_code_c0519b7d11734536a6a06b65736638b0-13"></a>    <span class="k">struct</span> <span class="n">impl</span> <span class="o">&lt;</span><span class="n">D2</span><span class="p">,</span> <span class="n">T22</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">enable_if_t</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">is_same</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">D2</span><span class="o">::</span><span class="n">type_id</span><span class="p">,</span> <span class="k">typename</span> <span class="n">T22</span><span class="o">::</span><span class="n">type_id</span><span class="o">&gt;::</span><span class="n">value</span><span class="o">&gt;&gt;</span> <span class="p">{</span>
<a name="rest_code_c0519b7d11734536a6a06b65736638b0-14"></a>        <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">C</span><span class="o">&gt;</span>
<a name="rest_code_c0519b7d11734536a6a06b65736638b0-15"></a>        <span class="k">using</span> <span class="n">value</span> <span class="o">=</span> <span class="k">typename</span> <span class="n">T22</span><span class="o">::</span><span class="k">template</span> <span class="n">value</span><span class="o">&lt;</span><span class="n">C</span><span class="o">&gt;</span><span class="p">;</span>
<a name="rest_code_c0519b7d11734536a6a06b65736638b0-16"></a>    <span class="p">};</span>
<a name="rest_code_c0519b7d11734536a6a06b65736638b0-17"></a>
<a name="rest_code_c0519b7d11734536a6a06b65736638b0-18"></a>    <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">C</span><span class="o">&gt;</span>
<a name="rest_code_c0519b7d11734536a6a06b65736638b0-19"></a>    <span class="k">using</span> <span class="n">value</span> <span class="o">=</span> <span class="k">typename</span> <span class="n">impl</span><span class="o">&lt;</span><span class="n">D</span><span class="p">,</span> <span class="n">T2</span><span class="o">&gt;::</span><span class="k">template</span> <span class="n">value</span><span class="o">&lt;</span><span class="n">C</span><span class="o">&gt;</span><span class="p">;</span>
<a name="rest_code_c0519b7d11734536a6a06b65736638b0-20"></a><span class="p">};</span>
<a name="rest_code_c0519b7d11734536a6a06b65736638b0-21"></a>
<a name="rest_code_c0519b7d11734536a6a06b65736638b0-22"></a><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">D</span><span class="o">&gt;</span>
<a name="rest_code_c0519b7d11734536a6a06b65736638b0-23"></a><span class="k">struct</span> <span class="n">get_template_type</span><span class="o">&lt;</span><span class="n">D</span><span class="o">&gt;</span> <span class="p">{</span>
<a name="rest_code_c0519b7d11734536a6a06b65736638b0-24"></a>    <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">C</span><span class="o">&gt;</span>
<a name="rest_code_c0519b7d11734536a6a06b65736638b0-25"></a>    <span class="k">using</span> <span class="n">value</span> <span class="o">=</span> <span class="k">typename</span> <span class="n">D</span><span class="o">::</span><span class="k">template</span> <span class="n">value</span><span class="o">&lt;</span><span class="n">C</span><span class="o">&gt;</span><span class="p">;</span>
<a name="rest_code_c0519b7d11734536a6a06b65736638b0-26"></a><span class="p">};</span>
</pre>
<p>Again, there are only few changes. Every previous alias declaration is now a template alias declaration and we have to use <em>template</em> disambiguator in front of value. We now have the final piece to write the configurable_v2 class:</p>
<pre class="code c++"><a name="rest_code_b0e07ea0dd81479eb317b75278a6f27e-1"></a><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="p">...</span> <span class="n">Args</span><span class="o">&gt;</span>
<a name="rest_code_b0e07ea0dd81479eb317b75278a6f27e-2"></a><span class="k">struct</span> <span class="n">configurable_v2</span> <span class="p">{</span>
<a name="rest_code_b0e07ea0dd81479eb317b75278a6f27e-3"></a>    <span class="k">static</span> <span class="k">constexpr</span> <span class="k">const</span> <span class="k">auto</span> <span class="n">A</span> <span class="o">=</span> <span class="n">get_value</span><span class="o">&lt;</span><span class="n">a</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">Args</span><span class="p">...</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">;</span>
<a name="rest_code_b0e07ea0dd81479eb317b75278a6f27e-4"></a>    <span class="k">static</span> <span class="k">constexpr</span> <span class="k">const</span> <span class="k">auto</span> <span class="n">B</span> <span class="o">=</span> <span class="n">get_value</span><span class="o">&lt;</span><span class="n">b</span><span class="o">&lt;</span><span class="sc">'b'</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">Args</span><span class="p">...</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">;</span>
<a name="rest_code_b0e07ea0dd81479eb317b75278a6f27e-5"></a>    <span class="k">static</span> <span class="k">constexpr</span> <span class="k">const</span> <span class="k">auto</span> <span class="n">C</span> <span class="o">=</span> <span class="n">get_value</span><span class="o">&lt;</span><span class="n">c</span><span class="o">&lt;</span><span class="n">type</span><span class="o">::</span><span class="n">BBB</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">Args</span><span class="p">...</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">;</span>
<a name="rest_code_b0e07ea0dd81479eb317b75278a6f27e-6"></a>    <span class="k">static</span> <span class="k">constexpr</span> <span class="k">const</span> <span class="k">auto</span> <span class="n">D</span> <span class="o">=</span> <span class="n">is_present</span><span class="o">&lt;</span><span class="n">d</span><span class="p">,</span> <span class="n">Args</span><span class="p">...</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">;</span>
<a name="rest_code_b0e07ea0dd81479eb317b75278a6f27e-7"></a>
<a name="rest_code_b0e07ea0dd81479eb317b75278a6f27e-8"></a>    <span class="k">using</span> <span class="n">E</span> <span class="o">=</span> <span class="k">typename</span> <span class="n">get_type</span><span class="o">&lt;</span><span class="n">e</span><span class="o">&lt;</span><span class="n">watcher_1</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">Args</span><span class="p">...</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">;</span>
<a name="rest_code_b0e07ea0dd81479eb317b75278a6f27e-9"></a>
<a name="rest_code_b0e07ea0dd81479eb317b75278a6f27e-10"></a>    <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">C</span><span class="o">&gt;</span>
<a name="rest_code_b0e07ea0dd81479eb317b75278a6f27e-11"></a>    <span class="k">using</span> <span class="n">F</span> <span class="o">=</span> <span class="k">typename</span> <span class="n">get_template_type</span><span class="o">&lt;</span><span class="n">f</span><span class="o">&lt;</span><span class="n">trainer_1</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">Args</span><span class="p">...</span><span class="o">&gt;::</span><span class="k">template</span> <span class="n">value</span><span class="o">&lt;</span><span class="n">C</span><span class="o">&gt;</span><span class="p">;</span>
<a name="rest_code_b0e07ea0dd81479eb317b75278a6f27e-12"></a><span class="p">};</span>
</pre>
</div>
<div class="section" id="validating-parameter-rules">
<h2>Validating parameter rules</h2>
<p>If you have more parameters and several classes that are configured in this manner, the user may use a wrong parameter in the list. In that case, nothing will happen, the parameter will simply be ignored. Sometimes, this behavior is acceptable, but sometimes it is better to make the code invalid. That's what we are going to do here by specifying a list of valid parameters and using static_assert to ensure this condition.</p>
<p>Here is the assertion:</p>
<pre class="code c++"><a name="rest_code_b951ed99c6af45529d6d7c5b273fce0a-1"></a><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="p">...</span> <span class="n">Args</span><span class="o">&gt;</span>
<a name="rest_code_b951ed99c6af45529d6d7c5b273fce0a-2"></a><span class="k">struct</span> <span class="n">configurable_v2</span> <span class="p">{</span>
<a name="rest_code_b951ed99c6af45529d6d7c5b273fce0a-3"></a>    <span class="k">static</span> <span class="k">constexpr</span> <span class="k">const</span> <span class="k">auto</span> <span class="n">A</span> <span class="o">=</span> <span class="n">get_value</span><span class="o">&lt;</span><span class="n">a</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">Args</span><span class="p">...</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">;</span>
<a name="rest_code_b951ed99c6af45529d6d7c5b273fce0a-4"></a>    <span class="k">static</span> <span class="k">constexpr</span> <span class="k">const</span> <span class="k">auto</span> <span class="n">B</span> <span class="o">=</span> <span class="n">get_value</span><span class="o">&lt;</span><span class="n">b</span><span class="o">&lt;</span><span class="sc">'b'</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">Args</span><span class="p">...</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">;</span>
<a name="rest_code_b951ed99c6af45529d6d7c5b273fce0a-5"></a>    <span class="k">static</span> <span class="k">constexpr</span> <span class="k">const</span> <span class="k">auto</span> <span class="n">C</span> <span class="o">=</span> <span class="n">get_value</span><span class="o">&lt;</span><span class="n">c</span><span class="o">&lt;</span><span class="n">type</span><span class="o">::</span><span class="n">BBB</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">Args</span><span class="p">...</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">;</span>
<a name="rest_code_b951ed99c6af45529d6d7c5b273fce0a-6"></a>    <span class="k">static</span> <span class="k">constexpr</span> <span class="k">const</span> <span class="k">auto</span> <span class="n">D</span> <span class="o">=</span> <span class="n">is_present</span><span class="o">&lt;</span><span class="n">d</span><span class="p">,</span> <span class="n">Args</span><span class="p">...</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">;</span>
<a name="rest_code_b951ed99c6af45529d6d7c5b273fce0a-7"></a>
<a name="rest_code_b951ed99c6af45529d6d7c5b273fce0a-8"></a>    <span class="k">using</span> <span class="n">E</span> <span class="o">=</span> <span class="k">typename</span> <span class="n">get_type</span><span class="o">&lt;</span><span class="n">e</span><span class="o">&lt;</span><span class="n">watcher_1</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">Args</span><span class="p">...</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">;</span>
<a name="rest_code_b951ed99c6af45529d6d7c5b273fce0a-9"></a>
<a name="rest_code_b951ed99c6af45529d6d7c5b273fce0a-10"></a>    <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">C</span><span class="o">&gt;</span>
<a name="rest_code_b951ed99c6af45529d6d7c5b273fce0a-11"></a>    <span class="k">using</span> <span class="n">F</span> <span class="o">=</span> <span class="k">typename</span> <span class="n">get_template_type</span><span class="o">&lt;</span><span class="n">f</span><span class="o">&lt;</span><span class="n">trainer_1</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">Args</span><span class="p">...</span><span class="o">&gt;::</span><span class="k">template</span> <span class="n">value</span><span class="o">&lt;</span><span class="n">C</span><span class="o">&gt;</span><span class="p">;</span>
<a name="rest_code_b951ed99c6af45529d6d7c5b273fce0a-12"></a>
<a name="rest_code_b951ed99c6af45529d6d7c5b273fce0a-13"></a>    <span class="k">static_assert</span><span class="p">(</span>
<a name="rest_code_b951ed99c6af45529d6d7c5b273fce0a-14"></a>        <span class="n">is_valid</span><span class="o">&lt;</span><span class="n">tmp_list</span><span class="o">&lt;</span><span class="n">a_id</span><span class="p">,</span> <span class="n">b_id</span><span class="p">,</span> <span class="n">c_id</span><span class="p">,</span> <span class="n">d_id</span><span class="p">,</span> <span class="n">e_id</span><span class="p">,</span> <span class="n">f_id</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">Args</span><span class="p">...</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">,</span>
<a name="rest_code_b951ed99c6af45529d6d7c5b273fce0a-15"></a>        <span class="s">"Invalid parameters type"</span><span class="p">);</span>
<a name="rest_code_b951ed99c6af45529d6d7c5b273fce0a-16"></a>
<a name="rest_code_b951ed99c6af45529d6d7c5b273fce0a-17"></a>    <span class="c1">//Something useful</span>
<a name="rest_code_b951ed99c6af45529d6d7c5b273fce0a-18"></a><span class="p">};</span>
</pre>
<p>Since the is_valid traits needs two variadic list of parameters, we have to encapsulate list of valid types in another structure (<em>tmp_list</em>) to separate the two sets. Here is the implementation of the validation:</p>
<pre class="code c++"><a name="rest_code_9cff8b6f0fa34e50ba42113463725642-1"></a><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="p">...</span> <span class="n">Valid</span><span class="o">&gt;</span>
<a name="rest_code_9cff8b6f0fa34e50ba42113463725642-2"></a><span class="k">struct</span> <span class="n">tmp_list</span> <span class="p">{</span>
<a name="rest_code_9cff8b6f0fa34e50ba42113463725642-3"></a>    <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
<a name="rest_code_9cff8b6f0fa34e50ba42113463725642-4"></a>    <span class="k">struct</span> <span class="nl">contains</span> <span class="p">:</span> <span class="n">std</span><span class="o">::</span><span class="n">integral_constant</span><span class="o">&lt;</span><span class="kt">bool</span><span class="p">,</span> <span class="n">is_present</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">::</span><span class="n">type_id</span><span class="p">,</span> <span class="n">Valid</span><span class="p">...</span><span class="o">&gt;::</span><span class="n">value</span><span class="o">&gt;</span> <span class="p">{};</span>
<a name="rest_code_9cff8b6f0fa34e50ba42113463725642-5"></a><span class="p">};</span>
<a name="rest_code_9cff8b6f0fa34e50ba42113463725642-6"></a>
<a name="rest_code_9cff8b6f0fa34e50ba42113463725642-7"></a><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">L</span><span class="p">,</span> <span class="k">typename</span><span class="p">...</span> <span class="n">Args</span><span class="o">&gt;</span>
<a name="rest_code_9cff8b6f0fa34e50ba42113463725642-8"></a><span class="k">struct</span> <span class="n">is_valid</span><span class="p">;</span>
<a name="rest_code_9cff8b6f0fa34e50ba42113463725642-9"></a>
<a name="rest_code_9cff8b6f0fa34e50ba42113463725642-10"></a><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">L</span><span class="p">,</span> <span class="k">typename</span> <span class="n">T1</span><span class="p">,</span> <span class="k">typename</span><span class="p">...</span> <span class="n">Args</span><span class="o">&gt;</span>
<a name="rest_code_9cff8b6f0fa34e50ba42113463725642-11"></a><span class="k">struct</span> <span class="n">is_valid</span> <span class="o">&lt;</span><span class="n">L</span><span class="p">,</span> <span class="n">T1</span><span class="p">,</span> <span class="n">Args</span><span class="p">...</span><span class="o">&gt;</span> <span class="o">:</span> <span class="n">std</span><span class="o">::</span><span class="n">integral_constant</span><span class="o">&lt;</span><span class="kt">bool</span><span class="p">,</span> <span class="n">L</span><span class="o">::</span><span class="k">template</span> <span class="n">contains</span><span class="o">&lt;</span><span class="n">T1</span><span class="o">&gt;::</span><span class="n">value</span> <span class="o">&amp;&amp;</span> <span class="n">is_valid</span><span class="o">&lt;</span><span class="n">L</span><span class="p">,</span> <span class="n">Args</span><span class="p">...</span><span class="o">&gt;::</span><span class="n">value</span><span class="o">&gt;</span> <span class="p">{};</span>
<a name="rest_code_9cff8b6f0fa34e50ba42113463725642-12"></a>
<a name="rest_code_9cff8b6f0fa34e50ba42113463725642-13"></a><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">L</span><span class="o">&gt;</span>
<a name="rest_code_9cff8b6f0fa34e50ba42113463725642-14"></a><span class="k">struct</span> <span class="n">is_valid</span> <span class="o">&lt;</span><span class="n">L</span><span class="o">&gt;</span> <span class="o">:</span> <span class="n">std</span><span class="o">::</span><span class="n">true_type</span> <span class="p">{};</span>
</pre>
<p>The struct tmp_list has a single inner class (<em>contains</em>) that test if a given type is present in the list. For this, we reuse the is_present template that we created when extracting boolean flag. The <em>is_valid</em> template simply test that each parameter is present in the <em>tmp_list</em>.</p>
<p>Validation could also be made so that no parameters could be present twice, but I will put that aside for now.</p>
</div>
<div class="section" id="conclusion">
<h2>Conclusion</h2>
<p>Here it is :)</p>
<p>We now have a set of template that allow us to configure a class at compile-time with named, optional, template parameters, with default and in any order. I personally thinks that this is a great way to configure a class at compile-time and it is also another proof of the power of C++. If you think that the code is complicated, don't forget that this is only the library code, the client code on contrary is at least as clear as the original version and even has several advantages.</p>
<p>I hope that this article interested you and that you learned something.</p>
<p>The code of this article is available on Github: <a class="reference external" href="https://github.com/wichtounet/articles/blob/master/src/named_template_par/configurable.cpp">https://github.com/wichtounet/articles/blob/master/src/named_template_par/configurable.cpp</a>
It has been tested on Clang 3.5 and GCC 4.9.1.</p>
</div>
</div>
        </div>
            
        
    <a href="posts/2015/03/named-optional-template-parameters-compile-time.html#disqus_thread" data-disqus-identifier="cache/posts/2015/03/named-optional-template-parameters-to-configure-a-class-at-compile-time.html">Comments</a>


        </article><article class="postbox h-entry post-text"><h1 class="p-name">
<a href="posts/2014/10/sonarqube-inspections-for-cpp-projects.html" class="u-url">SonarQube inspections for C++ projects</a>
        <br><small>  
             Posted: <time class="published dt-published" datetime="2014-10-05T14:55:46+02:00">2014-10-05 14:55</time></small>
</h1>
        <hr>
<div class="p-summary">
        <div>
<p>Back in the days, when I used to develop in Java (I hadn't discovered the
wonders of C++ :) ), I used Sonar a lot for my projects. Sonar is a great tool
for quality inspections of a project. Sonar has been made for Java and is mostly
free and opensource (some plugins are commercial) to inspect Java projects.
Unfortunately, this is not the case for C++ inspection. Indeed, the C++ plugin
cost 7000 euros (more than 8500$). As I mostly work on C++ for opensource and
school projects, I'm definitely not able to buy it. I wanted for a long time to
test the commercial C++ plugin. For this article, sonarsource provided me with a
short (very short) time license for the C++ plugin.</p>
<p>There is also another option for C++ which is the C++ community plugin:
<a class="reference external" href="https://github.com/wenns/sonar-cxx">https://github.com/wenns/sonar-cxx</a>. I have tested it some time ago, but I was
not satisfied with it, I had several errors and had to use a dev version to make
it work a bit. Moreover, the C++11 support is inexistant and management of
parsing error is not really satisfying. But maybe it is good for you. This
article will only focus on the commercial plugin.</p>
<div class="section" id="usage">
<h2>Usage</h2>
<p>For each project that you want to analyze with Sonar, you have to create a
sonar-project.properties files describing some basic information about your
project.</p>
<p>Then, there are two ways to inspect a C++ project. The first one and recommended
one is to use the <em>build-wrapper</em> executable. It is a sub project that you have
to download and install alongside Sonar. It works by wrapping the commands to
your build systems:</p>
<pre class="literal-block">
build-wrapper make all
</pre>
<p>and this should generate enough informations for not having to fill each field
in the project configuration. The, you have to use the <em>sonar-runner</em> program to
upload to Sonar.</p>
<p>I tried it on several projects and there seems to be a problem with the
includes. It didn't include the header files in the Sonar inspections.</p>
<p>I finally ended up using manual configuration of the Sonar project and the
header files were included correctly. However, you normally have to include many
information in the configuration including all macros for instance. For now, I
haven't bothered generating them and it doesn't seem to impact too much the
results.</p>
<p>When I look in the log, it seems that there are still a lot of parsing errors.
They seem mostly related to some compiler macro, especially the __has_feature__
macro of clang. This is the same problem with the build-wrapper. When I don't
use the build-wrapper I also have other problems with macros for unit testing.</p>
<p>I also have other errors coming during the inspection, for instance:</p>
<pre class="literal-block">
error directive: This file requires compiler and library support for the ISO C++
2011 standard. This support is currently experimental, and must be enabled with
the -std=c++11 or -std=gnu++11 compiler options
</pre>
<p>I think it comes from the fact that I compile with std=c++1y and that Sonar
does not support C++14.</p>
</div>
<div class="section" id="inspections">
<h2>Inspections</h2>
<p>Here is the results of inspection on my ETL project:</p>
<img alt="/images/etl_dashboard.png" src="images/etl_dashboard.png"><p>I really like the web interface of Sonar, it really sums well all the
information and the various plugins play quite nice with each other. Moreover,
when you check issues, you can see directly the source code very clearly. I
really think this is the strong point of Sonar.</p>
<p>Here is the Hotspots view for instance:</p>
<img alt="/images/etl_dashboard.png" src="images/etl_dashboard.png"><p>Or the Time Machine view:</p>
<img alt="/images/etl_dashboard.png" src="images/etl_dashboard.png"><p>The issues that are reported by Sonar are quite good. On this project there is a
lot of them related to naming conventions because I don't follow the conventions
configured by default. However, you can easily configure the inspections to give
your own naming regex or simple enable/disable some inspections.</p>
<p>There are some good inspections:</p>
<ul class="simple">
<li>Some missing explicit keyword</li>
<li>Some commented block of code that can be removed</li>
<li>An if-elseif construct that should have had a else</li>
<li>Files with too high complexity</li>
</ul>
<p>However, there are also some important false positives. For instance:</p>
<img alt="/images/etl_false_positive_1.png" src="images/etl_false_positive_1.png"><p>In here, there are no reasons to output this issue since the operator is
deleted. It proves that the C++11 support is rather incomplete. I have other
false positives of the same kind for <em>= default</em> operators and constructors.
Here is another example:</p>
<img alt="/images/etl_false_positive_2.png" src="images/etl_false_positive_2.png"><p>In this case, the varadic template support is mixed with the old ellipsis
notation, making it again a lack of C++11 support. There are also other false
positives for instance because of lambdas, but all of them were related to
C++11.</p>
</div>
<div class="section" id="various">
<h2>Various</h2>
<p>If you don't think you have enough quality rules, you can also include the one
from cppcheck simply by givin the path to cppcheck in sonar-project.properties.
I think this is great, since it works all by itself. You can also create your
own rule, but you'll have to use XPath for path.</p>
<p>If you want, you can also include unit test reports inside Sonar. I haven't
tested this support since they only support cppunit test reports and I use only
Catch for my unit tests. It would have been great if JUnit format would have
been supported since many tool support it.</p>
<p>The last option that is supported by this plugin is the support of GCOV reports
for code coverage information. I haven't been able to make it work, I had errors
indicating that the source files were not found. I didn't figure this out. It
may come from the fact that I used llvm and clang to generate the GCOV reports
and not G++.</p>
</div>
<div class="section" id="conclusion">
<h2>Conclusion</h2>
<p>First, here are some pros and cons for the C++ support in SonarQube.</p>
<p><strong>Pros</strong></p>
<ul class="simple">
<li>Good default inspections</li>
<li>Great web interface.</li>
<li>cppcheck very well integrated</li>
<li>Issues are easily configurable</li>
</ul>
<p><strong>Cons</strong></p>
<ul class="simple">
<li>C++11 support is incomplete and no C++14 support</li>
<li>build-wrapper support seems instable. It should be integrated directly into
sonar.</li>
<li>Unit tests support is limited to cppunit</li>
<li>Haven't been able to make Code Coverage work</li>
<li>Macro support not flexible enough</li>
<li>Too expensive</li>
<li>Quite complicated</li>
<li>No support for other static analyzer than cppcheck</li>
</ul>
<p>The general web interface feeling is quite good, everything looks great and the
report are really useful. However, the usage of the tool does not feel very
professional. I had a lot more problems than I expected to use it. I was also
really disappointed by the C++11. The syntax seems to be supported but not the
language feature in the inspections, making the C++11 support completely
useless. This is weird since they cite C+11 as supported. Moreover, there not
yet any C++14 support, but this is less dramatic. It is also a bit sad that they
limit the import to cppcheck and no other static analyzers and the same stands
for cppunit.</p>
<p>In my opinion, it is really an inferior product compared to the Java support.
I was expecting more from a 8500 dollars product.</p>
<p>For now, I won't probably use it anymore on my projects since all of them use at
least C++11, but I will probably retry Sonar for C++ in the future hoping that
it will become as the Sonar Java support.</p>
</div>
</div>
        </div>
            
        
    <a href="posts/2014/10/sonarqube-inspections-for-cpp-projects.html#disqus_thread" data-disqus-identifier="cache/posts/2014/10/sonarqube-inspections-for-cpp-projects.html">Comments</a>


        </article><article class="postbox h-entry post-text"><h1 class="p-name">
<a href="posts/2014/10/linux-tip-force-systemd-networkd-to-wait-for-dhcp.html" class="u-url">Linux tip: Force systemd networkd to wait for DHCP</a>
        <br><small>  
             Posted: <time class="published dt-published" datetime="2014-10-01T20:18:55+02:00">2014-10-01 20:18</time></small>
</h1>
        <hr>
<div class="p-summary">
        <div>
<p>Recently, I started using systemd-networkd to manage my network. It works really
good for static address configuration, but I experienced some problem with DHCP.
There is DHCP client support integrated into systemd, so I wanted to use this
instead of using another DHCP client.</p>
<p>(If you are not familiar with systemd-networkd, you can have a look at the last
section of this article)</p>
<p>The problem with that is that services are not waiting for DHCP leases to be
obtained. Most services (sshd for instance), are waiting for network.target,
however, network.target does not wait for the DHCP lease to be obtained from the
server. If you configured ssh on a specific IP and this IP is obtained with
DHCP, it will fail at startup. The same is true for NFS mounts for instance.</p>
<div class="section" id="force-services-to-wait-for-the-network-to-be-configured">
<h2>Force services to wait for the network to be configured</h2>
<p>The solution is to make services like sshd waits for network-online.target
instead of network.target. There is a simple way in systemd to override default
service files. For a X.service, systemd will also parse all the
/etc/systemd/X.service.d/*.conf files.</p>
<p>For instance, to make sshd be started only after DHCP is finished</p>
<p>/etc/systemd/systemd/sshd.service.d/network.conf:</p>
<pre class="literal-block">
[Unit]
Wants=network-online.target
After=network-online.target
</pre>
<p>However, by default, network-online.target does not wait for anything. You'll
have to enable another service to make it work:</p>
<pre class="literal-block">
systemctl enable systemd-networkd-wait-online
</pre>
<p>And another note, at least on Gentoo, I had to use systemd-216 for it to work:</p>
<pre class="literal-block">
emerge -a "=sys-apps/systemd-216"
</pre>
<p>And after this, it worked like a charm at startup.</p>
</div>
<div class="section" id="force-nfs-mounts-to-wait-for-the-network">
<h2>Force NFS mounts to wait for the network</h2>
<p>There is no service file for nfs mounts, but there is a target remote-fs.target
that groups the remote file systems mounts. You can override its configuration
in the same as a service:</p>
<p>/etc/systemd/systemd/remote-fs.target.d/network.conf:</p>
<pre class="literal-block">
[Unit]
Wants=network-online.target
After=network-online.target
</pre>
</div>
<div class="section" id="conclusion">
<h2>Conclusion</h2>
<p>Here we are, I hope this tip will be useful to some of you ;)</p>
</div>
<div class="section" id="appendix-configure-interface-with-dhcp-with-systemd">
<h2>Appendix. Configure interface with DHCP with systemd</h2>
<p>To configure an interface with DHCP, you have to create a .network file in
/etc/systemd/network/. For instance, here is my
/etc/systemd/network/local.network file:</p>
<pre class="code text"><a name="rest_code_154f339f1b484da2974433cfa97e2684-1"></a>[Match]
<a name="rest_code_154f339f1b484da2974433cfa97e2684-2"></a>Name=enp3s0
<a name="rest_code_154f339f1b484da2974433cfa97e2684-3"></a>
<a name="rest_code_154f339f1b484da2974433cfa97e2684-4"></a>[Network]
<a name="rest_code_154f339f1b484da2974433cfa97e2684-5"></a>DHCP=v4
</pre>
<p>and you have to enable systemd-networkd:</p>
<pre class="literal-block">
systemctl enable systemd-networkd
</pre>
</div>
</div>
        </div>
            
        
    <a href="posts/2014/10/linux-tip-force-systemd-networkd-to-wait-for-dhcp.html#disqus_thread" data-disqus-identifier="cache/posts/2014/10/linux-tip-force-systemd-networkd-to-wait-for-dhcp.html">Comments</a>


        </article><article class="postbox h-entry post-text"><h1 class="p-name">
<a href="posts/2014/09/budgetwarrior-041-expense-templates-and-year-projection.html" class="u-url">budgetwarrior 0.4.1 - Expense templates and year projection</a>
        <br><small>  
             Posted: <time class="published dt-published" datetime="2014-09-21T20:53:53+02:00">2014-09-21 20:53</time></small>
</h1>
        <hr>
<div class="p-summary">
        <div>
<p>I've been able to finish the version 0.4.1 of budgetwarrior before I though :)</p>
<div class="section" id="expense-templates">
<h2>Expense templates</h2>
<p>The "most useful" new feature of this release is the ability to create template
for expenses.</p>
<p>For that, you can give an extra parameter to budget expense add:</p>
<pre class="literal-block">
budget expense add template name
</pre>
<p>This will works exactly the same as creating a new expense expect that it will
be saved as a template. Then, the next time you do:</p>
<pre class="literal-block">
budget expense add template name
</pre>
<p>A new expense will be created with the date of the day and with the name and
amount saved into the template. You can create as many templates as you want as
long as they have different names. You can see all the templates you have by
using 'budget expense template'. A template can be deleted the exact same as an
expense with 'budget expense delete id'.</p>
<p>I think this is very useful for expense that are made several times a month, for
instance a coffee at your workplace. The price should not change a lot and it is
faster to just use the template name rather than entering all the information
again.</p>
</div>
<div class="section" id="year-prediction">
<h2>Year prediction</h2>
<p>You can now see what would be next year if you changed a bit your expenses. For
instance, how much would you still have at the end of the year if you increased
your house expenses by 20% and reduced your insurances by 5% ?</p>
<p>The 'budget predict' can be used for that purpose. You can enter a multiplier
for each account in your budget and a new year will be "predicted" based on
the expenses of the current year multiplied by the specified multiplier:</p>
<img alt="/images/budget_041_prediction.png" src="images/budget_041_prediction.png"><p>I think that this feature can be very useful if you want to estimate how your
budget will be for moving to a more expensive house or another insurance for
instance.</p>
</div>
<div class="section" id="various-changes">
<h2>Various changes</h2>
<p>Two accounts can be merged together with the 'budget account migrate' command.
This command will move all expenses from an account to another and adapt the
amount of the target account. The source account will be deleted. This supports
migrated accounts.</p>
<p>The 'budget wish list' command will now display the mean accuracy of your
predictions.</p>
<p>You don't need Boost anymore for this project. The only remaining dependency is
libuuid. I will perhaps remove it in the next version since the UUID are not
used in the application for now.</p>
<p>The command 'budget gc' will clean the IDs of all your data in order to fill the
holes and make all the IDs contiguous. It is mostly a feature for order-freaks
like me who do not like to have holes in a sequence of identifiers ;)</p>
<p>There was a bug in the monthly report causing the scale to be displayed
completely moved, it is now fixed:</p>
<img alt="https://raw.githubusercontent.com/wichtounet/budgetwarrior/develop/screenshots/budget_report.png" src="https://raw.githubusercontent.com/wichtounet/budgetwarrior/develop/screenshots/budget_report.png">
</div>
<div class="section" id="installation">
<h2>Installation</h2>
<p>If you are on Gentoo, you can install it using layman:</p>
<pre class="literal-block">
layman -a wichtounet
emerge -a budgetwarrior
</pre>
<p>If you are on Arch Linux, you can use this <a class="reference external" href="https://github.com/StreakyCobra/aur">AUR repository</a>.</p>
<p>For other systems, you'll have to install from sources:</p>
<pre class="literal-block">
git clone git://github.com/wichtounet/budgetwarrior.git
cd budgetwarrior
make
sudo make install
</pre>
</div>
<div class="section" id="conclusion">
<h2>Conclusion</h2>
<p>If you are interested by the sources, you can download them on Github:
<a class="reference external" href="https://github.com/wichtounet/budgetwarrior">budgetwarrior</a>.</p>
<p>If you have a suggestion for a new features or you found a bug, please post an
issue on Github, I'd be glad to help you.</p>
<p>If you have any comment, don't hesitate to contact me, either by letting a
comment on this post or by email.</p>
</div>
</div>
        </div>
            
        
    <a href="posts/2014/09/budgetwarrior-041-expense-templates-and-year-projection.html#disqus_thread" data-disqus-identifier="cache/posts/2014/09/budgetwarrior-041-expense-templates-and-year-projection.html">Comments</a>


        </article><nav class="postindexpager"><ul class="pager">
<li class="previous">
                <a href="index.html" rel="prev">Newer posts</a>
            </li>
            <li class="next">
                <a href="index-26.html" rel="next">Older posts</a>
            </li>
        </ul></nav><script>var disqus_shortname="blogwichtounet";(function(){var a=document.createElement("script");a.async=true;a.src="https://"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script>
</div>
        </div>
    </div>
</div>

<!-- Footer -->

<footer>
    Contents © 2016         <a href="mailto:baptistewicht@gmail.com">Baptiste Wicht</a> - Powered by         <a href="http://getnikola.com" rel="nofollow">Nikola</a>         
<a rel="license" href="http://creativecommons.org/licenses/by/4.0/"><img alt="Creative Commons License" style="padding-left:5px;border-width:0" src="assets/img/cc.png"></a>
        <ul class="footer_inline_ul"></ul></footer><!-- Late loading stuff  --><script src="assets/js/all-nocdn.js"></script><script type="text/javascript">
      $(document).ready(function() {
        jQuery.getJSON('/assets/js/tag_cloud_data.json', function(data) {
            var items = [];

            $.each(data, function(key, val) {
                items.push('<li><a href="' + val[1] +'" '+'data-weight="'+val[0]+'"'+'>' + key + '</a></li>');
            });

            $('<div/>', {
                'id': 'tags',
                html: '<ul>' + items.join('') + '</ul>'
            }).appendTo('body');

            if(!$('#tags_canvas').tagcanvas({
                textColour: '#FFFFFF',
                outlineColour: '#ff00ff',
                reverse: true,
                depth: 0.8,
                maxSpeed: 0.05,
                weight: true,
                weightFrom: "data-weight",
                weightSizeMin: 8,
                weightSizeMax: 24
            },'tags')) {
                //something went wrong, hide the canvas container
                $('#tags_container').hide();
            }});
        });
    </script><!-- Google platform JS --><script type="text/javascript" src="https://apis.google.com/js/platform.js"></script>
</body>
</html>
