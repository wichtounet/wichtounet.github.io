<html><body><p>When we work with OSGi, a problem we always have is how to work with dependencies non OSGi Ready.

This is not a really great problem because there we can work with. There is essentially two solutions :

</p><ul>
	<li>Embed the JAR files within the bundle. That is to say putting the JAR file into the bundle JAR and reference it in the Manifest</li>
	<li>Wrap the JAR files with an OSGi Manifest. Namely, transform the JAR into an OSGi bundle.</li>
</ul>

Personnaly, i doesn't like the first solution, because for me, having a jar into a jar sounds really weird and bad and i prefer to have real OSGi Bundle. With wrapping, if i need this library in an other bundle, i doesn't have to do anything.

<!--more-->

But, yes there is a but, wrapping a jar is much complicated than embedding. Because, we much transform the JAR into a real OSGi Bundle. That is to say that we much create a new JAR with a Manifest, importing all the needed packages, exporting all the necessary packages, computing the names and version, ...

If we must do that by hand, that could be really long and hard to do.

We can do that in a simple way using Maven 2 and the maven-bundle-plugin that can generate an OSGi jar embedding the other using the BND tools. With some configurations, we can simply create a totally valid OSGi Bundle. To make several bundles Â easily, i created a simple parent pom (i take the first sources from Spring Blog) and all the modules of this parent project will be simple project to wrap a dependency.

Here is the parent pom i use :

[xml]&lt;?xml version="1.0" encoding="UTF-8"?&gt;

&lt;project
        xmlns="http://maven.apache.org/POM/4.0.0"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd"&gt;

    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;
    &lt;groupId&gt;org.jtheque&lt;/groupId&gt;
    &lt;artifactId&gt;jtheque-osgi-wrap&lt;/artifactId&gt;
    &lt;name&gt;jtheque-osgi-wrap&lt;/name&gt;
    &lt;packaging&gt;pom&lt;/packaging&gt;
    &lt;version&gt;1.0&lt;/version&gt;

    &lt;modules&gt;
        &lt;!-- Modules --&gt;
    &lt;/modules&gt;
    
    &lt;properties&gt;
        &lt;export.packages&gt;${export.package}*;version=${unpack.version}&lt;/export.packages&gt;
        &lt;import.packages&gt;*&lt;/import.packages&gt;
        &lt;private.packages&gt;!*&lt;/private.packages&gt;
        &lt;symbolic.name&gt;${pom.groupId}.${pom.artifactId}&lt;/symbolic.name&gt;
        &lt;embed-dep&gt;*;scope=compile;type=!pom;inline=true&lt;/embed-dep&gt;
        &lt;unpack-bundle&gt;false&lt;/unpack-bundle&gt;
    &lt;/properties&gt;

    &lt;build&gt;
        &lt;directory&gt;${env.BUILD_HOME}/dependencies/${symbolic.name}&lt;/directory&gt;

        &lt;plugins&gt;
            &lt;plugin&gt;
                &lt;groupId&gt;org.apache.felix&lt;/groupId&gt;
                &lt;artifactId&gt;maven-bundle-plugin&lt;/artifactId&gt;
                &lt;version&gt;1.2.0&lt;/version&gt;
                &lt;configuration&gt;
                    &lt;unpackBundle&gt;${unpack.bundle}&lt;/unpackBundle&gt;
                    &lt;instructions&gt;
                        &lt;Bundle-Name&gt;${artifactId}&lt;/Bundle-Name&gt;
                        &lt;Bundle-SymbolicName&gt;${symbolic.name}&lt;/Bundle-SymbolicName&gt;
                        &lt;Bundle-Description&gt;${pom.name}&lt;/Bundle-Description&gt;
                        &lt;Import-Package&gt;${import.packages}&lt;/Import-Package&gt;
                        &lt;Private-Package&gt;${private.packages}&lt;/Private-Package&gt;
                        &lt;Include-Resource&gt;${include.resources}&lt;/Include-Resource&gt;
                        &lt;Embed-Dependency&gt;${embed-dep}&lt;/Embed-Dependency&gt;
                        &lt;_exportcontents&gt;${export.packages}&lt;/_exportcontents&gt;
                    &lt;/instructions&gt;
                &lt;/configuration&gt;
                &lt;extensions&gt;true&lt;/extensions&gt;
            &lt;/plugin&gt;
        &lt;/plugins&gt;
    &lt;/build&gt;
&lt;/project&gt;[/xml]

That really simple, we use some properties to generify the process to have really simple modules. 

Here is an example to wrap the substance look and feel library : 

[xml]&lt;?xml version="1.0" encoding="UTF-8"?&gt;

&lt;project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"&gt;

    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;
    &lt;groupId&gt;org.substance&lt;/groupId&gt;
    &lt;packaging&gt;bundle&lt;/packaging&gt;
    &lt;artifactId&gt;org.jtheque.substance&lt;/artifactId&gt;
    &lt;name&gt;apple-extensions&lt;/name&gt;
    &lt;version&gt;6.0.0&lt;/version&gt;

    &lt;parent&gt;
        &lt;artifactId&gt;jtheque-osgi-wrap&lt;/artifactId&gt;
        &lt;groupId&gt;org.jtheque&lt;/groupId&gt;
        &lt;version&gt;1.0&lt;/version&gt;
    &lt;/parent&gt;

    &lt;properties&gt;
        &lt;unpack.version&gt;6.0.0&lt;/unpack.version&gt;
        &lt;export.package/&gt;
    &lt;/properties&gt;

    &lt;dependencies&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.substance&lt;/groupId&gt;
            &lt;artifactId&gt;substance&lt;/artifactId&gt;
            &lt;version&gt;6.0&lt;/version&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;
&lt;/project&gt;[/xml]

Like you can see, that's really simple and that generates a great OSGi Bundle. Here i didnt' specify any export package. Doing that all the packages are exported except the ones containing impl or internal. 

Thats it :)

I hope that this post will be useful to some of you. </body></html>