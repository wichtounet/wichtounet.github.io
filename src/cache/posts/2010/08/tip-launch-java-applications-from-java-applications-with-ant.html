<p><html><body><p>One week ago, I searched a way <strong>to launch a Java application</strong> from an other Java application without loosing portability. And I found a post on StackOverflow explaining how achieve that goal using <strong>Apache Ant</strong>.</p>
<p>It's really easy. It use the Ant classes and simulate a project launching and a build task. In this post, we'll see a simple method to launch an application from Java.</p>
<!--more-->

<p>Here is a simple method that launch an application using Ant :</p>
<p>[java]package org.jtheque.osgi;</p>
<p>import org.apache.tools.ant.BuildException;</p>
<p>import org.apache.tools.ant.BuildLogger;</p>
<p>import org.apache.tools.ant.DefaultLogger;</p>
<p>import org.apache.tools.ant.DemuxOutputStream;</p>
<p>import org.apache.tools.ant.Project;</p>
<p>import org.apache.tools.ant.taskdefs.Java;</p>
<p>import java.io.PrintStream;</p>
<p>public class Launcher {
    private static int launchApplication(Class mainClass, String args) {
        int returnCode;</p>
<div class="code"><pre>    <span class="n">Project</span> <span class="n">project</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Project</span><span class="p">();</span>

    <span class="n">project</span><span class="p">.</span><span class="n">setBasedir</span><span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="n">getProperty</span><span class="p">(</span><span class="s">&quot;user.dir&quot;</span><span class="p">));</span>
    <span class="n">project</span><span class="p">.</span><span class="n">init</span><span class="p">();</span>

    <span class="n">PrintStream</span> <span class="n">out</span> <span class="o">=</span> <span class="n">System</span><span class="p">.</span><span class="n">out</span><span class="p">;</span>
    <span class="n">PrintStream</span> <span class="n">err</span> <span class="o">=</span> <span class="n">System</span><span class="p">.</span><span class="n">err</span><span class="p">;</span>

    <span class="n">BuildLogger</span> <span class="n">logger</span> <span class="o">=</span> <span class="n">new</span> <span class="n">DefaultLogger</span><span class="p">();</span>
    <span class="n">logger</span><span class="p">.</span><span class="n">setOutputPrintStream</span><span class="p">(</span><span class="n">out</span><span class="p">);</span>
    <span class="n">logger</span><span class="p">.</span><span class="n">setErrorPrintStream</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
    <span class="n">logger</span><span class="p">.</span><span class="n">setMessageOutputLevel</span><span class="p">(</span><span class="n">Project</span><span class="p">.</span><span class="n">MSG_INFO</span><span class="p">);</span>

    <span class="n">project</span><span class="p">.</span><span class="n">addBuildListener</span><span class="p">(</span><span class="n">logger</span><span class="p">);</span>

    <span class="n">System</span><span class="p">.</span><span class="n">setOut</span><span class="p">(</span><span class="n">new</span> <span class="n">PrintStream</span><span class="p">(</span><span class="n">new</span> <span class="n">DemuxOutputStream</span><span class="p">(</span><span class="n">project</span><span class="p">,</span> <span class="nb">false</span><span class="p">)));</span>
    <span class="n">System</span><span class="p">.</span><span class="n">setErr</span><span class="p">(</span><span class="n">new</span> <span class="n">PrintStream</span><span class="p">(</span><span class="n">new</span> <span class="n">DemuxOutputStream</span><span class="p">(</span><span class="n">project</span><span class="p">,</span> <span class="nb">true</span><span class="p">)));</span>

    <span class="n">project</span><span class="p">.</span><span class="n">fireBuildStarted</span><span class="p">();</span>

    <span class="n">Throwable</span> <span class="n">caught</span> <span class="o">=</span> <span class="n">null</span><span class="p">;</span>
    <span class="n">try</span> <span class="p">{</span>
        <span class="n">project</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="s">&quot;Launch Application&quot;</span><span class="p">);</span>

        <span class="n">Java</span> <span class="n">javaTask</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Java</span><span class="p">();</span>
        <span class="n">javaTask</span><span class="p">.</span><span class="n">setTaskName</span><span class="p">(</span><span class="s">&quot;Application Launcher&quot;</span><span class="p">);</span>
        <span class="n">javaTask</span><span class="p">.</span><span class="n">setProject</span><span class="p">(</span><span class="n">project</span><span class="p">);</span>
        <span class="n">javaTask</span><span class="p">.</span><span class="n">setFork</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
        <span class="n">javaTask</span><span class="p">.</span><span class="n">setFailonerror</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
        <span class="n">javaTask</span><span class="p">.</span><span class="n">setCloneVm</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
        <span class="n">javaTask</span><span class="p">.</span><span class="n">setClassname</span><span class="p">(</span><span class="n">mainClass</span><span class="p">.</span><span class="n">getName</span><span class="p">());</span>
        <span class="n">javaTask</span><span class="p">.</span><span class="n">setArgs</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
        <span class="n">javaTask</span><span class="p">.</span><span class="n">init</span><span class="p">();</span>

        <span class="n">returnCode</span> <span class="o">=</span> <span class="n">javaTask</span><span class="p">.</span><span class="n">executeJava</span><span class="p">();</span>
    <span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="n">BuildException</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">caught</span> <span class="o">=</span> <span class="n">e</span><span class="p">;</span>

        <span class="n">returnCode</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">project</span><span class="p">.</span><span class="n">fireBuildFinished</span><span class="p">(</span><span class="n">caught</span><span class="p">);</span>

    <span class="n">System</span><span class="p">.</span><span class="n">setOut</span><span class="p">(</span><span class="n">out</span><span class="p">);</span>
    <span class="n">System</span><span class="p">.</span><span class="n">setErr</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">returnCode</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<p>}[/java]</p>
<p>Here are some explanations :</p>
<p></p><ul>
    <li>First, we create a new Project using the user directory as base directory and init it.</li>
    <li>Then, we create a simple logger using the System.out and System.err streams and replace then with demux streams</li>
    <li>After that, we create the Java task. By using setCloneVm(true), the new virtual machine will clone the properties of the current virtual machine. We must use a fork virtual machine to get the return code of the application. We set also the name of the class and the args of the launch. Finally we init and execute the task</li>
    <li>Once the application is finished, we get the return code and restore the old System.out and System.err streams</li>
</ul></p>
<p>It's extremely simple and portable and the code is, I think, very clean.</body></html></p>