<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " lang="en">
<head>
<meta charset="utf-8">
<base href="http://baptiste-wicht.com/index.html">
<meta name="description" content="Website about vtechnologies Java, Spring, OSGi, Hardware,...">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>@Blog("Baptiste Wicht")</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta content="#5670d4" name="theme-color">
<link rel="alternate" type="application/rss+xml" title="RSS" href="rss.xml">
<link rel="canonical" href="http://baptiste-wicht.com/index.html">
<link rel="next" href="index-27.html" type="text/html">
<!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]--><script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-2175227-7']);
  _gaq.push(['_trackPageview']);
  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script><link href="favicon.ico" rel="icon" type="image/x-icon">
</head>
<body>

<div class="social_container">
    <div class="social_container_gplus">
        <a target="_blank" title="Share on Google+" href="https://plusone.google.com/_/+1/confirm?hl=en&amp;url=http://baptiste-wicht.com/index.html"><img src="assets/img/google_plus.png"></a>
    </div>
    <div class="social_container_facebook">
        <a target="_blank" title="Share on Facebook" href="http://www.facebook.com/sharer/sharer.php?u=#url"><img src="assets/img/facebook.png"></a>
    </div>
    <div class="social_container_twitter">
        <a target="_blank" title="Tweet on Twitter" href="http://twitter.com/home?status=#url"><img src="assets/img/twitter.svg"></a>
    </div>
</div>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-fixed-top" role="navigation"><div class="container-fluid">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="http://baptiste-wicht.com/">
                <span id="blog-title">@Blog("Baptiste Wicht")</span>
            </a>
        </div>
<!-- /.navbar-header -->
        
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
<li>
<a href="stories/about.html">About</a>
                </li>
<li>
<a href="stories/publications.html">Publications</a>
                </li>
<li>
<a href="stories/donate.html">Donate</a>
                </li>
<li>
<a href="stories/contact.html">Contact</a>
                </li>
<li>
<a href="stories/faq.html">FAQ</a>
                </li>
<li>
<a href="stories/legal.html">Legal</a>
                </li>
<li>
<a href="categories/index.html">Tags</a>
                </li>
<li>
<a href="archive.html">Archives</a>
                </li>
<li>
<a href="http://feeds.feedburner.com/BaptisteWicht">RSS</a>

            </li>
</ul>
<span class="navbar-form pull-left">
                <form action="stories/search.html">
                    <input type="text" name="q" id="tipue_search_input">
</form>
            </span>
            
            <ul class="nav navbar-nav navbar-right">
<li>
                    <a target="_blank" title="Follow @wichtounet on Twitter" href="https://twitter.com/wichtounet">
                        <img src="assets/img/twitter.svg" alt="Follow @wichtounet on Twitter"></a>
                </li>
                <li>
                    <a target="_blank" title="Follow +BaptisteWicht on Google+" href="https://plus.google.com/+BaptisteWicht">
                        <img src="assets/img/google_plus.svg" alt="Follow +BaptisteWicht on Google+"></a>
                </li>
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container-fluid -->
</nav><!-- End of Menubar --><div class="body-container">

    <!-- Sidebar -->

    <div class="left-sidebar">
            <div class="left-sidebar-widget">
                <h3>Welcome to my blog</h3>
                <div class="left-sidebar-widget-content">
                    <div class="g-person" data-width="275" data-href="//plus.google.com/u/0/103113673902796202116" data-theme="dark" data-layout="landscape" data-rel="author"></div>
                </div>
            </div>

            <div class="left-sidebar-widget">
                <h3>Tags</h3>
                <div class="left-sidebar-widget-content">
                    <div id="tags_container">
                        <canvas width="275" height="250" id="tags_canvas"><p>Anything in here will be replaced on browsers that support the canvas element</p>
                        </canvas>
</div>
                </div>
            </div>

        
        <div class="left-sidebar-widget">
            <h3>Recent comments</h3>
            <div class="left-sidebar-widget-content">
                <div id="recentcomments" class="dsq-widget">
                    <script type="text/javascript" src="http://blogwichtounet.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=0&amp;avatar_size=28&amp;excerpt_length=50"></script>
</div>
            </div>
        </div>

        <div class="left-sidebar-widget">
            <h3>Blogroll</h3>
            <div class="left-sidebar-widget-content">
                <ul>
<li><a target="_blank" href="http://www.asjava.com/">AsJava.com : Java Tutorial</a></li>
                    <li><a target="_blank" href="http://www.mkyong.com/">Mkyong : Java Tutorials</a></li>
                </ul>
</div>
        </div>
    </div>


    <!-- Content -->

    <div class="container">
        <div class="body-content">
            <div class="row">
                
        <article class="postbox h-entry post-text"><h1 class="p-name">
<a href="posts/2015/11/detect-overflows-and-more-in-java-with-cojac.html" class="u-url">Detect overflows and more in Java with COJAC</a>
        <br><small>  
             Posted: <time class="published dt-published" datetime="2015-11-27T14:18:52+01:00">2015-11-27 14:18</time></small>
</h1>
        <hr>
<div class="p-summary">
        <div>
<p>Back at school, I worked on the COJAC project to detect numeric overflow in
Java programs automatically. Since then, this project has evolved a lot and has
now more features:</p>
<blockquote>
<ul class="simple">
<li>It can detect integer overflows</li>
<li>Detect smearing and cancellation with float and double types</li>
<li>Detect NaN and Infinite results from computations</li>
<li>Detect offending type casting</li>
</ul>
</blockquote>
<p>Moreover, all these features are available without any recompilation of your
program. You simply add an argument to the invocation of the Java virtual
machine and all these errors will be detected for you automatically!</p>
<p>Frédéric Bapst, the person in charge of the project has recently published two
videos about the project, don't hesitate to check them out:</p>
<p>The first video presents the automatic analysis features of the tool:</p>
<iframe width="425" height="344" src="//www.youtube.com/embed/DqAFQfbWZOU?rel=0&amp;hd=1&amp;wmode=transparent"></iframe><p>And the second presents the numeric wrapper features of the tool for even more
features:</p>
<iframe width="425" height="344" src="//www.youtube.com/embed/4x9mJEFjcGc?rel=0&amp;hd=1&amp;wmode=transparent"></iframe><p>If you have any question related to the project, you can add a comment to this
page or contact me directly be email.</p>
<p>If you want more information on the project you can also check out its
repository on Github: <a class="reference external" href="https://github.com/Cojac/Cojac">https://github.com/Cojac/Cojac</a></p>
</div>
        </div>
            
        
    <a href="posts/2015/11/detect-overflows-and-more-in-java-with-cojac.html#disqus_thread" data-disqus-identifier="cache/posts/2015/11/detect-overflows-and-more-in-java-with-cojac.html">Comments</a>


        </article><article class="postbox h-entry post-text"><h1 class="p-name">
<a href="posts/2015/11/aggregator-plugin-display-global-metrics-in-sonarqube.html" class="u-url">Aggregator Plugin : Display global metrics in Sonarqube</a>
        <br><small>  
             Posted: <time class="published dt-published" datetime="2015-11-20T11:37:55+01:00">2015-11-20 11:37</time></small>
</h1>
        <hr>
<div class="p-summary">
        <div>
<p>Recently, I wanted to know how many lines of code I had on my Sonar server with all my C++ projects. Sonarsource proposes a commercial plugins (Views) that allows to do that (and much more...), but I didn't wanted to pay thousands of dollars simply to get a total of my lines of code, therefore I wrote a very  simple Sonar plugin to compute some global metrics.</p>
<p>This plugin is very simple, it only provides a global widgets that aggregates some stats over all your projects. For instance, here is the results on my Sonar server:</p>
<img alt="/images/aggregator_widget.png" class="align-center" src="images/aggregator_widget.png"><p>The plugin is freely available on Github: <a class="reference external" href="https://github.com/wichtounet/aggregator-plugin">https://github.com/wichtounet/aggregator-plugin</a> . However, it has only be tested on my Sonar server (4.5.2) and it is my first Sonar plugin, so it may not work everywhere. If you experience issues, don't hesitate to open an issue on Github or to propose a Pull Request.</p>
<p>You can install the plugin by putting the .jar file (from the Github Releases page) into your sonar/extensions/plugins directory and restart Sonar. You should then have access to a new global widget that you can add to a dashboard.</p>
<p>I hope this plugin helps some of you.</p>
</div>
        </div>
            
        
    <a href="posts/2015/11/aggregator-plugin-display-global-metrics-in-sonarqube.html#disqus_thread" data-disqus-identifier="cache/posts/2015/11/aggregator-plugin-display-global-metrics-in-sonarqube.html">Comments</a>


        </article><article class="postbox h-entry post-text"><h1 class="p-name">
<a href="posts/2015/11/upgrade-to-nikola-7.html" class="u-url">Upgrade to Nikola 7</a>
        <br><small>  
             Posted: <time class="published dt-published" datetime="2015-11-20T10:56:32+01:00">2015-11-20 10:56</time></small>
</h1>
        <hr>
<div class="p-summary">
        <div>
<p>I've finally taken the time to upgrade the website to Nikola 7 (it is about time, I know...).</p>
<p>The migration worked flawlessly, I simply had to update configuration to migrate deprecated and renamed tags and it worked really well. I also had to add a comma to the COMPILERS list because of the use of Python 3.3 now.</p>
<p>As you may have seen, I haven't posted in a while. I had quite some work for my thesis as well as for the courses I give at my school and I started playing Path Of Exile with took quite a bit of my free time :) I'll try to give some updates on the project I'm working on to make this blog live again.</p>
</div>
        </div>
            
        
    <a href="posts/2015/11/upgrade-to-nikola-7.html#disqus_thread" data-disqus-identifier="cache/posts/2015/11/upgrade-to-nikola-7.html">Comments</a>


        </article><article class="postbox h-entry post-text"><h1 class="p-name">
<a href="posts/2015/07/simulate-static_if-with-c11c14.html" class="u-url">Simulate static_if with C++11/C++14</a>
        <br><small>  
             Posted: <time class="published dt-published" datetime="2015-07-12T15:23:34+02:00">2015-07-12 15:23</time></small>
</h1>
        <hr>
<div class="p-summary">
        <div>
<p>If you are doing a lot of template metaprogramming and other template magic stuff, you are likely to miss a <code>static_if</code> in the language. Unfortunately, it didn't make the cut for C++11 and it seems unlikely that it will make it in C++17.</p>
<div class="section" id="static-if">
<h2>static_if</h2>
<p>As its name indicates, <code>static_if</code> is an if statement but that is done at compile-time. At first, it could seem that the main point is performance, but that is not the case. With recent compilers, if you have an if statement with a compile-time constant, it will never be executed at runtime and only the correct branch will be included in the final executable code. However, even if the compiler knows that a branch will never be executed, it still has to ensure that this branch compiles. This is not the case with <code>static_if</code>. With <code>static_if</code>, only the valid branch is compiled, the other can contains invalid code. The most common reason to use a <code>static_if</code> is inside a template where you perform a test on a template argument and execute code based on this test. <code>static_if</code> has another advantage on standard if. Since only one branch is instantiated, it may save quite a lot of compile-time.</p>
<p>Let's say we have to write a template function that, if the template argument is a string, removes the last character of the string argument, otherwise decrement the argument (I know, stupid example, but simple). With <code>static_if</code>, you can write it like this:</p>
<pre class="code cpp"><a name="rest_code_5aa51e59c52b4a899fb1696ae1ca565a-1"></a><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
<a name="rest_code_5aa51e59c52b4a899fb1696ae1ca565a-2"></a><span class="kt">void</span> <span class="n">decrement_kindof</span><span class="p">(</span><span class="n">T</span><span class="o">&amp;</span> <span class="n">value</span><span class="p">){</span>
<a name="rest_code_5aa51e59c52b4a899fb1696ae1ca565a-3"></a>    <span class="n">static_if</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">is_same</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span> <span class="n">T</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">){</span>
<a name="rest_code_5aa51e59c52b4a899fb1696ae1ca565a-4"></a>        <span class="n">value</span><span class="p">.</span><span class="n">pop_back</span><span class="p">();</span>
<a name="rest_code_5aa51e59c52b4a899fb1696ae1ca565a-5"></a>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="rest_code_5aa51e59c52b4a899fb1696ae1ca565a-6"></a>        <span class="o">--</span><span class="n">value</span><span class="p">;</span>
<a name="rest_code_5aa51e59c52b4a899fb1696ae1ca565a-7"></a>    <span class="p">}</span>
<a name="rest_code_5aa51e59c52b4a899fb1696ae1ca565a-8"></a><span class="p">}</span>
</pre>
<p>I think it is quite elegant.</p>
</div>
<div class="section" id="the-problem">
<h2>The problem</h2>
<p>Some may think, that we could do the same with C++ standard if statement:</p>
<pre class="code cpp"><a name="rest_code_afbcdb37e23444ebbf7f1175265af368-1"></a><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
<a name="rest_code_afbcdb37e23444ebbf7f1175265af368-2"></a><span class="kt">void</span> <span class="n">decrement_kindof</span><span class="p">(</span><span class="n">T</span><span class="o">&amp;</span> <span class="n">value</span><span class="p">){</span>
<a name="rest_code_afbcdb37e23444ebbf7f1175265af368-3"></a>    <span class="k">if</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">is_same</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span> <span class="n">T</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">){</span>
<a name="rest_code_afbcdb37e23444ebbf7f1175265af368-4"></a>        <span class="n">value</span><span class="p">.</span><span class="n">pop_back</span><span class="p">();</span>
<a name="rest_code_afbcdb37e23444ebbf7f1175265af368-5"></a>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="rest_code_afbcdb37e23444ebbf7f1175265af368-6"></a>        <span class="o">--</span><span class="n">value</span><span class="p">;</span>
<a name="rest_code_afbcdb37e23444ebbf7f1175265af368-7"></a>    <span class="p">}</span>
<a name="rest_code_afbcdb37e23444ebbf7f1175265af368-8"></a><span class="p">}</span>
</pre>
<p>However, this won't work. This template cannot be instantiated for <code>std::string</code> since it doesn't have an operator -- and it cannot be instantiated for int since it doesn't have a <code>pop_back()</code> function.</p>
<p>There are two solutions in plain C++: specialization and SFINAE. Let's start with specialization:</p>
<pre class="code cpp"><a name="rest_code_7ec2e3c43dd34fcb940da5b3132de923-1"></a><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
<a name="rest_code_7ec2e3c43dd34fcb940da5b3132de923-2"></a><span class="kt">void</span> <span class="n">decrement_kindof</span><span class="p">(</span><span class="n">T</span><span class="o">&amp;</span> <span class="n">value</span><span class="p">){</span>
<a name="rest_code_7ec2e3c43dd34fcb940da5b3132de923-3"></a>    <span class="o">--</span><span class="n">value</span><span class="p">;</span>
<a name="rest_code_7ec2e3c43dd34fcb940da5b3132de923-4"></a><span class="p">}</span>
<a name="rest_code_7ec2e3c43dd34fcb940da5b3132de923-5"></a>
<a name="rest_code_7ec2e3c43dd34fcb940da5b3132de923-6"></a><span class="k">template</span><span class="o">&lt;&gt;</span>
<a name="rest_code_7ec2e3c43dd34fcb940da5b3132de923-7"></a><span class="kt">void</span> <span class="n">decrement_kindof</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">value</span><span class="p">){</span>
<a name="rest_code_7ec2e3c43dd34fcb940da5b3132de923-8"></a>    <span class="n">value</span><span class="p">.</span><span class="n">pop_back</span><span class="p">();</span>
<a name="rest_code_7ec2e3c43dd34fcb940da5b3132de923-9"></a><span class="p">}</span>
</pre>
<p>We do a specialization for <code>std::string</code> case so that in the general case it uses -- and in the <code>std::string</code> case, it uses <code>pop_back()</code>. And the SFINAE version:</p>
<pre class="code cpp"><a name="rest_code_56277966069b47888c1421ac4fb25bfc-1"></a><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="kt">enable_if_t</span><span class="o">&lt;!</span><span class="n">std</span><span class="o">::</span><span class="n">is_same</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span> <span class="n">T</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">,</span> <span class="kt">int</span><span class="o">&gt;</span> <span class="o">=</span> <span class="mi">42</span><span class="o">&gt;</span>
<a name="rest_code_56277966069b47888c1421ac4fb25bfc-2"></a><span class="kt">void</span> <span class="n">decrement_kindof</span><span class="p">(</span><span class="n">T</span><span class="o">&amp;</span> <span class="n">value</span><span class="p">){</span>
<a name="rest_code_56277966069b47888c1421ac4fb25bfc-3"></a>    <span class="o">--</span><span class="n">value</span><span class="p">;</span>
<a name="rest_code_56277966069b47888c1421ac4fb25bfc-4"></a><span class="p">}</span>
<a name="rest_code_56277966069b47888c1421ac4fb25bfc-5"></a>
<a name="rest_code_56277966069b47888c1421ac4fb25bfc-6"></a><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="kt">enable_if_t</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">is_same</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span> <span class="n">T</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">,</span> <span class="kt">int</span><span class="o">&gt;</span> <span class="o">=</span> <span class="mi">42</span><span class="o">&gt;</span>
<a name="rest_code_56277966069b47888c1421ac4fb25bfc-7"></a><span class="kt">void</span> <span class="n">decrement_kindof</span><span class="p">(</span><span class="n">T</span><span class="o">&amp;</span> <span class="n">value</span><span class="p">){</span>
<a name="rest_code_56277966069b47888c1421ac4fb25bfc-8"></a>    <span class="n">value</span><span class="p">.</span><span class="n">pop_back</span><span class="p">();</span>
<a name="rest_code_56277966069b47888c1421ac4fb25bfc-9"></a><span class="p">}</span>
</pre>
<p>The first function is enabled when the type is not a <code>std::string</code> and the second function is enabled when the type is a <code>std::string</code>.</p>
<p>Both solutions needs two functions to make it work. In this particular case, specialization is easier since the condition states exactly one type. If the condition was more complex for instance testing that a constant inside the type is equals to some value, we could only do it with SFINAE.</p>
<p>Even if both solutions work, both solutions are more complicated than the static_if version and both solutions are creating more functions than what should be necessary.</p>
</div>
<div class="section" id="one-solution">
<h2>One solution</h2>
<p>There is one way to emulate a kind of <code>static_if</code> with C++14 generic lambdas. It is kind of using anonymous template function to emulate what we did with the previous solutions but does it behind the scene. Here the code I'm using for this emulation:</p>
<pre class="code cpp"><a name="rest_code_974b9da0efaa43abb8a5c66890f0f3f9-1"></a><span class="k">namespace</span> <span class="n">static_if_detail</span> <span class="p">{</span>
<a name="rest_code_974b9da0efaa43abb8a5c66890f0f3f9-2"></a>
<a name="rest_code_974b9da0efaa43abb8a5c66890f0f3f9-3"></a><span class="k">struct</span> <span class="n">identity</span> <span class="p">{</span>
<a name="rest_code_974b9da0efaa43abb8a5c66890f0f3f9-4"></a>    <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
<a name="rest_code_974b9da0efaa43abb8a5c66890f0f3f9-5"></a>    <span class="n">T</span> <span class="k">operator</span><span class="p">()(</span><span class="n">T</span><span class="o">&amp;&amp;</span> <span class="n">x</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
<a name="rest_code_974b9da0efaa43abb8a5c66890f0f3f9-6"></a>        <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">forward</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
<a name="rest_code_974b9da0efaa43abb8a5c66890f0f3f9-7"></a>    <span class="p">}</span>
<a name="rest_code_974b9da0efaa43abb8a5c66890f0f3f9-8"></a><span class="p">};</span>
<a name="rest_code_974b9da0efaa43abb8a5c66890f0f3f9-9"></a>
<a name="rest_code_974b9da0efaa43abb8a5c66890f0f3f9-10"></a><span class="k">template</span><span class="o">&lt;</span><span class="kt">bool</span> <span class="n">Cond</span><span class="o">&gt;</span>
<a name="rest_code_974b9da0efaa43abb8a5c66890f0f3f9-11"></a><span class="k">struct</span> <span class="n">statement</span> <span class="p">{</span>
<a name="rest_code_974b9da0efaa43abb8a5c66890f0f3f9-12"></a>    <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">F</span><span class="o">&gt;</span>
<a name="rest_code_974b9da0efaa43abb8a5c66890f0f3f9-13"></a>    <span class="kt">void</span> <span class="n">then</span><span class="p">(</span><span class="k">const</span> <span class="n">F</span><span class="o">&amp;</span> <span class="n">f</span><span class="p">){</span>
<a name="rest_code_974b9da0efaa43abb8a5c66890f0f3f9-14"></a>        <span class="n">f</span><span class="p">(</span><span class="n">identity</span><span class="p">());</span>
<a name="rest_code_974b9da0efaa43abb8a5c66890f0f3f9-15"></a>    <span class="p">}</span>
<a name="rest_code_974b9da0efaa43abb8a5c66890f0f3f9-16"></a>
<a name="rest_code_974b9da0efaa43abb8a5c66890f0f3f9-17"></a>    <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">F</span><span class="o">&gt;</span>
<a name="rest_code_974b9da0efaa43abb8a5c66890f0f3f9-18"></a>    <span class="kt">void</span> <span class="n">else_</span><span class="p">(</span><span class="k">const</span> <span class="n">F</span><span class="o">&amp;</span><span class="p">){}</span>
<a name="rest_code_974b9da0efaa43abb8a5c66890f0f3f9-19"></a><span class="p">};</span>
<a name="rest_code_974b9da0efaa43abb8a5c66890f0f3f9-20"></a>
<a name="rest_code_974b9da0efaa43abb8a5c66890f0f3f9-21"></a><span class="k">template</span><span class="o">&lt;&gt;</span>
<a name="rest_code_974b9da0efaa43abb8a5c66890f0f3f9-22"></a><span class="k">struct</span> <span class="n">statement</span><span class="o">&lt;</span><span class="nb">false</span><span class="o">&gt;</span> <span class="p">{</span>
<a name="rest_code_974b9da0efaa43abb8a5c66890f0f3f9-23"></a>    <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">F</span><span class="o">&gt;</span>
<a name="rest_code_974b9da0efaa43abb8a5c66890f0f3f9-24"></a>    <span class="kt">void</span> <span class="n">then</span><span class="p">(</span><span class="k">const</span> <span class="n">F</span><span class="o">&amp;</span><span class="p">){}</span>
<a name="rest_code_974b9da0efaa43abb8a5c66890f0f3f9-25"></a>
<a name="rest_code_974b9da0efaa43abb8a5c66890f0f3f9-26"></a>    <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">F</span><span class="o">&gt;</span>
<a name="rest_code_974b9da0efaa43abb8a5c66890f0f3f9-27"></a>    <span class="kt">void</span> <span class="n">else_</span><span class="p">(</span><span class="k">const</span> <span class="n">F</span><span class="o">&amp;</span> <span class="n">f</span><span class="p">){</span>
<a name="rest_code_974b9da0efaa43abb8a5c66890f0f3f9-28"></a>        <span class="n">f</span><span class="p">(</span><span class="n">identity</span><span class="p">());</span>
<a name="rest_code_974b9da0efaa43abb8a5c66890f0f3f9-29"></a>    <span class="p">}</span>
<a name="rest_code_974b9da0efaa43abb8a5c66890f0f3f9-30"></a><span class="p">};</span>
<a name="rest_code_974b9da0efaa43abb8a5c66890f0f3f9-31"></a>
<a name="rest_code_974b9da0efaa43abb8a5c66890f0f3f9-32"></a><span class="p">}</span> <span class="c1">//end of namespace static_if_detail</span>
<a name="rest_code_974b9da0efaa43abb8a5c66890f0f3f9-33"></a>
<a name="rest_code_974b9da0efaa43abb8a5c66890f0f3f9-34"></a><span class="k">template</span><span class="o">&lt;</span><span class="kt">bool</span> <span class="n">Cond</span><span class="p">,</span> <span class="k">typename</span> <span class="n">F</span><span class="o">&gt;</span>
<a name="rest_code_974b9da0efaa43abb8a5c66890f0f3f9-35"></a><span class="n">static_if_detail</span><span class="o">::</span><span class="n">statement</span><span class="o">&lt;</span><span class="n">Cond</span><span class="o">&gt;</span> <span class="n">static_if</span><span class="p">(</span><span class="n">F</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">f</span><span class="p">){</span>
<a name="rest_code_974b9da0efaa43abb8a5c66890f0f3f9-36"></a>    <span class="n">static_if_detail</span><span class="o">::</span><span class="n">statement</span><span class="o">&lt;</span><span class="n">Cond</span><span class="o">&gt;</span> <span class="n">if_</span><span class="p">;</span>
<a name="rest_code_974b9da0efaa43abb8a5c66890f0f3f9-37"></a>    <span class="n">if_</span><span class="p">.</span><span class="n">then</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
<a name="rest_code_974b9da0efaa43abb8a5c66890f0f3f9-38"></a>    <span class="k">return</span> <span class="n">if_</span><span class="p">;</span>
<a name="rest_code_974b9da0efaa43abb8a5c66890f0f3f9-39"></a><span class="p">}</span>
</pre>
<p>Note: I got the idea (and most of the code) from the <a class="reference external" href="http://lists.boost.org/Archives/boost/2014/08/216607.php">Boost Mailing List</a>.</p>
<p>The condition is passed a non-type template parameter and the code for the branch is a passed a generic lambda functor. The <code>static_if</code> function returns a statement structure. We could avoid returning a struct and directly execute, or not, the functor based on the condition, but using a structure allows for the <code>else_</code> part which may be practical. The structure <code>statement</code> is specialized on the condition. If the condition is true, the right part will execute the functor while the false part will not execute anything. The specialization when the condition is false willl do the contrary. A special point here is the use of the identity function. The function is passed to the lambda. The user can then use this function to make non-dependent type dependent. This is necessary if we want to call functions on non-dependent types and these functions may not exist. For instance, you may want to call a function on <code>this</code>, which is not a dependent type.</p>
<p>Here is how the code will look using this solution:</p>
<pre class="code cpp"><a name="rest_code_ec9bac8ce25b4304bdfc1635f947e071-1"></a><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
<a name="rest_code_ec9bac8ce25b4304bdfc1635f947e071-2"></a><span class="kt">void</span> <span class="n">decrement_kindof</span><span class="p">(</span><span class="n">T</span><span class="o">&amp;</span> <span class="n">value</span><span class="p">){</span>
<a name="rest_code_ec9bac8ce25b4304bdfc1635f947e071-3"></a>    <span class="n">static_if</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">is_same</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span> <span class="n">T</span><span class="o">&gt;::</span><span class="n">value</span><span class="o">&gt;</span><span class="p">([</span><span class="o">&amp;</span><span class="p">](</span><span class="k">auto</span> <span class="n">f</span><span class="p">){</span>
<a name="rest_code_ec9bac8ce25b4304bdfc1635f947e071-4"></a>        <span class="n">f</span><span class="p">(</span><span class="n">value</span><span class="p">).</span><span class="n">pop_back</span><span class="p">();</span>
<a name="rest_code_ec9bac8ce25b4304bdfc1635f947e071-5"></a>    <span class="p">}).</span><span class="n">else_</span><span class="p">([</span><span class="o">&amp;</span><span class="p">](</span><span class="k">auto</span> <span class="n">f</span><span class="p">){</span>
<a name="rest_code_ec9bac8ce25b4304bdfc1635f947e071-6"></a>        <span class="o">--</span><span class="n">f</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
<a name="rest_code_ec9bac8ce25b4304bdfc1635f947e071-7"></a>    <span class="p">});</span>
<a name="rest_code_ec9bac8ce25b4304bdfc1635f947e071-8"></a><span class="p">}</span>
</pre>
<p>It is not as elegant as the "real" <code>static_if</code> version, but it is closer than the other solutions.</p>
<p>If you don't use the lazy identity function (f), it still works on g++, but not on clang for some reasons.</p>
</div>
<div class="section" id="conclusion">
<h2>Conclusion</h2>
<p>We saw that there are some solutions to emulate <code>static_if</code> in C++ that you may use to make the code easier to read. I'm personally using this trick on branches with few lines of code and when I don't have to use the identity function too much, otherwise it is cleaner to use standard SFINAE functions to do the job. When you only have a if and no else, this trick is even better because that is where it saves the more code.</p>
<p>I hope this can be useful to some of you ;)</p>
<p>You can find my implementation <a class="reference external" href="https://github.com/wichtounet/cpp_utils/blob/master/static_if.hpp">on Github</a>.</p>
</div>
</div>
        </div>
            
        
    <a href="posts/2015/07/simulate-static_if-with-c11c14.html#disqus_thread" data-disqus-identifier="cache/posts/2015/07/simulate-static_if-with-c11c14.html">Comments</a>


        </article><article class="postbox h-entry post-text"><h1 class="p-name">
<a href="posts/2015/06/improve-etl-compile-time-with-precompiled-headers.html" class="u-url">Improve ETL compile-time with Precompiled Headers</a>
        <br><small>  
             Posted: <time class="published dt-published" datetime="2015-06-20T15:08:31+02:00">2015-06-20 15:08</time></small>
</h1>
        <hr>
<div class="p-summary">
        <div>
<p>Very recently, I started trying to improve the compile-time of the ETL test suite. While not critical, it is always better to have tests that compile as fast as possible. In a <a class="reference external" href="http://baptiste-wicht.com/posts/2015/06/how-i-improved-a-bit-compile-time-of-etl.html">previous post</a>, I was able to improve the time a bit by improve the makefile, using pragra once and avoiding <cite>&lt;iostream&gt;</cite> headers. With these techniques, I reduced the compile-time from 87.5 to 84.1, which is not bad, but not as good as I would have expected.</p>
<p>In the previous, I had not tried to use Precompiled Headers (PCH) to improve the compile time, so I thought it would be a good time to do it.</p>
<div class="section" id="precompiled-headers">
<h2>Precompiled Headers</h2>
<p>Precompiled Headers are an option of the compiler, where one header gets compiled. Normally, you only compile source files into object files, but you can also compile headers, although it is not the same thing. When a compiler compiles a header, it can do a lot of preprocessing (macros, includes, AST, symbols) and then store all the results into a precompiled header file. Once you compile the source files, the compiler will try to use the precompiled header file instead of the real header file. Of course, this can breaks the C++ standard since with that a header can not have different behaviour based on macros for instance. For these reasons (and probably implementation reasons as well), precompiled headers are really limited.</p>
<p>If we take the case of G++, G++ will consider the precompiled header file instead of the standard header only if (for a complete list, take a look at the GCC docs):</p>
<ul class="simple">
<li>The same compilation flags are the same between the two compilations</li>
<li>The same compiler binary is used for the compilations</li>
<li>Only one precompiled header can be used in each compilation</li>
<li>The same macros must be defined</li>
<li>The include of the header must be before every possible C/C++ token</li>
</ul>
<p>If all these conditions are met and you try to <cite>#include "header.hpp</cite> and there is a header.hpp.gch (the precompiled file) available in the search path, then the precompiled header will be taken instead of the standard one.</p>
<p>With clang, it is a bit different because the precompiled header cannot be included automatically, but has to be included explicitely in the source code, meaning you have to modify your code for this technique to work. This is a bad thing in my opinion, you never should have to modify your code to profit from a compiler feature. This is why I haven't used and don't plan to use precompiled headers with clang.</p>
</div>
<div class="section" id="how-to">
<h2>How-to</h2>
<p>Once you know all the conditions for a precompiled header to be automatically included, it is quite straightforward to use them.</p>
<p>To generate a PCH file is easy:</p>
<pre class="literal-block">
g++ options header.hpp
</pre>
<p>This will generate header.hpp.gch. When you compile your source file using header.hpp, you don't have anything to do, you just have to compile it as usually and if all the conditions are met, the PCH file will be used instead of the other header.</p>
</div>
<div class="section" id="results-and-conclusion">
<h2>Results and conclusion</h2>
<p>I added precompiled header support into my <a class="reference external" href="https://github.com/wichtounet/make-utils">make-utils</a> collection of Makefile utilities and tested it on ETL. I have precompiled a header that itself included Catch and ETL. Almost all test files are including this header. With this change, I went from 84 seconds to 78seconds. Headers are taking 1.5seconds to be precompiled. This is a nice result I think. If your application is not as template-heavy as mine or if you have more source files, you should expect better improvements.</p>
<p>To conclude, even if precompiled headers are a sound way to reduce compile-time, they are really limited to some cases. I'm not a fan of the feature overally. It is not portable between compilers and not standard. Anyway, if you are really in need of saving some time, you should not hesitate too much ;)</p>
</div>
</div>
        </div>
            
        
    <a href="posts/2015/06/improve-etl-compile-time-with-precompiled-headers.html#disqus_thread" data-disqus-identifier="cache/posts/2015/06/improve-etl-compile-time-with-precompiled-headers.html">Comments</a>


        </article><article class="postbox h-entry post-text"><h1 class="p-name">
<a href="posts/2015/06/how-i-improved-a-bit-compile-time-of-etl.html" class="u-url">How I improved (a bit) compile time of ETL ?</a>
        <br><small>  
             Posted: <time class="published dt-published" datetime="2015-06-16T22:00:21+02:00">2015-06-16 22:00</time></small>
</h1>
        <hr>
<div class="p-summary">
        <div>
<p>Recently I read several articles about C++ and compile time and I wondered if I could improve the compile time of my Expression Template Library (ETL) project. ETL is a header-only and template-heavy library. I'm not going to the change the design completely or to use type erasure techniques to reduce the compile time, ETL is all about performance.</p>
<p>As a disclaimer, don't expect fancy results from this post, I haven't been able to reduce compile time a lot, but I still wanted to share my experience.</p>
<p>I've used g++-4.9.2 to perform these tests.</p>
<p>I'm compiling the complete test suite (around 6900 source lines of codes in 36 files) in release mode. Each test file includes the ETL (around 10K SLOC). Each test is run with 8 threads (make -j8). For each result, I have run a complete build 5 times and taken the best result as the final result. Everything is run on a SSD and I have more than enough RAM to handle all the compilation in parallel.</p>
<p>The reference build time was 87.5 seconds.</p>
<div class="section" id="compile-and-generate-dependency-files-at-the-same-time">
<h2>Compile and generate dependency files at the same time</h2>
<p>To help write my makefiles, I'm using a set of functions that I have written. This includes automatic dependency generation using -MM -MT options of the compiler. Until now, I had two targets, one to compile the cpp file into the object file and another one to generate the dependency file. I recently saw that compilers were able to do both at the same time! Clang, G++ and the Intel compiler all have a -MD -MF options that lets you generate the dependency file at the same time you compile your file, saving you at least one read of the file.</p>
<p>My compilation rule in my makefile has now become:</p>
<pre class="code makefile"><a name="rest_code_409d4a1a853b44b7a55211361a5c1e0b-1"></a><span class="nf">release/$(1)/%.cpp.o</span><span class="o">:</span> <span class="k">$(</span>1<span class="k">)</span>/%.<span class="n">cpp</span>
<a name="rest_code_409d4a1a853b44b7a55211361a5c1e0b-2"></a>    @ mkdir -p release/<span class="k">$(</span>1<span class="k">)</span>/
<a name="rest_code_409d4a1a853b44b7a55211361a5c1e0b-3"></a>    <span class="k">$(</span>CXX<span class="k">)</span> <span class="k">$(</span>CXX_FLAGS<span class="k">)</span> <span class="k">$(</span>RELEASE_FLAGS<span class="k">)</span> <span class="k">$(</span>2<span class="k">)</span> -MD -MF release/<span class="k">$(</span>1<span class="k">)</span>/<span class="nv">$$</span>*.cpp.d -o release/<span class="k">$(</span>1<span class="k">)</span>/<span class="nv">$$</span>*.cpp.o -c <span class="k">$(</span>1<span class="k">)</span>/<span class="nv">$$</span>*.cpp
<a name="rest_code_409d4a1a853b44b7a55211361a5c1e0b-4"></a>    @ sed -i -e <span class="s1">'s@^\(.*\)\.o:@\1.d \1.o:@'</span> release/<span class="k">$(</span>1<span class="k">)</span>/<span class="nv">$$</span>*.cpp.d
</pre>
<p>This reduced the compilation time to 86.8 seconds. Not that much reduction, but it still is quite nice to know that. I would have expected this to reduce more the compile time.</p>
<div class="section" id="use-pragma-once">
<h3>Use #pragma once</h3>
<p>Normally, I'm not a fan of #pragma since it is not standard, but for now ETL only supports three compilers and only very recent of them, so I have the guarantee that #pragma once is available, so what the hell!</p>
<p>I've replaced all the include guards by single #pragma once directives.</p>
<p>Again, the results are not impressive, this reduced the compile time to 86.2 seconds. I would only advise to use this if you are sure of the compilers you want to support and you need the extra time.</p>
</div>
<div class="section" id="avoid-iostream">
<h3>Avoid &lt;iostream&gt;</h3>
<p>I've read that the &lt;iostream&gt; header was one of the slowest to compile of the STL. It is only one that is included several times in my headers only for stream operators and it turns out that there is a &lt;iosfwd&gt; header that forward declares a lot of things from the &lt;iostream&gt; and other I/O headers.</p>
<p>By replacing all &lt;iostream&gt; include by &lt;iosfwd&gt;, compile time has gone down to 84.1 seconds.</p>
</div>
<div class="section" id="conclusion">
<h3>Conclusion</h3>
<p>By using the three techniques, I've reduced the compile time from 87.5 to 84.1 seconds. I would have honestly hoped for more improvements, but this is a already a good start.</p>
<p>As a side note, clang compile time is 45.2 seconds under the same conditions (was 46.2 seconds before the optimizations). It is really much faster :) I'm still using GCC a lot since in several cases, it does generate much better code and in average, the generated code if faster (on my benchmarks at least). I don't have the numbers for icc, but icc is definitely the slowest of the three. When I have it available (at work), I use for release build before running something. The generated executables are generally faster (I only use Intel processors) and sometimes the difference can be quite important.</p>
<p>If you have ideas to reduce further the compile time on this test case, I'd be glad to hear them and put them to the test.</p>
<p>I hope that this small experience would be helpful to some of you :)</p>
</div>
<div class="section" id="other-techniques">
<h3>Other techniques</h3>
<p>There are several other techniques that you can use to reduce compile time:</p>
<ol class="arabic simple">
<li>Precompiled Headers are supported by both Clang and GCC, altough not in a compatible. I haven't tested this in a while, but it is quite effective and a very interesting technique. The main problem with this is that is not standard and not compatible between compilers. But it probably is the most efficient techniques when you have lots of headers and lots of templates as in my case.</li>
<li>Unity builds can make full rebuild much faster. I personally don't like unity builds especially because it is only really good for full builds and you generally don't do full rebuilds that much (I know, I know, this is also the test done in this article :) ). Moreover, it also sucks at doing parallel builds.</li>
<li>Pimpl idioms and other type erasure techniques can reduce compile time a lot. If it is well done, it can be implemented without so much overhead.</li>
<li>Explicit instantiation of templates can also help, but only in the case of a user program. In the case of a library itself, you cannot do anything.</li>
<li>Reduce inclusions and use forward declarations, obviously...</li>
<li>Use tools like distcc (I very rarely use it) and ccache (I generally use it).</li>
<li>Update your compiler</li>
<li>Upgrade your computer ;)</li>
<li>...</li>
</ol>
</div>
</div>
</div>
        </div>
            
        
    <a href="posts/2015/06/how-i-improved-a-bit-compile-time-of-etl.html#disqus_thread" data-disqus-identifier="cache/posts/2015/06/how-i-improved-a-bit-compile-time-of-etl.html">Comments</a>


        </article><article class="postbox h-entry post-text"><h1 class="p-name">
<a href="posts/2015/06/continuous-performance-management-with-cpm-for-cpp.html" class="u-url">Continuous Performance Management with CPM for C++</a>
        <br><small>  
             Posted: <time class="published dt-published" datetime="2015-06-14T14:02:57+02:00">2015-06-14 14:02</time></small>
</h1>
        <hr>
<div class="p-summary">
        <div>
<p>For some time, I have wanted some tool to monitor the performance of some of my projects. There are plenty of tools for Continuous Integration and Sonar is really great for continuous monitoring of code quality, but I haven't found anything satisfying for monitoring performance of C++ code. So I decided to write my own. <a class="reference external" href="https://github.com/wichtounet/cpm">Continous Performance Monitor (CPM)</a> is a simple C++ tool that helps you running benchmarks for your C++ programs and generate web reports based on the results. In this article, I will present this tool. CPM is especially made to benchmark several sub parts of libraries, but it perfectly be used to benchmark a whole program as well.</p>
<p>The idea is to couple it with a Continuous Integration tool (I use Jenkins for instance) and run the benchmarks for every new push in a repository. With that, you can check if you have performance regression for instance or simply see if your changes were really improving the performance as much as you thought.</p>
<p>It is made of two separate parts:</p>
<ol class="arabic simple">
<li>A header-only library that you can use to benchmark your program and that will give you the performance results. It will also generate a JSON report of the collected data.</li>
<li>A program that will generate a web version of the reports with analysis over time, over different compilers or over different configurations.</li>
</ol>
<p>CPM is especially made to benchmark functions that takes input data and which runtime depends on the dimensions of the input data. For each benchmark, CPM will execute it with several different input sizes. There are different ways to define a benchmark:</p>
<ul class="simple">
<li>
<em>two_pass</em>: The benchmark is made of two part, the initialization part is called once for each input size and then the benchmark part is repeated several times for the measure. This is the most general version.</li>
<li>
<em>global</em>: The benchmark will be run with different input sizes but uses global data that will be randomized before each measure</li>
<li>
<em>simple</em>: The benchmark will be run with different input sizes, data will not be randomized</li>
<li>
<em>once</em>: The benchmark will be run with no input size.</li>
</ul>
<p>Note: The randomization of the data can be disabled.</p>
<p>You can run independent benchmarks or you can run sections of benchmarks. A section is used to compared different implementations of the same thing. For instance, I use them to compare different implementation of convolution or to see how ETL compete with other Expression Templates library.</p>
<img alt="/images/cpm_large.png" src="images/cpm_large.png"><div class="section" id="examples">
<h2>Examples</h2>
<p>I've uploaded three generated reports so that you can have look at some results:</p>
<ul class="simple">
<li>Results of the ETL benchmark (one page per benchmark): <a class="reference external" href="http://baptiste-wicht.com/cpm/etl/">Site 1</a> <a class="reference external" href="https://github.com/wichtounet/etl/blob/master/workbench/benchmark.cpp">Source 1</a>
</li>
<li>Results of simple ETL / Blaze / Eigen3 comparison: <a class="reference external" href="http://baptiste-wicht.com/cpm/etl_blaze_eigen/">Site 2</a> <a class="reference external" href="https://github.com/wichtounet/etl_vs_blaze/blob/master/src/simple.cpp">Source 2</a>
</li>
<li>Results of the CPM dummy examples: <a class="reference external" href="http://baptiste-wicht.com/cpm/examples/">Site 3</a> <a class="reference external" href="https://github.com/wichtounet/cpm/blob/master/examples/simple.cpp">Source 3</a>
</li>
</ul>
</div>
<div class="section" id="run-benchmarks">
<h2>Run benchmarks</h2>
<p>There are two ways of running CPM. You can directly use the library to run the benchmarks or you can use the macro facilities to make it easier. I recommend to use the second way since it is easier and I'm gonna try to keep it stable while the library can change. If you want an example of using the library directly, you can take a look at <a class="reference external" href="https://github.com/wichtounet/cpm/blob/master/examples/simple.cpp">this example</a>. In this chapter, I'm gonna focus on the macro-way.</p>
<p>The library is available <a class="reference external" href="https://github.com/wichtounet/cpm">here</a>, you can either include as a submodule of your projects or install it globally to have access to its headers.</p>
<p>The first thing to do is to include the CPM header:</p>
<pre class="code cpp"><a name="rest_code_6aeecc3fc31c47c0b1881d434c99e014-1"></a><span class="cp">#define CPM_BENCHMARK "Example Benchmarks"</span>
<a name="rest_code_6aeecc3fc31c47c0b1881d434c99e014-2"></a><span class="cp">#include "cpm/cpm.hpp"</span>
</pre>
<p>You have to name your benchmark. This will automatically creates a main and will run all the declared benchmark.</p>
<div class="section" id="define-benchmarks">
<h3>Define benchmarks</h3>
<p>Benchmarks can be defined either in a CPM_BENCH functor or in the global scope with <code>CPM_DIRECT_BENCH</code>.</p>
<ol class="arabic simple">
<li>simple</li>
</ol>
<pre class="code cpp"><a name="rest_code_e1c2fc7da5bb40738f94a38a44bbb940-1"></a><span class="n">CPM_DIRECT_BENCH_SIMPLE</span><span class="p">(</span><span class="s">"bench_name"</span><span class="p">,</span> <span class="p">[](</span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">d</span><span class="p">){</span> <span class="n">std</span><span class="o">::</span><span class="n">this_thread</span><span class="o">::</span><span class="n">sleep_for</span><span class="p">((</span><span class="n">factor</span> <span class="o">*</span> <span class="n">d</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="n">_ns</span> <span class="p">);</span> <span class="p">})</span>
</pre>
<p>The first argument is the name of the benchmark and the second argument is the function that will be benchmarked by the system, this function takes the input size as input.</p>
<ol class="arabic simple" start="2">
<li>global</li>
</ol>
<pre class="code cpp"><a name="rest_code_af42a7b935fb4faab2c068e6da2a9868-1"></a><span class="n">CPM_BENCH</span><span class="p">()</span> <span class="p">{</span>
<a name="rest_code_af42a7b935fb4faab2c068e6da2a9868-2"></a>    <span class="n">test</span> <span class="n">a</span><span class="p">{</span><span class="mi">3</span><span class="p">};</span>
<a name="rest_code_af42a7b935fb4faab2c068e6da2a9868-3"></a>    <span class="n">CPM_GLOBAL</span><span class="p">(</span><span class="s">"bench_name"</span><span class="p">,</span> <span class="p">[</span><span class="o">&amp;</span><span class="n">a</span><span class="p">](</span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">d</span><span class="p">){</span> <span class="n">std</span><span class="o">::</span><span class="n">this_thread</span><span class="o">::</span><span class="n">sleep_for</span><span class="p">((</span><span class="n">factor</span> <span class="o">*</span> <span class="n">d</span> <span class="o">*</span> <span class="n">a</span><span class="p">.</span><span class="n">d</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1</span><span class="n">_ns</span> <span class="p">);</span> <span class="p">},</span> <span class="n">a</span><span class="p">);</span>
<a name="rest_code_af42a7b935fb4faab2c068e6da2a9868-4"></a><span class="p">}</span>
</pre>
<p>The first argument is the name of the benchmark, the second is the function being benchmarked and the following arguments must be references to global data that will be randomized by CPM.</p>
<ol class="arabic simple" start="3">
<li>two_pass</li>
</ol>
<pre class="code cpp"><a name="rest_code_8bb00d0e97944db4a7d3473f3125ae9d-1"></a><span class="n">CPM_DIRECT_BENCH_TWO_PASS</span><span class="p">(</span><span class="s">"bench_name"</span><span class="p">,</span>
<a name="rest_code_8bb00d0e97944db4a7d3473f3125ae9d-2"></a>    <span class="p">[](</span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">d</span><span class="p">){</span> <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">make_tuple</span><span class="p">(</span><span class="n">test</span><span class="p">{</span><span class="n">d</span><span class="p">});</span> <span class="p">},</span>
<a name="rest_code_8bb00d0e97944db4a7d3473f3125ae9d-3"></a>    <span class="p">[](</span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">d</span><span class="p">,</span> <span class="n">test</span><span class="o">&amp;</span> <span class="n">d2</span><span class="p">){</span> <span class="n">std</span><span class="o">::</span><span class="n">this_thread</span><span class="o">::</span><span class="n">sleep_for</span><span class="p">((</span><span class="n">factor</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="n">d</span> <span class="o">+</span> <span class="n">d2</span><span class="p">.</span><span class="n">d</span><span class="p">))</span> <span class="o">*</span> <span class="mi">1</span><span class="n">_ns</span> <span class="p">);</span> <span class="p">}</span>
<a name="rest_code_8bb00d0e97944db4a7d3473f3125ae9d-4"></a><span class="p">)</span>
</pre>
<p>Again, the first argument is the name. The second argument is the initialization functor. This functor must returns a tuple with all the information that will be passed (unpacked) to the third argument (the benchmark functor). Everything that is being returned by the initialization functor will be randomized.</p>
</div>
<div class="section" id="select-the-input-sizes">
<h3>Select the input sizes</h3>
<p>By default, CPM will invoke your benchmarks with values from 10 to 1000000, multiplying it by 10 each step. This can be tuned for each benchmark and section independently. Each benchmark macro has a _P suffix that allows you to set the size policy:</p>
<pre class="code cpp"><a name="rest_code_021d64c677a642e980fe39c6859bfc7c-1"></a><span class="n">CPM_SIMPLE_P</span><span class="p">(</span>
<a name="rest_code_021d64c677a642e980fe39c6859bfc7c-2"></a>    <span class="n">VALUES_POLICY</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span>
<a name="rest_code_021d64c677a642e980fe39c6859bfc7c-3"></a>    <span class="s">"simple_a_n"</span><span class="p">,</span>
<a name="rest_code_021d64c677a642e980fe39c6859bfc7c-4"></a>    <span class="p">[](</span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">d</span><span class="p">){</span> <span class="n">std</span><span class="o">::</span><span class="n">this_thread</span><span class="o">::</span><span class="n">sleep_for</span><span class="p">((</span><span class="n">factor</span> <span class="o">*</span> <span class="n">d</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1</span><span class="n">_ns</span> <span class="p">);</span> <span class="p">});</span>
</pre>
<p>You can also have several sizes (for multidimensional data structures or algorithms):</p>
<pre class="code cpp"><a name="rest_code_cbb949d297fc424ea9d6e6b573e3aa07-1"></a><span class="n">CPM_DIRECT_BENCH_TWO_PASS_P</span><span class="p">(</span>
<a name="rest_code_cbb949d297fc424ea9d6e6b573e3aa07-2"></a>    <span class="n">NARY_POLICY</span><span class="p">(</span><span class="n">VALUES_POLICY</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">64</span><span class="p">),</span> <span class="n">VALUES_POLICY</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">24</span><span class="p">)),</span>
<a name="rest_code_cbb949d297fc424ea9d6e6b573e3aa07-3"></a>    <span class="s">"convmtx2"</span><span class="p">,</span>
<a name="rest_code_cbb949d297fc424ea9d6e6b573e3aa07-4"></a>    <span class="p">[](</span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">d1</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">d2</span><span class="p">){</span> <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">make_tuple</span><span class="p">(</span><span class="n">dmat</span><span class="p">(</span><span class="n">d1</span><span class="p">,</span> <span class="n">d1</span><span class="p">),</span> <span class="n">dmat</span><span class="p">((</span><span class="n">d1</span> <span class="o">+</span> <span class="n">d2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">d1</span> <span class="o">+</span> <span class="n">d2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">d2</span> <span class="o">*</span> <span class="n">d2</span><span class="p">));</span> <span class="p">},</span>
<a name="rest_code_cbb949d297fc424ea9d6e6b573e3aa07-5"></a>    <span class="p">[](</span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="cm">/*d1*/</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">d2</span><span class="p">,</span> <span class="n">dmat</span><span class="o">&amp;</span> <span class="n">a</span><span class="p">,</span> <span class="n">dmat</span><span class="o">&amp;</span> <span class="n">b</span><span class="p">){</span> <span class="n">b</span> <span class="o">=</span> <span class="n">etl</span><span class="o">::</span><span class="n">convmtx2</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">d2</span><span class="p">,</span> <span class="n">d2</span><span class="p">);</span> <span class="p">}</span>
<a name="rest_code_cbb949d297fc424ea9d6e6b573e3aa07-6"></a><span class="p">)</span>
</pre>
</div>
<div class="section" id="configure-benchmarks">
<h3>Configure benchmarks</h3>
<p>By default, each benchmark is run 10 times for warmup and then repeated 50 times, but you can define your own values:</p>
<pre class="code cpp"><a name="rest_code_82e5593e65684bbfab3c53ce1beeebe4-1"></a><span class="cp">#define CPM_WARMUP 3</span>
<a name="rest_code_82e5593e65684bbfab3c53ce1beeebe4-2"></a><span class="cp">#define CPM_REPEAT 10</span>
</pre>
<p>This must be done before the inclusion of the header.</p>
</div>
<div class="section" id="define-sections">
<h3>Define sections</h3>
<p>Sections are simply a group of benchmarks, so instead of putting several benchmarks inside a <code>CPM_BENCH</code>, you can put them inside a <code>CPM_SECTION</code>. For instance:</p>
<pre class="code cpp"><a name="rest_code_b4694bb2fdaa4c6c8ae69eebf169bd97-1"></a><span class="n">CPM_SECTION</span><span class="p">(</span><span class="s">"mmul"</span><span class="p">)</span>
<a name="rest_code_b4694bb2fdaa4c6c8ae69eebf169bd97-2"></a>    <span class="n">CPM_SIMPLE</span><span class="p">(</span><span class="s">"std"</span><span class="p">,</span> <span class="p">[](</span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">d</span><span class="p">){</span> <span class="n">std</span><span class="o">::</span><span class="n">this_thread</span><span class="o">::</span><span class="n">sleep_for</span><span class="p">((</span><span class="n">factor</span> <span class="o">*</span> <span class="n">d</span><span class="p">)</span> <span class="o">*</span> <span class="mi">9</span><span class="n">_ns</span> <span class="p">);</span> <span class="p">});</span>
<a name="rest_code_b4694bb2fdaa4c6c8ae69eebf169bd97-3"></a>    <span class="n">CPM_SIMPLE</span><span class="p">(</span><span class="s">"fast"</span><span class="p">,</span> <span class="p">[](</span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">d</span><span class="p">){</span> <span class="n">std</span><span class="o">::</span><span class="n">this_thread</span><span class="o">::</span><span class="n">sleep_for</span><span class="p">((</span><span class="n">factor</span> <span class="o">*</span> <span class="p">(</span><span class="n">d</span> <span class="o">/</span> <span class="mi">3</span><span class="p">))</span> <span class="o">*</span> <span class="mi">1</span><span class="n">_ns</span> <span class="p">);</span> <span class="p">});</span>
<a name="rest_code_b4694bb2fdaa4c6c8ae69eebf169bd97-4"></a>    <span class="n">CPM_SIMPLE</span><span class="p">(</span><span class="s">"common"</span><span class="p">,</span> <span class="p">[](</span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">d</span><span class="p">){</span> <span class="n">std</span><span class="o">::</span><span class="n">this_thread</span><span class="o">::</span><span class="n">sleep_for</span><span class="p">((</span><span class="n">factor</span> <span class="o">*</span> <span class="p">(</span><span class="n">d</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span> <span class="o">*</span> <span class="mi">3</span><span class="n">_ns</span> <span class="p">);</span> <span class="p">});</span>
<a name="rest_code_b4694bb2fdaa4c6c8ae69eebf169bd97-5"></a><span class="p">}</span>
<a name="rest_code_b4694bb2fdaa4c6c8ae69eebf169bd97-6"></a><span class="n">CPM_SECTION</span><span class="p">(</span><span class="s">"conv"</span><span class="p">)</span>
<a name="rest_code_b4694bb2fdaa4c6c8ae69eebf169bd97-7"></a>    <span class="n">CPM_TWO_PASS</span><span class="p">(</span><span class="s">"std"</span><span class="p">,</span>
<a name="rest_code_b4694bb2fdaa4c6c8ae69eebf169bd97-8"></a>        <span class="p">[](</span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">d</span><span class="p">){</span> <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">make_tuple</span><span class="p">(</span><span class="n">test</span><span class="p">{</span><span class="n">d</span><span class="p">});</span> <span class="p">},</span>
<a name="rest_code_b4694bb2fdaa4c6c8ae69eebf169bd97-9"></a>        <span class="p">[](</span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">d</span><span class="p">,</span> <span class="n">test</span><span class="o">&amp;</span> <span class="n">d2</span><span class="p">){</span> <span class="n">std</span><span class="o">::</span><span class="n">this_thread</span><span class="o">::</span><span class="n">sleep_for</span><span class="p">((</span><span class="n">factor</span> <span class="o">*</span> <span class="mi">5</span> <span class="o">*</span> <span class="p">(</span><span class="n">d</span> <span class="o">+</span> <span class="n">d2</span><span class="p">.</span><span class="n">d</span><span class="p">))</span> <span class="o">*</span> <span class="mi">1</span><span class="n">_ns</span> <span class="p">);</span> <span class="p">}</span>
<a name="rest_code_b4694bb2fdaa4c6c8ae69eebf169bd97-10"></a>        <span class="p">);</span>
<a name="rest_code_b4694bb2fdaa4c6c8ae69eebf169bd97-11"></a>    <span class="n">CPM_TWO_PASS</span><span class="p">(</span><span class="s">"fast"</span><span class="p">,</span>
<a name="rest_code_b4694bb2fdaa4c6c8ae69eebf169bd97-12"></a>        <span class="p">[](</span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">d</span><span class="p">){</span> <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">make_tuple</span><span class="p">(</span><span class="n">test</span><span class="p">{</span><span class="n">d</span><span class="p">});</span> <span class="p">},</span>
<a name="rest_code_b4694bb2fdaa4c6c8ae69eebf169bd97-13"></a>        <span class="p">[](</span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">d</span><span class="p">,</span> <span class="n">test</span><span class="o">&amp;</span> <span class="n">d2</span><span class="p">){</span> <span class="n">std</span><span class="o">::</span><span class="n">this_thread</span><span class="o">::</span><span class="n">sleep_for</span><span class="p">((</span><span class="n">factor</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="n">d</span> <span class="o">+</span> <span class="n">d2</span><span class="p">.</span><span class="n">d</span><span class="p">))</span> <span class="o">*</span> <span class="mi">1</span><span class="n">_ns</span> <span class="p">);</span> <span class="p">}</span>
<a name="rest_code_b4694bb2fdaa4c6c8ae69eebf169bd97-14"></a>        <span class="p">);</span>
<a name="rest_code_b4694bb2fdaa4c6c8ae69eebf169bd97-15"></a><span class="p">}</span>
</pre>
<p>You can also set different warmup and repeat values for each section by using <code>CPM_SECTION_O</code>:</p>
<pre class="code cpp"><a name="rest_code_c66991cc81b74c48a8e758e4867fda9c-1"></a><span class="n">CPM_SECTION_O</span><span class="p">(</span><span class="s">"fft"</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">51</span><span class="p">)</span>
<a name="rest_code_c66991cc81b74c48a8e758e4867fda9c-2"></a>    <span class="n">test</span> <span class="n">a</span><span class="p">{</span><span class="mi">3</span><span class="p">};</span>
<a name="rest_code_c66991cc81b74c48a8e758e4867fda9c-3"></a>    <span class="n">test</span> <span class="n">b</span><span class="p">{</span><span class="mi">5</span><span class="p">};</span>
<a name="rest_code_c66991cc81b74c48a8e758e4867fda9c-4"></a>    <span class="n">CPM_GLOBAL</span><span class="p">(</span><span class="s">"std"</span><span class="p">,</span> <span class="p">[</span><span class="o">&amp;</span><span class="n">a</span><span class="p">](</span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">d</span><span class="p">){</span> <span class="n">std</span><span class="o">::</span><span class="n">this_thread</span><span class="o">::</span><span class="n">sleep_for</span><span class="p">((</span><span class="n">factor</span> <span class="o">*</span> <span class="n">d</span> <span class="o">*</span> <span class="p">(</span><span class="n">d</span> <span class="o">%</span> <span class="n">a</span><span class="p">.</span><span class="n">d</span><span class="p">))</span> <span class="o">*</span> <span class="mi">1</span><span class="n">_ns</span> <span class="p">);</span> <span class="p">},</span> <span class="n">a</span><span class="p">);</span>
<a name="rest_code_c66991cc81b74c48a8e758e4867fda9c-5"></a>    <span class="n">CPM_GLOBAL</span><span class="p">(</span><span class="s">"mkl"</span><span class="p">,</span> <span class="p">[</span><span class="o">&amp;</span><span class="n">b</span><span class="p">](</span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">d</span><span class="p">){</span> <span class="n">std</span><span class="o">::</span><span class="n">this_thread</span><span class="o">::</span><span class="n">sleep_for</span><span class="p">((</span><span class="n">factor</span> <span class="o">*</span> <span class="n">d</span> <span class="o">*</span> <span class="p">(</span><span class="n">d</span> <span class="o">%</span> <span class="n">b</span><span class="p">.</span><span class="n">d</span><span class="p">))</span> <span class="o">*</span> <span class="mi">1</span><span class="n">_ns</span> <span class="p">);</span> <span class="p">},</span> <span class="n">b</span><span class="p">);</span>
<a name="rest_code_c66991cc81b74c48a8e758e4867fda9c-6"></a><span class="p">}</span>
</pre>
<p>will be warmup 11 times and run 51 times.</p>
<p>The size policy can also be changed for the complete section (cannot be changed independently for benchmarks inside the section):</p>
<pre class="code cpp"><a name="rest_code_befc4621685445c9b791f464cd41dba4-1"></a><span class="n">CPM_SECTION_P</span><span class="p">(</span><span class="s">"mmul"</span><span class="p">,</span>
<a name="rest_code_befc4621685445c9b791f464cd41dba4-2"></a>    <span class="n">NARY_POLICY</span><span class="p">(</span><span class="n">STD_STOP_POLICY</span><span class="p">,</span> <span class="n">VALUES_POLICY</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span> <span class="n">VALUES_POLICY</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span><span class="mi">32</span><span class="p">,</span><span class="mi">64</span><span class="p">)))</span>
<a name="rest_code_befc4621685445c9b791f464cd41dba4-3"></a>    <span class="n">test</span> <span class="n">a</span><span class="p">{</span><span class="mi">3</span><span class="p">};</span>
<a name="rest_code_befc4621685445c9b791f464cd41dba4-4"></a>    <span class="n">test</span> <span class="n">b</span><span class="p">{</span><span class="mi">5</span><span class="p">};</span>
<a name="rest_code_befc4621685445c9b791f464cd41dba4-5"></a>    <span class="n">CPM_GLOBAL</span><span class="p">(</span><span class="s">"std"</span><span class="p">,</span> <span class="p">[</span><span class="o">&amp;</span><span class="n">a</span><span class="p">](</span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">d1</span><span class="p">,</span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">d2</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">d3</span><span class="p">){</span> <span class="cm">/* Something */</span> <span class="p">},</span> <span class="n">a</span><span class="p">);</span>
<a name="rest_code_befc4621685445c9b791f464cd41dba4-6"></a>    <span class="n">CPM_GLOBAL</span><span class="p">(</span><span class="s">"mkl"</span><span class="p">,</span> <span class="p">[</span><span class="o">&amp;</span><span class="n">a</span><span class="p">](</span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">d1</span><span class="p">,</span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">d2</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">d3</span><span class="p">){</span> <span class="cm">/* Something */</span> <span class="p">},</span> <span class="n">a</span><span class="p">);</span>
<a name="rest_code_befc4621685445c9b791f464cd41dba4-7"></a>    <span class="n">CPM_GLOBAL</span><span class="p">(</span><span class="s">"bla"</span><span class="p">,</span> <span class="p">[</span><span class="o">&amp;</span><span class="n">a</span><span class="p">](</span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">d1</span><span class="p">,</span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">d2</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">d3</span><span class="p">){</span> <span class="cm">/* Something */</span> <span class="p">},</span> <span class="n">a</span><span class="p">);</span>
<a name="rest_code_befc4621685445c9b791f464cd41dba4-8"></a><span class="p">}</span>
</pre>
</div>
<div class="section" id="run">
<h3>Run</h3>
<p>Once your benchmarks and sections are defined, you can build you program as a normal C++ main and run it. You can pass several options:</p>
<pre class="code text"><a name="rest_code_81dc95e5a49f4e13807429f4380966d2-1"></a>./debug/bin/full -h
<a name="rest_code_81dc95e5a49f4e13807429f4380966d2-2"></a>Usage:
<a name="rest_code_81dc95e5a49f4e13807429f4380966d2-3"></a>  ./debug/bin/full [OPTION...]
<a name="rest_code_81dc95e5a49f4e13807429f4380966d2-4"></a>
<a name="rest_code_81dc95e5a49f4e13807429f4380966d2-5"></a>  -n, --name arg           Benchmark name
<a name="rest_code_81dc95e5a49f4e13807429f4380966d2-6"></a>  -t, --tag arg            Tag name
<a name="rest_code_81dc95e5a49f4e13807429f4380966d2-7"></a>  -c, --configuration arg  Configuration
<a name="rest_code_81dc95e5a49f4e13807429f4380966d2-8"></a>  -o, --output arg         Output folder
<a name="rest_code_81dc95e5a49f4e13807429f4380966d2-9"></a>  -h, --help               Print help
</pre>
<p>The tag is used to distinguish between runs, I recommend that you use a SCM identifier for the tag. If you want to run your program with different configurations (compiler options for instance), you'll have to set the configuration with the --configuration option.</p>
<p>Here is a possible output:</p>
<pre class="code text"><a name="rest_code_caa866a022614a8aa1b076c8422c52f1-1"></a> Start CPM benchmarks
<a name="rest_code_caa866a022614a8aa1b076c8422c52f1-2"></a>    Results will be automatically saved in /home/wichtounet/dev/cpm/results/10.cpm
<a name="rest_code_caa866a022614a8aa1b076c8422c52f1-3"></a>    Each test is warmed-up 10 times
<a name="rest_code_caa866a022614a8aa1b076c8422c52f1-4"></a>    Each test is repeated 50 times
<a name="rest_code_caa866a022614a8aa1b076c8422c52f1-5"></a>    Time Sun Jun 14 15:33:51 2015
<a name="rest_code_caa866a022614a8aa1b076c8422c52f1-6"></a>
<a name="rest_code_caa866a022614a8aa1b076c8422c52f1-7"></a>    Tag: 10
<a name="rest_code_caa866a022614a8aa1b076c8422c52f1-8"></a>    Configuration:
<a name="rest_code_caa866a022614a8aa1b076c8422c52f1-9"></a>    Compiler: clang-3.5.0
<a name="rest_code_caa866a022614a8aa1b076c8422c52f1-10"></a>    Operating System: Linux x86_64 3.16.5-gentoo
<a name="rest_code_caa866a022614a8aa1b076c8422c52f1-11"></a>
<a name="rest_code_caa866a022614a8aa1b076c8422c52f1-12"></a>
<a name="rest_code_caa866a022614a8aa1b076c8422c52f1-13"></a> simple_a(10) : mean: 52.5us (52.3us,52.7us) stddev: 675ns min: 48.5us max: 53.3us througput: 190KEs
<a name="rest_code_caa866a022614a8aa1b076c8422c52f1-14"></a> simple_a(100) : mean: 50.1us (48us,52.2us) stddev: 7.53us min: 7.61us max: 52.3us througput: 2MEs
<a name="rest_code_caa866a022614a8aa1b076c8422c52f1-15"></a> simple_a(1000) : mean: 52.7us (52.7us,52.7us) stddev: 48.7ns min: 52.7us max: 53us througput: 19MEs
<a name="rest_code_caa866a022614a8aa1b076c8422c52f1-16"></a> simple_a(10000) : mean: 62.6us (62.6us,62.7us) stddev: 124ns min: 62.6us max: 63.5us througput: 160MEs
<a name="rest_code_caa866a022614a8aa1b076c8422c52f1-17"></a> simple_a(100000) : mean: 161us (159us,162us) stddev: 5.41us min: 132us max: 163us througput: 622MEs
<a name="rest_code_caa866a022614a8aa1b076c8422c52f1-18"></a> simple_a(1000000) : mean: 1.16ms (1.16ms,1.17ms) stddev: 7.66us min: 1.15ms max: 1.18ms througput: 859MEs
<a name="rest_code_caa866a022614a8aa1b076c8422c52f1-19"></a>
<a name="rest_code_caa866a022614a8aa1b076c8422c52f1-20"></a>-----------------------------------------
<a name="rest_code_caa866a022614a8aa1b076c8422c52f1-21"></a>|            gemm |       std |     mkl |
<a name="rest_code_caa866a022614a8aa1b076c8422c52f1-22"></a>-----------------------------------------
<a name="rest_code_caa866a022614a8aa1b076c8422c52f1-23"></a>|           10x10 | 51.7189us | 64.64ns |
<a name="rest_code_caa866a022614a8aa1b076c8422c52f1-24"></a>|         100x100 | 52.4336us | 63.42ns |
<a name="rest_code_caa866a022614a8aa1b076c8422c52f1-25"></a>|       1000x1000 | 56.0097us |  63.2ns |
<a name="rest_code_caa866a022614a8aa1b076c8422c52f1-26"></a>|     10000x10000 | 95.6123us | 63.52ns |
<a name="rest_code_caa866a022614a8aa1b076c8422c52f1-27"></a>|   100000x100000 | 493.795us | 63.48ns |
<a name="rest_code_caa866a022614a8aa1b076c8422c52f1-28"></a>| 1000000x1000000 | 4.46646ms |  63.8ns |
<a name="rest_code_caa866a022614a8aa1b076c8422c52f1-29"></a>-----------------------------------------
</pre>
<p>The program will give you for each benchmark, the mean duration (with confidence interval), the standard deviation of the samples, the min and max duration and an estimated throughput. The throughput is simply using the size and the mean duration. Each section is directly compared with an array-like output. Once the benchmark is run, a JSON report will be generated inside the output folder.</p>
</div>
</div>
<div class="section" id="continuous-monitoring">
<h2>Continuous Monitoring</h2>
<p>Once you have run the benchmark, you can use the CPM program to generate the web reports. It will generate:</p>
<ul class="simple">
<li>1 performance graph for each benchmark and section</li>
<li>1 graph comparing the performances over time of your benchmark sections if you have run the benchmark several time</li>
<li>1 graph comparing different compiler if you have compiled your program with different compiler</li>
<li>1 graph comparing different configuration if you have run the benchmark with different configuration</li>
<li>1 table summary for each benchmark / section</li>
</ul>
<p>First you have to build and install the CPM program (you can have a look at the <a class="reference external" href="https://github.com/wichtounet/cpm/blob/master/README.rst">Readme</a> for more informations.</p>
<p>Several options are available:</p>
<pre class="code text"><a name="rest_code_ddb87ff23cf345f380020810c82a1032-1"></a>Usage:
<a name="rest_code_ddb87ff23cf345f380020810c82a1032-2"></a>  cpm [OPTION...]  results_folder
<a name="rest_code_ddb87ff23cf345f380020810c82a1032-3"></a>
<a name="rest_code_ddb87ff23cf345f380020810c82a1032-4"></a>      --time-sizes             Display multiple sizes in the time graphs
<a name="rest_code_ddb87ff23cf345f380020810c82a1032-5"></a>  -t, --theme arg              Theme name [raw,bootstrap,boostrap-tabs] (default:bootstrap)
<a name="rest_code_ddb87ff23cf345f380020810c82a1032-6"></a>  -c, --hctheme theme_name     Highcharts Theme name [std,dark_unica] (default:dark_unica)
<a name="rest_code_ddb87ff23cf345f380020810c82a1032-7"></a>  -o, --output output_folder   Output folder (default:reports)
<a name="rest_code_ddb87ff23cf345f380020810c82a1032-8"></a>      --input arg              Input results
<a name="rest_code_ddb87ff23cf345f380020810c82a1032-9"></a>  -s, --sort-by-tag            Sort by tag instaed of time
<a name="rest_code_ddb87ff23cf345f380020810c82a1032-10"></a>  -p, --pages                  General several HTML pages (one per bench/section)
<a name="rest_code_ddb87ff23cf345f380020810c82a1032-11"></a>  -d, --disable-time           Disable time graphs
<a name="rest_code_ddb87ff23cf345f380020810c82a1032-12"></a>      --disable-compiler       Disable compiler graphs
<a name="rest_code_ddb87ff23cf345f380020810c82a1032-13"></a>      --disable-configuration  Disable configuration graphs
<a name="rest_code_ddb87ff23cf345f380020810c82a1032-14"></a>      --disable-summary        Disable summary table
<a name="rest_code_ddb87ff23cf345f380020810c82a1032-15"></a>  -h, --help                   Print help
</pre>
<p>There are 3 themes:</p>
<ul class="simple">
<li>
<em>bootstrap</em>: The default theme, using Bootstrap to make a responsive interface.</li>
<li>
<em>bootstrap-tabs</em>: Similar to the <em>bootstrap</em> theme except that only is displayed at the same time for each benchmark, with tabs.</li>
<li>
<em>raw</em> : A very basic theme, only using Highcharts library for graphs. It is very minimalistic</li>
</ul>
<p>For instance, here are how the reports are generated for the ETL benchmark:</p>
<pre class="code text"><a name="rest_code_5149680703de45abbe40af47eb851d7f-1"></a>cpm -p -s -t bootstrap -c dark_unica -o reports results
</pre>
<p>Here is the graph generated for the "R = A + B + C" benchmark and different compilers:</p>
<img alt="/images/cpm_etl_compiler.png" src="images/cpm_etl_compiler.png"><p>and its summary:</p>
<img alt="/images/cpm_etl_summary.png" src="images/cpm_etl_summary.png"><p>Here is the graph for a 2D convolution with ETL:</p>
<img alt="/images/cpm_etl_section.png" src="images/cpm_etl_section.png"><p>And the graph for different configurations of ETL and the dense matrix matrix multiplication:</p>
<img alt="/images/cpm_etl_configuration.png" src="images/cpm_etl_configuration.png">
</div>
<div class="section" id="conclusion-and-future-work">
<h2>Conclusion and Future Work</h2>
<p>Although CPM is already working, there are several things that could be done to improve it further:</p>
<ul class="simple">
<li>The generated web report could benefit from a global summary.</li>
<li>The throughput evaluation should be evaluated more carefully.</li>
<li>The tool should automatically evaluate the number of times that each tests should be run to have a good result instead of global warmup and repeat constants.</li>
<li>A better bootstrapping procedure should be used to determine the quality of the results and compute the confidence intervals.</li>
<li>The performances of the website with lots of graphs should be improved.</li>
<li>Make CPM more general-purpose to support larger needs.</li>
</ul>
<p>Here it is, I have summed most of the features of the CPM Continuous Performance Analysis tool. I hope that it will be helpful to some of you as well.</p>
<p>If you have other ideas or want to contribute something to the project, you can directly open an issue or a pull request on <a class="reference external" href="https://github.com/wichtounet/cpm">Github</a>. Or contact me via this site or Github.</p>
</div>
</div>
        </div>
            
        
    <a href="posts/2015/06/continuous-performance-management-with-cpm-for-cpp.html#disqus_thread" data-disqus-identifier="cache/posts/2015/06/continuous-performance-management-with-cpm-for-cpp.html">Comments</a>


        </article><article class="postbox h-entry post-text"><h1 class="p-name">
<a href="posts/2015/05/cpp17-fold-expressions.html" class="u-url">C++17 Fold Expressions</a>
        <br><small>  
             Posted: <time class="published dt-published" datetime="2015-05-23T19:08:20+02:00">2015-05-23 19:08</time></small>
</h1>
        <hr>
<div class="p-summary">
        <div>
<div class="section" id="variadic-templates">
<h2>Variadic Templates</h2>
<p>C++11 introduced variadic template to the languages. This new feature allows to write template functions and classes taking an arbitrary number of template parameters. This a feature I really like and I already used it quite a lot in my different libraries. Here is a very simple example computing the sum of the parameters:</p>
<pre class="code c++"><a name="rest_code_caf823d0e0de4ee786e4cc0307f837ec-1"></a><span class="k">auto</span> <span class="nf">old_sum</span><span class="p">(){</span>
<a name="rest_code_caf823d0e0de4ee786e4cc0307f837ec-2"></a>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="rest_code_caf823d0e0de4ee786e4cc0307f837ec-3"></a><span class="p">}</span>
<a name="rest_code_caf823d0e0de4ee786e4cc0307f837ec-4"></a>
<a name="rest_code_caf823d0e0de4ee786e4cc0307f837ec-5"></a><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T1</span><span class="p">,</span> <span class="k">typename</span><span class="p">...</span> <span class="n">T</span><span class="o">&gt;</span>
<a name="rest_code_caf823d0e0de4ee786e4cc0307f837ec-6"></a><span class="k">auto</span> <span class="n">old_sum</span><span class="p">(</span><span class="n">T1</span> <span class="n">s</span><span class="p">,</span> <span class="n">T</span><span class="p">...</span> <span class="n">ts</span><span class="p">){</span>
<a name="rest_code_caf823d0e0de4ee786e4cc0307f837ec-7"></a>    <span class="k">return</span> <span class="n">s</span> <span class="o">+</span> <span class="n">old_sum</span><span class="p">(</span><span class="n">ts</span><span class="p">...);;</span>
<a name="rest_code_caf823d0e0de4ee786e4cc0307f837ec-8"></a><span class="p">}</span>
</pre>
<p>What can be seen here is a typical use of variadic templates. Almost all the time, is is necessary to use recursion and several functions to unpack the parameters and process them. There is only one way to unpack the arguments, by using the ... operator that simply put comma between arguments. Even if it works well, it is a bit heavy on the code. This will likely be completely optimized to a series of addition by the compiler, but it may still happen in more complicated functions that this is not done. Moreover, the intent is not always clear with that.</p>
<p>That is why C++17 introduced an extension for the variadic template, fold expressions.</p>
</div>
<div class="section" id="fold-expressions">
<h2>Fold expressions</h2>
<p>Fold expressions are a new way to unpack variadic parameters with operators. For now, only Clang 3.6 supports C++17 fold expression, with the -std=c++1z flag. That is the compiler I used to validate the examples of this post.</p>
<p>The syntax is bit disturbing at first but quite logical:</p>
<pre class="code c++"><a name="rest_code_e2f81bea34e24bef8e8d650c6cf612b0-1"></a><span class="p">(</span> <span class="n">pack</span> <span class="n">op</span> <span class="p">...</span> <span class="p">)</span>             <span class="c1">//(1)</span>
<a name="rest_code_e2f81bea34e24bef8e8d650c6cf612b0-2"></a><span class="p">(</span> <span class="p">...</span> <span class="n">op</span> <span class="n">pack</span> <span class="p">)</span>             <span class="c1">//(2)</span>
<a name="rest_code_e2f81bea34e24bef8e8d650c6cf612b0-3"></a><span class="p">(</span> <span class="n">pack</span> <span class="n">op</span> <span class="p">...</span> <span class="n">op</span> <span class="n">init</span> <span class="p">)</span>     <span class="c1">//(3)</span>
<a name="rest_code_e2f81bea34e24bef8e8d650c6cf612b0-4"></a><span class="p">(</span> <span class="n">init</span> <span class="n">op</span> <span class="p">...</span> <span class="n">op</span> <span class="n">pack</span> <span class="p">)</span>     <span class="c1">//(4)</span>
</pre>
<p>Where <em>pack</em> is an unexpanded parameter pack, <em>op</em> an operator and <em>init</em> a value. The version (1) is a right fold that is expanded like (P1 op (P2 op (P3 ... (PN-1 op PN)))). The version (2) is a left fold where the expansion is taken from the left. The (3) and (4) versions are almost the value except for an init value. Only some operators (+,*,&amp;,|,&amp;&amp;,||, ,) have defined init values and can be used with the versions (1) and (2). The other operators can only be used with an init value.</p>
<p>For instance, here is how we could write the sum functions with fold expressions:</p>
<pre class="code c++"><a name="rest_code_d6910dbf3c4c40ff8da4e5d35611e042-1"></a><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="p">...</span> <span class="n">T</span><span class="o">&gt;</span>
<a name="rest_code_d6910dbf3c4c40ff8da4e5d35611e042-2"></a><span class="k">auto</span> <span class="n">fold_sum_1</span><span class="p">(</span><span class="n">T</span><span class="p">...</span> <span class="n">s</span><span class="p">){</span>
<a name="rest_code_d6910dbf3c4c40ff8da4e5d35611e042-3"></a>    <span class="k">return</span> <span class="p">(...</span> <span class="o">+</span> <span class="n">s</span><span class="p">);</span>
<a name="rest_code_d6910dbf3c4c40ff8da4e5d35611e042-4"></a><span class="p">}</span>
</pre>
<p>I personally think it is much better, it clearly states our intent and does not need recursion. By default, the init value used for addition is 0, but you can change it:</p>
<pre class="code c++"><a name="rest_code_6e194673413645709e9d1a861d3ec528-1"></a><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="p">...</span> <span class="n">T</span><span class="o">&gt;</span>
<a name="rest_code_6e194673413645709e9d1a861d3ec528-2"></a><span class="k">auto</span> <span class="n">fold_sum_2</span><span class="p">(</span><span class="n">T</span><span class="p">...</span> <span class="n">s</span><span class="p">){</span>
<a name="rest_code_6e194673413645709e9d1a861d3ec528-3"></a>    <span class="k">return</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="p">...</span> <span class="o">+</span> <span class="n">s</span><span class="p">);</span>
<a name="rest_code_6e194673413645709e9d1a861d3ec528-4"></a><span class="p">}</span>
</pre>
<p>This will yield the sum of the elements plus one.</p>
<p>This can be also very practical to print some elements for instance:</p>
<pre class="code c++"><a name="rest_code_098d1a6e2b244f058a389c1f3141fb55-1"></a><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="p">...</span><span class="n">Args</span><span class="o">&gt;</span>
<a name="rest_code_098d1a6e2b244f058a389c1f3141fb55-2"></a><span class="kt">void</span> <span class="n">print_1</span><span class="p">(</span><span class="n">Args</span><span class="o">&amp;&amp;</span><span class="p">...</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
<a name="rest_code_098d1a6e2b244f058a389c1f3141fb55-3"></a>    <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="p">...</span> <span class="o">&lt;&lt;</span> <span class="n">args</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="sc">'\n'</span><span class="p">;</span>
<a name="rest_code_098d1a6e2b244f058a389c1f3141fb55-4"></a><span class="p">}</span>
</pre>
<p>And this can even be used when doing Template Metaprogramming, for instance here is a TMP version of the and operator:</p>
<pre class="code c++"><a name="rest_code_3746faa725424a5384c45b1eb1199649-1"></a><span class="k">template</span><span class="o">&lt;</span><span class="kt">bool</span><span class="p">...</span> <span class="n">B</span><span class="o">&gt;</span>
<a name="rest_code_3746faa725424a5384c45b1eb1199649-2"></a><span class="k">struct</span> <span class="nl">fold_and</span> <span class="p">:</span> <span class="n">std</span><span class="o">::</span><span class="n">integral_constant</span><span class="o">&lt;</span><span class="kt">bool</span><span class="p">,</span> <span class="p">(</span><span class="n">B</span> <span class="o">&amp;&amp;</span> <span class="p">...)</span><span class="o">&gt;</span> <span class="p">{};</span>
</pre>
</div>
<div class="section" id="conclusion">
<h2>Conclusion</h2>
<p>C++17 fold expressions are a really nice additions to the language that makes working with variadic templates much easier. This already makes me wish for C++17 release :)</p>
<p>The source code for the examples are available on Github: <a class="reference external" href="https://github.com/wichtounet/articles/blob/master/src/fold_expressions.cpp">https://github.com/wichtounet/articles/blob/master/src/fold_expressions.cpp</a></p>
</div>
</div>
        </div>
            
        
    <a href="posts/2015/05/cpp17-fold-expressions.html#disqus_thread" data-disqus-identifier="cache/posts/2015/05/cpp17-fold-expressions.html">Comments</a>


        </article><article class="postbox h-entry post-text"><h1 class="p-name">
<a href="posts/2015/05/sonar-cpp-community-plugin-review.html" class="u-url">Sonar C++ Community Plugin Review</a>
        <br><small>  
             Posted: <time class="published dt-published" datetime="2015-05-14T17:09:59+02:00">2015-05-14 17:09</time></small>
</h1>
        <hr>
<div class="p-summary">
        <div>
<p>It's been a long time since I have written on this blog. I have had quite a lot of work between my Ph.D and my teaching. I have several projects going on, I'll try to write updates on them later on.</p>
<p>Some time ago, I wrote an article <cite>about the official C++ plugin for Sonar &lt;http://baptiste-wicht.com/posts/2014/10/sonarqube-inspections-for-cpp-projects.html&gt;</cite>. I was quite disappointed by the quality of a plugin. I was expecting more from an expensive official plugin.</p>
<p>There is an open-source alternative to the commercial plugin: <cite>sonar-cxx-plugin &lt;https://github.com/wenns/sonar-cxx&gt;</cite>. I already tested it quite some time ago (a development version of the 0.9.1 version) and the results were quite bad. I'm using C++11 and C++14 in almost all of my projects and the support was quite bad at that time. Happily, this support has now gotten much better :) In this article, I'll talk about the version 0.9.2.</p>
<div class="section" id="usage">
<h2>Usage</h2>
<p>The usage of this plugin is very easy, you don't need any complicated build wrapping techniques for it. You simply need to complete a <em>sonar-project.properties</em> file:</p>
<pre class="literal-block">
sonar.projectKey=etl
sonar.projectName=etl
sonar.projectVersion=1.0

sonar.sourceEncoding=UTF-8
sonar.sources=include,test,workbench
sonar.language=c++
</pre>
<p>After that, you simply have to use <em>sonar-runner</em> as for any other Sonar project:</p>
<blockquote>
sonar-runner</blockquote>
<p>And the analysis will be run.</p>
<p>I haven't had any issues with the analysis. However, the plugin is not yet completely C++11/C++14 compatible, therefore I'm encountering a lot of parser errors during the analysis. When an error is encountered by the parser, the line is skipped and the parser goes to the next line. This means that the analysis of the line is incomplete, which may lead to false positives or to missing issues. This comes from that sonar-cxx uses its own parser, which is to on par with clang-compatible parsers for instance.</p>
<p>Here is the Sonar summary of my ETL project:</p>
<img alt="/images/sonar_summary.png" src="images/sonar_summary.png">
</div>
<div class="section" id="inspections">
<h2>Inspections</h2>
<p>This plugin supports some inspections on itself. Nevertheless, you have to enable since it seems that most of them are disable by default. Code duplication is also automatically generated during the analysis:</p>
<img alt="/images/sonar_duplicated.png" src="images/sonar_duplicated.png"><p>The philosophy of this project is not to develop all inspections, but to integrate with other tools. For instance, cppcheck is already supported and the integration works perfectly. Here are the tools that sonar-cxx supports for quality analysis:</p>
<ul class="simple">
<li>cppcheck</li>
<li>valgrind</li>
<li>Vera++</li>
<li>RATS</li>
<li>PC-Lint</li>
</ul>
<p>I have only tested cppcheck for now. I plan to use valgrind running on my tests in the future. I don't plan to use the others.</p>
<p>It should also be noted that the plugin supports compiler warnings coming from G++ and Visual Studio. I don't use this since I compile all my projects with -Werror.</p>
<p>The biggest absent here is Clang, there is no support for its warnings, its static-analyzer or its advanced clang-tidy tool. If clang-tidy support does not come in the near future, I'm planning to try to add it myself, provided I find some time.</p>
<p>You can have to some inspections on one of my project:</p>
<img alt="/images/sonar_inspections.png" src="images/sonar_inspections.png"><p>As with any Sonar projects, you have access to the Hotsposts view:</p>
<img alt="/images/sonar_hotspots.png" src="images/sonar_hotspots.png">
</div>
<div class="section" id="unit-tests-integration">
<h2>Unit Tests Integration</h2>
<p>I have been able to integrate my unit tests results inside Sonar. The plugin expects JUnit compatible format. Several of C++ unit test libraries already generates compatible format. In my case, I used Catch and it worked very well.</p>
<p>What is even more interesting is the support for code coverage. You have to run your coverage-enabled executable and then use gcovr to generate an XML file that the plugin can read.</p>
<p>This support works quite well. The only thing I haven't been able to make work is the execution time computation of the unit tests, but that is not something I really care about.</p>
<p>Here are the coverage results for one of my files:</p>
<img alt="/images/sonar_coverage.png" src="images/sonar_coverage.png">
</div>
<div class="section" id="conclusion">
<h2>Conclusion</h2>
<p><strong>Pros</strong></p>
<ul class="simple">
<li>Support of a lot of external tools</li>
<li>Very easy to use</li>
<li>Duplicated code analysis</li>
<li>Very good code coverage analysis integration</li>
</ul>
<p><strong>Cons</strong></p>
<ul class="simple">
<li>Too few integrated inspections</li>
<li>Limited parsing of C++</li>
<li>Not fully compatible with C++11/C++14</li>
<li>False positives</li>
<li>Not enough love for clang (compiler warnings, clang-tidy, tooling, static-analyzer, ...)</li>
</ul>
<p>The provided metrics are really good, the usage is quite simple and this plugin supports some external tools adding interesting inspections. Even if this plugin is not perfect, it is a very good way to do Continuous Quality Analysis of your C++ projects. I personally find it superior to the official plugin. The usage is more simple (no build-wrapper that does not work), it supports more external tools and supports JUnit reports. On the other hand, it has much less integrated inspections and rely more on external tools. Both have problems with modern C++ features.</p>
<p>What I would really like in this plugin is the support of the clang-tidy analyzer (and other Clang analysis tools) and also complete C++11/C++14 support. I honestly think that the only way to fix the latter is to switch to Clang parsing with libtooling rather than developing an in-house parser, but that is not up to me.</p>
<p>I will definitely continue to use this plugin to generate metrics for my C++ projects. I use it with Jenkins which launch the analysis every time I push to one my git repositories. This plugin definitely shows promises.</p>
</div>
</div>
        </div>
            
        
    <a href="posts/2015/05/sonar-cpp-community-plugin-review.html#disqus_thread" data-disqus-identifier="cache/posts/2015/05/sonar-cpp-community-plugin-review.html">Comments</a>


        </article><article class="postbox h-entry post-text"><h1 class="p-name">
<a href="posts/2015/03/how-to-speed-up-raid-5-6-growing-with-mdadm.html" class="u-url">How to speed up RAID (5-6) growing with mdadm ?</a>
        <br><small>  
             Posted: <time class="published dt-published" datetime="2015-03-07T15:01:56+01:00">2015-03-07 15:01</time></small>
</h1>
        <hr>
<div class="p-summary">
        <div>
<p>Yesterday, I added my 11th disk to my RAID 6 array. As the last time it took my more than 20 hours, I spent some time investigating how to speed things up and this post contains some tips on how to achieve good grow performances. With these tips, I have been able to reach a speed of about 55K in average during reshape. It did finish in about 13 hours.</p>
<p>First, take into account that some of these tips may depend on your configuration. In my case, this server is only used for this RAID, so I don't care if the CPU is used a lot during rebuild or if other processes are suffering from the load. This may not be the case with your configuration. Moreover, I speak only of hard disks, if you use SSD RAID, there are probably better way of tuning the rebuild (or perhaps it is fast enough). Finally, you have know that a RAID reshape is going to be slow, there is no way you'll grow a 10+ RAID array in one hour. G</p>
<p>In the examples, I use /dev/md0 as the raid array, you'll have to change this to your array name.</p>
<p>The first 3 tips can be used even after the rebuild has started and you should the differences in real-time. But, these 3 tips will also be erased after each reboot.</p>
<div class="section" id="increase-speed-limits">
<h2>Increase speed limits</h2>
<p>The easiest thing to do is to increase the system speed limits on raid. You can see the current limits on your system by using these commands:</p>
<pre class="code bash"><a name="rest_code_5401e53a2ca84e8eb11ee086fdaf44c2-1"></a>sysctl dev.raid.speed_limit_min
<a name="rest_code_5401e53a2ca84e8eb11ee086fdaf44c2-2"></a>sysctl dev.raid.speed_limit_max
</pre>
<p>These values are set in Kibibytes per second (KiB/s).</p>
<p>You can put them to high values:</p>
<pre class="code bash"><a name="rest_code_a9afa1f000054b379c57e4e4812b778d-1"></a>sysctl -w dev.raid.speed_limit_min<span class="o">=</span>100000
<a name="rest_code_a9afa1f000054b379c57e4e4812b778d-2"></a>sysctl -w dev.raid.speed_limit_max<span class="o">=</span>500000
</pre>
<p>At least with these values, you won't be limited by the system.</p>
</div>
<div class="section" id="increase-stripe-cache-size">
<h2>Increase stripe cache size</h2>
<p>By allowing the array to use more memory for its stripe cache, you may improve the performances. In some cases, it can improve performances by up to 6 times. By default, the size of the stripe cache is 256, in pages. By default, Linux uses 4096B pages. If you use 256 pages for the stripe cache and you have 10 disks, the cache would use 10*256*4096=10MiB of RAM. In my case, I have increased it to 4096:</p>
<pre class="code bash"><a name="rest_code_95435be0a07d406f991d0047295fa162-1"></a><span class="nb">echo </span><span class="m">4096</span> &gt; /sys/block/md0/md/stripe_cache_size
</pre>
<p>The maximum value is 32768. If you have many disks, this may well take all your available memory. I don't think values higher than 4096 will improve performance, but feel free to try it ;)</p>
</div>
<div class="section" id="increase-read-ahead">
<h2>Increase read-ahead</h2>
<p>If configured too low, the read-ahead of your array may make things slower.</p>
<p>You can see get the current read-ahead value with this command:</p>
<pre class="code bash"><a name="rest_code_6a0fd73ed1304dbb822d4810331e63a2-1"></a>blockdev --getra /dev/md0
</pre>
<p>These values are in 512B sector. You can set it to 32MB to be sure:</p>
<pre class="code bash"><a name="rest_code_31c6928e5949436bac0cb0a32d34652e-1"></a>blockdev --setra <span class="m">65536</span> /dev/md0
</pre>
<p>This can improve the performances, but don't expect this to be a game-changer unless it was configured really low at the first place.</p>
</div>
<div class="section" id="bonus-speed-up-standard-resync-with-a-write-intent-bitmap">
<h2>Bonus: Speed up standard resync with a write-intent bitmap</h2>
<p>Although it won't speed up the growing of your array, this is something that you should do after the rebuild has finished. Write-intent bitmaps is a kind of map of what needs to be resynced. This is of great help in several cases:</p>
<ul class="simple">
<li>When the computer crash (power shutdown for instance)</li>
<li>If a disk is disconnected, then reconnected.</li>
</ul>
<p>In these case, it may totally avoid the need of a rebuild which is great in my opinion. Moreover, it does not take any space on the array since it uses space that is not usable by the array.</p>
<p>Here is how to enable it:</p>
<pre class="code bash"><a name="rest_code_c55edd6004d843e3b1d0365a905a50f8-1"></a>mdadm --grow --bitmap<span class="o">=</span>internal /dev/md0
</pre>
<p>However, it may cause some write performance degradation. In my case, I haven't seen any noticeable degradation, but if it is the case, you may want to disable it:</p>
<pre class="code bash"><a name="rest_code_910dc68303f74ee1a7bd8d9d5e18fe99-1"></a>mdadm --grow --bitmap<span class="o">=</span>none /dev/md0
</pre>
</div>
<div class="section" id="bonus-monitor-rebuild-process">
<h2>Bonus: Monitor rebuild process</h2>
<p>If you want to monitor the build process, you can use the watch command:</p>
<pre class="code bash"><a name="rest_code_56fae42822d04a3ab0058423bfbaebf9-1"></a>watch cat /proc/mdstat
</pre>
<p>With that you'll see the rebuild going in real-time.</p>
<p>You can also monitor the I/O statistics:</p>
<pre class="code bash"><a name="rest_code_a0684e3db05f4320a8af2761f90559a6-1"></a>watch iostat -k <span class="m">1</span> 2
</pre>
</div>
<div class="section" id="bonus-how-to-grow-a-raid-5-6-array">
<h2>Bonus: How to grow a RAID 5-6 array</h2>
<p>As a sidenote, this section indicates how to grow an array. If you  want to add the disk /dev/sdl to the array /dev/md0, you'll first have to add it:</p>
<pre class="code bash"><a name="rest_code_b7b2958297d248ba812925c3552a1b8d-1"></a>mdadm --add /dev/md0 /dev/sdl
</pre>
<p>This will add the disk as a spare disk. If you had 5 disks before, you'll want to grow it to 6:</p>
<pre class="code bash"><a name="rest_code_d74ba854aaf74b928ced705ba7be9b8e-1"></a>mdadm --grow --backup-file<span class="o">=</span>/root/grow_md0_backup_file --raid-devices<span class="o">=</span><span class="m">6</span> /dev/md0
</pre>
<p>The backup file must be on another disk of course. The backup file is optional but improves the chance of success if you have a power shutdown or another form of unexpected shutdown. If you know what you're doing, you can grow it without backup-file:</p>
<pre class="code bash"><a name="rest_code_11791c0a850e4f5093a4592bc1ba5d3f-1"></a>mdadm --grow --raid-devices<span class="o">=</span><span class="m">6</span> /dev/md0
</pre>
<p>This command will return almost instantly, but the actual reshape won't likely be finished for hours (maybe days). kkkkkkkkkkkkk</p>
<p>Once the rebuild is finished, you'll still have to extend the partitions with resize2fs. If you use LVM on top of the array, you'll have to resize the Physical Volume (PV) first:</p>
<pre class="code bash"><a name="rest_code_ff15d0d9e9d64fe0b7dd44b4c544dc84-1"></a>pvresize /dev/md0
</pre>
<p>and then extend the Logical Volume (s) (LV). For instance, if you want to add 1T to a LV named /dev/vgraid/work:</p>
<pre class="code bash"><a name="rest_code_6f31f62d21a143d98b7730836c7019d2-1"></a>vgextend -r -L+1T /dev/vgraid/work
</pre>
<p>The -r option will automatically resize the underlying filesystem. Otherwise, you'd still have to resize it with resize2fs.</p>
</div>
<div class="section" id="conclusion">
<h2>Conclusion</h2>
<p>These are the changes I have found that speed up the reshape process. There are others that you may test in your case. For instance, in some systems disabling NCQ on each disk may help.</p>
<p>I hope that these tips will help you doing fast rebuilds in your RAID array :)</p>
</div>
</div>
        </div>
            
        
    <a href="posts/2015/03/how-to-speed-up-raid-5-6-growing-with-mdadm.html#disqus_thread" data-disqus-identifier="cache/posts/2015/03/how-to-speed-up-raid-5-6-growing-with-mdadm.html">Comments</a>


        </article><nav class="postindexpager"><ul class="pager">
<li class="next">
                <a href="index-27.html" rel="next">Older posts</a>
            </li>
        </ul></nav><script>var disqus_shortname="blogwichtounet";(function(){var a=document.createElement("script");a.async=true;a.src="//"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script>
</div>
        </div>
    </div>
</div>

<!-- Footer -->

<footer>
    Contents © 2015         <a href="mailto:baptistewicht@gmail.com">Baptiste Wicht</a> - Powered by         <a href="http://getnikola.com" rel="nofollow">Nikola</a>         
<a rel="license" href="http://creativecommons.org/licenses/by/4.0/"><img alt="Creative Commons License" style="padding-left:5px;border-width:0" src="assets/img/cc.png"></a>
        <ul class="footer_inline_ul"></ul></footer><!-- Late loading stuff  --><script src="assets/js/all-nocdn.js"></script><script type="text/javascript">
      $(document).ready(function() {
        jQuery.getJSON('/assets/js/tag_cloud_data.json', function(data) {
            var items = [];

            $.each(data, function(key, val) {
                items.push('<li><a href="' + val[1] +'" '+'data-weight="'+val[0]+'"'+'>' + key + '</a></li>');
            });

            $('<div/>', {
                'id': 'tags',
                html: '<ul>' + items.join('') + '</ul>'
            }).appendTo('body');

            if(!$('#tags_canvas').tagcanvas({
                textColour: '#FFFFFF',
                outlineColour: '#ff00ff',
                reverse: true,
                depth: 0.8,
                maxSpeed: 0.05,
                weight: true,
                weightFrom: "data-weight",
                weightSizeMin: 8,
                weightSizeMax: 24
            },'tags')) {
                //something went wrong, hide the canvas container
                $('#tags_container').hide();
            }});
        });
    </script><!-- Google platform JS --><script type="text/javascript" src="https://apis.google.com/js/platform.js"></script>
</body>
</html>
