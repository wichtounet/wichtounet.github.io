<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " lang="en">
<head>
<meta charset="utf-8">
<base href="http://baptiste-wicht.com/index.html">
<meta name="description" content="Tutorials and short posts about programming, C++, Java, Assembly, Operating Systems Development, Compilers, ...">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Blog blog("Baptiste Wicht");</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta content="#5670d4" name="theme-color">
<link rel="alternate" type="application/rss+xml" title="RSS" href="rss.xml">
<link rel="canonical" href="http://baptiste-wicht.com/index.html">
<link rel="next" href="index-28.html" type="text/html">
<!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]--><script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-2175227-7']);
  _gaq.push(['_trackPageview']);
  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script><link href="favicon.ico" rel="icon" type="image/x-icon">
<link rel="publisher" href="https://plus.google.com/+BaptisteWicht">
</head>
<body>

<!-- Menubar -->

<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<div class="container-fluid">
<!-- This keeps the margins nice -->
    <div class="row">
        <div class="col-sm-3 col-lg-2">
            <nav class="navbar navbar-inverse navbar-fixed-side"><div class="navbar-header">
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="http://baptiste-wicht.com/">
                        <span id="blog-title">Blog blog("Baptiste Wicht");</span>
                    </a>
                </div>
<!-- /.navbar-header -->

                <div class="collapse navbar-collapse navbar-ex1-collapse">
                    <ul class="nav navbar-nav">
<li>
<a href="stories/about.html">About</a>
                </li>
<li>
<a href="stories/publications.html">Publications</a>
                </li>
<li>
<a href="categories/index.html">Tags</a>
                </li>
<li>
<a href="archive.html">Archives</a>
                </li>
<li>
<a href="http://feeds.feedburner.com/BaptisteWicht">RSS</a>


                            </li>
<li class="navbar-content">
                                <h3>Tags</h3>
                            </li>
                            <li class="navbar-empty">
                                <div id="tag_cloud_left_container" style="line-height: 18px !important;"></div>
                            </li>
                            <li class="navbar-block">


                        <li class="wicht-navbar-right">
                            <a target="_blank" title="Follow @wichtounet on Twitter" href="https://twitter.com/wichtounet">
                                <img src="assets/img/twitter.png" alt="Follow @wichtounet on Twitter"></a>
                        </li>

                        <li class="wicht-navbar-right">
                            <a target="_blank" title="Follow +BaptisteWicht on Google+" href="https://plus.google.com/+BaptisteWicht">
                                <img src="assets/img/google_plus.png" alt="Follow +BaptisteWicht on Google+"></a>
                        </li>


                    </ul>
</div>
<!-- /.navbar-collapse -->
            </nav>
</div> <!-- col -->
        <div class="col-sm-9 col-lg-10">
            <div id="content"></div>
            
        <article class="postbox h-entry post-text"><h1 class="p-name">
<a href="posts/2016/11/new-design-faster-and-mobile-compatible.html" class="u-url">New design: Faster and mobile compatible</a>
        <br><small>  
             Posted: <time class="published dt-published" datetime="2016-11-28T07:55:48+01:00">2016-11-28 07:55</time></small>
</h1>
        <hr>
<div class="p-summary">
        <div>
<p>I've finally taken the time to improve the design of the website!</p>
<p>The site was becoming slower and slower, the design was not responsive at all
and was an horror on mobile.</p>
<p>I've changed the design to focus more on content and removed superfluous things
such as the Google profile or slow things such as the 3D tag cloud. Moreover,
the design is now responsive again. It was a matter of removing a lot of bad
things I did in the CSS. Instead of having a vertical and an horizontal bars,
I now have only one vertical bar with both the navigation and a bit more
information. With these changes, the design is now also working on mobile phone!
It's about time.</p>
<p>Moreover, I've also spent quite some time working on the speed of the website.
For this, I've bundled most of the JS and CSS files together and reduced them.
Moreover, the static files are now hosted and cached by CloudFlare. I've also
removed the 3D tag cloud which was quite slow. The Google API usage for the
Google profile badge were also quite slow. Overall, the index page is now really
fast. The article pages are also much faster but it's not perfect, especially
because of Disqus that does tons of requests and redirects everywhere. I've also
got rid of the Disqus ads which were really insignificant in the end. It may
take a while for the ads to disappear according to Disqus.</p>
<p>I know that it's still not perfect, but I hope that user experience on the blog
is now improved for all readers and now article can be read on mobile normally.
I'll try to continue monitoring the speed and usability of the website to see if
I can improve it further in the coming days.</p>
<p>If you have any issue on the updated website, don't hesitate to let me know
either by commenting on this post or sending me an email (check the Contact
page).</p>
</div>
        </div>
            
        
    <a href="posts/2016/11/new-design-faster-and-mobile-compatible.html#disqus_thread" data-disqus-identifier="cache/posts/2016/11/new-design-faster-and-mobile-compatible.html">Comments</a>


        </article><article class="postbox h-entry post-text"><h1 class="p-name">
<a href="posts/2016/11/zapcc-a-faster-cpp-compiler.html" class="u-url">zapcc - a faster C++ compiler</a>
        <br><small>  
             Posted: <time class="published dt-published" datetime="2016-11-26T13:17:50+01:00">2016-11-26 13:17</time></small>
</h1>
        <hr>
<div class="p-summary">
        <div>
<p>I just joined the private beta program of zapcc. Zapcc is a c++ compiler, based
on Clang which aims at being much faster than other C++ compilers. How they are
doing this is using a caching server that saves some of the compiler structures,
which should speed up compilation a lot. The private beta is free, but once the
compiler is ready, it will be a commercial compiler.</p>
<p>Every C++ developer knows that compilation time can quickly be an issue when
programs are getting very big and especially when working with template-heavy
code.</p>
<p>To benchmark this new compiler, I use my Expression Template Library
(<a class="reference external" href="https://github.com/wichtounet/etl/">ETL</a>). This is a purely header-only
library with lots of templates. There are lots of test cases which is what I'm
going to compile. I'm going to compare against Clang-3.7 and gcc-4.9.3.</p>
<p>I have configured zapcc to let is use 2Go RAM per caching server, which is the
maximum allowed. Moreover, I killed the servers before each tests.</p>
<div class="section" id="debug-build">
<h2>Debug build</h2>
<p>Let's start with a debug build. In that configuration, there is no optimization
going on and several of the features of the library (GPU, BLAS, ...) are
disabled. This is the fastest way to compile ETL. I gathered this result on
a 4 core, 8 threads, Intel processor, with an SSD.</p>
<p>The following table presents the results with different number of threads and
the difference of zapcc compared to the other compilers:</p>
<table border="1" class="docutils">
<colgroup>
<col width="42%">
<col width="11%">
<col width="13%">
<col width="11%">
<col width="11%">
<col width="11%">
</colgroup>
<thead valign="bottom"><tr>
<th class="head">Compiler</th>
<th class="head">-j1</th>
<th class="head">-j2</th>
<th class="head">-j4</th>
<th class="head">-j6</th>
<th class="head">-j8</th>
</tr></thead>
<tbody valign="top">
<tr>
<td>g++-4.9.3</td>
<td>350s</td>
<td>185s</td>
<td>104s</td>
<td>94s</td>
<td>91s</td>
</tr>
<tr>
<td>clang++-3.7</td>
<td>513s</td>
<td>271s</td>
<td>153s</td>
<td>145s</td>
<td>138s</td>
</tr>
<tr>
<td>zapcc++</td>
<td>158s</td>
<td>87s</td>
<td>47s</td>
<td>44s</td>
<td>42s</td>
</tr>
<tr>
<td>Speedup VS Clang</td>
<td>3.24</td>
<td>3.103</td>
<td>3.25</td>
<td>3.29</td>
<td>3.28</td>
</tr>
<tr>
<td>Speedup VS GCC</td>
<td>2.21</td>
<td>2.12</td>
<td>2.21</td>
<td>2.13</td>
<td>2.16</td>
</tr>
</tbody>
</table>
<p>The result is pretty clear! zapcc is around <strong>three times faster than Clang</strong> and around
<strong>two times faster than GCC</strong>. This is pretty impressive!</p>
<p>For those that think than Clang is always faster than GCC, keep in mind that
this is not the case for template-heavy code such as this library. In all my
tests, Clang has always been slower and much memory hungrier than GCC on
template-heavy C++ code. And sometimes the difference is very significant.</p>
<p>Interestingly, we can also see that going past the physical cores is not really
interesting on this computer. On some computer, the speedups are interesting,
but not on this one. Always benchmark!</p>
</div>
<div class="section" id="release-build">
<h2>Release build</h2>
<p>We have seen the results on a debug build, let's now compare on something a bit
more timely, a release build with all options of ETL enabled (GPU, BLAS, ...),
which should make it significantly longer to compile.</p>
<p>Again, the table:</p>
<table border="1" class="docutils">
<colgroup>
<col width="40%">
<col width="12%">
<col width="12%">
<col width="12%">
<col width="12%">
<col width="12%">
</colgroup>
<thead valign="bottom"><tr>
<th class="head">Compiler</th>
<th class="head">-j1</th>
<th class="head">-j2</th>
<th class="head">-j4</th>
<th class="head">-j6</th>
<th class="head">-j8</th>
</tr></thead>
<tbody valign="top">
<tr>
<td>g++-4.9.3</td>
<td>628s</td>
<td>336s</td>
<td>197s</td>
<td>189s</td>
<td>184s</td>
</tr>
<tr>
<td>clang++-3.7</td>
<td>663s</td>
<td>388s</td>
<td>215s</td>
<td>212s</td>
<td>205s</td>
</tr>
<tr>
<td>zapcc++</td>
<td>515s</td>
<td>281s</td>
<td>173s</td>
<td>168s</td>
<td>158s</td>
</tr>
<tr>
<td>Speedup VS Clang</td>
<td>1.28</td>
<td>1.38</td>
<td>1.24</td>
<td>1.26</td>
<td>1.29</td>
</tr>
<tr>
<td>Speedup VS GCC</td>
<td>1.21</td>
<td>1.30</td>
<td>1.13</td>
<td>1.12</td>
<td>1.16</td>
</tr>
</tbody>
</table>
<p>This time, we can see that the difference is much lower. Zapcc is <strong>between 1.2
and 1.4 times faster than Clang</strong> and <strong>between 1.1 and 1.3 times faster than
GCC</strong>. This shows that most of the speedups from zapcc are in the front end of
the compiler. This is not a lot but still significant over long builds,
especially if you have few threads where the absolute difference would be
higher.</p>
<p>We can also observe that Clang is now almost on par with GCC which shows that
optimization is faster in Clang while front and backend is faster in gcc.</p>
<p>You also have to keep in mind that zapcc memory usage is higher than Clang
because of all the caching. Moreover, the server are still up in between
compilations, so this memory usage stays between builds, which may not be what
you want.</p>
<p>As for runtime, I have not seem any significant difference in performance
between the clang version and the zapcc. According to the official benchmarks
and documentation, there should not be any difference in that between zapcc and
the version of clang on which zapcc is based.</p>
</div>
<div class="section" id="incremental-build">
<h2>Incremental build</h2>
<p>Normally, zapcc should shine at incremental building, but I was unable to show
any speedup when changing a single without killing the zapcc servers. Maybe
I did something wrong in my usage of zapcc.</p>
</div>
<div class="section" id="conclusion">
<h2>Conclusion</h2>
<p>In conclusion, we can see that zapcc is always faster than both GCC and Clang,
on my template-heavy library. Moreover, on debug builds, it is much faster than
any of the two compilers, being more than 2 times faster than GCC and more than
3 times faster than clang. This is really great. Moreover, I have not see any
issue with the tool so far, it can seamlessly replace Clang without problem.</p>
<p>It's a bit weird that you cannot allocate more than 2Go to the zapcc servers.</p>
<p>For a program, that's really impressive. I hope that they are continuing the
good work and especially that this motivates other compilers to improve the
speed of compilation (especially of templates).</p>
<p>If you want more information, you can go to the
<a class="reference external" href="https://www.zapcc.com/">official website of zapcc</a></p>
</div>
</div>
        </div>
            
        
    <a href="posts/2016/11/zapcc-a-faster-cpp-compiler.html#disqus_thread" data-disqus-identifier="cache/posts/2016/11/zapcc-a-faster-c++-compiler.html">Comments</a>


        </article><article class="postbox h-entry post-text"><h1 class="p-name">
<a href="posts/2016/09/blazing-fast-unit-test-compilation-with-doctest-11.html" class="u-url">Blazing fast unit test compilation with doctest 1.1</a>
        <br><small>  
             Posted: <time class="published dt-published" datetime="2016-09-21T21:45:13+02:00">2016-09-21 21:45</time></small>
</h1>
        <hr>
<div class="p-summary">
        <div>
<p>You may remember <a class="reference external" href="http://baptiste-wicht.com/posts/2016/06/reduce-compilation-time-by-another-16-with-catch.html">my quest for faster compilation times</a>. I had made several changes to the Catch test framework macros in order to save some compilation at the expense of my test code looking a bit less nice:</p>
<pre class="code cpp"><a name="rest_code_88d6a1d526a140dab3432da9fb19998e-1"></a><span class="n">REQUIRE</span><span class="p">(</span><span class="n">a</span> <span class="o">==</span> <span class="mi">9</span><span class="p">);</span> <span class="c1">//Before</span>
<a name="rest_code_88d6a1d526a140dab3432da9fb19998e-2"></a><span class="n">REQUIRE_EQUALS</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="mi">9</span><span class="p">);</span> <span class="c1">//After</span>
</pre>
<p>The first line is a little bit better, but using several optimizations, I was
able to dramatically change the compilation time of the test cases of ETL. In
the end, I don't think that the difference between the two lines justifies the
high overhead in compilation times.</p>
<div class="section" id="doctest">
<h2>doctest</h2>
<p><a class="reference external" href="https://github.com/onqtam/doctest">doctest</a> is a framework quite similar to
Catch but that claims to be much lighter. I tested doctest 1.0 early on, but at
this point it was actually slower than Catch and especially slower than my
versions of the macro.</p>
<p>Today, doctest 1.1 was released with promises of being even lighter than before
and providing several new ways of speeding up compilation. If you want the
results directly, you can take a look at the next section.</p>
<p>First of all, this new version improved the basic macros to make expression
decomposition faster. When you use the standard REQUIRE macro, the expression is
composed by using several template techniques and operator overloading. This is
really slow to compile. By removing the need for this decomposition, the fast
Catch macros are much faster to compile.</p>
<p>Moreover, doctest 1.1 also introduces CHECK_EQ that does not any expression
decomposition. This is close to what I did in my macros expect that it is
directly integrated into the framework and preserves all its features. It is
also possible to bypass the expression checking code by using FAST_CHECK_EQ
macro. In that case, the exceptions are not captured. Finally, a new
configuration option is introduced (DOCTEST_CONFIG_SUPER_FAST_ASSERTS) that
removes some features related to automatic debugger breaks. Since I don't use
the debugger features and I don't need to capture exception everywhere (it's
sufficient for me that the test fails completely if an exception is thrown), I'm
more than eager to use these new features.</p>
</div>
<div class="section" id="results">
<h2>Results</h2>
<p>For evaluation, I have compiled the complete test suite of ETL, with 1 thread,
using gcc 4.9.3 with various different options, starting from Catch to doctest
1.1 with all compilation time features. Here are the results, in seconds:</p>
<table border="1" class="docutils">
<colgroup>
<col width="29%">
<col width="12%">
<col width="14%">
<col width="22%">
<col width="23%">
</colgroup>
<thead valign="bottom"><tr>
<th class="head">Version</th>
<th class="head">Time</th>
<th class="head">VS Catch</th>
<th class="head">VS Fast Catch</th>
<th class="head">VS doctest 1.0</th>
</tr></thead>
<tbody valign="top">
<tr>
<td>Catch</td>
<td>724.22</td>
<td> </td>
<td> </td>
<td> </td>
</tr>
<tr>
<td>Fast Catch</td>
<td>464.52</td>
<td>-36%</td>
<td> </td>
<td> </td>
</tr>
<tr>
<td>doctest 1.0</td>
<td>871.54</td>
<td>+20%</td>
<td>+87%</td>
<td> </td>
</tr>
<tr>
<td>doctest 1.1</td>
<td>614.67</td>
<td>-16%</td>
<td>+32%</td>
<td>-30%</td>
</tr>
<tr>
<td>REQUIRE_EQ</td>
<td>493.97</td>
<td>-32%</td>
<td>+6%</td>
<td>-43%</td>
</tr>
<tr>
<td>FAST_REQUIRE_EQ</td>
<td>439.09</td>
<td>-39%</td>
<td>-6%</td>
<td>-50%</td>
</tr>
<tr>
<td>SUPER_FAST_ASSERTS</td>
<td>411.11</td>
<td>-43%</td>
<td>-12%</td>
<td>-53%</td>
</tr>
</tbody>
</table>
<p>As you can see, doctest 1.1 is much faster to compile than doctest 1.0! This is
really great news. Moreover, it is already 16% faster than Catch. When all the
features are used, doctest is 12% faster than my stripped down versions of Catch
macros (and 43% faster than Catch standard macros). This is really cool! It
means that I don't have to do any change in the code (no need to strip macros
myself) and I can gain a lot of compilation time compared to the bare Catch
framework.</p>
<p>I really think the author of doctest did a great job with the new version.
Although this was not of as much interest for me, there are also a lot of
other changes in the new version. You can consult the
<a class="reference external" href="https://github.com/onqtam/doctest/blob/master/CHANGELOG.md">changelog</a> if you want more information.</p>
</div>
<div class="section" id="conclusion">
<h2>Conclusion</h2>
<p>Overall, doctest 1.1 is much faster to compile than doctest 1.0. Moreover, it
offers very fast macros for test assertions that are much faster to compile
than Catch versions and even faster than the versions I created myself to reduce
compilation time. I really thing this is a great advance for doctest. When
compiling with all the optimizations, doctest 1.1 saves me 50 seconds in
compilation time compared to the fast version of Catch macro and more than
5 minutes compared to the standard version of Catch macros.</p>
<p>I'll probably start using doctest on my development machine. For now, I'll keep
Catch as well since I need it to generate the unit test reports in XML format
for Sonarqube. Once this feature appears in doctest, I'll probably drop Catch
from ETL and DLL</p>
<p>If you need blazing fast compilation times for your unit tests, doctest 1.1 is
probably the way to go.</p>
</div>
</div>
        </div>
            
        
    <a href="posts/2016/09/blazing-fast-unit-test-compilation-with-doctest-11.html#disqus_thread" data-disqus-identifier="cache/posts/2016/09/blazing-fast-unit-test-compilation-with-doctest-11.html">Comments</a>


        </article><article class="postbox h-entry post-text"><h1 class="p-name">
<a href="posts/2016/09/short-review-of-bullseye-coverage.html" class="u-url">Short review of Bullseye Coverage</a>
        <br><small>  
             Posted: <time class="published dt-published" datetime="2016-09-16T13:25:44+02:00">2016-09-16 13:25</time></small>
</h1>
        <hr>
<div class="p-summary">
        <div>
<p><a class="reference external" href="http://www.bullseye.com/">Bullseye</a> is a commercial Code Coverage analyzer.
It is fully-featured with an export to HTML, to XML and even a specific GUI to
see the application.It costs about 800$, with a renewal fee of about 200$ per
year.</p>
<p>I'm currently using gcov and passing the results to Sonar. This works well, but
there are several problems. First, I need to use gcovr to generate the XML file,
that means two tools. Then, gcov has no way to merge coverage reports. In my
tests of ETL, I have seven different profiles being tested and I need the
overall coverage report. lcov has a merge feature but it is slow as hell (it
takes longer to merge the coverage files than to compile and run the complete
test suite seven times...). For now, I'm using a C++ program that I wrote to
combine the XML files or a Python script that does that, but neither are perfect
and it needs maintenance. Finally, it's impossible to exclude some code from the
coverage report (there is code that isn't meant to be executed (exceptional
code)). For now, I'm using yet another C++ program  that I wrote to do this from
comments in code.</p>
<p>Bullseye does have all these feature, so I got an evaluation license online and
tried this tool and wrote a short review of it.</p>
<div class="section" id="usage">
<h2>Usage</h2>
<p>The usage is pretty simple. You put the coverage executables in your PATH
variable and activate coverage globally. Then, we you compile, the compiler
calls will be intercepted and a coverage file will be generated. When the
compilation is done, run the program and the coverage measurements will be
filled.</p>
<p>The coverage results can then be exported to HTML (or XML) or visualized using
the CoverageBrowser tool:</p>
<div class="figure align-center">
<img alt="Screenshot of Bullseye main coverage view" src="images/bullseye_view.png"><p class="caption">The main view of the Bullseye tool code coverage results</p>
</div>
<p>It's a pretty good view of the coverage result. You have a breakdown by folders,
by file, by function and finally by condition. You can view directly the source
code:</p>
<div class="figure align-center">
<img alt="Screenshot of Bullseye source code coverage view" src="images/bullseye_source_view.png"><p class="caption">The source view of the Bullseye tool code coverage results</p>
</div>
<p>If you want to exclude some code from your coverage reports, you can use
a pragma:</p>
<pre class="code cpp"><a name="rest_code_ac8d2ef4054d40e2ab031ee4286bbb4b-1"></a><span class="k">switch</span> <span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="p">{</span>
<a name="rest_code_ac8d2ef4054d40e2ab031ee4286bbb4b-2"></a>    <span class="k">case</span> <span class="mi">1</span><span class="o">:</span> <span class="n">one</span><span class="o">++</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
<a name="rest_code_ac8d2ef4054d40e2ab031ee4286bbb4b-3"></a>    <span class="k">case</span> <span class="mi">2</span><span class="o">:</span> <span class="n">two</span><span class="o">++</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
<a name="rest_code_ac8d2ef4054d40e2ab031ee4286bbb4b-4"></a>    <span class="k">case</span> <span class="mi">3</span><span class="o">:</span> <span class="n">three</span><span class="o">++</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
<a name="rest_code_ac8d2ef4054d40e2ab031ee4286bbb4b-5"></a>    <span class="cp">#pragma BullseyeCoverage off</span>
<a name="rest_code_ac8d2ef4054d40e2ab031ee4286bbb4b-6"></a>    <span class="k">default</span><span class="o">:</span> <span class="n">abort</span><span class="p">();</span>
<a name="rest_code_ac8d2ef4054d40e2ab031ee4286bbb4b-7"></a>    <span class="cp">#pragma BullseyeCoverage on</span>
<a name="rest_code_ac8d2ef4054d40e2ab031ee4286bbb4b-8"></a><span class="p">}</span>
</pre>
<p>So that the condition won't be set as uncovered.</p>
<p>As for the coverage, it's pretty straightforward. For example:</p>
<pre class="code bash"><a name="rest_code_28d663bc255544fba718ed6d80595b40-1"></a>covmerge -c -ffinal.cov sse.cov avx.cov
</pre>
<p>and it's really fast. Unfortunately, the merging is only done at the function
level, not at the statement or at the condition level. This is a bit
disappointing, especially from a commercial tool. Nevertheless, it works well.</p>
</div>
<div class="section" id="conclusion">
<h2>Conclusion</h2>
<p>To conclude, Bullseye seems to be a pretty good tool. It has more features than
standard gcov coverage and all features are well integrated together. I have
only covered the features I was interested in, there are plenty of other things
you can look at on the <a class="reference external" href="http://www.bullseye.com/">official website</a>.</p>
<p>However, if you don't need the extra features such as the visualizer (or use
something like Sonar for this), or the merge or code excluding, it's probably
not worth paying the price for it. In my case, since the merge is not better
than my C++ tool (both do almost the same and my tool does some basic line
coverage merging as well) and I don't need the visualizer, I won't pay the price
for it. Moreover, they don't have student or open source licensing, therefore,
I'll continue with my complicated toolchain :)</p>
</div>
</div>
        </div>
            
        
    <a href="posts/2016/09/short-review-of-bullseye-coverage.html#disqus_thread" data-disqus-identifier="cache/posts/2016/09/short-review-of-bullseye-coverage.html">Comments</a>


        </article><article class="postbox h-entry post-text"><h1 class="p-name">
<a href="posts/2016/09/expression-templates-library-etl-10.html" class="u-url">Expression Templates Library (ETL) 1.0</a>
        <br><small>  
             Posted: <time class="published dt-published" datetime="2016-09-02T16:12:38+02:00">2016-09-02 16:12</time></small>
</h1>
        <hr>
<div class="p-summary">
        <div>
<p>I've just released the first official version of my Expression Templates Library
(ETL for short): The version 1.0.</p>
<p>Until now, I was using a simple rolling release model, but I think it's now time
to switch to some basic versioning. The project is now at a stable state.</p>
<p>ETL 1.0 has the following main features:</p>
<ul class="simple">
<li>Smart Expression Templates</li>
<li>Matrix and vector (runtime-sized and compile-time-sized)</li>
<li>Simple element-wise operations</li>
<li>Reductions (sum, mean, max, ...)</li>
<li>Unary operations (sigmoid, log, exp, abs, ...)</li>
<li>Matrix multiplication</li>
<li>Convolution (1D and 2D and higher variations)</li>
<li>Max Pooling</li>
<li>Fast Fourrier Transform</li>
<li>Use of SSE/AVX to speed up operations</li>
<li>Use of BLAS/MKL/CUBLAS/CUFFT/CUDNN libraries to speed up operations</li>
<li>Symmetric matrix adapter (experimental)</li>
<li>Sparse matrix (experimental)</li>
</ul>
<div class="section" id="examples">
<h2>Examples</h2>
<p>Here is an example of expressions in ETL:</p>
<pre class="code cpp"><a name="rest_code_1b5c8d7bd3ec4225a495511a55367aa2-1"></a><span class="n">etl</span><span class="o">::</span><span class="n">fast_matrix</span><span class="o">&lt;</span><span class="kt">float</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="o">&gt;</span> <span class="n">a</span> <span class="o">=</span> <span class="p">{</span><span class="mf">1.1</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">};</span>
<a name="rest_code_1b5c8d7bd3ec4225a495511a55367aa2-2"></a><span class="n">etl</span><span class="o">::</span><span class="n">fast_matrix</span><span class="o">&lt;</span><span class="kt">float</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="o">&gt;</span> <span class="n">b</span> <span class="o">=</span> <span class="p">{</span><span class="mf">2.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.0</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.0</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">};</span>
<a name="rest_code_1b5c8d7bd3ec4225a495511a55367aa2-3"></a><span class="n">etl</span><span class="o">::</span><span class="n">fast_matrix</span><span class="o">&lt;</span><span class="kt">float</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="o">&gt;</span> <span class="n">c</span> <span class="o">=</span> <span class="p">{</span><span class="mf">2.2</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">2.2</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">};</span>
<a name="rest_code_1b5c8d7bd3ec4225a495511a55367aa2-4"></a>
<a name="rest_code_1b5c8d7bd3ec4225a495511a55367aa2-5"></a><span class="n">etl</span><span class="o">::</span><span class="n">fast_matrix</span><span class="o">&lt;</span><span class="kt">float</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="o">&gt;</span> <span class="n">d</span><span class="p">(</span><span class="mf">2.5</span> <span class="o">*</span> <span class="p">((</span><span class="n">a</span> <span class="o">&gt;&gt;</span> <span class="n">b</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">log</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">abs</span><span class="p">(</span><span class="n">c</span><span class="p">)))</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.5</span> <span class="o">*</span> <span class="n">scale</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">sign</span><span class="p">(</span><span class="n">b</span><span class="p">))</span> <span class="o">/</span> <span class="n">c</span><span class="p">)</span> <span class="o">+</span> <span class="mf">2.111</span> <span class="o">/</span> <span class="n">log</span><span class="p">(</span><span class="n">c</span><span class="p">));</span>
</pre>
<p>Or another I'm using in my neural networks library:</p>
<pre class="code cpp"><a name="rest_code_dd3493e23c174f3abbb58472e547e3ba-1"></a><span class="n">h</span> <span class="o">=</span> <span class="n">etl</span><span class="o">::</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">b</span> <span class="o">+</span> <span class="n">v</span> <span class="o">*</span> <span class="n">w</span><span class="p">)</span>
</pre>
<p>In that case, the vector-matrix multiplication will be executed using a BLAS
kernel (if ETL is configured correclty) and the assignment, the sigmoid and the
addition will be automatically vectorized to use either AVX or SSE depending
on the machine.</p>
<p>Or with a convolutional layer and a ReLU activation function:</p>
<pre class="code cpp"><a name="rest_code_151c43a9a7344f388d129467612a0fc0-1"></a><span class="n">etl</span><span class="o">::</span><span class="n">reshape</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">NH1</span><span class="p">,</span> <span class="n">NH2</span><span class="o">&gt;</span><span class="p">(</span><span class="n">h_a</span><span class="p">)</span> <span class="o">=</span> <span class="n">etl</span><span class="o">::</span><span class="n">conv_4d_valid_flipped</span><span class="p">(</span><span class="n">etl</span><span class="o">::</span><span class="n">reshape</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">,</span> <span class="n">NC</span><span class="p">,</span> <span class="n">NV1</span><span class="p">,</span> <span class="n">NV2</span><span class="o">&gt;</span><span class="p">(</span><span class="n">v_a</span><span class="p">),</span> <span class="n">w</span><span class="p">);</span>
<a name="rest_code_151c43a9a7344f388d129467612a0fc0-2"></a><span class="n">h</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">b_rep</span> <span class="o">+</span> <span class="n">h_a</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">);</span>
</pre>
<p>This will automatically be computed either with NVIDIA CUDNN (if available) or
with optimized SSE/AVX kernels.</p>
<p>For more information, you can take a look at the <a class="reference external" href="https://github.com/wichtounet/etl/wiki">Reference</a> on the wiki.</p>
</div>
<div class="section" id="next-version">
<h2>Next version</h2>
<p>For the next version, I'll focus on several things:</p>
<ul class="simple">
<li>Improve matrix-matrix multiplication kernels when BLAS is not available. There
is a lot of room for improvement here</li>
<li>Complete support for symmetric matrices (currently experimental)</li>
<li>Maybe some new adapters such as Hermitian matrices</li>
<li>GPU improvements for some operations that can be done entirely on GPU</li>
<li>New convolution performanceimprovements</li>
<li>Perhaps more complete parallel support for some implementations</li>
<li>Drop some compiler support to use full C++14 support</li>
</ul>
</div>
<div class="section" id="download-etl">
<h2>Download ETL</h2>
<p>You can download ETL <a class="reference external" href="https://github.com/wichtounet/etl">on Github</a>. If you
only interested in the 1.0 version, you can look at the
<a class="reference external" href="https://github.com/wichtounet/etl/releases">Releases pages</a> or clone the tag
1.0. There are several branches:</p>
<ul class="simple">
<li>
<em>master</em> Is the eternal development branch, may not always be stable</li>
<li>
<em>stable</em> Is a branch always pointing to the last tag, no development here</li>
</ul>
<p>For the future release, there always will tags pointing to the corresponding
commits. I'm not following the git flow way, I'd rather try to have a more
linear history with one eternal development branch, rather than an useless
develop branch or a load of other branches for releases.</p>
<p>Don't hesitate to comment this post if you have any comment on this library or
any question. You can also open an Issue on Github if you have a problem using
this library or propose a Pull Request if you have any contribution you'd like
to make to the library.</p>
<p>Hope this may be useful to some of you :)</p>
</div>
</div>
        </div>
            
        
    <a href="posts/2016/09/expression-templates-library-etl-10.html#disqus_thread" data-disqus-identifier="cache/posts/2016/09/expression-templates-library-etl-10.html">Comments</a>


        </article><article class="postbox h-entry post-text"><h1 class="p-name">
<a href="posts/2016/08/asgard-home-automation-project.html" class="u-url">Asgard: Home Automation project</a>
        <br><small>  
             Posted: <time class="published dt-published" datetime="2016-08-27T22:28:16+02:00">2016-08-27 22:28</time></small>
</h1>
        <hr>
<div class="p-summary">
        <div>
<p>I have updated my asgard project to make it finally useful for me, so I figured
I'd present the project now.</p>
<p>Asgard is my project of home automation based on a Raspberry Pi. I started this
project after Ninja Blocks kickstarter company went down and I was left with
useless sensors. So I figured why not have fun creating my own :P I know there
are some other projects out there that are pretty good, but I wanted to do some
more low level stuff for once, so what the hell.</p>
<p>Of course, everything is written in C++, no surprise here. The project is built
upon a server / drivers architecture. The drivers and the server are talking via
network sockets, so they can be on different machines.  The server is displaying
the data it got on a web interface and also provide a way to trigger actions of
drivers either from the web interface or through the integrated rules engine.
The data are stored in a database, accessed with CPPSqlite3 (probably going to
be replaced by sqlcpp11) and the web server is handled with mongoose (with a c++
interface).</p>
<p>I must mention that most of the web part of the project was made by a student of
mine, Stéphane Ly, who work on it as part of his study.</p>
<p>Here is a picture of the Raspberry Pi system (not very pretty ;) ):</p>
<img alt="Asgard automation system hardware" class="align-center" src="images/asgard_hardware.jpg"><p>I plan to try to fit at least some of it on a nicer box with nicer cables and
such. Moreover, I also plan to add real antennas to the RF transmitter and
receiver, but I haven't received them so far.</p>
<div class="section" id="sensors">
<h2>Sensors</h2>
<p>asgard support several sensors:</p>
<ul class="simple">
<li>DHT11 Temperature/Humdity Sensor</li>
<li>WT450 Temperature/Humdity Sensor</li>
<li>RF Button</li>
<li>IR Remote</li>
<li>CPU Temperature Sensor</li>
</ul>
<p>You can see the sensors data displayed on the web interface:</p>
<img alt="Asgard automation system home page" class="align-center" src="images/asgard_home.png">
</div>
<div class="section" id="actions">
<h2>Actions</h2>
<p>There are currently a few actions provided by the drivers:</p>
<ul class="simple">
<li>Wake-On-Lan a computer by its MAC Address</li>
<li>ITT-1500 smart plugs ON and OFF</li>
<li>Kodi actions: Pause / Play / Next / Previous on Kodi</li>
</ul>
<p>Here are the rules engine:</p>
<img alt="Asgard automation system rules page" class="align-center" src="images/asgard_rules.png">
</div>
<div class="section" id="my-home-automation">
<h2>My home automation</h2>
<p>I'm currently using this system to monitor the temperature in my appartment.
Nothing great so far because I don't have enough sensors yet. And now, I'm also
using a wireless button to turn on my power socket, wait 2 seconds and then
power on my Kodi Home Theater with wake on lan.</p>
<p>It's nothing fancy so far, but it's already better than what I had with Ninja
Blocks, except for the ugly hardware ;).</p>
</div>
<div class="section" id="future">
<h2>Future</h2>
<p>There are still tons of work on the project and on integration in my home.</p>
<ul class="simple">
<li>I'm really dissatisfied with the WT450 sensor, I've ordered new Oregon sensors to try to do better.</li>
<li>I've ordered a few new sensors: Door intrusion detector and motion detector</li>
<li>The rules system needs to be improve to support multiple conditions</li>
<li>I plan to add a simple state system to the asgard server</li>
<li>There are a lot of refactorings necessary in the code and</li>
</ul>
<p>However, I don't know when I'll work on this again, my work on this project is
pretty episodic to say the least.</p>
</div>
<div class="section" id="code">
<h2>Code</h2>
<p>The code is, as always, available on Github. There are multiple repositories:
<a class="reference external" href="https://github.com/search?q=user%3Awichtounet+asgard">all asgard repositories</a>.
It's not that much code for now, about 2000 lines of code, but some of it may be
useful. If you plan to use the system, keep in mind that it was never tested out
of my environment and that there is no documentation so far, but don't hesitate
to open Issues on Github if you have questions or post a comment here.</p>
</div>
</div>
        </div>
            
        
    <a href="posts/2016/08/asgard-home-automation-project.html#disqus_thread" data-disqus-identifier="cache/posts/2016/08/asgard-home-automation-project.html">Comments</a>


        </article><article class="postbox h-entry post-text"><h1 class="p-name">
<a href="posts/2016/08/update-thor-thesis-and-publications.html" class="u-url">Update: Thor, Thesis and Publications</a>
        <br><small>  
             Posted: <time class="published dt-published" datetime="2016-08-23T07:40:13+02:00">2016-08-23 07:40</time></small>
</h1>
        <hr>
<div class="p-summary">
        <div>
<p>Since it's been a real while since the last post I've written here, I wanted to
write a short status update.</p>
<p>I had to serve one month in the army, which does not help at all for
productivity :P Since the update to Boost Spirit X3, I haven't worked on my
eddic compiler again, but I've switched back to my operating system project:
thor. I'm having a lot of fun with it again and it's in much better state than
before.</p>
<p>We also have been very productive on the publication side, with four new
publications this year in various conferences. I'll update the blog when the
proceedings are published. I'll be going to ICANN 2016 and ANNPR 2016 next week
and probably to ICFHR in October. And of course, I'll go back to Meeting C++ in
November :) As for my thesis, it's finally going great, I've started writing
regularly and it's taking form!</p>
<div class="section" id="thor">
<h2>Thor</h2>
<p>My project Thor Operating System now has much more features than before:</p>
<ul class="simple">
<li>64bit operating system</li>
<li>Preemptive Multiprocessing</li>
<li>Keyboard / Mouse driver</li>
<li>Full ACPI support with ACPICA</li>
<li>Read/Write ATA driver</li>
<li>FAT32 file system support</li>
<li>HPET/RTC/PIT drivers</li>
<li>Basic PCI support</li>
<li>Multi stage booting with FAT32</li>
</ul>
<p>Since last time, I've fixed tons of bug in the system. Although there are still
some culprit, it's much more stable than before. They were a lot of bugs in the
scheduler with loads of race conditions. I hope I've working through most of
them now.</p>
<p>I'm currently working on the network stack. I'm able to receive and send packets
using the Realtek 8139 card. I have working support for Ethernet, IP and ARP.
I'm currently working on adding ICMP support. I've come to realize that the
hardest part is not to develop the code here but to find a way to test it.
Network in Qemu is a huge pain in the ass to configure. And then, you need tools
to generate some packets or at least answer to packets send by the virtual
machine, and it's really bad... Nevertheless, it's pretty fun overall :)</p>
<p>Aside from this, I'm also working on a window manager. I'll try to post an
update on this.</p>
<p>You can take a look at the <a class="reference external" href="https://github.com/wichtounet/thor-os">thor sources</a> if you're interested.</p>
</div>
<div class="section" id="future">
<h2>Future</h2>
<p>For the time being, I'll focus my effort on the thor project. I also have some
development to do on my home automation system: <a class="reference external" href="https://github.com/wichtounet/asgard-server">asgard-server</a> that I plan to finalize and deploy in a useful way this weekend in my apartment. You can also expect some updates on my deep learning library where I've started work to make it more user-friendly (kind of). I'm also still waiting on the first stable version of doctest for a new comparison with Catch.</p>
<p>I really want to try to publish again some more posts on the blog. I'll
especially try to publish some more updates about Thor.</p>
</div>
</div>
        </div>
            
        
    <a href="posts/2016/08/update-thor-thesis-and-publications.html#disqus_thread" data-disqus-identifier="cache/posts/2016/08/update-thor-thesis-and-publications.html">Comments</a>


        </article><article class="postbox h-entry post-text"><h1 class="p-name">
<a href="posts/2016/06/eddic-124-new-boost-spirit-x3-parser-and-minor-cleanups.html" class="u-url">eddic 1.2.4: New Boost Spirit X3 parser and minor cleanups</a>
        <br><small>  
             Posted: <time class="published dt-published" datetime="2016-06-26T22:35:04+02:00">2016-06-26 22:35</time></small>
</h1>
        <hr>
<div class="p-summary">
        <div>
<p>After almost 2 years, the new version of eddic (the compiler of the EDDI
programming language) is out! eddic 1.2.4</p>
<p>I haven't worked a lot on this project in the last years, I have been busy with
my Ph.D. related projects (ETL and DLL), my operating systems, cpm, ... I've
mostly worked on the parser to test the new version of Boost Spirit: X3. This
will be described on the next section, with the other changes in the later
section.</p>
<div class="section" id="new-boost-spirit-x3">
<h2>New Boost Spirit X3</h2>
<p>Boost Spirit X3 is a completely revamped version of Boost Spirit X3. It's aimed
at performance, both at compile-time and at runtime and uses recent features of
modern C++. It's not compatible with Boost Spirit Qi, so you'll most likely
have to rewrite a lot of stuff, in the parser, in the Abstract Syntax Tree
(AST) and in the AST passes as well.</p>
<p>For reference, I'm using the Boost 1.59 version.</p>
<div class="section" id="pros">
<h3>Pros</h3>
<p>Let's start with the pros.</p>
<p>First, the runtime performance is definitely better. Parsing all my eddi test
cases and samples, <em>takes 42% less time than with the previous parser</em>. It is
important to know that the old parser was very optimized, with moves instead of
copies and with a static lexer. You can take a look at <a class="reference external" href="http://baptiste-wicht.com/posts/2013/06/improving-eddic-boost-spirit-parser-performances.html">this post</a>
to see what was necessary to optimize the old Qi. I think it's a good result
since the new grammar does not use a lexer (x3 does not support it) and does
not need these optimizations. This improvement really was my objective. I'll
try to push it farther in the future.</p>
<p>Compile-time performance is also much better. It takes 3 times less time to
compile the new parser (1 minute to around 20 seconds). Moreover, the new
parser is now in only one file, rather than being it necessary to split it all
over the place for compile-time performance. Even though it's not really
important for me, it's still good to have :)</p>
<p>Especially due to the performance point, I've been able to remove some code,
the lexer, the generated static lexer and the special pointers optimizations of
the AST.</p>
</div>
<div class="section" id="cons">
<h3>Cons</h3>
<p>Unfortunately, there are some disadvantages of using the new Spirit X3.</p>
<p>First, the AST needs to be changed. For good parsing performance, you need to
use x3::variant and x3::forward_ast. This is a major pain in the ass since
x3::variant is much less practical to use than boost::variant. Almost
everything is explicit, meaning uglier code than before, in my opinion.
Moreover, you need to work around x3::forward_ast for boost::get, whereas
boost::recursive_wrapper was working better in that matter. I've had to create
my own wrapper around boost::get in order to be able to use the new tree. In my
opinion, this is clearly a regression.</p>
<p>Secondly, although X3 was also meant to remove the need to use some hacks in
the grammar, I ended up having more hacks than before. For instance, many AST
node have a fake field in order to make X3 happy. I've still had to use the
horrible eps hack at one place. I've had to create a few more rules in order to
fix type deduction that is working differently than before (worse for me). And
for some reasons, I had to replace some expectations from the grammar to make it
parse correctly. This is a really important regression in my opinion, since it
may make the parsing slower and will make the error message less nice.</p>
<p>The previous error handling system allowed me to track the file from which an
AST node was parsed from. Although the new error handler is a lot nicer than
the old system, it does not have this feature, so I had to work around this by
using new annotation nodes and a new global handler. Overall, it's probably a
bit worse than before, but makes for lighter AST nodes.</p>
<p>Finally, for some reason, I haven't been able to use the debug option of the
library (lots of compile time errors). That complicated a bit the debugging of
the parser.</p>
</div>
<div class="section" id="spirit-x3-or-spirit-qi">
<h3>Spirit X3 or Spirit Qi ?</h3>
<p>Overall, I have to say I'm a bit disappointed by Spirit X3. Even though it's
faster at runtime and faster to compile, I was really expecting less issues
with it. What I really did not like was all the changes I had to make because
of x3::variant and x3::forward_ast. Overall, I really don't think it was worth
the trouble porting my parser to Spirit X3.</p>
<p>If you have a new project, I would still consider using Boost Spirit X3.</p>
<p>If you have an existing parser, I would probably not advice porting it to X3.
Unless you really have issues with parsing performances (and especially if you
have not already optimized QI parser), it's probably not worth the trouble and
all the time necessary for all the changes.</p>
</div>
</div>
<div class="section" id="other-changes">
<h2>Other changes</h2>
<p>The other changes are much more minor. First of all, I've gotten rid of CMake.
This project has really made me hate CMake. I have actually gotten rid of it on
all my projects. I'm now using plain Makefiles and having a much better time
with them. I've also replaced boost Program Options with cxxopts. It's a much
more modern approach for program options parsing. Moreover, it's much more
lightweight and it's header only. Only advantages. There also have been lots of
changes to code (still not very good quality though).</p>
</div>
<div class="section" id="future">
<h2>Future</h2>
<p>eddic was my first real project in C++ and this can be seen in the code and the
organization. The quality of the code is really bad now that I read it again.
Some things are actually terrible :P It's probably normal since I was a
beginner in C++ at the time.</p>
<p>For the future version of the compiler, I want to clean the code a lot more and
focus on the EDDI language adding new features. Moreover, I'll also get rid of
Boost Test Framework by using Catch (or doctest if it is ready).</p>
<p>As for now, I'm not sure on which project I'm going to focus. Either I'll
continue working on the compiler or I'll start working again on my operating
system (thor-os) in which I was working on process concurrency (without too
much success :P). I'll probably post next updates on this post in the coming
months.</p>
</div>
<div class="section" id="download">
<h2>Download</h2>
<p>You can find the EDDI Compiler sources on the <a class="reference external" href="https://github.com/wichtounet/eddic">Github repository</a></p>
<p>The version is available in the <em>v1.2.4</em> tag available in the GitHub
repository, in the releases pages or directly in the &lt;em&gt;master&lt;/em&gt; branch.</p>
</div>
</div>
        </div>
            
        
    <a href="posts/2016/06/eddic-124-new-boost-spirit-x3-parser-and-minor-cleanups.html#disqus_thread" data-disqus-identifier="cache/posts/2016/06/eddic-124-new-boost-spirit-x3-parser-and-minor-cleanups.html">Comments</a>


        </article><article class="postbox h-entry post-text"><h1 class="p-name">
<a href="posts/2016/06/reduce-compilation-time-by-another-16-with-catch.html" class="u-url">Reduce Catch tests compilation time by another 16%</a>
        <br><small>  
             Posted: <time class="published dt-published" datetime="2016-06-01T07:28:36+02:00">2016-06-01 07:28</time></small>
</h1>
        <hr>
<div class="p-summary">
        <div>
<p>No, it's not the same post as two days! I've been able to reduce the compilation
time of my test cases by another 16%!</p>
<p>Two days ago, I posted an article about how <a class="reference external" href="http://baptiste-wicht.com/posts/2016/05/speedup-compilation-by-13-by-simplifying-unit-test-with-catch.html">I reduced the compilation time of my tests by 13%</a>, by bypassing the expression deduction from Catch. I came up with the macro <code class="cpp"><span class="n">REQUIRE_EQUALS</span></code>:</p>
<pre class="code cpp"><a name="rest_code_845ab232a4f14c8085fa731c9b9ccc34-1"></a><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">L</span><span class="p">,</span> <span class="k">typename</span> <span class="n">R</span><span class="o">&gt;</span>
<a name="rest_code_845ab232a4f14c8085fa731c9b9ccc34-2"></a><span class="kt">void</span> <span class="n">evaluate_result</span><span class="p">(</span><span class="n">Catch</span><span class="o">::</span><span class="n">ResultBuilder</span><span class="o">&amp;&amp;</span> <span class="n">__result</span><span class="p">,</span> <span class="n">L</span> <span class="n">lhs</span><span class="p">,</span> <span class="n">R</span> <span class="n">rhs</span><span class="p">){</span>
<a name="rest_code_845ab232a4f14c8085fa731c9b9ccc34-3"></a>    <span class="n">__result</span><span class="p">.</span><span class="n">setResultType</span><span class="p">(</span><span class="n">lhs</span> <span class="o">==</span> <span class="n">rhs</span><span class="p">);</span>
<a name="rest_code_845ab232a4f14c8085fa731c9b9ccc34-4"></a>    <span class="n">__result</span><span class="p">.</span><span class="n">setLhs</span><span class="p">(</span><span class="n">Catch</span><span class="o">::</span><span class="n">toString</span><span class="p">(</span><span class="n">lhs</span><span class="p">));</span>
<a name="rest_code_845ab232a4f14c8085fa731c9b9ccc34-5"></a>    <span class="n">__result</span><span class="p">.</span><span class="n">setRhs</span><span class="p">(</span><span class="n">Catch</span><span class="o">::</span><span class="n">toString</span><span class="p">(</span><span class="n">rhs</span><span class="p">));</span>
<a name="rest_code_845ab232a4f14c8085fa731c9b9ccc34-6"></a>    <span class="n">__result</span><span class="p">.</span><span class="n">setOp</span><span class="p">(</span><span class="s">"=="</span><span class="p">);</span>
<a name="rest_code_845ab232a4f14c8085fa731c9b9ccc34-7"></a>    <span class="n">__result</span><span class="p">.</span><span class="n">endExpression</span><span class="p">();</span>
<a name="rest_code_845ab232a4f14c8085fa731c9b9ccc34-8"></a>    <span class="n">__result</span><span class="p">.</span><span class="n">react</span><span class="p">();</span>
<a name="rest_code_845ab232a4f14c8085fa731c9b9ccc34-9"></a><span class="p">}</span>
<a name="rest_code_845ab232a4f14c8085fa731c9b9ccc34-10"></a>
<a name="rest_code_845ab232a4f14c8085fa731c9b9ccc34-11"></a><span class="cp">#define REQUIRE_EQUALS(lhs, rhs) \</span>
<a name="rest_code_845ab232a4f14c8085fa731c9b9ccc34-12"></a><span class="cp">    evaluate_result(Catch::ResultBuilder( "REQUIRE", CATCH_INTERNAL_LINEINFO, #lhs " == " #rhs, Catch::ResultDisposition::Normal ), lhs, rhs);</span>
</pre>
<p>This has the advantage that the left and right hand sides are directly set, not
deduced with templates and operator overloading. This still has exactly the same
features has the original macro, but it is a bit less nice in the test code.
I was quite happy with that optimization, but it turned out, I was not
aggressive enough in my optimizations.</p>
<p>Even though it seems simple, the macro is still bloated. There are two
constructors calls: <code class="cpp"><span class="n">ResultBuilder</span></code> and <code class="cpp"><span class="n">SourceLineInfo</span></code> (hidden behind
<code class="cpp"><span class="n">CATCH_INTERNAL_LINEINFO</span></code>). That means that if you test case has 100
assertions, 200 constructor calls will need to be processed by the compiler.
Considering that I have some test files with around 400 assertions, this is
a lot of overhead for nothing. Moreover, two parameters have always the same
value, no need to repeat them every time.</p>
<p>Simplifying the macro to the minimum led me to this:</p>
<pre class="code cpp"><a name="rest_code_46c6be1082e344feb4770e6bf9291f15-1"></a><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">L</span><span class="p">,</span> <span class="k">typename</span> <span class="n">R</span><span class="o">&gt;</span>
<a name="rest_code_46c6be1082e344feb4770e6bf9291f15-2"></a><span class="kt">void</span> <span class="n">evaluate_result</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">file</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">line</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">exp</span><span class="p">,</span> <span class="n">L</span> <span class="n">lhs</span><span class="p">,</span> <span class="n">R</span> <span class="n">rhs</span><span class="p">){</span>
<a name="rest_code_46c6be1082e344feb4770e6bf9291f15-3"></a>    <span class="n">Catch</span><span class="o">::</span><span class="n">ResultBuilder</span> <span class="n">result</span><span class="p">(</span><span class="s">"REQUIRE"</span><span class="p">,</span> <span class="p">{</span><span class="n">file</span><span class="p">,</span> <span class="n">line</span><span class="p">},</span> <span class="n">exp</span><span class="p">,</span> <span class="n">Catch</span><span class="o">::</span><span class="n">ResultDisposition</span><span class="o">::</span><span class="n">Flags</span><span class="o">::</span><span class="n">Normal</span><span class="p">);</span>
<a name="rest_code_46c6be1082e344feb4770e6bf9291f15-4"></a>    <span class="n">result</span><span class="p">.</span><span class="n">setResultType</span><span class="p">(</span><span class="n">lhs</span> <span class="o">==</span> <span class="n">rhs</span><span class="p">);</span>
<a name="rest_code_46c6be1082e344feb4770e6bf9291f15-5"></a>    <span class="n">result</span><span class="p">.</span><span class="n">setLhs</span><span class="p">(</span><span class="n">Catch</span><span class="o">::</span><span class="n">toString</span><span class="p">(</span><span class="n">lhs</span><span class="p">));</span>
<a name="rest_code_46c6be1082e344feb4770e6bf9291f15-6"></a>    <span class="n">result</span><span class="p">.</span><span class="n">setRhs</span><span class="p">(</span><span class="n">Catch</span><span class="o">::</span><span class="n">toString</span><span class="p">(</span><span class="n">rhs</span><span class="p">));</span>
<a name="rest_code_46c6be1082e344feb4770e6bf9291f15-7"></a>    <span class="n">result</span><span class="p">.</span><span class="n">setOp</span><span class="p">(</span><span class="s">"=="</span><span class="p">);</span>
<a name="rest_code_46c6be1082e344feb4770e6bf9291f15-8"></a>    <span class="n">result</span><span class="p">.</span><span class="n">endExpression</span><span class="p">();</span>
<a name="rest_code_46c6be1082e344feb4770e6bf9291f15-9"></a>    <span class="n">result</span><span class="p">.</span><span class="n">react</span><span class="p">();</span>
<a name="rest_code_46c6be1082e344feb4770e6bf9291f15-10"></a><span class="p">}</span>
<a name="rest_code_46c6be1082e344feb4770e6bf9291f15-11"></a>
<a name="rest_code_46c6be1082e344feb4770e6bf9291f15-12"></a><span class="cp">#define REQUIRE_EQUALS(lhs, rhs) \</span>
<a name="rest_code_46c6be1082e344feb4770e6bf9291f15-13"></a><span class="cp">    evaluate_result(__FILE__, __LINE__, #lhs " == " #rhs, lhs, rhs);</span>
</pre>
<p>The macro is now a simple function call. Even though the function is a template
function, it will only be compiled for a few types (<code class="cpp"><span class="kt">double</span></code> and
<code class="cpp"><span class="kt">float</span></code> in my case), whereas the code of the macro would be unconditionally
compiled for each invocation.</p>
<p>With this new macro and function, the compilation time went down from 664
seconds to 554 seconds! This is <strong>more than 16% reduction in compilation
time</strong>. When comparing against the original compilation time (without both
optimizations) of 764 seconds, this is a 27% reduction! And there are absolutely
no difference in features.</p>
<p>This is a really great result, in my opinion. I don't think this can be cut down
more. However, there is still some room for optimization regarding the includes
that Catch need. Indeed, it is very bloated as well. A new test framework,
<a class="reference external" href="https://github.com/onqtam/doctest">doctest</a> follows the same philosophy, but
has much smaller include overhead. Once all the necessary features are in
doctest, I may consider adapting my macros for it and using it in place of Catch
is there is some substantial reduction in compilation time.</p>
<p>If you want to take a look at the code, you can find the adapted code on <a class="reference external" href="https://github.com/wichtounet/etl/blob/master/test/include/fast_catch.hpp">Github</a>.</p>
</div>
        </div>
            
        
    <a href="posts/2016/06/reduce-compilation-time-by-another-16-with-catch.html#disqus_thread" data-disqus-identifier="cache/posts/2016/06/reduce-compilation-time-by-another-16-with-catch.html">Comments</a>


        </article><article class="postbox h-entry post-text"><h1 class="p-name">
<a href="posts/2016/05/speedup-compilation-by-13-by-simplifying-unit-test-with-catch.html" class="u-url">Speed up compilation by 13% by simplifying Catch unit tests</a>
        <br><small>  
             Posted: <time class="published dt-published" datetime="2016-05-25T12:35:16+02:00">2016-05-25 12:35</time></small>
</h1>
        <hr>
<div class="p-summary">
        <div>
<p>In the previous two days, I've working on improving compilation time of my
project Expression Templates Library (ETL). I have been able to reduce the
compilation time of the complete test suite from 794 seconds to 764 seconds
(using only one thread). Trying to get further, I started checking what was
taking the most time in a test case when I saw that the REQUIRE calls of <strong>the
test library were taking a large portion of the compilation time!</strong></p>
<p>I have been <a class="reference external" href="http://baptiste-wicht.com/posts/2014/07/catch-powerful-yet-simple-cpp-test-framework.html">using Catch as my test framework</a>
for more than two years and it's really been great overall. It is a great tool,
header-only, fully-featured, XML reporting for Sonar, ... It really has
everything I need from a test framework.</p>
<p>Contrary to some popular test frameworks that provides ASSERT_EQUALS,
ASSERT_GREATER and all fashion of assert macros, Catch only provides one
version: REQUIRE. For instance:</p>
<pre class="code cpp"><a name="rest_code_3b13dbe49e2e4553a47fdca12957d25a-1"></a><span class="n">REQUIRE</span><span class="p">(</span><span class="n">x</span> <span class="o">==</span> <span class="mf">1.0</span><span class="p">);</span>
<a name="rest_code_3b13dbe49e2e4553a47fdca12957d25a-2"></a><span class="n">REQUIRE</span><span class="p">(</span><span class="n">y</span> <span class="o">&lt;</span> <span class="mf">5.5</span><span class="p">);</span>
<a name="rest_code_3b13dbe49e2e4553a47fdca12957d25a-3"></a><span class="n">REQUIRE</span><span class="p">((</span><span class="n">z</span> <span class="o">+</span> <span class="n">x</span><span class="p">)</span> <span class="o">!=</span> <span class="mf">22.01f</span><span class="p">);</span>
</pre>
<p>The left and right part are detected with some smart template and operator
overloading techniques and this makes for very nice test output in case of
errors, for instance:</p>
<pre class="code text"><a name="rest_code_fb1768396fed4fc3b99a13338fef86be-1"></a>test/src/dyn_matrix.cpp:16: FAILED:
<a name="rest_code_fb1768396fed4fc3b99a13338fef86be-2"></a>  REQUIRE( test_matrix.rows() == 2UL )
<a name="rest_code_fb1768396fed4fc3b99a13338fef86be-3"></a>with expansion:
<a name="rest_code_fb1768396fed4fc3b99a13338fef86be-4"></a>  3 == 2
</pre>
<p>I think this is pretty nice and the tests are really clear. However, <em>it comes
with a cost</em> and I underestimated this at first.</p>
<p>To overcome this, I create two new macros (and few other variations)
REQUIRE_EQUALS and REQUIRE_DIRECT that simply bypass Catch deduction of the
expression:</p>
<pre class="code cpp"><a name="rest_code_35ecc60856544961b7b774d390915046-1"></a><span class="kr">inline</span> <span class="kt">void</span> <span class="nf">evaluate_result_direct</span><span class="p">(</span><span class="n">Catch</span><span class="o">::</span><span class="n">ResultBuilder</span><span class="o">&amp;&amp;</span> <span class="n">__result</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">value</span><span class="p">){</span>
<a name="rest_code_35ecc60856544961b7b774d390915046-2"></a>    <span class="n">__result</span><span class="p">.</span><span class="n">setResultType</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
<a name="rest_code_35ecc60856544961b7b774d390915046-3"></a>    <span class="n">__result</span><span class="p">.</span><span class="n">setLhs</span><span class="p">(</span><span class="n">value</span> <span class="o">?</span> <span class="s">"true"</span> <span class="o">:</span> <span class="s">"false"</span><span class="p">);</span>
<a name="rest_code_35ecc60856544961b7b774d390915046-4"></a>    <span class="n">__result</span><span class="p">.</span><span class="n">setOp</span><span class="p">(</span><span class="s">""</span><span class="p">);</span>
<a name="rest_code_35ecc60856544961b7b774d390915046-5"></a>    <span class="n">__result</span><span class="p">.</span><span class="n">endExpression</span><span class="p">();</span>
<a name="rest_code_35ecc60856544961b7b774d390915046-6"></a><span class="p">}</span>
<a name="rest_code_35ecc60856544961b7b774d390915046-7"></a>
<a name="rest_code_35ecc60856544961b7b774d390915046-8"></a><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">L</span><span class="p">,</span> <span class="k">typename</span> <span class="n">R</span><span class="o">&gt;</span>
<a name="rest_code_35ecc60856544961b7b774d390915046-9"></a><span class="kt">void</span> <span class="n">evaluate_result</span><span class="p">(</span><span class="n">Catch</span><span class="o">::</span><span class="n">ResultBuilder</span><span class="o">&amp;&amp;</span> <span class="n">__result</span><span class="p">,</span> <span class="n">L</span> <span class="n">lhs</span><span class="p">,</span> <span class="n">R</span> <span class="n">rhs</span><span class="p">){</span>
<a name="rest_code_35ecc60856544961b7b774d390915046-10"></a>    <span class="n">__result</span><span class="p">.</span><span class="n">setResultType</span><span class="p">(</span><span class="n">lhs</span> <span class="o">==</span> <span class="n">rhs</span><span class="p">);</span>
<a name="rest_code_35ecc60856544961b7b774d390915046-11"></a>    <span class="n">__result</span><span class="p">.</span><span class="n">setLhs</span><span class="p">(</span><span class="n">Catch</span><span class="o">::</span><span class="n">toString</span><span class="p">(</span><span class="n">lhs</span><span class="p">));</span>
<a name="rest_code_35ecc60856544961b7b774d390915046-12"></a>    <span class="n">__result</span><span class="p">.</span><span class="n">setRhs</span><span class="p">(</span><span class="n">Catch</span><span class="o">::</span><span class="n">toString</span><span class="p">(</span><span class="n">rhs</span><span class="p">));</span>
<a name="rest_code_35ecc60856544961b7b774d390915046-13"></a>    <span class="n">__result</span><span class="p">.</span><span class="n">setOp</span><span class="p">(</span><span class="s">"=="</span><span class="p">);</span>
<a name="rest_code_35ecc60856544961b7b774d390915046-14"></a>    <span class="n">__result</span><span class="p">.</span><span class="n">endExpression</span><span class="p">();</span>
<a name="rest_code_35ecc60856544961b7b774d390915046-15"></a><span class="p">}</span>
<a name="rest_code_35ecc60856544961b7b774d390915046-16"></a>
<a name="rest_code_35ecc60856544961b7b774d390915046-17"></a><span class="cp">#define REQUIRE_DIRECT(value) \</span>
<a name="rest_code_35ecc60856544961b7b774d390915046-18"></a><span class="cp">    evaluate_result_direct(Catch::ResultBuilder( "REQUIRE", CATCH_INTERNAL_LINEINFO, #value, Catch::ResultDisposition::Normal ), value);</span>
<a name="rest_code_35ecc60856544961b7b774d390915046-19"></a>
<a name="rest_code_35ecc60856544961b7b774d390915046-20"></a><span class="cp">#define REQUIRE_EQUALS(lhs, rhs) \</span>
<a name="rest_code_35ecc60856544961b7b774d390915046-21"></a><span class="cp">    evaluate_result(Catch::ResultBuilder( "REQUIRE", CATCH_INTERNAL_LINEINFO, #lhs " == " #rhs, Catch::ResultDisposition::Normal ), lhs, rhs);</span>
</pre>
<p>There is really nothing too special about it, I simply followed the macros and
functions in Catch source code until I found out what to bypass.</p>
<p>And now, we use them directly:</p>
<pre class="code cpp"><a name="rest_code_39ae0b30b90a468a9ddf7fdecd559dd7-1"></a><span class="n">REQUIRE_DIRECT</span><span class="p">(</span><span class="n">am_i_true</span><span class="p">());</span>
<a name="rest_code_39ae0b30b90a468a9ddf7fdecd559dd7-2"></a><span class="n">REQUIRE_EQUALS</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
</pre>
<p>This is a bit less nice and it requires to know a few more macros, I admit, but
it turns out to be much faster (and who really cares about the beauty of test
code anyway...). Indeed, the total compilation time of the tests went from 764
seconds to 664 seconds!  This is <strong>a 13% reduction of the compilation time</strong>!
I really am impressed of the overhead of this technique. I cannot justify this
slowdown just for a bit nicer test code. Finally, the output in case of error
remains exactly the same as before.</p>
<p>This proves that sometimes the bottlenecks are not where we expect them :)</p>
<p>If you are interested, you can find the adapted code on <a class="reference external" href="https://github.com/wichtounet/etl/blob/master/test/include/fast_catch.hpp">Github</a>.</p>
</div>
        </div>
            
        
    <a href="posts/2016/05/speedup-compilation-by-13-by-simplifying-unit-test-with-catch.html#disqus_thread" data-disqus-identifier="cache/posts/2016/05/speedup-compilation-by-13-by-simplifying-unit-test-with-catch.html">Comments</a>


        </article><nav class="postindexpager"><ul class="pager">
<li class="next">
                <a href="index-28.html" rel="next">Older posts</a>
            </li>
        </ul></nav><script>var disqus_shortname="blogwichtounet";(function(){var a=document.createElement("script");a.async=true;a.src="https://"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script>
</div> <!-- col -->
    </div>
<!-- row  -->
</div>
<!-- container-fluid -->

<!-- End of Menubar -->

<!-- Footer -->

<footer>
    Contents © 2016         <a href="mailto:baptistewicht@gmail.com">Baptiste Wicht</a> - Powered by         <a href="http://getnikola.com" rel="nofollow">Nikola</a>         - License: 
<a rel="license" href="http://creativecommons.org/licenses/by/4.0/"><img alt="Creative Commons License" style="padding-left:5px;border-width:0" src="assets/img/cc.png"></a>
        <ul class="footer_inline_ul"></ul></footer><!-- Late loading stuff  --><script src="assets/js/all-nocdn.js"></script><script type="text/javascript">
      $(document).ready(function() {
        $.getJSON("/assets/js/tx3_tag_cloud.json", function(data){
            var items = [];
            $.each(data, function(key, val){
                var count = val[0];
                var url = val[1];
                var posts = val[2];

                if(count > 9){
                    items.push("<li data-weight='" + count + "'><a href='" + url + "'>" + key + "</a></li>");
                }
            });

            $("<ul/>", {
                "id": "tag_cloud_left",
                html: items.join("")
            }).appendTo("#tag_cloud_left_container");

            $("#tag_cloud_left").tx3TagCloud({
                multiplier: 0.8 // default multiplier is "1"
            });
        });
      });
    </script><!-- Google platform JS -->
</body>
</html>
