<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " lang="en">
<head>
<meta charset="utf-8">
<base href="http://baptiste-wicht.com/index.html">
<meta name="description" content="Tutorials and short posts about programming, C++, Java, Assembly, Operating Systems Development, Compilers, ...">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Blog blog("Baptiste Wicht");</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta content="#5670d4" name="theme-color">
<link rel="alternate" type="application/rss+xml" title="RSS" href="rss.xml">
<link rel="canonical" href="http://baptiste-wicht.com/index.html">
<link rel="next" href="index-29.html" type="text/html">
<!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]--><script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-2175227-7']);
  _gaq.push(['_trackPageview']);
  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script><link href="favicon.ico" rel="icon" type="image/x-icon">
<link rel="publisher" href="https://plus.google.com/+BaptisteWicht">
</head>
<body>

<!-- Menubar -->

<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<div class="container-fluid">
<!-- This keeps the margins nice -->
    <div class="row">
        <div class="col-sm-3 col-lg-2">
            <nav class="navbar navbar-inverse navbar-fixed-side"><div class="navbar-header">
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="http://baptiste-wicht.com/">
                        <span id="blog-title">Blog blog("Baptiste Wicht");</span>
                    </a>
                </div>
<!-- /.navbar-header -->

                <div class="collapse navbar-collapse navbar-ex1-collapse">
                    <ul class="nav navbar-nav">
<li>
<a href="stories/about.html">About</a>
                </li>
<li>
<a href="stories/publications.html">Publications</a>
                </li>
<li>
<a href="stories/projects.html">Projects</a>
                </li>
<li>
<a href="categories/index.html">Tags</a>
                </li>
<li>
<a href="archive.html">Archives</a>
                </li>
<li>
<a href="http://feeds.feedburner.com/BaptisteWicht">RSS</a>


                            </li>
<li class="navbar-content">
                                <h3>Tags</h3>
                            </li>
                            <li class="navbar-empty">
                                <div id="tag_cloud_left_container" style="line-height: 18px !important;"></div>
                            </li>
                            <li class="navbar-block">


                        <li class="wicht-navbar-right">
                            <a target="_blank" title="Follow @wichtounet on Twitter" href="https://twitter.com/wichtounet">
                                <img src="assets/img/twitter.png" alt="Follow @wichtounet on Twitter"></a>
                        </li>

                        <li class="wicht-navbar-right">
                            <a target="_blank" title="Follow +BaptisteWicht on Google+" href="https://plus.google.com/+BaptisteWicht">
                                <img src="assets/img/google_plus.png" alt="Follow +BaptisteWicht on Google+"></a>
                        </li>


                    </ul>
</div>
<!-- /.navbar-collapse -->
            </nav>
</div> <!-- col -->
        <div class="col-sm-9 col-lg-10">
            <div id="content"></div>
            
        <article class="postbox h-entry post-text"><h1 class="p-name">
<a href="posts/2017/03/migrated-from-owncloud-5-to-nextcloud-11.html" class="u-url">Migrated from owncloud 5 to Nextcloud 11</a>
        <br><small>  
             Posted: <time class="published dt-published" datetime="2017-03-03T09:08:58+01:00">2017-03-03 09:08</time></small>
</h1>
        <hr>
<div class="p-summary">
        <div>
<p>For several years now I've been using Owncloud running on one of my servers.
I'm using simply using as a simple synchronization, I don't use any of the tons
of fancy features they keep adding. Except from several synchronization issues,
I haven't had too much issues with it.</p>
<p>However, I have had a very bad time with updates of Owncloud. The last time
I tried, already long ago, was to upgrade from 5.0 to 6.0 and I never succeeded
without losing all the configuration and having to do the resync. Therefore,
I've still an Owncloud 5.0 running. From this time, I had to say that I've been
lazy and didn't try again to upgrade it. Recently, I've received several mails
indicating that this is a security threat.</p>
<p>Since I was not satisfied with updates in Owncloud and its security has been
challenged recently, I figured it would be a good moment to upgrade to Nextcloud
which is a very active fork of Owncloud that was forked by developers of
Owncloud.</p>
<p>I haven't even tried to do an upgrade from such an old version to the last
version of Nextcloud, it was doomed to fail. Therefore, I made a new clean
installation. Since I only use the sync feature of the tool, it does not really
matter, it is just some time lost to sync everything again, but nothing too bad.</p>
<p>I configured a new PostgreSQL on one of my servers for the new database and then
installed Nextcloud 11 on Gentoo. It's a bit a pain to have a working Nginx
configuration for Nextcloud, I don't advice to do it by hand, better take one
from the official documentation, you'll also gain some security. One very bad
thing in the installation process is that you cannot choose the database prefix,
it's set like Owncloud. The problem with that is that you cannot install both
Owncloud and Nextcloud on the same database which would be more practical for
testing purpose. It's a bit retarded in my opinion, but not a big problem in the
end. Other than these two points, everything went well and it was installation
pretty nicely. Then, you should have your user ready to go.</p>
<img alt="Nextcloud view" class="align-center" src="images/nextcloud.png"><p>As for the interface, I don't think there is a lot to tell here. Most of it is
what you would except from this kind of tool. Moreover, I very rarely use the
web interface or any of the feature that are not the sync feature. One thing
that is pretty cool I think is the monitoring graphs in the Admin section of the
interface. You can the number of users connected, the memory used and the CPU
load. It's pretty useful if you share your Nextcloud between a lot of different
users.</p>
<p>I didn't have any issue with the sync either. I used the nextcloud-client
package on Gentoo directly and it worked perfectly directly. It took about 10
minutes to sync everything again (about 5GB). I'll have to do the same thing on
my other computer as well, but I don't think I'll have any issue.</p>
<p>So far, I cannot say that this is better than Owncloud, I just hope the next
upgrade will fare better than they did on Owncloud. Moreover, I also hope that
the security that they promise is really here and I won't have any problem with
it. I'll see in the future!</p>
</div>
        </div>
            
        
    <a href="posts/2017/03/migrated-from-owncloud-5-to-nextcloud-11.html#disqus_thread" data-disqus-identifier="cache/posts/2017/03/migrated-from-owncloud-5-to-nextcloud-11.html">Comments</a>


        </article><article class="postbox h-entry post-text"><h1 class="p-name">
<a href="posts/2017/03/release-zapcc-10-fast-cpp-compiler.html" class="u-url">Release of zapcc 1.0 - Fast C++ compiler</a>
        <br><small>  
             Posted: <time class="published dt-published" datetime="2017-03-02T14:50:04+01:00">2017-03-02 14:50</time></small>
</h1>
        <hr>
<div class="p-summary">
        <div>
<p>If you remember, I recently wrote about <a class="reference external" href="http://baptiste-wicht.com/posts/2016/12/zapcc-cpp-compilation-speed-against-gcc-54-and-clang-39.html">zapcc C++ compilation speed against gcc 5.4 and clang 3.9</a> in which I was comparing the beta version of zapcc against gcc and clang.</p>
<p>I just been informed that zapcc was just released in version 1.0. I though it
was a good occasion to test it again. It will be compared against gcc-4.9,
gcc-5.3 and clang-3.9. This version is based on the trunk of clang-5.0.</p>
<p>Again, I will use my Expression Template Library (<a class="reference external" href="https://github.com/wichtounet/etl/">ETL</a>) project. This is a purely header-only
library with lots of templates. I'm going to compile the full test cases. This
is a perfect example for long compilation times.</p>
<p>The current tests are made on the last version of the library and with slightly
different parameters for compilation, therefore the absolute times are not
comparable, but the speedups should be comparable.</p>
<p>Just like last time, I have configured zapcc to let is use 2Go RAM per caching
server, which is the maximum allowed. Moreover, I killed the servers before each
tests.</p>
<div class="section" id="debug-results">
<h2>Debug results</h2>
<p>Let's start with a debug build, with no optimizations enabled. Every build will
use four threads. This is the equivalent of doing make -j4 debug/bin/etl_test
without the link step.</p>
<table border="1" class="docutils">
<colgroup>
<col width="73%">
<col width="27%">
</colgroup>
<thead valign="bottom"><tr>
<th class="head">Compiler</th>
<th class="head"> </th>
</tr></thead>
<tbody valign="top">
<tr>
<td>g++-4.9.3</td>
<td>190.09s</td>
</tr>
<tr>
<td>g++-5.3.0</td>
<td>200.92s</td>
</tr>
<tr>
<td>clang++-3.9</td>
<td>313.85</td>
</tr>
<tr>
<td>zapcc++</td>
<td>81.25</td>
</tr>
<tr>
<td>Speedup VS Clang</td>
<td>3.86</td>
</tr>
<tr>
<td>Speedup VS GCC-5.3</td>
<td>2.47</td>
</tr>
<tr>
<td>Speedup VS GCC-4.9</td>
<td>2.33</td>
</tr>
</tbody>
</table>
<p>The speedups are even more impressive than last time! zapcc is <strong>almost four
times fast than clang-3.9</strong> and around <strong>2.5 times faster than GCC-5.3</strong>.
Interestingly, we can see that gcc-5.3 is slighly slower than GCC-4.9.</p>
<p>It seems that they have the compiler even faster!</p>
</div>
<div class="section" id="release-results">
<h2>Release results</h2>
<p>Let's start with a debug build, with no optimizations enabled. Every build will
use four threads. This is the equivalent of doing make -j4
release_debug/bin/etl_test without the link step.</p>
<table border="1" class="docutils">
<colgroup>
<col width="75%">
<col width="25%">
</colgroup>
<thead valign="bottom"><tr>
<th class="head">Compiler</th>
<th class="head"> </th>
</tr></thead>
<tbody valign="top">
<tr>
<td>g++-4.9.3</td>
<td>252.99</td>
</tr>
<tr>
<td>g++-5.3.0</td>
<td>264.96</td>
</tr>
<tr>
<td>clang++-3.9</td>
<td>361.65</td>
</tr>
<tr>
<td>zapcc++</td>
<td>237.96</td>
</tr>
<tr>
<td>Speedup VS Clang</td>
<td>1.51</td>
</tr>
<tr>
<td>Speedup VS GCC-5.3</td>
<td>1.11</td>
</tr>
<tr>
<td>Speedup VS GCC-4.9</td>
<td>1.06</td>
</tr>
</tbody>
</table>
<p>We can see that this time the speedups are not as interesting as they were.
Very interestingly, it's the compiler that suffers the more from the
optimization overhead. Indeed, zapcc is three times slower in release mode than
it was in debug mode. Nevertheless, it still manages to beat the three other
compilers, by about 10% for Gcc and 50% than clang, which is already
interesting.</p>
<div class="section" id="conclusion">
<h3>Conclusion</h3>
<p>To conclude, we have observed that zapcc is always faster than the three
compilers tested in this experiment. Moreover, in debug mode, the speedups are
very significant, it was almost 4 times faster than clang and around 2.5 faster
than gcc.</p>
<p>I haven't seen any problem with the tool, it's like clang and it should generate
code of the same performance, but just compile it much faster. One problem
I have with zapcc is that it is not based on an already released version of
clang but on the trunk. That means it is hard to be compare with the exact same
version of clang and it is also a risk of running into clang bugs.</p>
<p>Although the prices have not been published yet, it is indicated on the website
that zapcc is free for non-commercial entities. Which is really great.</p>
<p>If you want more information, you can go to the
<a class="reference external" href="https://www.zapcc.com/">official website of zapcc</a></p>
</div>
</div>
</div>
        </div>
            
        
    <a href="posts/2017/03/release-zapcc-10-fast-cpp-compiler.html#disqus_thread" data-disqus-identifier="cache/posts/2017/03/release-zapcc-10-fast-cpp-compiler.html">Comments</a>


        </article><article class="postbox h-entry post-text"><h1 class="p-name">
<a href="posts/2017/02/home-automation-first-attempt-voice-control-jarvis.html" class="u-url">Home Automation: First attempt at voice control with Jarvis</a>
        <br><small>  
             Posted: <time class="published dt-published" datetime="2017-02-14T18:34:19+01:00">2017-02-14 18:34</time></small>
</h1>
        <hr>
<div class="p-summary">
        <div>
<p>I have several devices in my home that can be controller via Domoticz, a few
power outlets, a few lights (more are coming), my Kodi home theater. And I have
a lot of sensors and information gathered by Domoticz. All of this is working
quite well, but I have only a few actuators and intelligence (motion sensor,
button and some automation via Lua script).</p>
<p>My next objective was to add voice control to my system. If I was living in
United States or United Kingdom I would directly an Amazon Dot or even an Amazon
Echo, but they are not available in Switzerland. I could have arranged for
delivery, but if I want my system to be useful to several people, I need to have
in French. It's the same problem with the Google Home system. So, no other way
than custom solutions.</p>
<p>Since I had an extra Raspberry Pi 2, I based my system on this. I bought a Trust
Mico microphone and a Trust Compact speakers and installed them on the Pi. Both
peripherals are working quite well.</p>
<p>You can have a closer look at my microphone:</p>
<img alt="Trust Mico microphone for Jarvis Home Automation Voice Control" class="align-center" src="images/jarvis_mic.jpg"><p>and the complete installation:</p>
<img alt="Jarvis Home Automation Voice Control around my TV" class="align-center" src="images/jarvis_full.jpg"><p>The Raspberry Pi is on the bottom, the speakers below the TV, left and right and
the microphone on the top right.</p>
<p>For the voice control software, I decided to go with Jarvis. It seems to me that
this is the best suited software for this kind of project. Moreover, it supports
French natively which seems good. I also tried Jasper, but this has been such
a pain to install that I gave up.</p>
<p>Jarvis is reasonably easy to install if you have a recent Raspbian image. It
took some time to install the dependencies, but in the end it was not difficult.
The installation process has a step-by-step wizard help so it's really easy to
configure everything.</p>
<p>However, even if it's easy to install, it's easy to configure correctly. The
first thing is to configure the hotword to activate commands. There are several
options, but I used snowboy which is offline and is made for hotword
recognition. This worked quite well, you just have to train a model with the
hotword to recognize the voice. After this, the problems started... You then
have to configure audio for the commands themselves. There are 6 parameters for
audio capture (noise levels to start and stop the capture, silence levels, ...)
and no help to tune them. So basically, I tried a lot of combinations until
I had something working reasonably well. When you are in debug mode, you can
listen to what the system captured. These parameters are dependent on your
environment and on your microphone and on your voice. I may be dumb but it took
several hours and a lot of tries to get a configuration working. After this, you
have to choose the engine for recognition of the commands. Unfortunately, all
the good options are online so everything you'll say as commands after the
hotword will be sent online. I first tried Bing, but I had very poor recognition
rate. I then switched to wit.ai which gave me better results. In the end, I have
about 60% recognition rate, which is not great at all, but at least some phrases
are working almost all the time while others are always failing. Another problem
I have with this is the large delay between commands and action. It takes almost
five seconds between the end of my sentence and the time where the lights in my
living room are tuned on or off by Jarvis via Domoticz.</p>
<p>So far, I'm a bit disappointed by the quality of the system, but maybe I was
hoping for too much. I have been able to control a few of my appliances but not
really reliably. Another thing I have realized is that when counting the
Raspberry Pi, its enclosure the Microphone and the speakers, this system is more
costly than an Amazon Dot and seem highly inferior (and is much less good
looking).</p>
<p>I'll try to improve the current system with better configuration and commands in
the coming days and I will maybe try another system for voice control. I still
hope Amazon Alexa systems or Google Home are made available in
France/Switzerland not too far in the future, since I believe these systems are
a better solution than custom made systems, at least for now. Moreover, next
month, I plan to integrate ZWave into my systems with a few sensors, complete
the lighting installation and add new motion sensors. This should make it more
useful. And hopefully, by this time, I should have a good voice control system,
but I'm not too hopeful.</p>
<p>Don't hesitate to comment or contact me if you have questions about this
installation or want to share experience about voice control in home automation.
If you want more details about this, dont' hesitate to ask as well ;)</p>
</div>
        </div>
            
        
    <a href="posts/2017/02/home-automation-first-attempt-voice-control-jarvis.html#disqus_thread" data-disqus-identifier="cache/posts/2017/02/home-automation-first-attempt-at-voice-control-with-jarvis.html">Comments</a>


        </article><article class="postbox h-entry post-text"><h1 class="p-name">
<a href="posts/2017/02/publication-cpu-performance-optimizations-rbm-crbm.html" class="u-url">Publication: CPU Performance Optimizations for RBM and CRBM</a>
        <br><small>  
             Posted: <time class="published dt-published" datetime="2017-02-07T17:33:33+01:00">2017-02-07 17:33</time></small>
</h1>
        <hr>
<div class="p-summary">
        <div>
<p>Recently, we have published a paper about performance optimizations that may
interest you.</p>
<p>The paper is <a class="reference external" href="https://www.researchgate.net/publication/307908790_On_CPU_Performance_Optimization_of_Restricted_Boltzmann_Machine_and_Convolutional_RBM">On CPU Performance Optimizations for Restricted Boltzmann Machine and Convolutional RBM</a>, published in the Proceedings of the Artificial Neural Networks and Pattern Recognition workshop (ANNPR-2016). I've presented this paper in Germany, at Ulm.</p>
<p>Although most of the performance research going on is focused on GPU, there are
still of research laboratories that are only equipped with CPU and it remains
important to be as fast as possible on CPU. Moreover, this is something
I really like.</p>
<p>For this publication, I have tried to make my Restricted Boltzmann Machine (RBM)
and Convolutional RBM (CRBM) implementations in my DLL library as fast as
possible.</p>
<p>The first part of the article is about Restricted Boltzmann Machine (RBM) which
are a form of dense Artificial Neural Network (ANN). Their training is very
similar to that of the ANN with Gradient Descent. Four different network
configurations are being tested.</p>
<p>First, mini-batch training is shown to be much faster than online training, even
when online training is performed in parallel. Once mini-batch training is used,
BLAS operations are used in order to get as much performance as possible on the
different operations, mainly the Matrix Matrix Multiplication with the use of
the GEMM operation from the Intel Math Kernel Library (MKL). Moreover, the
parallel version of the MKL is also used to get even more performance. When all
these optimizations are performed, speedups of 11 to 30 are obtained compared to
the online training, depending on the network configurations. This final version
is able  to perform one epoch of Contrastive Divergence in 4 to 15 seconds
depending on the network, for 60000 images.</p>
<p>The second part of the article is about Convolutional Restricted Boltzmann
Machine (CRBM). This is almost the equivalent of a Convolutional Neural Network
(CNN). Again four different networks are evaluated.</p>
<p>The main problem with CRBM is that there are no standard implementations of the
convolution operation that is really fast. Therefore, it is not possible to
simply use a BLAS library to make the computation as fast as possible. The first
optimization that was tried is to vectorize the convolutions. With this, the
speedups have been between 1.1 and 1.9 times faster. I'm not really satisfied
with these results since in fact per convolution the speedups are much better.
Moreover, I have since been able to obtain better speedups but the deadline was
too short to include them in this paper. I'll try to talk about these
improvements in more details on this blog. What is more interesting to to
parallellize the different convolutions since they are mostly independent. This
can bring a speedup of the amount of cores available on the machine. Since
convolutions are extremely memory hungry, virtual cores with Hyper Threading
generally does not help. An interesting optimization is to use a Matrix
Multiplication to compute several valid convolutions at once.  This can give an
additional speedup between 1.6 and 2.2 compared to the vectorized version. While
it is possible to use the FFT to reduce the full convolution as well, in our
experiment the images were not big enough for this to be interesting. The final
speedups are about 10 times faster with these optimizations.</p>
<p>We have obtained pretty good and I'm happy we have been published. However, I'm
not very satisfied with these results since I've been able to get even faster
since this and when compared with other frameworks, DLL is actually quite
competitive. I'll try to publish something new in the future.</p>
<p>If you want more information, you can have a look at the paper. If you want to
look at the code, you can have a look at my projects:</p>
<ul class="simple">
<li>
<a class="reference external" href="https://github.com/wichtounet/etl">Expression Templates Library (ETL)</a>: For
the Matrix Multiplication and Convolutions</li>
<li>
<a class="reference external" href="https://github.com/wichtounet/dll">Deep Learning Library (DLL)</a>: For the RBM
and CRBM implementations</li>
</ul>
<p>Don't hesitate to ask any questions if you want more information :)</p>
</div>
        </div>
            
        
    <a href="posts/2017/02/publication-cpu-performance-optimizations-rbm-crbm.html#disqus_thread" data-disqus-identifier="cache/posts/2017/02/publication-cpu-performance-optimizations-rbm-crbm.html">Comments</a>


        </article><article class="postbox h-entry post-text"><h1 class="p-name">
<a href="posts/2017/01/publications-sudoku-recognition-with-deep-belief-network.html" class="u-url">Publications - Sudoku Recognition with Deep Belief Network</a>
        <br><small>  
             Posted: <time class="published dt-published" datetime="2017-01-20T08:56:46+01:00">2017-01-20 08:56</time></small>
</h1>
        <hr>
<div class="p-summary">
        <div>
<p>I recently realized that I never talked about my publications on this website...
I thought it was time to start. I'll start to write a few posts about my earlier
publications and then I'll try to write something for the new ones not too late.</p>
<p>For the story, I'm currently a PHD student at the University of Fribourg, in
Switzerland. My PHD is about the use of Deep Learning technologies to
automatically extract features from images. I have developed my Deep Learning
Library (DLL) project for this thesis. We have published a few articles on the
various projects that we tackled during the thesis. I'll try to go in order.</p>
<p>At the beginning of the thesis, I used Restricted Boltzmann Machine and Deep
Belief Network to perform digit recognition on images of Sudoku taken with
a phone camera. We published two papers on this subject.</p>
<ul class="simple">
<li>
<a class="reference external" href="https://www.researchgate.net/publication/282303748_Camera-based_Sudoku_recognition_with_deep_belief_network">Camera-based Sudoku Recognition with Deep Belief Network</a>, in the Proceedings of the International Conference on Soft Computing and Pattern Recognition (SOCPAR-2014)</li>
<li>
<a class="reference external" href="https://www.researchgate.net/publication/307545305_Mixed_handwritten_and_printed_digit_recognition_in_Sudoku_with_Convolutional_Deep_Belief_Network">Mixed Handwritten and printed digit recognition in Sudoku With Convolutional Deep Belief Network</a>, in the Proceedings of the International Conference on Document Analysis and Recognition (ICDAR-2015)</li>
</ul>
<p>The Sudoku grid and digits are detected using standard image processing
techniques:</p>
<ol class="arabic simple">
<li>The image is first converted to grayscale, then a median blur is applied to
remove noise and the image is binarized using Adapteive Thresholding</li>
<li>The edges are detected using the Canny algorithm. From these, the lines are
detected using a Progressive Probabilistic Hough Transform</li>
<li>Using a connected component analysis, the segments of lines are clustered
together to detect the Sudoku Grid</li>
<li>The cells are then detected inside the grid using the inner lines and contour
detection is used to isolate the digits.</li>
</ol>
<p>Here is one of the original images from our dataset:</p>
<img alt="Original image from our dataset" class="align-center" src="images/image124.jpg"><p>Here are the detected characters from the previous image:</p>
<img alt="Detected digits from our application" class="align-center" src="images/image124_char.jpg"><p>Once all the digits have been found they are passed to a Deep Belief Network for
recognition. A Deep Belief Network is composed of several Restricted Boltzmann
Machines (RBM) that are stacked. The network is pretrained, by training each
RBM, in turn, with Contrastive Divergence. This algorithm basically trains each
RBM as an auto-encoder and learns a good feature representation of the inputs.
Once all the layers have been trained, the network can then be trained as
a regular neural network with Stochastic Gradient Descent.</p>
<p>In the second paper, the images of Sudoku are containing both computer printed
and handwritten digits (the grid is already filled). The other difference is
that the second system used a Convolutional DBN instead of DBN. The difference
being that each layer is a Convolutional RBM. Such a model will learn a set of
small filters that will be applied to each position of the image.</p>
<p>On the second version of the dataset, we have been able to achieve 99.14% of
recognition of the digits or 92.5% of fully-recognized grid  with the
Convolutional Network.</p>
<p>You can find the <a class="reference external" href="https://github.com/wichtounet/sudoku_recognizer">C++ implementation on Github</a>.</p>
<p>If you want to have a look, I've updated the
<a class="reference external" href="http://baptiste-wicht.com/stories/publications.html">list of my publications</a>
on this website.</p>
<p>If you want more details on this project, don't hesitate to ask here or on
Github, or read the paper :)
The next post about my publications will probably be about CPU performances!</p>
</div>
        </div>
            
        
    <a href="posts/2017/01/publications-sudoku-recognition-with-deep-belief-network.html#disqus_thread" data-disqus-identifier="cache/posts/2017/01/publications-sudoku-recognition-with-deep-belief-network.html">Comments</a>


        </article><article class="postbox h-entry post-text"><h1 class="p-name">
<a href="posts/2017/01/add-milight-smart-lights-to-domoticz-home-automation-system.html" class="u-url">Add Milight smart lights to my Domoticz home automation system</a>
        <br><small>  
             Posted: <time class="published dt-published" datetime="2017-01-15T22:00:25+01:00">2017-01-15 22:00</time></small>
</h1>
        <hr>
<div class="p-summary">
        <div>
<p>Recently, <a class="reference external" href="http://baptiste-wicht.com/posts/2017/01/new-home-automation-system-with-domoticz.html#">I switched from my hand crafted home automation system to Domoticz</a>.
This allows me to easily integrate new smart devices and remote controllable
peripherals without much effort. I plan to relate my effort in having fun
controlling my home :)</p>
<p>I'm now able to control lights in two rooms with Domoticz. The most well-known
smart bulbs are the Philips Hue. However, they are stupidly expensive. There are
a lot of alternatives. I've ordered some Milight light bulbs and controller to
test with Domoticz. I didn't order a lot of them because I wanted to make sure
they would work with my system.
Milight system is working over Wifi. There are several components to a Milight
system:</p>
<ul class="simple">
<li>The LED Light Bulbs with Red/Green/Blue/White channels</li>
<li>The Wifi Controller that is able to control 4 zones</li>
<li>An RGBW Controller for LED strip</li>
</ul>
<p>The first two are necessary for any installation, the third is to control an
RGBW LED strip. This list is not exhaustive, it's only the components that
I have used. It is important to note that a single Wifi controller can only
control 4 zones. There are also remotes, but I have not bought one since I plan
to use them only from Domoticz and maybe smartphone.</p>
<p>The installation of the controller is relatively easy. You need to download the
Milight 2.0 application on the Android Play Store (or the equivalent for IOS).
Then, you can power on the Wifi Controller. It'll create a new Wifi on which you
can then connect on your phone. Then, you can use the application on your phone
to configure the device and make it connect to your home wireless network. Once,
this is done, you can connect your phone back to your home network. You can then
use the Milight application to configure your device. I highly recommend to set
a static IP address to the controller. The way I did it is simply to set a fixed
IP address on my DHCP server based on the MAC address of the MAC controller but
you can simply do the configuration in the application or in the web interface
of the controller (the user and password combination is admin:admin).</p>
<p>Here is the look of the controller (next to my RFLink):</p>
<img alt="Milight wifi controller" class="align-center" src="images/system.jpg"><p>(My phone is starting to die, hence the very bad quality of images)</p>
<p>You can then install your LED light bulbs. For, open first the remote on your
Android Milight application. Then plug the light bulb without power first. Then
power on the light and press once on one of the I buttons on one of the zones on
the remote. This will link the LED to the selected zone on the controller. You
can then control the light from your phone. Remember, only four zones and
therefore four lights per controller.</p>
<p>The installation for a LED strip is not much complicated. You need to plug the
4 wires (or 5 wires if your have an actual RGBW LED) into the corresponding
inputs on the controller. Then, you power it and you can link it to a zone like
a normal light bulb!</p>
<img alt="LEDS in my Living Room controlled by Milight" class="align-center" src="images/leds.jpg"><p>It works really well and directly without problems.</p>
<p>The last step is of course to configure your controller in Domoticz. It is
really easy to do. You need to add a new hardware of each of the Milight
controller. It is listed under the name "Limitless/AppLamp/Mi Light with
LAN/WiFi interface". You then can set the IP address and the port by default is
8899. Once you did configure the hardware, you'll see new devices appear in the
Devices list. There will one device for each zone and one device to control all
four zones at once. You can add the device you already configured as switches.
From the Switches interface you can turn the lamp on and off and you can</p>
<img alt="Domoticz Light Bulbs control" class="align-center" src="images/domoticz_rgbw.png"><p>You can then put them on your floor plan or control them from your rules.</p>
<p>So far, I'm pretty satisfied with this Milight system. The Android application
is of poor quality but aside from this is pretty good and the price is very
fair. I'm also really satisfied with the Domoticz support. The only that is sad
is that the Domoticz Android application does not support RGBW control of the
lamps, only on and off, but that is already cool.</p>
<p>Now that all of this is working well, I've ordered a few more light bulbs to
cover all my rooms and a few LED controller to control (and install first) the
other LEDS that I have in mind.</p>
<p>On another note, I've also added a new outside temperature sensor outside my
apartment. It is a very cheap Chinese sensor, bought on Ebay, based on the
XT200 system that is working very well with RFLink.</p>
<p>The next step in my system is probably to integrate Voice Control, but I don't
know exactly which way I'll go. I ordered a simple microphone that I intend to
plug on my spare Raspberry Pi, but I don't know if the range will be enough to
cover a room. Ideally, I would like to use an Amazon Dot, but they are not
available in Switzerland. I'll probably write more on the subject once I've
found an adequate solution. Another idea I've is to integrate support for ZWave
via OpenZWave and then add a few more cool sensors that I haven't found on an
cheaper system.</p>
<p>I hope this is interesting and don't hesitate if you have any question about my
home automation project. You can expect a few more posts about this as soon as
In improve it :)</p>
</div>
        </div>
            
        
    <a href="posts/2017/01/add-milight-smart-lights-to-domoticz-home-automation-system.html#disqus_thread" data-disqus-identifier="cache/posts/2017/01/add-milight-smart-lights-to-my-domoticz-home-automation-system.html">Comments</a>


        </article><article class="postbox h-entry post-text"><h1 class="p-name">
<a href="posts/2017/01/vivaldi-vimium-finally-no-more-firefox.html" class="u-url">Vivaldi + Vimium = Finally no more Firefox!</a>
        <br><small>  
             Posted: <time class="published dt-published" datetime="2017-01-14T20:55:26+01:00">2017-01-14 20:55</time></small>
</h1>
        <hr>
<div class="p-summary">
        <div>
<p>I've been using the Pentadactyl Firefox extension for a long time. This
extensions "vimifies" Firefox and it does a very good job of it. This is
probably the best extension I have ever seen on any browser. This post is really
not against Pentadactyl, this is a great addon and it still works great.</p>
<p>However, I have been more and more dissatisfied of Mozilla Firefox over the
years. Indeed, the browser is becoming slower and slower all the time and I'm
experiencing more and more issues on Gentoo with it. But the biggest problem
I've with Firefox right now is the philosophy of the developers that is really
crappy. Currently, there is only one thing that is good in Firefox compared to
the other browsers, its extensions. Basically, an extension in Firefox can do
almost anything. Pentadactyl is able to transform most of the interface and get
rid of all of the useless parts of the interface. It is currently impossible to
do so in other browsers. These powerful addons are using the XUL/XPCOM
programming interface to do so. Pentadactyl is the only reason I've kept to
Firefox so long. But Firefox has announced, already more than a year ago, that
it will deprecate its XUL/XPCOM interface in favour of webextensions. This means
that a lot of very good addons will not be able to work anymore once the
deprecation has been completed. Several writers of popular Firefox have
announced that they will not even try to port their addons and some addons will
simply not be possible anymore. This is the case for Pentadactyl which is on the
line for when the deprecation occurs. The data for deprecated has already been
delayed but is likely to come anyway.</p>
<p>For several months, I've been looking at several possible replacements for my
current Pentadactyl browser. I've tried qutebrowser, but it is really too
limited in terms of features so far. I've also tried again Chromium which is
a great browser but unfortunately, there are very few possibilities for addons
to modify the interface. Vimium is a great addon for Chromium which is basically
the very much more lightweight alternative to Pentadactyl. It has much less
features, but most of the missing features are simply things that cannot be done
in Chromium.</p>
<p>Only recently did I test Vivaldi. Vivaldi is a free multi-platform browser,
based on Chromium and supporting Chromium extensions. The major difference with
Chrome is how the UI is customizable, due to the use of a dynamic UI, stylable
with CSS. With the customizability of Vivaldi plus the great shortcuts and
vim-like behaviour of vimium, I really feel like I found a new Pentadactyl with
the advantage of not having to bear Firefox!</p>
<p>Here is how it is looking with the follow URLs feature from vimium:</p>
<img alt="View of my Vivaldi browser" class="align-center" src="images/vivaldi.png"><p>Note: The gray bar on the left is the console to the left and the top kind of
bar is awesome wm, they are not part of the browser.</p>
<p>I'm using the dark theme with native windows. I've disabled the address bar,
moved the tab bar to the bottom and completely hidden the side panel. All that
remained was the title bar and the scroll bar.</p>
<p>To get rid of the title bar, you can use CSS. First, you have to only display
the Vivaldi button in the settings page. Then, you can use this custom CSS:</p>
<pre class="code CSS"><a name="rest_code_ba75722958d7422aaac58ae348465a34-1"></a><span class="nt">button</span><span class="nc">.vivaldi</span> <span class="p">{</span>
<a name="rest_code_ba75722958d7422aaac58ae348465a34-2"></a>    <span class="nb">display</span><span class="o">:</span> <span class="nb">none</span> <span class="cp">!important</span><span class="p">;</span>
<a name="rest_code_ba75722958d7422aaac58ae348465a34-3"></a><span class="p">}</span>
<a name="rest_code_ba75722958d7422aaac58ae348465a34-4"></a>
<a name="rest_code_ba75722958d7422aaac58ae348465a34-5"></a><span class="nn">#header</span> <span class="p">{</span>
<a name="rest_code_ba75722958d7422aaac58ae348465a34-6"></a>    <span class="nb">min-height</span><span class="o">:</span> <span class="m">0</span> <span class="cp">!important</span><span class="p">;</span>
<a name="rest_code_ba75722958d7422aaac58ae348465a34-7"></a>    <span class="nb">z-index</span><span class="o">:</span> <span class="nb">auto</span> <span class="cp">!important</span><span class="p">;</span>
<a name="rest_code_ba75722958d7422aaac58ae348465a34-8"></a><span class="p">}</span>
<a name="rest_code_ba75722958d7422aaac58ae348465a34-9"></a>
<a name="rest_code_ba75722958d7422aaac58ae348465a34-10"></a><span class="nc">.button-toolbar.home</span> <span class="p">{</span> <span class="nb">display</span><span class="o">:</span> <span class="nb">none</span> <span class="p">}</span>
</pre>
<p>to hide the title completely! To get rid of the scroll bar, you need to use the
Stylish extension and use this custom CSS:</p>
<pre class="code CSS"><a name="rest_code_3a8e36f0a354452e8cba7237a52027f1-1"></a><span class="o">:</span><span class="nd">:-webkit-scrollbar</span><span class="p">{</span><span class="nb">display</span><span class="o">:</span><span class="nb">none</span> <span class="cp">!important</span><span class="p">;</span> <span class="nb">width</span><span class="o">:</span><span class="m">0px</span><span class="p">;}</span>
<a name="rest_code_3a8e36f0a354452e8cba7237a52027f1-2"></a><span class="o">:</span><span class="nd">:-webkit-scrollbar-button</span><span class="o">,:</span><span class="nd">:-webkit-scrollbar-track</span><span class="p">{</span><span class="nb">display</span><span class="o">:</span><span class="nb">none</span> <span class="cp">!important</span><span class="p">;}</span>
<a name="rest_code_3a8e36f0a354452e8cba7237a52027f1-3"></a><span class="o">:</span><span class="nd">:-webkit-scrollbar-thumb</span><span class="p">{</span><span class="nb">display</span><span class="o">:</span> <span class="nb">none</span> <span class="cp">!important</span><span class="p">;}</span>
<a name="rest_code_3a8e36f0a354452e8cba7237a52027f1-4"></a><span class="o">:</span><span class="nd">:-webkit-scrollbar-track</span><span class="p">{</span><span class="nb">display</span><span class="o">:</span> <span class="nb">none</span> <span class="cp">!important</span><span class="p">;}</span>
</pre>
<p>And then, no more scroll bar :)</p>
<p>If you want to have full HTML5 video support, you need to install extra codecs.
On Gentoo, I've uploaded a ebuild on my overlay (wichtounet on layman) with the
name vivaldi-ffmpeg-codecs and everything should be working fine :)</p>
<p>Vimium is clearly inferior to Pentadactyl in that for instance it only works in
web page, not in system page and you still have to use the browser for a few
things, but it does not seem too bar so far. Moreover, I wasn't using all the
features of Pentadactyl. I haven't been used this browser for a long time, so
maybe there are things that I will miss from Pentadactyl, but I won't certainly
miss Firefox!</p>
</div>
        </div>
            
        
    <a href="posts/2017/01/vivaldi-vimium-finally-no-more-firefox.html#disqus_thread" data-disqus-identifier="cache/posts/2017/01/vivaldi-+-vimium-finally-no-more-firefox.html">Comments</a>


        </article><article class="postbox h-entry post-text"><h1 class="p-name">
<a href="posts/2017/01/new-home-automation-system-with-domoticz.html" class="u-url">New home automation system with Domoticz</a>
        <br><small>  
             Posted: <time class="published dt-published" datetime="2017-01-08T16:08:42+01:00">2017-01-08 16:08</time></small>
</h1>
        <hr>
<div class="p-summary">
        <div>
<p>As you may remember, I started going into Home Automation last year with a <a class="reference external" href="http://baptiste-wicht.com/posts/2016/08/asgard-home-automation-project.html">C++ project, Asgard</a>.</p>
<p>Unfortunately, I haven't add the time to improve this project further and make
it really useful and I have so many C++ projects already, so I decided to switch
to using an existing project.</p>
<div class="section" id="choice">
<h2>Choice</h2>
<p>I needed a system that was at least able to handle everything my existing system
does:</p>
<ol class="arabic simple">
<li>Control my RF-433 Temperature Sensors (Oregon Temperature Sensors)</li>
<li>Control my RF-433 Remote Button</li>
<li>Control my smart power outlets</li>
<li>Ping and wake-on-lan my different computers</li>
<li>Be installable on a Raspberry Pi</li>
<li>Control Skadi/Kodi Home Cinema</li>
</ol>
<p>Of course, it also had to be open source and in a language that I can write
without agonizing pain (no Ruby, no JavaScript, ideally no Python (I hate a lot
of languages...)).</p>
<p>It's impressive the number of home automation projects that exist today. It's
really a hot topic, more than I though. After a few hours of research, I've
finally settled on Domoticz. It seemed that it could handle all my home
automation devices that I already had. Domoticz is an open source home
automation system. It's written mainly in C++, which is an advantage for me
since I'll be able to work inside it if necessary. It has a quite modern HTML5
interface. It has a lot of support for hardware and a lot of bridges for other
controllers as well. One of the reason I chose it is also the floor-planner
feature that looks really cool.</p>
</div>
<div class="section" id="installation">
<h2>Installation</h2>
<p>First of all, I cleaned the hardware of my Raspberry Pi. I got rid of my
breadboard and the components on it. Then, I put the Raspberry Pi on a nicer box
that I had laying around. One problem with Domoticz is that it does not support
directly RF433 devices, but need a controller in the middle. At first,
I believed I could simply connect them through GPIO and lets Domoticz do the
rest, but it's not possible. I ordered the different pieces for a RFLink
controller at nodo-shops. It is running on a Arduino Mega and is connected to
the Pi. The very big advantage is that they handle a lot of protocols directly,
so you only have to read the serial port to get information on RF-433 events.</p>
<p>Here is how the current system look:</p>
<img alt="Asgard automation system hardware" class="align-center" src="images/home_automation_hardware.jpg"><p>The black box is the Arduino Mega with RFLink software while the Transparent is
simply the Raspberry on which Domoticz is installed.</p>
<p>As for the installation of Domoticz, it's really simple. They also have images of
Raspberry Pi directly, but since my Raspberry was already installed with
Raspbian, I installed Domoticz on it directly. A simple matter of curl and bash:</p>
<pre class="code bash"><a name="rest_code_99d875d64b634552ab6e96c4b3ebcf69-1"></a>sudo curl -L install.domoticz.com <span class="p">|</span> sudo bash
</pre>
<p>After a few questions, your installation should be complete. You can browse your
Domoticz installation at the IP of your Pi and at the given port.</p>
</div>
<div class="section" id="home-automation-with-domoticz">
<h2>Home Automation with Domoticz</h2>
<p>There are several concepts in Domoticz that are important. At first, it seemed
a bit weird to me, but in the end it works really well and you get used to it
pretty fast.</p>
<p>The first concept is the hardware. It is not necessary hardware directly, but
rather a driver to some piece of information of switches than a real hardware in
my opinion. For instance, the RFLink Gateway is considered hardware as well as
the Forecast weather API. Here is all the hardware I've configured:</p>
<img alt="Domoticz Hardware Configuration" class="align-center" src="images/domoticz_hardware.png"><p>I've got some sensors from the motherboard, the Kodi interaction, the driver to
ping the different computers, the Forecast weather with Dark Sky and Weather
Underground, the RFLink communication, the wake-on-lan and some dummies virtual
switches.</p>
<p>On its own, an hardware is useless, but it can create devices that will be used
for home automation. A device is sub device of a particular driver. In some
cases, the devices will be created automatically. For instance, RF Link can
create devices as soon as they are detected. For wake-on-lan, you have to
configure MAC Addresses and they will be added as devices. And so on...</p>
<p>There are a lot of types of devices, also called switches. Some devices can do
some actions, for instance the wake-on-lan devices, while others are information
based such as ping or temperature sensors detected from the RFLink. For
instance, here are my temperature sensors:</p>
<img alt="Domoticz Temperature Sensors" class="align-center" src="images/domoticz_temperature.png"><p>As for my hardware I already had, I haven't add too many issues with them. The
Oregon Temperature Sensors worked out of the box without any issues as well my
old RF433 Ninja Block temperature sensor. The smart power outlets have been
pretty easy to use as well. The most problem I've add was with the remote
buttons. It seems to many that it should be the easiest, but RFLink has a lot of
problem with them, they are detected several times and are highly unreliable.
Interestingly you can also change the icon of most device to a large variety of
existing devices so that they would look more realistic.</p>
<p>Another feature I find pretty cool is the floor plan. You can create plans for
each floor of your house and then create rooms inside and finally attach devices
to each room and place inside the plan. Unfortunately, to draw the plan, you'll
have to use an external tool. I've used floorplanner for this, but you may use
any plan you have as long as you have an image.</p>
<p>Here is my floor plan with the devices (the scale is terribly off :P) :</p>
<img alt="Domoticz Floor Plan" class="align-center" src="images/domoticz_floorplan.png"><p>With that you can directly see the status of each of your sensors in each room.
Moreover, you can also activate some devices directly from the floor plan as
well :)</p>
<p>Normally, my Somfy blinds are supposed to work with the RFLink controller.
I have managed to control my blinds but only when the RFLink was within 50
centimeters of the Blinds, which is clearly not acceptable. I don't know from
where the problem comes. It may come from my Blinds controller inside the wall
or may come from bad antenna of the RFLink or from a bug in RFLink, so from now
I cannot control my blinds.</p>
<p>I have several D-Link cameras at home. You can also add cameras to Domoticz, but
don't expect a lot of support on this side. It's pretty poor indeed. The only
useful you can do in Domoticz with Cameras is to take a screenshot from them.
You cannot control the Camera or even have a decent video stream and cannot do
motion detection directly. I hope that the Camera support will improve in the
future. One thing that would be good is to add a view of the cameras in the
floor plan, but it is not possible currently.</p>
<p>What I did is to use Zoneminder to manage the cameras and send alert to Domoticz
when motion is detect with the REST API of Domoticz. Unfortunately that means
two systems to manage the Cameras. Zoneminder is a very good piece of software,
but one of the ugliest I've ever seen (even I can do a better web interface...)
and quite obscure to configure. But the numbers of cameras it can handle and the
capabilities to control the camera is very very powerful.</p>
</div>
<div class="section" id="events-and-actions">
<h2>Events and actions</h2>
<p>No home automation system would be complete without an events and rules system.
In Domoticz, you have several ways to create rules.</p>
<p>The first solution is to create group. A group is simply a set of switches that
are all activated together. This is pretty limited, but can be useful. The
second solution is a scene. A scene is activated by a device and can set several
switches to on or off after the activation. The problem with this is that you
have to listen for an action as activation, you cannot use an existing device or
a rule with a value. For me, these two possibilities are way too limited and
I don't really a reason to use them.</p>
<p>The best solution is to script an handler. For that, there are two ways, either
you define visually your script with blocky, for instance:</p>
<img alt="Domoticz Blockly Rule" class="align-center" src="images/domoticz_blockly.png"><p>This seemed so cool that I wanted to do all my rules with that. Unfortunately,
it is really limited. The main limitation is that you cannot nest if blocks. In
fact the interface lets you do, but it doesn't work afterwards. The other
limitation is that it has no notion of time. For instance, it's very hard to
create an action if a computer is shutdown for more than 60 seconds. You can do
it, but you end up creating virtual devices which are turned off after some
delay and it gets really complicated really soon...</p>
<p>In the end, I used Lua script directly. These scripts have the information about
the last values of each device and the last updated time as well. It's much
easier with that to create powerful rules especially when you want a notion of
time. There are plenty of examples on the Domoticz forum about very powerful
rules that you can create. Unfortunately, there are some limitations. For
instance, you cannot send several actions to the same device in the same script
Moreover, you also have to decode the values of the sensors yourself. For
instance, for a temperature and humidity sensor, you'll have to parse the values
and extract the one you need by hand.</p>
<p>So far, I haven't created many rules, only four. The first rule is that with the
push of one remote button I can power on my smart socket and turn on one of my
computers in my office. Then, if both the computers on this smart sockets have
been off for more than 60 seconds, the power is shut off on the smart socket.
And I have done almost the same for my media center and TV in my living room.</p>
<p>In the future, I'll probably only use the Lua scripting capability. In my
opinion, it's better to have all the scripts in the same language for
maintainability reasons. Once my futures devices arrive, I'll have a few more
rules to code.</p>
</div>
<div class="section" id="conclusion">
<h2>Conclusion</h2>
<p>To wrap up, I'd say that I'm pretty satisfied with my new home automation system
with Domoticz. It's not a perfect tool, but it has a lot of features and is
working quite well in general. I would recommend you to try it if you want
a good home automation system, fully featured and relatively easy to use.</p>
<p>I've several more things planned for this system. I plan to test a real motion
sensor rather than rely only on the cameras which are focused on the doors and
windows. I also plan to add an outdoor temperature sensor. And more
interestingly, I'm going to try to integrate smart bulbs from Milight to be able
to control my lights from the system. These are the shot term projects that
I want to do, but I have many more ideas!</p>
<p>I'm also sure that there are some features from Domoticz that I have overlooked
or not discovered.</p>
<p>I'll probably write more posts on Home Automation on the coming months.</p>
<p>For more information on Domoticz, you can consult
<a class="reference external" href="http://domoticz.com/">the official Domoticz website</a>.</p>
</div>
</div>
        </div>
            
        
    <a href="posts/2017/01/new-home-automation-system-with-domoticz.html#disqus_thread" data-disqus-identifier="cache/posts/2017/01/new-home-automation-system-with-domoticz.html">Comments</a>


        </article><article class="postbox h-entry post-text"><h1 class="p-name">
<a href="posts/2016/12/pvs-studio-on-cpp-library-review.html" class="u-url">PVS-Studio on C++ Library Review</a>
        <br><small>  
             Posted: <time class="published dt-published" datetime="2016-12-20T09:40:12+01:00">2016-12-20 09:40</time></small>
</h1>
        <hr>
<div class="p-summary">
        <div>
<p>PVS-Studio is a commercial static analyzer for C, C++ and C#. It works in both
Windows and Linux.</p>
<p>It has been a long time since I wanted to test it on my projects. I contacted
The PVS-Studio team and they gave me a temporary license so that I can test the
tool and make a review.</p>
<p>I tried the static analyzer on my Expression Templates Library (ETL) project.
This is a heavily-templated C++ library. I tried it on Linux of course.</p>
<div class="section" id="usage">
<h2>Usage</h2>
<p>The installation is very simple, simply untar an archive and put the executables
in your PATH (or use absolute paths). There are also some deb and rpm packages
for some distributions. You need strace to make the analyzer work, it should be
available on any Linux platform.</p>
<p>The usage of PVS-Studio on Linux should be straightforward. First, you can use the
analyzer directly with make and it will detect the invocations of the compiler.
For instance, here is the command I used for ETL:</p>
<pre class="code text"><a name="rest_code_44396ac984724de5baf642249d8b1b1b-1"></a>pvs-studio-analyzer trace -- make -j5 debug/bin/etl_test
</pre>
<p>Note that you can use several threads without issues, which is really great.
There does not seem to be any slowdown at this stage, probably only collecting
compiler arguments.</p>
<p>This first step creates a strace_out file that will be used by the next stage.</p>
<p>Once, the compilation has been analyzed, you can generate the results with the
analyze function, for which you'll need a license. Here is what I did:</p>
<pre class="code text"><a name="rest_code_7bb49910aa3e424f990d0dc4f71bf88a-1"></a>pvs-studio-analyzer analyze -l ~/pvs_studio/PVS-Studio.lic -j5
</pre>
<p>Unfortunately, this didn't work for me:</p>
<pre class="code text"><a name="rest_code_c289ffebcbec48ab9098134a934aa153-1"></a>No compilation units found
<a name="rest_code_c289ffebcbec48ab9098134a934aa153-2"></a>Analysis finished in 0:00:00.00
</pre>
<p>Apparently, it's not able to use the strace_out it generated itself...</p>
<p>Another possibility is to use the compilation database from clang to use
PVS-Studio. So I generated my compile_commands.json file again (it was not up to
date...) with <a class="reference external" href="https://github.com/rizsotto/Bear">Bear</a>. And then, you only
need to run the analyze step:</p>
<pre class="code text"><a name="rest_code_a99e73de15ab4e77aee8375613e6f487-1"></a>pvs-studio-analyzer analyze -l ~/pvs_studio/PVS-Studio.lic -j5
</pre>
<p>Make sure you have the same compiler configured than the one used to generate
the compilation database to avoid errors with compiler arguments.</p>
<p>Unfortunately, this just printed a load of crap on my console:</p>
<pre class="code text"><a name="rest_code_b61137b790ed450e9402de88b4c2fbcc-1"></a>(L8Pu(]-'Lo8h&gt;uo(_uv(uo2(-&gt;'2h_u(uo2(uvU2K h&gt;'o8a=}Lkk;x[G^%cuaa8acr[VS%
<a name="rest_code_b61137b790ed450e9402de88b4c2fbcc-2"></a>$ckUaoc8 c'8&gt;_-o-8&gt;U2cu/kau==-8&gt;c-=cU2]Uf=c U2=u%c&amp;kU__-&gt;j}c@uvu2%cJ
<a name="rest_code_b61137b790ed450e9402de88b4c2fbcc-3"></a>(L8Pu(]-'Lo8h&gt;uo(_uv(uo2(-&gt;'2h_u(uo2(uvU2K h&gt;'o8a=}Lkk;JVJ^%cuaa8acr[VS%
<a name="rest_code_b61137b790ed450e9402de88b4c2fbcc-4"></a>$ckUaoc8 c'8&gt;_-o-8&gt;U2cu/kau==-8&gt;c-=cU2]Uf=c U2=u%c&amp;kU__-&gt;j}c@uvu2%cJ
<a name="rest_code_b61137b790ed450e9402de88b4c2fbcc-5"></a>(L8Pu(]-'Lo8h&gt;uo(_uv(uo2(-&gt;'2h_u(uo2(uvU2K h&gt;'o8a=}Lkk;*[G^%cuaa8acr[VS%
<a name="rest_code_b61137b790ed450e9402de88b4c2fbcc-6"></a>$ckUaoc8 c'8&gt;_-o-8&gt;U2cu/kau==-8&gt;c-=cU2]Uf=c U2=u%c&amp;kU__-&gt;j}c@uvu2%cJ
<a name="rest_code_b61137b790ed450e9402de88b4c2fbcc-7"></a>(L8Pu(]-'Lo8h&gt;uo(_uv(uo2(-&gt;'2h_u(uo2(uvU2K h&gt;'o8a=}Lkk;b[b^%cuaa8acr[VS%
<a name="rest_code_b61137b790ed450e9402de88b4c2fbcc-8"></a>$ckUaoc8 c'8&gt;_-o-8&gt;U2cu/kau==-8&gt;c-=cU2]Uf=c U2=u%c&amp;kU__-&gt;j}c@uvu2%cJ
<a name="rest_code_b61137b790ed450e9402de88b4c2fbcc-9"></a>(L8Pu(]-'Lo8h&gt;uo(_uv(uo2(-&gt;'2h_u(uo2(uvU2K h&gt;'o8a=}Lkk;[[x^%cuaa8acr[VS%
<a name="rest_code_b61137b790ed450e9402de88b4c2fbcc-10"></a>$ckUaoc8 c'8&gt;_-o-8&gt;U2cu/kau==-8&gt;c-=cU2]Uf=c U2=u%c&amp;kU__-&gt;j}c@uvu2%cJ
</pre>
<p>Pretty nice, isn't it ?</p>
<p>Let's try again in a file:</p>
<pre class="code text"><a name="rest_code_01c76ef92a904311bc9f4bc8c7cfb2ca-1"></a>pvs-studio-analyzer analyze -o results.log -l ~/pvs_studio/PVS-Studio.lic -j5
</pre>
<p>The time is quite reasonable for the analysis, it took much less time than the
compilation time. In total, it took 88 seconds to analyze all the files. It's
much faster than the clang static analyzer.</p>
<p>This time it worked, but the log file is not readable, you need to convert it
again:</p>
<pre class="code text"><a name="rest_code_441cd40154814f3b8df891575b8d5694-1"></a>plog-converter -t errorfile -o errors results.log
</pre>
<p>And finally, you can read the results of the analysis in the errors file.</p>
</div>
<div class="section" id="results">
<h2>Results</h2>
<p>Overall, PVS-Studio found 236 messages in the ETL library, I was expecting more.
I also wish there was an HTML report that include the source code as well as the
error message. I had to lookup at the code for each message (you could integrate
it in vim and then use the quickfix window to do that). There are some
visualization but in things like QtCreator or LibreOffice which I don't have nor
want on my computer.</p>
<p>Let's look at the results. For each message, I'll include the message from
PVS-Studio and the code if it's relevant.</p>
<p>The first is about using the comma:</p>
<pre class="code text"><a name="rest_code_eac1f9450eb243338cdf0679d99b35f1-1"></a>include/etl/traits.hpp:674:1: error: V521 Such expressions using the ',' operator are dangerous. Make sure the expression is correct.
<a name="rest_code_eac1f9450eb243338cdf0679d99b35f1-2"></a>include/etl/traits.hpp:674:1: error: V685 Consider inspecting the return statement. The expression contains a comma.
</pre>
<pre class="code cpp"><a name="rest_code_c59b6a60d74847c28ef4a79509527e76-1"></a><span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">E</span><span class="o">&gt;</span>
<a name="rest_code_c59b6a60d74847c28ef4a79509527e76-2"></a><span class="k">constexpr</span> <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">dimensions</span><span class="p">(</span><span class="k">const</span> <span class="n">E</span><span class="o">&amp;</span> <span class="n">expr</span><span class="p">)</span> <span class="k">noexcept</span> <span class="p">{</span>
<a name="rest_code_c59b6a60d74847c28ef4a79509527e76-3"></a>    <span class="k">return</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">expr</span><span class="p">,</span> <span class="n">etl_traits</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;::</span><span class="n">dimensions</span><span class="p">();</span>
<a name="rest_code_c59b6a60d74847c28ef4a79509527e76-4"></a><span class="p">}</span>
</pre>
<p>Here I'm simply using the comma operand to ignore expr to avoid a warning. To
make this compile in C++11, you need to do it in one line otherwise it's not
a constexpr function. It's probably not perfect to use this construct, but there
is no problem here.</p>
<p>There is a bunch of these, let's filter them, it remains 207 warnings. Let's
jump to the next one:</p>
<pre class="code text"><a name="rest_code_a48dcc1d9c38457486d13564182a7e55-1"></a>include/etl/impl/blas/fft.hpp:29:1: error: V501 There are identical sub-expressions to the left and to the right of the '==' operator: (DFTI_SINGLE) == DFTI_SINGLE
</pre>
<pre class="code cpp"><a name="rest_code_582aa25275464bcf8c85d63c940e6439-1"></a><span class="kr">inline</span> <span class="kt">void</span> <span class="nf">fft_kernel</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">complex</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;*</span> <span class="n">in</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">s</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">complex</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;*</span> <span class="n">out</span><span class="p">)</span> <span class="p">{</span>
<a name="rest_code_582aa25275464bcf8c85d63c940e6439-2"></a>    <span class="n">DFTI_DESCRIPTOR_HANDLE</span> <span class="n">descriptor</span><span class="p">;</span>
<a name="rest_code_582aa25275464bcf8c85d63c940e6439-3"></a>
<a name="rest_code_582aa25275464bcf8c85d63c940e6439-4"></a>    <span class="kt">void</span><span class="o">*</span> <span class="n">in_ptr</span> <span class="o">=</span> <span class="k">const_cast</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">*&gt;</span><span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="kt">void</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">in</span><span class="p">));</span>
<a name="rest_code_582aa25275464bcf8c85d63c940e6439-5"></a>
<a name="rest_code_582aa25275464bcf8c85d63c940e6439-6"></a>    <span class="n">DftiCreateDescriptor</span><span class="p">(</span><span class="o">&amp;</span><span class="n">descriptor</span><span class="p">,</span> <span class="n">DFTI_SINGLE</span><span class="p">,</span> <span class="n">DFTI_COMPLEX</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span> <span class="c1">//Specify size and precision</span>
<a name="rest_code_582aa25275464bcf8c85d63c940e6439-7"></a>    <span class="n">DftiSetValue</span><span class="p">(</span><span class="n">descriptor</span><span class="p">,</span> <span class="n">DFTI_PLACEMENT</span><span class="p">,</span> <span class="n">DFTI_NOT_INPLACE</span><span class="p">);</span>         <span class="c1">//Out of place FFT</span>
<a name="rest_code_582aa25275464bcf8c85d63c940e6439-8"></a>    <span class="n">DftiCommitDescriptor</span><span class="p">(</span><span class="n">descriptor</span><span class="p">);</span>                                   <span class="c1">//Finalize the descriptor</span>
<a name="rest_code_582aa25275464bcf8c85d63c940e6439-9"></a>    <span class="n">DftiComputeForward</span><span class="p">(</span><span class="n">descriptor</span><span class="p">,</span> <span class="n">in_ptr</span><span class="p">,</span> <span class="n">out</span><span class="p">);</span>                        <span class="c1">//Compute the Forward FFT</span>
<a name="rest_code_582aa25275464bcf8c85d63c940e6439-10"></a>    <span class="n">DftiFreeDescriptor</span><span class="p">(</span><span class="o">&amp;</span><span class="n">descriptor</span><span class="p">);</span>                                    <span class="c1">//Free the descriptor</span>
<a name="rest_code_582aa25275464bcf8c85d63c940e6439-11"></a><span class="p">}</span>
</pre>
<p>Unfortunately, the error is inside the MKL library. Here, I really don't think
it's an issue. There is pack of them. I forgot to exclude non-ETL code from the
results. Once filter from all dependencies, 137 messages remain.</p>
<pre class="code text"><a name="rest_code_4b72670377c4423085b4504d130f3fd2-1"></a>include/etl/eval_functors.hpp:157:1: warning: V560 A part of conditional expression is always false: !padding.
</pre>
<p>This is true, but not an issue since padding is a configuration constant that
enables the use of padding in vector and matrices. There was 27 of these at
different locations and with different configuration variables.</p>
<pre class="code text"><a name="rest_code_c1c292c6d36c4a1b87b8de34b4cf8ba2-1"></a>include/etl/op/sub_view.hpp:161:1: note: V688 The 'i' function argument possesses the same name as one of the class members, which can result in a confusion.
</pre>
<p>This is again true, but not a bug in this particular case. It is still helpful and
I ended up changing these to avoid confusion. Again, there was a few of these.</p>
<pre class="code text"><a name="rest_code_6605e51b88374972a6cb24048d55d27d-1"></a>etl/test/src/conv_multi_multi.cpp:23:1: error: V573 Uninitialized variable 'k' was used. The variable was used to initialize itself.
</pre>
<p>This one is in the test code:</p>
<pre class="code cpp"><a name="rest_code_07702aae3524443eb8a07687541e50eb-1"></a><span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">etl</span><span class="o">::</span><span class="n">dim</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">(</span><span class="n">K</span><span class="p">);</span> <span class="o">++</span><span class="n">k</span><span class="p">)</span> <span class="p">{</span>
<a name="rest_code_07702aae3524443eb8a07687541e50eb-2"></a>    <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">etl</span><span class="o">::</span><span class="n">dim</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">(</span><span class="n">I</span><span class="p">);</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
<a name="rest_code_07702aae3524443eb8a07687541e50eb-3"></a>        <span class="n">C_ref</span><span class="p">(</span><span class="n">k</span><span class="p">)(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">conv_2d_valid</span><span class="p">(</span><span class="n">I</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">K</span><span class="p">(</span><span class="n">k</span><span class="p">));</span> <span class="c1">// HERE</span>
<a name="rest_code_07702aae3524443eb8a07687541e50eb-4"></a>    <span class="p">}</span>
<a name="rest_code_07702aae3524443eb8a07687541e50eb-5"></a><span class="p">}</span>
</pre>
<p>I don't see any error, k is initialized correctly to zero in the first loop.
This is a <strong>false positive</strong> for me. There were several of these in different
places. It seems to that the use of the operator() is confusing for PVS-Studio.</p>
<pre class="code text"><a name="rest_code_c14241f3adb64607965eba61f4350a43-1"></a>include/etl/traits.hpp:703:1: note: V659 Declarations of functions with 'rows' name differ in the 'const' keyword only, but the bodies of these functions have different composition. This is suspicious and can possibly be an error. Check lines: 693, 703.
</pre>
<pre class="code cpp"><a name="rest_code_dcc14551bd6546bba9ab43ac9ae281df-1"></a><span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">E</span><span class="p">,</span> <span class="n">cpp_disable_if</span><span class="p">(</span><span class="n">decay_traits</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;::</span><span class="n">is_fast</span><span class="p">)</span><span class="o">&gt;</span>
<a name="rest_code_dcc14551bd6546bba9ab43ac9ae281df-2"></a><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">rows</span><span class="p">(</span><span class="k">const</span> <span class="n">E</span><span class="o">&amp;</span> <span class="n">expr</span><span class="p">)</span> <span class="p">{</span> <span class="c1">//693</span>
<a name="rest_code_dcc14551bd6546bba9ab43ac9ae281df-3"></a>    <span class="k">return</span> <span class="n">etl_traits</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;::</span><span class="n">dim</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<a name="rest_code_dcc14551bd6546bba9ab43ac9ae281df-4"></a><span class="p">}</span>
<a name="rest_code_dcc14551bd6546bba9ab43ac9ae281df-5"></a>
<a name="rest_code_dcc14551bd6546bba9ab43ac9ae281df-6"></a><span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">E</span><span class="p">,</span> <span class="n">cpp_enable_if</span><span class="p">(</span><span class="n">decay_traits</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;::</span><span class="n">is_fast</span><span class="p">)</span><span class="o">&gt;</span>
<a name="rest_code_dcc14551bd6546bba9ab43ac9ae281df-7"></a><span class="k">constexpr</span> <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">rows</span><span class="p">(</span><span class="k">const</span> <span class="n">E</span><span class="o">&amp;</span> <span class="n">expr</span><span class="p">)</span> <span class="k">noexcept</span> <span class="p">{</span> <span class="c1">//703</span>
<a name="rest_code_dcc14551bd6546bba9ab43ac9ae281df-8"></a>    <span class="k">return</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">expr</span><span class="p">,</span> <span class="n">etl_traits</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;::</span><span class="k">template</span> <span class="n">dim</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">();</span>
<a name="rest_code_dcc14551bd6546bba9ab43ac9ae281df-9"></a><span class="p">}</span>
</pre>
<p>Unfortunately, this is again a <strong>false positive</strong> because PVS-Studio failed to
recognized SFINAE and therefore the warning is wrong.</p>
<pre class="code text"><a name="rest_code_e861d2202b0b457484c042af68e34349-1"></a>include/etl/builder/expression_builder.hpp:345:1: note: V524 It is odd that the body of '&gt;&gt;=' function is fully equivalent to the body of '*=' function.
</pre>
<p>This one is interesting indeed. It is true that they are exactly because in ETL
&gt;&gt; is used for scalar element-wise multiplication. This is quite interesting that
PVS-Studio points that out. There was a few of these oddities but all were
normal in the library.</p>
<pre class="code text"><a name="rest_code_ff2627f03f674dc79415db0650c57802-1"></a>etl/test/src/compare.cpp:23:1: error: V501 There are identical sub-expressions to the left and to the right of the '!=' operator: a != a
</pre>
<p>Again, it is nice that PVS-Studio finds that, but this is done on purpose on the
tests to compare an object to itself. If I remove all the oddities in the test
cases, there are only 17 left in the headers. None of the warnings on the test
case was serious, but there was no more false positives either, so that's great.</p>
<pre class="code text"><a name="rest_code_f7f25213556d4ac298975968ed81caa4-1"></a>include/etl/impl/vec/sum.hpp:92:1: error: V591 Non-void function should return a value.
</pre>
<pre class="code cpp"><a name="rest_code_8ed0f728a961493a9a88937bf35de0a7-1"></a><span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">L</span><span class="p">,</span> <span class="n">cpp_disable_if</span><span class="p">((</span><span class="n">vec_enabled</span> <span class="o">&amp;&amp;</span> <span class="n">all_vectorizable</span><span class="o">&lt;</span><span class="n">vector_mode</span><span class="p">,</span> <span class="n">L</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">))</span><span class="o">&gt;</span>
<a name="rest_code_8ed0f728a961493a9a88937bf35de0a7-2"></a><span class="n">value_t</span><span class="o">&lt;</span><span class="n">L</span><span class="o">&gt;</span> <span class="n">sum</span><span class="p">(</span><span class="k">const</span> <span class="n">L</span><span class="o">&amp;</span> <span class="n">lhs</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">first</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">last</span><span class="p">)</span> <span class="p">{</span>
<a name="rest_code_8ed0f728a961493a9a88937bf35de0a7-3"></a>    <span class="n">cpp_unused</span><span class="p">(</span><span class="n">lhs</span><span class="p">);</span>
<a name="rest_code_8ed0f728a961493a9a88937bf35de0a7-4"></a>    <span class="n">cpp_unused</span><span class="p">(</span><span class="n">first</span><span class="p">);</span>
<a name="rest_code_8ed0f728a961493a9a88937bf35de0a7-5"></a>    <span class="n">cpp_unused</span><span class="p">(</span><span class="n">last</span><span class="p">);</span>
<a name="rest_code_8ed0f728a961493a9a88937bf35de0a7-6"></a>    <span class="n">cpp_unreachable</span><span class="p">(</span><span class="s">"vec::sum called with invalid parameters"</span><span class="p">);</span>
<a name="rest_code_8ed0f728a961493a9a88937bf35de0a7-7"></a><span class="p">}</span>
</pre>
<p>This one is interesting. It's not a false positive since indeed the function
does not return a value, but there is a __builtin_unreachable() inside the
function and it cannot be called. In my opinion, the static analyzer should be
able to handle that, but this is really a corner case.</p>
<pre class="code text"><a name="rest_code_4b28ce4a2b3941abb4758ef27b156051-1"></a>include/etl/sparse.hpp:148:1: note: V550 An odd precise comparison: a == 0.0. It's probably better to use a comparison with defined precision: fabs(A - B) &lt; Epsilon.
</pre>
<pre class="code cpp"><a name="rest_code_1abfdee9913e4f0697f3ea17f5338c48-1"></a><span class="kr">inline</span> <span class="kt">bool</span> <span class="nf">is_zero</span><span class="p">(</span><span class="kt">double</span> <span class="n">a</span><span class="p">)</span> <span class="p">{</span>
<a name="rest_code_1abfdee9913e4f0697f3ea17f5338c48-2"></a>    <span class="k">return</span> <span class="n">a</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">;</span>
<a name="rest_code_1abfdee9913e4f0697f3ea17f5338c48-3"></a><span class="p">}</span>
</pre>
<p>This is not false, but again this is intended because of the comparison to zero
for a sparse matrix. There were 10 of these in the same class.</p>
<pre class="code text"><a name="rest_code_28d6d048cdca4e2ca9e957f7d41bf10e-1"></a>include/etl/impl/blas/fft.hpp:562:1: note: V656 Variables 'a_padded', 'b_padded' are initialized through the call to the same function. It's probably an error or un-optimized code. Consider inspecting the 'etl::size(c)' expression. Check lines: 561, 562.
</pre>
<pre class="code cpp"><a name="rest_code_0d7beca8c57d402996b8476695148e9e-1"></a><span class="n">dyn_vector</span><span class="o">&lt;</span><span class="n">etl</span><span class="o">::</span><span class="n">complex</span><span class="o">&lt;</span><span class="n">type</span><span class="o">&gt;&gt;</span> <span class="n">a_padded</span><span class="p">(</span><span class="n">etl</span><span class="o">::</span><span class="n">size</span><span class="p">(</span><span class="n">c</span><span class="p">));</span>
<a name="rest_code_0d7beca8c57d402996b8476695148e9e-2"></a><span class="n">dyn_vector</span><span class="o">&lt;</span><span class="n">etl</span><span class="o">::</span><span class="n">complex</span><span class="o">&lt;</span><span class="n">type</span><span class="o">&gt;&gt;</span> <span class="n">b_padded</span><span class="p">(</span><span class="n">etl</span><span class="o">::</span><span class="n">size</span><span class="p">(</span><span class="n">c</span><span class="p">));</span>
</pre>
<p>It's indeed constructed with the same size, but for me I don't think it's an
odd pattern. I would not consider that as a warning, especially since it's
a constructor and not a assignment.</p>
<pre class="code text"><a name="rest_code_18635a9f63cb4c48ac770d27dcbf469a-1"></a>include/etl/dyn_base.hpp:312:1: warning: V690 The 'dense_dyn_base' class implements a copy constructor, but lacks the '=' operator. It is dangerous to use such a class.
</pre>
<p>This is again a kind of corner case in the library because it's a base class
and the assignment is different between the sub classes and not a real
assignment in the C++ sense.</p>
<pre class="code text"><a name="rest_code_2eac308db4654a8f9d8695dee69bd00a-1"></a>include/etl/impl/reduc/conv_multi.hpp:657:1: warning: V711 It is dangerous to create a local variable within a loop with a same name as a variable controlling this loop.
</pre>
<pre class="code cpp"><a name="rest_code_9d9d311c836d4e1baa0c1ddbe98f9985-1"></a><span class="k">for</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="n">C</span><span class="p">;</span> <span class="o">++</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
<a name="rest_code_9d9d311c836d4e1baa0c1ddbe98f9985-2"></a>    <span class="k">for</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">K</span><span class="p">;</span> <span class="o">++</span><span class="n">k</span><span class="p">)</span> <span class="p">{</span>
<a name="rest_code_9d9d311c836d4e1baa0c1ddbe98f9985-3"></a>        <span class="n">conv</span><span class="p">(</span><span class="n">k</span><span class="p">)(</span><span class="n">c</span><span class="p">)</span> <span class="o">=</span> <span class="n">conv_temp</span><span class="p">(</span><span class="n">c</span><span class="p">)(</span><span class="n">k</span><span class="p">);</span>
<a name="rest_code_9d9d311c836d4e1baa0c1ddbe98f9985-4"></a>    <span class="p">}</span>
<a name="rest_code_9d9d311c836d4e1baa0c1ddbe98f9985-5"></a><span class="p">}</span>
</pre>
<p>This is again a false positive... It really seems that PVS-Studio is not able to
handle the operator().</p>
<pre class="code text"><a name="rest_code_3f1773c3cc104044979434a5bafc0e46-1"></a>include/etl/impl/pooling.hpp:396:1: error: V501 There are identical sub-expressions to the left and to the right of the '||' operator: P1 || P2 || P1
</pre>
<pre class="code cpp"><a name="rest_code_b8328798421d4e18b8ed8e4cb55b7bd8-1"></a><span class="k">template</span> <span class="o">&lt;</span><span class="kt">size_t</span> <span class="n">C1</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">C2</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">C3</span><span class="p">,</span><span class="kt">size_t</span> <span class="n">S1</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">S2</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">S3</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">P1</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">P2</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">P3</span><span class="p">,</span> <span class="k">typename</span> <span class="n">A</span><span class="p">,</span> <span class="k">typename</span> <span class="n">M</span><span class="o">&gt;</span>
<a name="rest_code_b8328798421d4e18b8ed8e4cb55b7bd8-2"></a><span class="k">static</span> <span class="kt">void</span> <span class="n">apply</span><span class="p">(</span><span class="k">const</span> <span class="n">A</span><span class="o">&amp;</span> <span class="n">sub</span><span class="p">,</span> <span class="n">M</span><span class="o">&amp;&amp;</span> <span class="n">m</span><span class="p">)</span> <span class="p">{</span>
<a name="rest_code_b8328798421d4e18b8ed8e4cb55b7bd8-3"></a>    <span class="k">const</span> <span class="kt">size_t</span> <span class="n">o1</span> <span class="o">=</span> <span class="p">(</span><span class="n">etl</span><span class="o">::</span><span class="n">dim</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">(</span><span class="n">sub</span><span class="p">)</span> <span class="o">-</span> <span class="n">C1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">P1</span><span class="p">)</span> <span class="o">/</span> <span class="n">S1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<a name="rest_code_b8328798421d4e18b8ed8e4cb55b7bd8-4"></a>    <span class="k">const</span> <span class="kt">size_t</span> <span class="n">o2</span> <span class="o">=</span> <span class="p">(</span><span class="n">etl</span><span class="o">::</span><span class="n">dim</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">(</span><span class="n">sub</span><span class="p">)</span> <span class="o">-</span> <span class="n">C2</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">P2</span><span class="p">)</span> <span class="o">/</span> <span class="n">S2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<a name="rest_code_b8328798421d4e18b8ed8e4cb55b7bd8-5"></a>    <span class="k">const</span> <span class="kt">size_t</span> <span class="n">o3</span> <span class="o">=</span> <span class="p">(</span><span class="n">etl</span><span class="o">::</span><span class="n">dim</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="p">(</span><span class="n">sub</span><span class="p">)</span> <span class="o">-</span> <span class="n">C3</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">P3</span><span class="p">)</span> <span class="o">/</span> <span class="n">S3</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<a name="rest_code_b8328798421d4e18b8ed8e4cb55b7bd8-6"></a>
<a name="rest_code_b8328798421d4e18b8ed8e4cb55b7bd8-7"></a>    <span class="k">if</span><span class="p">(</span><span class="n">P1</span> <span class="o">||</span> <span class="n">P2</span> <span class="o">||</span> <span class="n">P1</span><span class="p">){</span>
</pre>
<p>Last but not least, this time, it's entirely true and it's in fact a bug in my
code! The condition should be written like this:</p>
<pre class="code cpp"><a name="rest_code_6d36019a11d94ce7afe8d4821a5d994d-1"></a><span class="k">if</span><span class="p">(</span><span class="n">P1</span> <span class="o">||</span> <span class="n">P2</span> <span class="o">||</span> <span class="n">P3</span><span class="p">){</span>
</pre>
<p>This is now fixed in the master of ETL.</p>
</div>
<div class="section" id="conclusion">
<h2>Conclusion</h2>
<p>The installation was pretty easy, but the usage was not as easy as it could
because the first method by analyzing the build system did not work.
Fortunately, the system supports using the Clang compilation database directly
and therefore it was possible to use.</p>
<p>Overall, it found 236 warnings on my code base (heavily templated library).
Around 50 of them were in some of the extend libraries, but I forgot to filter
them out. The quality of the results is pretty good in my opinion. It was able
to <strong>find a bug</strong> in my implementation of pooling with padding. Unfortunately,
there was quite a few false positives, due to SFINAE, bad handling of the
operator() and no handling of __builtin_unreachable. The remaining were all
correct, but were not bug considering their usages.</p>
<p>To conclude, I think it's a great static analyzer that is really fast compared
to other one in the market. There are a few false positives, but it's really not
bad compared to other tools and some of the messages are really great. An HTML
report including the source code would be great as well.</p>
<p>If you want more information, you can consult
<a class="reference external" href="http://www.viva64.com/en/pvs-studio/">the official site</a>. There is even a way
to use it on open-source code for free, but you have to add comments on top of
each of your files.</p>
<p>I hope it was helpful ;)</p>
</div>
</div>
        </div>
            
        
    <a href="posts/2016/12/pvs-studio-on-cpp-library-review.html#disqus_thread" data-disqus-identifier="cache/posts/2016/12/pvs-studio-on-cpp-library-review.html">Comments</a>


        </article><article class="postbox h-entry post-text"><h1 class="p-name">
<a href="posts/2016/12/cpp-compiler-benchmark-on-expression-templates-library-etl.html" class="u-url">C++ Compiler benchmark on Expression Templates Library (ETL)</a>
        <br><small>  
             Posted: <time class="published dt-published" datetime="2016-12-11T14:17:30+01:00">2016-12-11 14:17</time></small>
</h1>
        <hr>
<div class="p-summary">
        <div>
<script src="https://code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script><script src="https://code.highcharts.com/highcharts.js"></script><script src="https://code.highcharts.com/modules/exporting.js"></script><p>In my Expression Templates Library (ETL) project, I have a lot of template heavy
code that needs to run as fast as possible and that is quite intensive to
compile. In this post, I'm going to compare the performance of a few of the
kernels produced by different compilers. I've got GCC 5.4, GCC 6.20 and clang
3.9. I also included zapcc which is based on clang 4.0.</p>
<p>These tests have been run on an Haswell processor. The automatic parallelization
of ETL has been turned off for these tests.</p>
<p>Keep in mind that some of the diagrams are presented in logarithmic form.</p>
<div class="section" id="vector-multiplication">
<h2>Vector multiplication</h2>
<p>The first kernel is a very simple one, simple element-wise multiplication of two
vectors. Nothing fancy here.</p>
<div id="mul_container" style="min-width: 310px; height:400px; margin: 0 auto; "></div>
<script>
$(function () {
    Highcharts.chart('mul_container', {
        chart: { type: 'column' },
        title: { text: 'Element-wise Vector Multiplication' },
        xAxis: {
            categories: ['10', '100', '1000', '10000', '100000', '1000000']
        },
        yAxis: {
            type: 'logarithmic',
            title: { text: 'Time (us)' },
            plotLines: [{
                value: 0,
                width: 1,
                color: '#808080'
            }]
        },
        tooltip: {valueSuffix: 'us'},
        series: [
        {
            name: 'g++-5.4', data: [0.021, 0.040, 0.215, 2.07, 32.1, 403]
        },
        {
            name: 'g++-6.2', data: [0.021, 0.037, 0.208, 2.17, 32.1, 376]
        },
        {
            name: 'clang-3.9', data: [0.027, 0.045, 0.243, 2.43, 32.7, 389]
        },
        {
            name: 'zapcc-4.0', data: [0.026, 0.047, 0.321, 2.5, 32.8, 411]
        }
        ]
    });
});
</script><p>For small vectors, clang is significantly slower than gcc-5.4 and gcc6.2. On
vectors from 100'000 elements, the speed is comparable for each compiler,
depending on the memory bandwidth. Overall, gcc-6.2 produces the fastest code
here. clang-4.0 is slightly slower than clang-3.9, but nothing dramatic.</p>
</div>
<div class="section" id="vector-exponentiation">
<h2>Vector exponentiation</h2>
<p>The second kernel is computing the exponentials of each elements of a vector and
storing them in another vector.</p>
<div id="exp_container" style="min-width: 310px; height:400px; margin: 0 auto; "></div>
<script>
$(function () {
    Highcharts.chart('exp_container', {
        chart: { type: 'column' },
        title: { text: 'Element-wise Vector Exponentiation' },
        xAxis: {
            categories: ['10', '100', '1000', '10000', '100000', '1000000']
        },
        yAxis: {
            type: 'logarithmic',
            title: { text: 'Time (us)' },
            plotLines: [{
                value: 0,
                width: 1,
                color: '#808080'
            }]
        },
        tooltip: {valueSuffix: 'us'},
        series: [
        {
            name: 'g++-5.4', data: [0.0478, 0.137, 1.12, 9.79, 97.5, 959]
        },
        {
            name: 'g++-6.2', data: [0.0474, 0.132, 1.11, 9.71, 97, 1000]
        },
        {
            name: 'clang-3.9', data: [0.0492, 0.136, 0.959, 9.24, 92.9, 914]
        },
        {
            name: 'zapcc-4.0', data: [0.0488, 0.142, 0.952, 9.25, 91.9, 915]
        }
        ]
    });
});
</script><p>Interestingly, this time, clang versions are significantly faster for medium to
large vectors, from 1000 elements and higher, by about 5%. There is no
significant differences between the different versions of each compiler.</p>
</div>
<div class="section" id="matrix-matrix-multiplication">
<h2>Matrix-Matrix Multiplication</h2>
<p>The next kernel I did benchmark with the matrix-matrix multiplication operation.
In that case, the kernel is hand-unrolled and vectorized.</p>
<div id="gemm_container_small" style="min-width: 310px; height:400px; margin: 0 auto; "></div>
<div id="gemm_container_large" style="min-width: 310px; height:400px; margin: 0 auto; "></div>
<script>
$(function () {
    Highcharts.chart('gemm_container_small', {
        chart: { type: 'column' },
        title: { text: 'Matrix Matrix Multiplication (small)', },
        xAxis: {
            categories: ['10x10', '20x20', '40x40', '60x60', '80x80', '100x100']
        },
        yAxis: {
            type: 'logarithmic',
            title: { text: 'Time (us)' },
            plotLines: [{
                value: 0,
                width: 1,
                color: '#808080'
            }]
        },
        tooltip: {valueSuffix: 'us'},
        series: [
        {
            name: 'g++-5.4', data: [0.159, 0.815, 2.637, 13.849, 17.281, 78.903]
        },
        {
            name: 'g++-6.2', data: [0.162, 0.802, 2.431, 13.531, 17.274, 74.02]
        },
        {
            name: 'clang-3.9', data: [0.179, 1.218, 2.391, 14.981, 15.142, 61.548]
        },
        {
            name: 'zapcc-4.0', data: [0.159, 0.836, 2.712, 13.426, 15.114, 62.241]
        }
        ]
    });
    Highcharts.chart('gemm_container_large', {
        chart: { type: 'column' },
        title: { text: 'Matrix Matrix Multiplication (large)', },
        xAxis: {
            categories: ['200x200', '300x300', '400x400', '500x500', '600x600', '700x700', '800x800', '900x900', '1000x1000']
        },
        yAxis: {
            type: 'logarithmic',
            title: { text: 'Time (us)' },
            plotLines: [{
                value: 0,
                width: 1,
                color: '#808080'
            }]
        },
        tooltip: {valueSuffix: 'us'},
        series: [
        {
            name: 'g++-5.4', data: [275.219, 1371, 1837, 5177, 6667, 14981, 17037, 31492, 32813]
        },
        {
            name: 'g++-6.2', data: [267.776, 1362, 1808, 5297, 6859, 15166, 15664, 30666, 33067]
        },
        {
            name: 'clang-3.9', data: [266.033, 1230, 1789, 4825, 6969, 14488, 15916, 30872, 33186]
        },
        {
            name: 'zapcc-4.0', data: [267.806, 1237, 1820, 4909, 7035, 15191, 18193, 33127, 37346]
        }
        ]
    });
});
</script><p>There are few differences between the compilers. The first thing is that for
some sizes such as 80x80 and 100x100, clang is significantly faster than GCC, by
more than 10%. The other interesting fact is that for large matrices
zapcc-clang-4.0 is always slower than clang-3.9 which is itself on par with the
two GCC versions. In my opinion, it comes from a regression in clang trunk but
it could also come from zapcc itself.</p>
<div id="std_gemm_container_large" style="min-width: 310px; height:400px; margin: 0 auto; "></div>
<script>
$(function () {
    Highcharts.chart('std_gemm_container_large', {
        chart: { type: 'column' },
        title: { text: 'Matrix Matrix Multiplication (naive)', },
        xAxis: {
            categories: ['200x200', '300x300', '400x400', '500x500', '600x600', '700x700', '800x800', '900x900', '1000x1000']
        },
        yAxis: {
            type: 'logarithmic',
            title: { text: 'Time (ms)' },
            plotLines: [{
                value: 0,
                width: 1,
                color: '#808080'
            }]
        },
        tooltip: {valueSuffix: 'ms'},
        series: [
        {
            name: 'g++-5.4', data: [1.195, 4.891, 10.467, 22.400, 33.399,
            58.401, 77.150, 121.392, 148.469]
        },
        {
            name: 'g++-6.2', data: [1.109, 4.540, 9.964, 21.359, 31.904,
            55.282, 72.690, 113.52, 143.27]
        },
        {
            name: 'clang-3.9', data: [0.893, 3.710, 7.287, 16.244, 23.920,
            43.342, 56.771, 91.870, 112.309]
        },
        {
            name: 'zapcc-4.0', data: [5.088, 16.909, 39.632, 77.194, 133.15,
            214.539, 316.01, 447.715, 612.255]
        }
        ]
    });
});
</script><p>The results are much more interesting here! First, there is a huge regression in
clang-4.0 (or in zapcc for that matter). Indeed, it is up to 6 times slower than
clang-3.9. Moreover, the clang-3.9 is always significantly faster than gcc-6.2.
Finally, there is a small improvement in gcc-6.2 compared to gcc 5.4.</p>
</div>
<div class="section" id="fast-fourrier-transform">
<h2>Fast-Fourrier Transform</h2>
<p>The following kernel is the performance of a hand-crafted Fast-Fourrier
transform implementation.</p>
<div id="fft_container" style="min-width: 310px; height:400px; margin: 0 auto; "></div>
<script>
$(function () {
    Highcharts.chart('fft_container', {
        chart: { type: 'column' },
        title: { text: 'Fast Fourrier Transform', },
        xAxis: {
            categories: ['100', '1000', '10000', '100000', '1000000']
        },
        yAxis: {
            type: 'logarithmic',
            title: { text: 'Time (us)' },
            plotLines: [{
                value: 0,
                width: 1,
                color: '#808080'
            }]
        },
        tooltip: {valueSuffix: 'us'},
        series: [
        {
            name: 'g++-5.4', data: [2.640, 27.515, 308.239, 3427.4, 41695.9]
        },
        {
            name: 'g++-6.2', data: [2.578, 26.194, 298.97, 3348.82, 40783.8]
        },
        {
            name: 'clang-3.9', data: [3.047, 30.514, 333.403, 3569.36,43860.6]
        },
        {
            name: 'zapcc-4.0', data: [3.199,33.304,317.135,4025.18,48445.3]
        }
        ]
    });
});
</script><p>On this benchmark, gcc-6.2 is the clear winner. It is significantly faster
than clang-3.9 and clang-4.0. Moreover, gcc-6.2 is also faster than gcc-5.4.
On the contrary, clang-4.0 is significantly slower than clang-3.9 except on one
configuration (10000 elements).</p>
</div>
<div class="section" id="d-convolution">
<h2>1D Convolution</h2>
<p>This kernel is about computing the 1D valid convolution of two vectors.</p>
<div id="conv1_container" style="min-width: 310px; height:400px; margin: 0 auto; "></div>
<script>
$(function () {
    Highcharts.chart('conv1_container', {
        chart: { type: 'column' },
        title: { text: '1D convolution (optimized)', },
        xAxis: {
            categories: ['1000x500', '2000x1000', '3000x1500', '4000x2000',
            '5000x2500', '6000x3000', '7000x3500', '8000x4000', '9000x4500',
            '10000x5000']
        },
        yAxis: {
            type: 'logarithmic',
            title: { text: 'Time (us)' },
            plotLines: [{
                value: 0,
                width: 1,
                color: '#808080'
            }]
        },
        tooltip: {valueSuffix: 'us'},
        series: [
        {
            name: 'g++-5.4', data: [11.710, 41.002, 91.201, 158.178,
            248.985, 353.695, 486.676, 634.53, 867.101, 1082.62]
        },
        {
            name: 'g++-6.2', data: [9.307, 40.921, 90.327, 158.734, 248.892,
            354.582, 488.38, 636.899, 869.637, 1084.86]
        },
        {
            name: 'clang-3.9', data: [13.404, 41.409, 95.094, 162.339,
            256.143, 362.34, 498.66, 651.352, 886.465, 1092.24]
        },
        {
            name: 'zapcc-4.0', data: [13.528, 40.886, 94.473, 159.917,
            252.992, 356.63, 493.653, 640.348, 872.282, 1091.36]
        }
        ]
    });
});
</script><p>While clang-4.0 is faster than clang-3.9, it is still slightly slower than both
gcc versions. On the GCC side, there is not a lot of difference except on the
1000x500 on which gcc-6.2 is 25% faster.</p>
<p>And here are the results with the naive implementation:</p>
<div id="std_conv1_container" style="min-width: 310px; height:400px; margin: 0 auto; "></div>
<script>
$(function () {
    Highcharts.chart('std_conv1_container', {
        chart: { type: 'column' },
        title: { text: '1D convolution (naive)', },
        xAxis: {
            categories: ['1000x500', '2000x1000', '3000x1500', '4000x2000',
            '5000x2500', '6000x3000', '7000x3500', '8000x4000', '9000x4500',
            '10000x5000']
        },
        yAxis: {
            type: 'logarithmic',
            title: { text: 'Time (ms)' },
            plotLines: [{
                value: 0,
                width: 1,
                color: '#808080'
            }]
        },
        tooltip: {valueSuffix: 'ms'},
        series: [
        {
            name: 'g++-5.4', data: [0.350, 1.452, 3.260, 5.823, 9.116,
            13.155, 17.922, 23.438, 29.705, 36.683]
        },
        {
            name: 'g++-6.2', data: [0.350, 1.457, 3.262, 5.823, 9.120,
            13.152, 17.922, 23.436, 29.687, 36.665]
        },
        {
            name: 'clang-3.9', data: [0.216, 0.873, 1.974, 3.517, 5.501,
            7.921, 10.793, 14.11, 17.867, 22.068]
        },
        {
            name: 'zapcc-4.0', data: [0.215, 0.873, 1.972, 3.514, 5.501,
            7.928, 10.799, 14.11, 17.879, 22.065]
        }
        ]
    });
});
</script><p>Again, on the naive version, clang is much faster than GCC on the naive, by
about 65%. This is a really large speedup.</p>
</div>
<div class="section" id="id1">
<h2>2D Convolution</h2>
<p>This next kernel is computing the 2D valid convolution of two matrices</p>
<div id="conv2_container" style="min-width: 310px; height:400px; margin: 0 auto; "></div>
<script>
$(function () {
    Highcharts.chart('conv2_container', {
        chart: { type: 'column' },
        title: { text: '2D Convolution (optimized)', },
        xAxis: {
            categories: ['100x50', '105x50', '110x55', '115x55', '120x60',
            '125x60', '130x65', '135x65', '140x70']
        },
        yAxis: {
            title: { text: 'Time (us)' },
            plotLines: [{
                value: 0,
                width: 1,
                color: '#808080'
            }]
        },
        tooltip: {valueSuffix: 'us'},
        series: [
        {
            name: 'g++-5.4', data: [327.399, 367.389, 441.457, 576.021,
            762.268, 794, 994.06, 1261.71, 1360.57]
        },
        {
            name: 'g++-6.2', data: [327.764, 367.379, 441.993, 572.241,
            761.741, 784.605, 991.717, 1266.55, 1361.59]
        },
        {
            name: 'clang-3.9', data: [330.199, 364.253, 443.483, 580.676,
            763.772, 777.39, 1000.53, 1267.75, 1375.51]
        },
        {
            name: 'zapcc-4.0', data: [339.358, 364.756, 443.807, 575.917,
            761.248, 784.695, 992.29, 1265.04, 1367.33]
        }
        ]
    });
});
</script><p>There is no clear difference between the compilers in this code. Every compiler
here has up and down.</p>
<p>Let's look at the naive implementation of the 2D convolution (units are
milliseconds here not microseconds):</p>
<div id="std_conv2_container" style="min-width: 310px; height:400px; margin: 0 auto; "></div>
<script>
$(function () {
    Highcharts.chart('std_conv2_container', {
        chart: { type: 'column' },
        title: { text: '2D Convolution (naive)', },
        xAxis: {
            categories: ['100x50', '105x50', '110x55', '115x55', '120x60',
            '125x60', '130x65', '135x65', '140x70']
        },
        yAxis: {
            title: { text: 'Time (ms)' },
            plotLines: [{
                value: 0,
                width: 1,
                color: '#808080'
            }]
        },
        tooltip: {valueSuffix: 'ms'},
        series: [
        {
            name: 'g++-5.4', data: [9.501,11.458,13.888, 16.489, 19.634,
            22.898, 27.012, 31.246, 36.269]
        },
        {
            name: 'g++-6.2', data: [9.502, 11.464, 13.903, 16.484, 19.642,
            22.994, 27.004, 31.248, 36.26]
        },
        {
            name: 'clang-3.9', data: [5.880, 7.136, 8.610, 10.226, 12.164,
            14.247, 17.024, 19.577, 22.510]
        },
        {
            name: 'zapcc-4.0', data: [5.875, 7.091, 8.661, 10.241, 12.218,
            14.302, 16.777, 19.424, 22.472]
        }
        ]
    });
});
</script><p>This time the difference is very large! Indeed, clang versions are about 60%
faster than the GCC versions! This is really impressive. Even though this does
not comes close to the optimized. It seems the vectorizer of clang is much more
efficient than the one from GCC.</p>
</div>
<div class="section" id="id2">
<h2>4D Convolution</h2>
<p>The final kernel that I'm testing is the batched 4D convolutions that is used a
lot in Deep Learning. This is not really a 4D convolution, but a large number
of 2D convolutions applied on 4D tensors.</p>
<div id="conv4_container" style="min-width: 310px; height:400px; margin: 0 auto; "></div>
<script>
$(function () {
    Highcharts.chart('conv4_container', {
        chart: { type: 'column' },
        title: { text: '4D Convolution', },
        xAxis: {
            categories: ['2x6x3x28x16', '2x6x3x28x16', '2x6x3x28x16',
            '2x6x3x28x16', '2x6x3x28x16', '2x6x3x28x16', '2x6x3x28x16',
            '2x6x3x28x16', '2x6x3x28x16']
        },
        yAxis: {
            type: 'logarithmic',
            title: { text: 'Time (ms)' },
            plotLines: [{
                value: 0,
                width: 1,
                color: '#808080'
            }]
        },
        tooltip: {valueSuffix: 'ms'},
        series: [
        {
            name: 'g++-5.4', data: [0.095, 0.402, 1.083, 2.237, 3.988,
            6.474, 9.985, 14.132, 19.539]
        },
        {
            name: 'g++-6.2', data: [0.089, 0.413, 1.081, 2.224, 3.990,
            6.462, 9.815, 14.118, 19.612]
        },
        {
            name: 'clang-3.9', data: [0.090, 0.416, 1.108, 2.277, 4.077,
            6.587, 10.024, 14.359, 20.006]
        },
        {
            name: 'zapcc-4.0', data: [0.088, 0.406, 1.080, 2.237, 3.987,
            6.484, 9.827, 14.130, 19.569]
        }
        ]
    });
});
</script><p>Again, there are very small differences between each version. The best versions
are the most recent versions of the compiler gcc-6.2 and clang-4.0 on a tie.</p>
</div>
<div class="section" id="conclusion">
<h2>Conclusion</h2>
<p>Overall, we can see two trends in these results. First, when working with
highly-optimized code, the choice of compiler will not make a huge difference.
On these kind of kernels, gcc-6.2 tend to perform faster than the other
compilers, but only by a very slight margin, except in some cases. On the other
hand, when working with naive implementations, clang versions really did perform
much better than GCC. The clang compiled versions of the 1D and 2D convolutions
are more than 60% faster than their GCC counter parts. This is really
impressive. Overall, clang-4.0 seems to have several performance regressions,
but since it's not still a work in progress, I would not be suprised if these
regressions are not present in the final version. Since the clang-4.0 version is
in fact the clang version used by zapcc, it's also possible that zapcc is
introducing new performance regressions.</p>
<p>Overall, my advice would be to use GCC-6.2 (or 5.4) on hand-optimized kernels
and clang when you have mostly naive implementations. However, keep in mind that
at least for the example shown here, the naive version optimized by the compiler
never comes close to the highly-optimized version.</p>
<p>As ever, takes this with a grain of salt, it's only been tested on one project
and one machine, you may obtain very different results on other projects and on
other processors.</p>
</div>
</div>
        </div>
            
        
    <a href="posts/2016/12/cpp-compiler-benchmark-on-expression-templates-library-etl.html#disqus_thread" data-disqus-identifier="cache/posts/2016/12/cpp-compiler-benchmark-on-expression-templates-library-etl.html">Comments</a>


        </article><nav class="postindexpager"><ul class="pager">
<li class="next">
                <a href="index-29.html" rel="next">Older posts</a>
            </li>
        </ul></nav><script>var disqus_shortname="blogwichtounet";(function(){var a=document.createElement("script");a.async=true;a.src="https://"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script>
</div> <!-- col -->
    </div>
<!-- row  -->
</div>
<!-- container-fluid -->

<!-- End of Menubar -->

<!-- Footer -->

<footer>
    Contents © 2017         <a href="mailto:baptistewicht@gmail.com">Baptiste Wicht</a> - Powered by         <a href="http://getnikola.com" rel="nofollow">Nikola</a>         - License: 
<a rel="license" href="http://creativecommons.org/licenses/by/4.0/"><img alt="Creative Commons License" style="padding-left:5px;border-width:0" src="assets/img/cc.png"></a>
        <ul class="footer_inline_ul"></ul></footer><!-- Late loading stuff  --><script src="assets/js/all-nocdn.js"></script><script type="text/javascript">
      $(document).ready(function() {
        $.getJSON("/assets/js/tx3_tag_cloud.json", function(data){
            var items = [];
            $.each(data, function(key, val){
                var count = val[0];
                var url = val[1];
                var posts = val[2];

                if(count > 9){
                    items.push("<li data-weight='" + count + "'><a href='" + url + "'>" + key + "</a></li>");
                }
            });

            $("<ul/>", {
                "id": "tag_cloud_left",
                html: items.join("")
            }).appendTo("#tag_cloud_left_container");

            $("#tag_cloud_left").tx3TagCloud({
                multiplier: 0.8 // default multiplier is "1"
            });
        });
      });
    </script><!-- Google platform JS -->
</body>
</html>
