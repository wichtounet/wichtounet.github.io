<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="Tutorials and short posts about programming, C++, Java, Assembly, Operating Systems Development, Compilers, ...">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Blog blog("Baptiste Wicht"); (old posts, page 28) | Blog blog("Baptiste Wicht");</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" hreflang="en" href="rss.xml">
<link rel="canonical" href="https://baptiste-wicht.com/index-28.html">
<link rel="prev" href="index-29.html" type="text/html">
<link rel="next" href="index-27.html" type="text/html">
<!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]-->
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://baptiste-wicht.com/">

                <span id="blog-title">Blog blog("Baptiste Wicht");</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="stories/about.html">About</a>
                </li>
<li>
<a href="stories/publications.html">Publications</a>
                </li>
<li>
<a href="stories/projects.html">Projects</a>
                </li>
<li>
<a href="categories/index.html">Tags</a>
                </li>
<li>
<a href="archive.html">Archives</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            

    


    
<div class="postindex">
    <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/2016/06/eddic-124-new-boost-spirit-x3-parser-and-minor-cleanups.html" class="u-url">eddic 1.2.4: New Boost Spirit X3 parser and minor cleanups</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Baptiste Wicht
            </span></p>
            <p class="dateline">
            <a href="posts/2016/06/eddic-124-new-boost-spirit-x3-parser-and-minor-cleanups.html" rel="bookmark">
            <time class="published dt-published" datetime="2016-06-26T22:35:04+02:00" itemprop="datePublished" title="2016-06-26 22:35">2016-06-26 22:35</time></a>
            </p>
                <p class="commentline">
    
    <a href="posts/2016/06/eddic-124-new-boost-spirit-x3-parser-and-minor-cleanups.html#disqus_thread" data-disqus-identifier="cache/posts/2016/06/eddic-124-new-boost-spirit-x3-parser-and-minor-cleanups.html">Comments</a>


        </p>
</div>
    </header><div class="p-summary entry-summary">
    <p>After almost 2 years, the new version of eddic (the compiler of the EDDI
programming language) is out! eddic 1.2.4</p>
<p>I haven't worked a lot on this project in the last years, I have been busy with
my Ph.D. related projects (ETL and DLL), my operating systems, cpm, ... I've
mostly worked on the parser to test the new version of Boost Spirit: X3. This
will be described on the next section, with the other changes in the later
section.</p>
<section id="new-boost-spirit-x3"><h2>New Boost Spirit X3</h2>
<p>Boost Spirit X3 is a completely revamped version of Boost Spirit X3. It's aimed
at performance, both at compile-time and at runtime and uses recent features of
modern C++. It's not compatible with Boost Spirit Qi, so you'll most likely
have to rewrite a lot of stuff, in the parser, in the Abstract Syntax Tree
(AST) and in the AST passes as well.</p>
<p>For reference, I'm using the Boost 1.59 version.</p>
<section id="pros"><h3>Pros</h3>
<p>Let's start with the pros.</p>
<p>First, the runtime performance is definitely better. Parsing all my eddi test
cases and samples, <em>takes 42% less time than with the previous parser</em>. It is
important to know that the old parser was very optimized, with moves instead of
copies and with a static lexer. You can take a look at <a class="reference external" href="http://baptiste-wicht.com/posts/2013/06/improving-eddic-boost-spirit-parser-performances.html">this post</a>
to see what was necessary to optimize the old Qi. I think it's a good result
since the new grammar does not use a lexer (x3 does not support it) and does
not need these optimizations. This improvement really was my objective. I'll
try to push it farther in the future.</p>
<p>Compile-time performance is also much better. It takes 3 times less time to
compile the new parser (1 minute to around 20 seconds). Moreover, the new
parser is now in only one file, rather than being it necessary to split it all
over the place for compile-time performance. Even though it's not really
important for me, it's still good to have :)</p>
<p>Especially due to the performance point, I've been able to remove some code,
the lexer, the generated static lexer and the special pointers optimizations of
the AST.</p>
</section><section id="cons"><h3>Cons</h3>
<p>Unfortunately, there are some disadvantages of using the new Spirit X3.</p>
<p>First, the AST needs to be changed. For good parsing performance, you need to
use x3::variant and x3::forward_ast. This is a major pain in the ass since
x3::variant is much less practical to use than boost::variant. Almost
everything is explicit, meaning uglier code than before, in my opinion.
Moreover, you need to work around x3::forward_ast for boost::get, whereas
boost::recursive_wrapper was working better in that matter. I've had to create
my own wrapper around boost::get in order to be able to use the new tree. In my
opinion, this is clearly a regression.</p>
<p>Secondly, although X3 was also meant to remove the need to use some hacks in
the grammar, I ended up having more hacks than before. For instance, many AST
node have a fake field in order to make X3 happy. I've still had to use the
horrible eps hack at one place. I've had to create a few more rules in order to
fix type deduction that is working differently than before (worse for me). And
for some reasons, I had to replace some expectations from the grammar to make it
parse correctly. This is a really important regression in my opinion, since it
may make the parsing slower and will make the error message less nice.</p>
<p>The previous error handling system allowed me to track the file from which an
AST node was parsed from. Although the new error handler is a lot nicer than
the old system, it does not have this feature, so I had to work around this by
using new annotation nodes and a new global handler. Overall, it's probably a
bit worse than before, but makes for lighter AST nodes.</p>
<p>Finally, for some reason, I haven't been able to use the debug option of the
library (lots of compile time errors). That complicated a bit the debugging of
the parser.</p>
</section><section id="spirit-x3-or-spirit-qi"><h3>Spirit X3 or Spirit Qi ?</h3>
<p>Overall, I have to say I'm a bit disappointed by Spirit X3. Even though it's
faster at runtime and faster to compile, I was really expecting less issues
with it. What I really did not like was all the changes I had to make because
of x3::variant and x3::forward_ast. Overall, I really don't think it was worth
the trouble porting my parser to Spirit X3.</p>
<p>If you have a new project, I would still consider using Boost Spirit X3.</p>
<p>If you have an existing parser, I would probably not advice porting it to X3.
Unless you really have issues with parsing performances (and especially if you
have not already optimized QI parser), it's probably not worth the trouble and
all the time necessary for all the changes.</p>
</section></section><section id="other-changes"><h2>Other changes</h2>
<p>The other changes are much more minor. First of all, I've gotten rid of CMake.
This project has really made me hate CMake. I have actually gotten rid of it on
all my projects. I'm now using plain Makefiles and having a much better time
with them. I've also replaced boost Program Options with cxxopts. It's a much
more modern approach for program options parsing. Moreover, it's much more
lightweight and it's header only. Only advantages. There also have been lots of
changes to code (still not very good quality though).</p>
</section><section id="future"><h2>Future</h2>
<p>eddic was my first real project in C++ and this can be seen in the code and the
organization. The quality of the code is really bad now that I read it again.
Some things are actually terrible :P It's probably normal since I was a
beginner in C++ at the time.</p>
<p>For the future version of the compiler, I want to clean the code a lot more and
focus on the EDDI language adding new features. Moreover, I'll also get rid of
Boost Test Framework by using Catch (or doctest if it is ready).</p>
<p>As for now, I'm not sure on which project I'm going to focus. Either I'll
continue working on the compiler or I'll start working again on my operating
system (thor-os) in which I was working on process concurrency (without too
much success :P). I'll probably post next updates on this post in the coming
months.</p>
</section><section id="download"><h2>Download</h2>
<p>You can find the EDDI Compiler sources on the <a class="reference external" href="https://github.com/wichtounet/eddic">Github repository</a></p>
<p>The version is available in the <em>v1.2.4</em> tag available in the GitHub
repository, in the releases pages or directly in the &lt;em&gt;master&lt;/em&gt; branch.</p>
</section>
</div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/2016/06/reduce-compilation-time-by-another-16-with-catch.html" class="u-url">Reduce Catch tests compilation time by another 16%</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Baptiste Wicht
            </span></p>
            <p class="dateline">
            <a href="posts/2016/06/reduce-compilation-time-by-another-16-with-catch.html" rel="bookmark">
            <time class="published dt-published" datetime="2016-06-01T07:28:36+02:00" itemprop="datePublished" title="2016-06-01 07:28">2016-06-01 07:28</time></a>
            </p>
                <p class="commentline">
    
    <a href="posts/2016/06/reduce-compilation-time-by-another-16-with-catch.html#disqus_thread" data-disqus-identifier="cache/posts/2016/06/reduce-compilation-time-by-another-16-with-catch.html">Comments</a>


        </p>
</div>
    </header><div class="p-summary entry-summary">
    <p>No, it's not the same post as two days! I've been able to reduce the compilation
time of my test cases by another 16%!</p>
<p>Two days ago, I posted an article about how <a class="reference external" href="http://baptiste-wicht.com/posts/2016/05/speedup-compilation-by-13-by-simplifying-unit-test-with-catch.html">I reduced the compilation time of my tests by 13%</a>, by bypassing the expression deduction from Catch. I came up with the macro <code class="cpp"><span class="n">REQUIRE_EQUALS</span></code>:</p>
<div class="code"><pre class="code cpp"><a id="rest_code_00038348b16a424584da04b79a335adb-1" name="rest_code_00038348b16a424584da04b79a335adb-1" href="posts/2016/06/reduce-compilation-time-by-another-16-with-catch.html#rest_code_00038348b16a424584da04b79a335adb-1"></a><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">L</span><span class="p">,</span><span class="w"> </span><span class="k">typename</span><span class="w"> </span><span class="nc">R</span><span class="o">&gt;</span>
<a id="rest_code_00038348b16a424584da04b79a335adb-2" name="rest_code_00038348b16a424584da04b79a335adb-2" href="posts/2016/06/reduce-compilation-time-by-another-16-with-catch.html#rest_code_00038348b16a424584da04b79a335adb-2"></a><span class="kt">void</span><span class="w"> </span><span class="n">evaluate_result</span><span class="p">(</span><span class="n">Catch</span><span class="o">::</span><span class="n">ResultBuilder</span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">__result</span><span class="p">,</span><span class="w"> </span><span class="n">L</span><span class="w"> </span><span class="n">lhs</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="w"> </span><span class="n">rhs</span><span class="p">){</span>
<a id="rest_code_00038348b16a424584da04b79a335adb-3" name="rest_code_00038348b16a424584da04b79a335adb-3" href="posts/2016/06/reduce-compilation-time-by-another-16-with-catch.html#rest_code_00038348b16a424584da04b79a335adb-3"></a><span class="w">    </span><span class="n">__result</span><span class="p">.</span><span class="n">setResultType</span><span class="p">(</span><span class="n">lhs</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">rhs</span><span class="p">);</span>
<a id="rest_code_00038348b16a424584da04b79a335adb-4" name="rest_code_00038348b16a424584da04b79a335adb-4" href="posts/2016/06/reduce-compilation-time-by-another-16-with-catch.html#rest_code_00038348b16a424584da04b79a335adb-4"></a><span class="w">    </span><span class="n">__result</span><span class="p">.</span><span class="n">setLhs</span><span class="p">(</span><span class="n">Catch</span><span class="o">::</span><span class="n">toString</span><span class="p">(</span><span class="n">lhs</span><span class="p">));</span>
<a id="rest_code_00038348b16a424584da04b79a335adb-5" name="rest_code_00038348b16a424584da04b79a335adb-5" href="posts/2016/06/reduce-compilation-time-by-another-16-with-catch.html#rest_code_00038348b16a424584da04b79a335adb-5"></a><span class="w">    </span><span class="n">__result</span><span class="p">.</span><span class="n">setRhs</span><span class="p">(</span><span class="n">Catch</span><span class="o">::</span><span class="n">toString</span><span class="p">(</span><span class="n">rhs</span><span class="p">));</span>
<a id="rest_code_00038348b16a424584da04b79a335adb-6" name="rest_code_00038348b16a424584da04b79a335adb-6" href="posts/2016/06/reduce-compilation-time-by-another-16-with-catch.html#rest_code_00038348b16a424584da04b79a335adb-6"></a><span class="w">    </span><span class="n">__result</span><span class="p">.</span><span class="n">setOp</span><span class="p">(</span><span class="s">"=="</span><span class="p">);</span>
<a id="rest_code_00038348b16a424584da04b79a335adb-7" name="rest_code_00038348b16a424584da04b79a335adb-7" href="posts/2016/06/reduce-compilation-time-by-another-16-with-catch.html#rest_code_00038348b16a424584da04b79a335adb-7"></a><span class="w">    </span><span class="n">__result</span><span class="p">.</span><span class="n">endExpression</span><span class="p">();</span>
<a id="rest_code_00038348b16a424584da04b79a335adb-8" name="rest_code_00038348b16a424584da04b79a335adb-8" href="posts/2016/06/reduce-compilation-time-by-another-16-with-catch.html#rest_code_00038348b16a424584da04b79a335adb-8"></a><span class="w">    </span><span class="n">__result</span><span class="p">.</span><span class="n">react</span><span class="p">();</span>
<a id="rest_code_00038348b16a424584da04b79a335adb-9" name="rest_code_00038348b16a424584da04b79a335adb-9" href="posts/2016/06/reduce-compilation-time-by-another-16-with-catch.html#rest_code_00038348b16a424584da04b79a335adb-9"></a><span class="p">}</span>
<a id="rest_code_00038348b16a424584da04b79a335adb-10" name="rest_code_00038348b16a424584da04b79a335adb-10" href="posts/2016/06/reduce-compilation-time-by-another-16-with-catch.html#rest_code_00038348b16a424584da04b79a335adb-10"></a>
<a id="rest_code_00038348b16a424584da04b79a335adb-11" name="rest_code_00038348b16a424584da04b79a335adb-11" href="posts/2016/06/reduce-compilation-time-by-another-16-with-catch.html#rest_code_00038348b16a424584da04b79a335adb-11"></a><span class="cp">#define REQUIRE_EQUALS(lhs, rhs) \</span>
<a id="rest_code_00038348b16a424584da04b79a335adb-12" name="rest_code_00038348b16a424584da04b79a335adb-12" href="posts/2016/06/reduce-compilation-time-by-another-16-with-catch.html#rest_code_00038348b16a424584da04b79a335adb-12"></a><span class="cp">    evaluate_result(Catch::ResultBuilder( "REQUIRE", CATCH_INTERNAL_LINEINFO, #lhs " == " #rhs, Catch::ResultDisposition::Normal ), lhs, rhs);</span>
</pre></div>
<p>This has the advantage that the left and right hand sides are directly set, not
deduced with templates and operator overloading. This still has exactly the same
features has the original macro, but it is a bit less nice in the test code.
I was quite happy with that optimization, but it turned out, I was not
aggressive enough in my optimizations.</p>
<p>Even though it seems simple, the macro is still bloated. There are two
constructors calls: <code class="cpp"><span class="n">ResultBuilder</span></code> and <code class="cpp"><span class="n">SourceLineInfo</span></code> (hidden behind
<code class="cpp"><span class="n">CATCH_INTERNAL_LINEINFO</span></code>). That means that if you test case has 100
assertions, 200 constructor calls will need to be processed by the compiler.
Considering that I have some test files with around 400 assertions, this is
a lot of overhead for nothing. Moreover, two parameters have always the same
value, no need to repeat them every time.</p>
<p>Simplifying the macro to the minimum led me to this:</p>
<div class="code"><pre class="code cpp"><a id="rest_code_f8411e3d4b6f4f4dbcd0076e036d2e50-1" name="rest_code_f8411e3d4b6f4f4dbcd0076e036d2e50-1" href="posts/2016/06/reduce-compilation-time-by-another-16-with-catch.html#rest_code_f8411e3d4b6f4f4dbcd0076e036d2e50-1"></a><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">L</span><span class="p">,</span><span class="w"> </span><span class="k">typename</span><span class="w"> </span><span class="nc">R</span><span class="o">&gt;</span>
<a id="rest_code_f8411e3d4b6f4f4dbcd0076e036d2e50-2" name="rest_code_f8411e3d4b6f4f4dbcd0076e036d2e50-2" href="posts/2016/06/reduce-compilation-time-by-another-16-with-catch.html#rest_code_f8411e3d4b6f4f4dbcd0076e036d2e50-2"></a><span class="kt">void</span><span class="w"> </span><span class="n">evaluate_result</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span><span class="w"> </span><span class="n">line</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">exp</span><span class="p">,</span><span class="w"> </span><span class="n">L</span><span class="w"> </span><span class="n">lhs</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="w"> </span><span class="n">rhs</span><span class="p">){</span>
<a id="rest_code_f8411e3d4b6f4f4dbcd0076e036d2e50-3" name="rest_code_f8411e3d4b6f4f4dbcd0076e036d2e50-3" href="posts/2016/06/reduce-compilation-time-by-another-16-with-catch.html#rest_code_f8411e3d4b6f4f4dbcd0076e036d2e50-3"></a><span class="w">    </span><span class="n">Catch</span><span class="o">::</span><span class="n">ResultBuilder</span><span class="w"> </span><span class="n">result</span><span class="p">(</span><span class="s">"REQUIRE"</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="n">line</span><span class="p">},</span><span class="w"> </span><span class="n">exp</span><span class="p">,</span><span class="w"> </span><span class="n">Catch</span><span class="o">::</span><span class="n">ResultDisposition</span><span class="o">::</span><span class="n">Flags</span><span class="o">::</span><span class="n">Normal</span><span class="p">);</span>
<a id="rest_code_f8411e3d4b6f4f4dbcd0076e036d2e50-4" name="rest_code_f8411e3d4b6f4f4dbcd0076e036d2e50-4" href="posts/2016/06/reduce-compilation-time-by-another-16-with-catch.html#rest_code_f8411e3d4b6f4f4dbcd0076e036d2e50-4"></a><span class="w">    </span><span class="n">result</span><span class="p">.</span><span class="n">setResultType</span><span class="p">(</span><span class="n">lhs</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">rhs</span><span class="p">);</span>
<a id="rest_code_f8411e3d4b6f4f4dbcd0076e036d2e50-5" name="rest_code_f8411e3d4b6f4f4dbcd0076e036d2e50-5" href="posts/2016/06/reduce-compilation-time-by-another-16-with-catch.html#rest_code_f8411e3d4b6f4f4dbcd0076e036d2e50-5"></a><span class="w">    </span><span class="n">result</span><span class="p">.</span><span class="n">setLhs</span><span class="p">(</span><span class="n">Catch</span><span class="o">::</span><span class="n">toString</span><span class="p">(</span><span class="n">lhs</span><span class="p">));</span>
<a id="rest_code_f8411e3d4b6f4f4dbcd0076e036d2e50-6" name="rest_code_f8411e3d4b6f4f4dbcd0076e036d2e50-6" href="posts/2016/06/reduce-compilation-time-by-another-16-with-catch.html#rest_code_f8411e3d4b6f4f4dbcd0076e036d2e50-6"></a><span class="w">    </span><span class="n">result</span><span class="p">.</span><span class="n">setRhs</span><span class="p">(</span><span class="n">Catch</span><span class="o">::</span><span class="n">toString</span><span class="p">(</span><span class="n">rhs</span><span class="p">));</span>
<a id="rest_code_f8411e3d4b6f4f4dbcd0076e036d2e50-7" name="rest_code_f8411e3d4b6f4f4dbcd0076e036d2e50-7" href="posts/2016/06/reduce-compilation-time-by-another-16-with-catch.html#rest_code_f8411e3d4b6f4f4dbcd0076e036d2e50-7"></a><span class="w">    </span><span class="n">result</span><span class="p">.</span><span class="n">setOp</span><span class="p">(</span><span class="s">"=="</span><span class="p">);</span>
<a id="rest_code_f8411e3d4b6f4f4dbcd0076e036d2e50-8" name="rest_code_f8411e3d4b6f4f4dbcd0076e036d2e50-8" href="posts/2016/06/reduce-compilation-time-by-another-16-with-catch.html#rest_code_f8411e3d4b6f4f4dbcd0076e036d2e50-8"></a><span class="w">    </span><span class="n">result</span><span class="p">.</span><span class="n">endExpression</span><span class="p">();</span>
<a id="rest_code_f8411e3d4b6f4f4dbcd0076e036d2e50-9" name="rest_code_f8411e3d4b6f4f4dbcd0076e036d2e50-9" href="posts/2016/06/reduce-compilation-time-by-another-16-with-catch.html#rest_code_f8411e3d4b6f4f4dbcd0076e036d2e50-9"></a><span class="w">    </span><span class="n">result</span><span class="p">.</span><span class="n">react</span><span class="p">();</span>
<a id="rest_code_f8411e3d4b6f4f4dbcd0076e036d2e50-10" name="rest_code_f8411e3d4b6f4f4dbcd0076e036d2e50-10" href="posts/2016/06/reduce-compilation-time-by-another-16-with-catch.html#rest_code_f8411e3d4b6f4f4dbcd0076e036d2e50-10"></a><span class="p">}</span>
<a id="rest_code_f8411e3d4b6f4f4dbcd0076e036d2e50-11" name="rest_code_f8411e3d4b6f4f4dbcd0076e036d2e50-11" href="posts/2016/06/reduce-compilation-time-by-another-16-with-catch.html#rest_code_f8411e3d4b6f4f4dbcd0076e036d2e50-11"></a>
<a id="rest_code_f8411e3d4b6f4f4dbcd0076e036d2e50-12" name="rest_code_f8411e3d4b6f4f4dbcd0076e036d2e50-12" href="posts/2016/06/reduce-compilation-time-by-another-16-with-catch.html#rest_code_f8411e3d4b6f4f4dbcd0076e036d2e50-12"></a><span class="cp">#define REQUIRE_EQUALS(lhs, rhs) \</span>
<a id="rest_code_f8411e3d4b6f4f4dbcd0076e036d2e50-13" name="rest_code_f8411e3d4b6f4f4dbcd0076e036d2e50-13" href="posts/2016/06/reduce-compilation-time-by-another-16-with-catch.html#rest_code_f8411e3d4b6f4f4dbcd0076e036d2e50-13"></a><span class="cp">    evaluate_result(__FILE__, __LINE__, #lhs " == " #rhs, lhs, rhs);</span>
</pre></div>
<p>The macro is now a simple function call. Even though the function is a template
function, it will only be compiled for a few types (<code class="cpp"><span class="kt">double</span></code> and
<code class="cpp"><span class="kt">float</span></code> in my case), whereas the code of the macro would be unconditionally
compiled for each invocation.</p>
<p>With this new macro and function, the compilation time went down from 664
seconds to 554 seconds! This is <strong>more than 16% reduction in compilation
time</strong>. When comparing against the original compilation time (without both
optimizations) of 764 seconds, this is a 27% reduction! And there are absolutely
no difference in features.</p>
<p>This is a really great result, in my opinion. I don't think this can be cut down
more. However, there is still some room for optimization regarding the includes
that Catch need. Indeed, it is very bloated as well. A new test framework,
<a class="reference external" href="https://github.com/onqtam/doctest">doctest</a> follows the same philosophy, but
has much smaller include overhead. Once all the necessary features are in
doctest, I may consider adapting my macros for it and using it in place of Catch
is there is some substantial reduction in compilation time.</p>
<p>If you want to take a look at the code, you can find the adapted code on <a class="reference external" href="https://github.com/wichtounet/etl/blob/master/test/include/fast_catch.hpp">Github</a>.</p>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/2016/05/speedup-compilation-by-13-by-simplifying-unit-test-with-catch.html" class="u-url">Speed up compilation by 13% by simplifying Catch unit tests</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Baptiste Wicht
            </span></p>
            <p class="dateline">
            <a href="posts/2016/05/speedup-compilation-by-13-by-simplifying-unit-test-with-catch.html" rel="bookmark">
            <time class="published dt-published" datetime="2016-05-25T12:35:16+02:00" itemprop="datePublished" title="2016-05-25 12:35">2016-05-25 12:35</time></a>
            </p>
                <p class="commentline">
    
    <a href="posts/2016/05/speedup-compilation-by-13-by-simplifying-unit-test-with-catch.html#disqus_thread" data-disqus-identifier="cache/posts/2016/05/speedup-compilation-by-13-by-simplifying-unit-test-with-catch.html">Comments</a>


        </p>
</div>
    </header><div class="p-summary entry-summary">
    <p>In the previous two days, I've working on improving compilation time of my
project Expression Templates Library (ETL). I have been able to reduce the
compilation time of the complete test suite from 794 seconds to 764 seconds
(using only one thread). Trying to get further, I started checking what was
taking the most time in a test case when I saw that the REQUIRE calls of <strong>the
test library were taking a large portion of the compilation time!</strong></p>
<p>I have been <a class="reference external" href="http://baptiste-wicht.com/posts/2014/07/catch-powerful-yet-simple-cpp-test-framework.html">using Catch as my test framework</a>
for more than two years and it's really been great overall. It is a great tool,
header-only, fully-featured, XML reporting for Sonar, ... It really has
everything I need from a test framework.</p>
<p>Contrary to some popular test frameworks that provides ASSERT_EQUALS,
ASSERT_GREATER and all fashion of assert macros, Catch only provides one
version: REQUIRE. For instance:</p>
<div class="code"><pre class="code cpp"><a id="rest_code_98c41b76acca4c96804a259025764ee9-1" name="rest_code_98c41b76acca4c96804a259025764ee9-1" href="posts/2016/05/speedup-compilation-by-13-by-simplifying-unit-test-with-catch.html#rest_code_98c41b76acca4c96804a259025764ee9-1"></a><span class="n">REQUIRE</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">1.0</span><span class="p">);</span>
<a id="rest_code_98c41b76acca4c96804a259025764ee9-2" name="rest_code_98c41b76acca4c96804a259025764ee9-2" href="posts/2016/05/speedup-compilation-by-13-by-simplifying-unit-test-with-catch.html#rest_code_98c41b76acca4c96804a259025764ee9-2"></a><span class="n">REQUIRE</span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">5.5</span><span class="p">);</span>
<a id="rest_code_98c41b76acca4c96804a259025764ee9-3" name="rest_code_98c41b76acca4c96804a259025764ee9-3" href="posts/2016/05/speedup-compilation-by-13-by-simplifying-unit-test-with-catch.html#rest_code_98c41b76acca4c96804a259025764ee9-3"></a><span class="n">REQUIRE</span><span class="p">((</span><span class="n">z</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mf">22.01f</span><span class="p">);</span>
</pre></div>
<p>The left and right part are detected with some smart template and operator
overloading techniques and this makes for very nice test output in case of
errors, for instance:</p>
<div class="code"><pre class="code text"><a id="rest_code_6ab0971a06ce41e3abc7f80b65eed971-1" name="rest_code_6ab0971a06ce41e3abc7f80b65eed971-1" href="posts/2016/05/speedup-compilation-by-13-by-simplifying-unit-test-with-catch.html#rest_code_6ab0971a06ce41e3abc7f80b65eed971-1"></a>test/src/dyn_matrix.cpp:16: FAILED:
<a id="rest_code_6ab0971a06ce41e3abc7f80b65eed971-2" name="rest_code_6ab0971a06ce41e3abc7f80b65eed971-2" href="posts/2016/05/speedup-compilation-by-13-by-simplifying-unit-test-with-catch.html#rest_code_6ab0971a06ce41e3abc7f80b65eed971-2"></a>  REQUIRE( test_matrix.rows() == 2UL )
<a id="rest_code_6ab0971a06ce41e3abc7f80b65eed971-3" name="rest_code_6ab0971a06ce41e3abc7f80b65eed971-3" href="posts/2016/05/speedup-compilation-by-13-by-simplifying-unit-test-with-catch.html#rest_code_6ab0971a06ce41e3abc7f80b65eed971-3"></a>with expansion:
<a id="rest_code_6ab0971a06ce41e3abc7f80b65eed971-4" name="rest_code_6ab0971a06ce41e3abc7f80b65eed971-4" href="posts/2016/05/speedup-compilation-by-13-by-simplifying-unit-test-with-catch.html#rest_code_6ab0971a06ce41e3abc7f80b65eed971-4"></a>  3 == 2
</pre></div>
<p>I think this is pretty nice and the tests are really clear. However, <em>it comes
with a cost</em> and I underestimated this at first.</p>
<p>To overcome this, I create two new macros (and few other variations)
REQUIRE_EQUALS and REQUIRE_DIRECT that simply bypass Catch deduction of the
expression:</p>
<div class="code"><pre class="code cpp"><a id="rest_code_b24b8ed75e3b437ca8f7bd5c478ae60b-1" name="rest_code_b24b8ed75e3b437ca8f7bd5c478ae60b-1" href="posts/2016/05/speedup-compilation-by-13-by-simplifying-unit-test-with-catch.html#rest_code_b24b8ed75e3b437ca8f7bd5c478ae60b-1"></a><span class="kr">inline</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">evaluate_result_direct</span><span class="p">(</span><span class="n">Catch</span><span class="o">::</span><span class="n">ResultBuilder</span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">__result</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">value</span><span class="p">){</span>
<a id="rest_code_b24b8ed75e3b437ca8f7bd5c478ae60b-2" name="rest_code_b24b8ed75e3b437ca8f7bd5c478ae60b-2" href="posts/2016/05/speedup-compilation-by-13-by-simplifying-unit-test-with-catch.html#rest_code_b24b8ed75e3b437ca8f7bd5c478ae60b-2"></a><span class="w">    </span><span class="n">__result</span><span class="p">.</span><span class="n">setResultType</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
<a id="rest_code_b24b8ed75e3b437ca8f7bd5c478ae60b-3" name="rest_code_b24b8ed75e3b437ca8f7bd5c478ae60b-3" href="posts/2016/05/speedup-compilation-by-13-by-simplifying-unit-test-with-catch.html#rest_code_b24b8ed75e3b437ca8f7bd5c478ae60b-3"></a><span class="w">    </span><span class="n">__result</span><span class="p">.</span><span class="n">setLhs</span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s">"true"</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">"false"</span><span class="p">);</span>
<a id="rest_code_b24b8ed75e3b437ca8f7bd5c478ae60b-4" name="rest_code_b24b8ed75e3b437ca8f7bd5c478ae60b-4" href="posts/2016/05/speedup-compilation-by-13-by-simplifying-unit-test-with-catch.html#rest_code_b24b8ed75e3b437ca8f7bd5c478ae60b-4"></a><span class="w">    </span><span class="n">__result</span><span class="p">.</span><span class="n">setOp</span><span class="p">(</span><span class="s">""</span><span class="p">);</span>
<a id="rest_code_b24b8ed75e3b437ca8f7bd5c478ae60b-5" name="rest_code_b24b8ed75e3b437ca8f7bd5c478ae60b-5" href="posts/2016/05/speedup-compilation-by-13-by-simplifying-unit-test-with-catch.html#rest_code_b24b8ed75e3b437ca8f7bd5c478ae60b-5"></a><span class="w">    </span><span class="n">__result</span><span class="p">.</span><span class="n">endExpression</span><span class="p">();</span>
<a id="rest_code_b24b8ed75e3b437ca8f7bd5c478ae60b-6" name="rest_code_b24b8ed75e3b437ca8f7bd5c478ae60b-6" href="posts/2016/05/speedup-compilation-by-13-by-simplifying-unit-test-with-catch.html#rest_code_b24b8ed75e3b437ca8f7bd5c478ae60b-6"></a><span class="p">}</span>
<a id="rest_code_b24b8ed75e3b437ca8f7bd5c478ae60b-7" name="rest_code_b24b8ed75e3b437ca8f7bd5c478ae60b-7" href="posts/2016/05/speedup-compilation-by-13-by-simplifying-unit-test-with-catch.html#rest_code_b24b8ed75e3b437ca8f7bd5c478ae60b-7"></a>
<a id="rest_code_b24b8ed75e3b437ca8f7bd5c478ae60b-8" name="rest_code_b24b8ed75e3b437ca8f7bd5c478ae60b-8" href="posts/2016/05/speedup-compilation-by-13-by-simplifying-unit-test-with-catch.html#rest_code_b24b8ed75e3b437ca8f7bd5c478ae60b-8"></a><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">L</span><span class="p">,</span><span class="w"> </span><span class="k">typename</span><span class="w"> </span><span class="nc">R</span><span class="o">&gt;</span>
<a id="rest_code_b24b8ed75e3b437ca8f7bd5c478ae60b-9" name="rest_code_b24b8ed75e3b437ca8f7bd5c478ae60b-9" href="posts/2016/05/speedup-compilation-by-13-by-simplifying-unit-test-with-catch.html#rest_code_b24b8ed75e3b437ca8f7bd5c478ae60b-9"></a><span class="kt">void</span><span class="w"> </span><span class="n">evaluate_result</span><span class="p">(</span><span class="n">Catch</span><span class="o">::</span><span class="n">ResultBuilder</span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">__result</span><span class="p">,</span><span class="w"> </span><span class="n">L</span><span class="w"> </span><span class="n">lhs</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="w"> </span><span class="n">rhs</span><span class="p">){</span>
<a id="rest_code_b24b8ed75e3b437ca8f7bd5c478ae60b-10" name="rest_code_b24b8ed75e3b437ca8f7bd5c478ae60b-10" href="posts/2016/05/speedup-compilation-by-13-by-simplifying-unit-test-with-catch.html#rest_code_b24b8ed75e3b437ca8f7bd5c478ae60b-10"></a><span class="w">    </span><span class="n">__result</span><span class="p">.</span><span class="n">setResultType</span><span class="p">(</span><span class="n">lhs</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">rhs</span><span class="p">);</span>
<a id="rest_code_b24b8ed75e3b437ca8f7bd5c478ae60b-11" name="rest_code_b24b8ed75e3b437ca8f7bd5c478ae60b-11" href="posts/2016/05/speedup-compilation-by-13-by-simplifying-unit-test-with-catch.html#rest_code_b24b8ed75e3b437ca8f7bd5c478ae60b-11"></a><span class="w">    </span><span class="n">__result</span><span class="p">.</span><span class="n">setLhs</span><span class="p">(</span><span class="n">Catch</span><span class="o">::</span><span class="n">toString</span><span class="p">(</span><span class="n">lhs</span><span class="p">));</span>
<a id="rest_code_b24b8ed75e3b437ca8f7bd5c478ae60b-12" name="rest_code_b24b8ed75e3b437ca8f7bd5c478ae60b-12" href="posts/2016/05/speedup-compilation-by-13-by-simplifying-unit-test-with-catch.html#rest_code_b24b8ed75e3b437ca8f7bd5c478ae60b-12"></a><span class="w">    </span><span class="n">__result</span><span class="p">.</span><span class="n">setRhs</span><span class="p">(</span><span class="n">Catch</span><span class="o">::</span><span class="n">toString</span><span class="p">(</span><span class="n">rhs</span><span class="p">));</span>
<a id="rest_code_b24b8ed75e3b437ca8f7bd5c478ae60b-13" name="rest_code_b24b8ed75e3b437ca8f7bd5c478ae60b-13" href="posts/2016/05/speedup-compilation-by-13-by-simplifying-unit-test-with-catch.html#rest_code_b24b8ed75e3b437ca8f7bd5c478ae60b-13"></a><span class="w">    </span><span class="n">__result</span><span class="p">.</span><span class="n">setOp</span><span class="p">(</span><span class="s">"=="</span><span class="p">);</span>
<a id="rest_code_b24b8ed75e3b437ca8f7bd5c478ae60b-14" name="rest_code_b24b8ed75e3b437ca8f7bd5c478ae60b-14" href="posts/2016/05/speedup-compilation-by-13-by-simplifying-unit-test-with-catch.html#rest_code_b24b8ed75e3b437ca8f7bd5c478ae60b-14"></a><span class="w">    </span><span class="n">__result</span><span class="p">.</span><span class="n">endExpression</span><span class="p">();</span>
<a id="rest_code_b24b8ed75e3b437ca8f7bd5c478ae60b-15" name="rest_code_b24b8ed75e3b437ca8f7bd5c478ae60b-15" href="posts/2016/05/speedup-compilation-by-13-by-simplifying-unit-test-with-catch.html#rest_code_b24b8ed75e3b437ca8f7bd5c478ae60b-15"></a><span class="p">}</span>
<a id="rest_code_b24b8ed75e3b437ca8f7bd5c478ae60b-16" name="rest_code_b24b8ed75e3b437ca8f7bd5c478ae60b-16" href="posts/2016/05/speedup-compilation-by-13-by-simplifying-unit-test-with-catch.html#rest_code_b24b8ed75e3b437ca8f7bd5c478ae60b-16"></a>
<a id="rest_code_b24b8ed75e3b437ca8f7bd5c478ae60b-17" name="rest_code_b24b8ed75e3b437ca8f7bd5c478ae60b-17" href="posts/2016/05/speedup-compilation-by-13-by-simplifying-unit-test-with-catch.html#rest_code_b24b8ed75e3b437ca8f7bd5c478ae60b-17"></a><span class="cp">#define REQUIRE_DIRECT(value) \</span>
<a id="rest_code_b24b8ed75e3b437ca8f7bd5c478ae60b-18" name="rest_code_b24b8ed75e3b437ca8f7bd5c478ae60b-18" href="posts/2016/05/speedup-compilation-by-13-by-simplifying-unit-test-with-catch.html#rest_code_b24b8ed75e3b437ca8f7bd5c478ae60b-18"></a><span class="cp">    evaluate_result_direct(Catch::ResultBuilder( "REQUIRE", CATCH_INTERNAL_LINEINFO, #value, Catch::ResultDisposition::Normal ), value);</span>
<a id="rest_code_b24b8ed75e3b437ca8f7bd5c478ae60b-19" name="rest_code_b24b8ed75e3b437ca8f7bd5c478ae60b-19" href="posts/2016/05/speedup-compilation-by-13-by-simplifying-unit-test-with-catch.html#rest_code_b24b8ed75e3b437ca8f7bd5c478ae60b-19"></a>
<a id="rest_code_b24b8ed75e3b437ca8f7bd5c478ae60b-20" name="rest_code_b24b8ed75e3b437ca8f7bd5c478ae60b-20" href="posts/2016/05/speedup-compilation-by-13-by-simplifying-unit-test-with-catch.html#rest_code_b24b8ed75e3b437ca8f7bd5c478ae60b-20"></a><span class="cp">#define REQUIRE_EQUALS(lhs, rhs) \</span>
<a id="rest_code_b24b8ed75e3b437ca8f7bd5c478ae60b-21" name="rest_code_b24b8ed75e3b437ca8f7bd5c478ae60b-21" href="posts/2016/05/speedup-compilation-by-13-by-simplifying-unit-test-with-catch.html#rest_code_b24b8ed75e3b437ca8f7bd5c478ae60b-21"></a><span class="cp">    evaluate_result(Catch::ResultBuilder( "REQUIRE", CATCH_INTERNAL_LINEINFO, #lhs " == " #rhs, Catch::ResultDisposition::Normal ), lhs, rhs);</span>
</pre></div>
<p>There is really nothing too special about it, I simply followed the macros and
functions in Catch source code until I found out what to bypass.</p>
<p>And now, we use them directly:</p>
<div class="code"><pre class="code cpp"><a id="rest_code_bf6a7195911d4aed8161178aaffa2139-1" name="rest_code_bf6a7195911d4aed8161178aaffa2139-1" href="posts/2016/05/speedup-compilation-by-13-by-simplifying-unit-test-with-catch.html#rest_code_bf6a7195911d4aed8161178aaffa2139-1"></a><span class="n">REQUIRE_DIRECT</span><span class="p">(</span><span class="n">am_i_true</span><span class="p">());</span>
<a id="rest_code_bf6a7195911d4aed8161178aaffa2139-2" name="rest_code_bf6a7195911d4aed8161178aaffa2139-2" href="posts/2016/05/speedup-compilation-by-13-by-simplifying-unit-test-with-catch.html#rest_code_bf6a7195911d4aed8161178aaffa2139-2"></a><span class="n">REQUIRE_EQUALS</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">);</span>
</pre></div>
<p>This is a bit less nice and it requires to know a few more macros, I admit, but
it turns out to be much faster (and who really cares about the beauty of test
code anyway...). Indeed, the total compilation time of the tests went from 764
seconds to 664 seconds!  This is <strong>a 13% reduction of the compilation time</strong>!
I really am impressed of the overhead of this technique. I cannot justify this
slowdown just for a bit nicer test code. Finally, the output in case of error
remains exactly the same as before.</p>
<p>This proves that sometimes the bottlenecks are not where we expect them :)</p>
<p>If you are interested, you can find the adapted code on <a class="reference external" href="https://github.com/wichtounet/etl/blob/master/test/include/fast_catch.hpp">Github</a>.</p>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/2016/04/simplify-deep-learning-library-usage-on-linux-and-windows.html" class="u-url">Simplify Deep Learning Library usage on Linux and Windows!</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Baptiste Wicht
            </span></p>
            <p class="dateline">
            <a href="posts/2016/04/simplify-deep-learning-library-usage-on-linux-and-windows.html" rel="bookmark">
            <time class="published dt-published" datetime="2016-04-29T12:48:18+02:00" itemprop="datePublished" title="2016-04-29 12:48">2016-04-29 12:48</time></a>
            </p>
                <p class="commentline">
    
    <a href="posts/2016/04/simplify-deep-learning-library-usage-on-linux-and-windows.html#disqus_thread" data-disqus-identifier="cache/posts/2016/04/simplify-deep-learning-library-usage-on-linux-and-windows.html">Comments</a>


        </p>
</div>
    </header><div class="p-summary entry-summary">
    <p>No, I'm not dead ;) I've been very busy with my Ph.D (and playing Path of Exile,
let's be honest...) and haven't had time to write something here in a long time.</p>
<p>Until now, there was too way to use my
<a class="reference external" href="https://github.com/wichtounet/dll/">Deep Learning Library (DLL)</a> project:</p>
<ol class="arabic simple">
<li><p>Write a C++ program that uses the library</p></li>
<li><p>Install DLL and write a configuration file to define your network and the problem to solve</p></li>
</ol>
<p>The first version gives you all the features of the tool and allows you to build
exactly what you need. The second version is a bit more limited, but does not
require any C++ knowledge. However, it still does require a recent C++ compiler
and build system.</p>
<p>Due to the high C++ requirements that are not met by Visual Studio and the fact
that I don't work on Windows, this platform is not supported by the tool. Until
now!</p>
<p>I've added a third option to use DLL in the form of a Docker image to make the
second option even easier and allow the use of DLL on Windows. All you need is
Docker, which is available on Linux, Mac and Windows. This is still limited to
the second option in that you need to write a configuration describing the
network, but you need to build DLL and don't need to install all its
dependencies.</p>
<section id="usage"><h2>Usage</h2>
<p>To install the image, you can simply use <cite>docker pull</cite>:</p>
<div class="code"><pre class="code bash"><a id="rest_code_acb060ce8faf4058a0c429d194cc7e8d-1" name="rest_code_acb060ce8faf4058a0c429d194cc7e8d-1" href="posts/2016/04/simplify-deep-learning-library-usage-on-linux-and-windows.html#rest_code_acb060ce8faf4058a0c429d194cc7e8d-1"></a>docker<span class="w"> </span>pull<span class="w"> </span>wichtounet/docker-dll
</pre></div>
<p>Then, to run it, you have to create a folder containing a <cite>dll.conf</cite> file and
mount in the container at <cite>/dll/data/</cite>. There are some examples in the
<a class="reference external" href="https://github.com/wichtounet/docker-dll/">image repository</a>.  For instance,
on Linux from the cloned repository:</p>
<div class="code"><pre class="code bash"><a id="rest_code_655292abdd314e299046c19cc3905e8e-1" name="rest_code_655292abdd314e299046c19cc3905e8e-1" href="posts/2016/04/simplify-deep-learning-library-usage-on-linux-and-windows.html#rest_code_655292abdd314e299046c19cc3905e8e-1"></a>docker<span class="w"> </span>run<span class="w"> </span>-v<span class="w"> </span><span class="si">${</span><span class="nv">pwd</span><span class="si">}</span>/rbm_mnist/:/dll/data/<span class="w"> </span>wichtounet/docker-dll
</pre></div>
<p>or on Windows:</p>
<div class="code"><pre class="code bash"><a id="rest_code_a7f6991824714c679b20775bc0db0134-1" name="rest_code_a7f6991824714c679b20775bc0db0134-1" href="posts/2016/04/simplify-deep-learning-library-usage-on-linux-and-windows.html#rest_code_a7f6991824714c679b20775bc0db0134-1"></a>docker<span class="w"> </span>run<span class="w"> </span>-v<span class="w"> </span>/c/Users/Baptiste/rbm_mnist/:/dll/data<span class="w"> </span>wichtounet/docker-dll
</pre></div>
<p>This will automatically run the actions specified in the configuration file and
train your network.</p>
</section><section id="conclusion-4"><h2>Conclusion</h2>
<p>I would really have thought this would be harder, but it turned out that Docker
is a very good solution to deploy multiplatform demo tools :)</p>
<p>As of now, there is only support for mnist data format in the tool in this
form, but I plan to add basic CSV support as well in the near future.</p>
<p>I hope that this will help people willing to try the library with a simpler
usage.</p>
</section>
</div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/2016/02/use-templight-and-templar-to-debug-cpp-templates.html" class="u-url">Use templight and Templar to debug C++ templates</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Baptiste Wicht
            </span></p>
            <p class="dateline">
            <a href="posts/2016/02/use-templight-and-templar-to-debug-cpp-templates.html" rel="bookmark">
            <time class="published dt-published" datetime="2016-02-08T08:11:18+01:00" itemprop="datePublished" title="2016-02-08 08:11">2016-02-08 08:11</time></a>
            </p>
                <p class="commentline">
    
    <a href="posts/2016/02/use-templight-and-templar-to-debug-cpp-templates.html#disqus_thread" data-disqus-identifier="cache/posts/2016/02/use-templight-and-templar-to-debug-cpp-templates.html">Comments</a>


        </p>
</div>
    </header><div class="p-summary entry-summary">
    <p>C++ has some very good tools to debug, profile and analyze source files and executables. This all works well for standard runtime program. But, when you are using templates, you sometimes want these tools to act at compile-time. And at this point the support is much more scarce.</p>
<p><a class="reference external" href="https://github.com/mikael-s-persson/templight">templight</a> and <a class="reference external" href="https://github.com/schulmar/Templar">Templar</a> and two tools that are trying to fix this issue.</p>
<p>From the templight site:</p>
<blockquote>
<p>Templight is a Clang-based tool to profile the time and memory consumption of template instantiations and to perform interactive debugging sessions to gain introspection into the template instantiation process.</p>
</blockquote>
<p>and Templar is a visualization tool for the traces generated by templight.</p>
<section id="installation"><h2>Installation</h2>
<p>Unfortunately, the templight installation is not user-friendly at all. You need to clone the complete LLVM/Clang tree and add templight inside it before compiling the complete clang toolchain. But that is the case for all clang-based tools... You also need to patch clang but that may not be necessary in the future. The complete instructions are available <a class="reference external" href="https://github.com/mikael-s-persson/templight#getting-and-compiling-templight">here</a>.</p>
<p>The installation of Templar is much more convenient:</p>
<div class="code"><pre class="code bash"><a id="rest_code_28bbe608b202477e805bd2660c8d260d-1" name="rest_code_28bbe608b202477e805bd2660c8d260d-1" href="posts/2016/02/use-templight-and-templar-to-debug-cpp-templates.html#rest_code_28bbe608b202477e805bd2660c8d260d-1"></a>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/schulmar/Templar.git
<a id="rest_code_28bbe608b202477e805bd2660c8d260d-2" name="rest_code_28bbe608b202477e805bd2660c8d260d-2" href="posts/2016/02/use-templight-and-templar-to-debug-cpp-templates.html#rest_code_28bbe608b202477e805bd2660c8d260d-2"></a><span class="nb">cd</span><span class="w"> </span>Templar
<a id="rest_code_28bbe608b202477e805bd2660c8d260d-3" name="rest_code_28bbe608b202477e805bd2660c8d260d-3" href="posts/2016/02/use-templight-and-templar-to-debug-cpp-templates.html#rest_code_28bbe608b202477e805bd2660c8d260d-3"></a>git<span class="w"> </span>checkout<span class="w"> </span>feature/templight2
<a id="rest_code_28bbe608b202477e805bd2660c8d260d-4" name="rest_code_28bbe608b202477e805bd2660c8d260d-4" href="posts/2016/02/use-templight-and-templar-to-debug-cpp-templates.html#rest_code_28bbe608b202477e805bd2660c8d260d-4"></a>qmake<span class="w"> </span>.
<a id="rest_code_28bbe608b202477e805bd2660c8d260d-5" name="rest_code_28bbe608b202477e805bd2660c8d260d-5" href="posts/2016/02/use-templight-and-templar-to-debug-cpp-templates.html#rest_code_28bbe608b202477e805bd2660c8d260d-5"></a>make
<a id="rest_code_28bbe608b202477e805bd2660c8d260d-6" name="rest_code_28bbe608b202477e805bd2660c8d260d-6" href="posts/2016/02/use-templight-and-templar-to-debug-cpp-templates.html#rest_code_28bbe608b202477e805bd2660c8d260d-6"></a>sudo<span class="w"> </span>make<span class="w"> </span>install
</pre></div>
<p>The branch feature/templight2 has much more features than the master and should support both Qt4 and Qt5, but I have only tested it on Qt4.</p>
</section><section id="example"><h2>Example</h2>
<p>Let's use the class Fibonacci function as an example:</p>
<div class="code"><pre class="code cpp"><a id="rest_code_01d392daf97c4ec39f9af56a6dbd19d9-1" name="rest_code_01d392daf97c4ec39f9af56a6dbd19d9-1" href="posts/2016/02/use-templight-and-templar-to-debug-cpp-templates.html#rest_code_01d392daf97c4ec39f9af56a6dbd19d9-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iostream&gt;</span>
<a id="rest_code_01d392daf97c4ec39f9af56a6dbd19d9-2" name="rest_code_01d392daf97c4ec39f9af56a6dbd19d9-2" href="posts/2016/02/use-templight-and-templar-to-debug-cpp-templates.html#rest_code_01d392daf97c4ec39f9af56a6dbd19d9-2"></a>
<a id="rest_code_01d392daf97c4ec39f9af56a6dbd19d9-3" name="rest_code_01d392daf97c4ec39f9af56a6dbd19d9-3" href="posts/2016/02/use-templight-and-templar-to-debug-cpp-templates.html#rest_code_01d392daf97c4ec39f9af56a6dbd19d9-3"></a><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span><span class="w"> </span><span class="n">N</span><span class="o">&gt;</span>
<a id="rest_code_01d392daf97c4ec39f9af56a6dbd19d9-4" name="rest_code_01d392daf97c4ec39f9af56a6dbd19d9-4" href="posts/2016/02/use-templight-and-templar-to-debug-cpp-templates.html#rest_code_01d392daf97c4ec39f9af56a6dbd19d9-4"></a><span class="k">struct</span><span class="w"> </span><span class="nc">Fibonacci</span><span class="w"> </span><span class="p">{</span>
<a id="rest_code_01d392daf97c4ec39f9af56a6dbd19d9-5" name="rest_code_01d392daf97c4ec39f9af56a6dbd19d9-5" href="posts/2016/02/use-templight-and-templar-to-debug-cpp-templates.html#rest_code_01d392daf97c4ec39f9af56a6dbd19d9-5"></a><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="k">constexpr</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Fibonacci</span><span class="o">&lt;</span><span class="n">N</span><span class="mi">-1</span><span class="o">&gt;::</span><span class="n">value</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Fibonacci</span><span class="o">&lt;</span><span class="n">N</span><span class="mi">-2</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">;</span>
<a id="rest_code_01d392daf97c4ec39f9af56a6dbd19d9-6" name="rest_code_01d392daf97c4ec39f9af56a6dbd19d9-6" href="posts/2016/02/use-templight-and-templar-to-debug-cpp-templates.html#rest_code_01d392daf97c4ec39f9af56a6dbd19d9-6"></a><span class="p">};</span>
<a id="rest_code_01d392daf97c4ec39f9af56a6dbd19d9-7" name="rest_code_01d392daf97c4ec39f9af56a6dbd19d9-7" href="posts/2016/02/use-templight-and-templar-to-debug-cpp-templates.html#rest_code_01d392daf97c4ec39f9af56a6dbd19d9-7"></a>
<a id="rest_code_01d392daf97c4ec39f9af56a6dbd19d9-8" name="rest_code_01d392daf97c4ec39f9af56a6dbd19d9-8" href="posts/2016/02/use-templight-and-templar-to-debug-cpp-templates.html#rest_code_01d392daf97c4ec39f9af56a6dbd19d9-8"></a><span class="k">template</span><span class="w"> </span><span class="o">&lt;&gt;</span>
<a id="rest_code_01d392daf97c4ec39f9af56a6dbd19d9-9" name="rest_code_01d392daf97c4ec39f9af56a6dbd19d9-9" href="posts/2016/02/use-templight-and-templar-to-debug-cpp-templates.html#rest_code_01d392daf97c4ec39f9af56a6dbd19d9-9"></a><span class="k">struct</span><span class="w"> </span><span class="nc">Fibonacci</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="rest_code_01d392daf97c4ec39f9af56a6dbd19d9-10" name="rest_code_01d392daf97c4ec39f9af56a6dbd19d9-10" href="posts/2016/02/use-templight-and-templar-to-debug-cpp-templates.html#rest_code_01d392daf97c4ec39f9af56a6dbd19d9-10"></a><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="k">constexpr</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="rest_code_01d392daf97c4ec39f9af56a6dbd19d9-11" name="rest_code_01d392daf97c4ec39f9af56a6dbd19d9-11" href="posts/2016/02/use-templight-and-templar-to-debug-cpp-templates.html#rest_code_01d392daf97c4ec39f9af56a6dbd19d9-11"></a><span class="p">};</span>
<a id="rest_code_01d392daf97c4ec39f9af56a6dbd19d9-12" name="rest_code_01d392daf97c4ec39f9af56a6dbd19d9-12" href="posts/2016/02/use-templight-and-templar-to-debug-cpp-templates.html#rest_code_01d392daf97c4ec39f9af56a6dbd19d9-12"></a>
<a id="rest_code_01d392daf97c4ec39f9af56a6dbd19d9-13" name="rest_code_01d392daf97c4ec39f9af56a6dbd19d9-13" href="posts/2016/02/use-templight-and-templar-to-debug-cpp-templates.html#rest_code_01d392daf97c4ec39f9af56a6dbd19d9-13"></a><span class="k">template</span><span class="w"> </span><span class="o">&lt;&gt;</span>
<a id="rest_code_01d392daf97c4ec39f9af56a6dbd19d9-14" name="rest_code_01d392daf97c4ec39f9af56a6dbd19d9-14" href="posts/2016/02/use-templight-and-templar-to-debug-cpp-templates.html#rest_code_01d392daf97c4ec39f9af56a6dbd19d9-14"></a><span class="k">struct</span><span class="w"> </span><span class="nc">Fibonacci</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="rest_code_01d392daf97c4ec39f9af56a6dbd19d9-15" name="rest_code_01d392daf97c4ec39f9af56a6dbd19d9-15" href="posts/2016/02/use-templight-and-templar-to-debug-cpp-templates.html#rest_code_01d392daf97c4ec39f9af56a6dbd19d9-15"></a><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="k">constexpr</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="rest_code_01d392daf97c4ec39f9af56a6dbd19d9-16" name="rest_code_01d392daf97c4ec39f9af56a6dbd19d9-16" href="posts/2016/02/use-templight-and-templar-to-debug-cpp-templates.html#rest_code_01d392daf97c4ec39f9af56a6dbd19d9-16"></a><span class="p">};</span>
<a id="rest_code_01d392daf97c4ec39f9af56a6dbd19d9-17" name="rest_code_01d392daf97c4ec39f9af56a6dbd19d9-17" href="posts/2016/02/use-templight-and-templar-to-debug-cpp-templates.html#rest_code_01d392daf97c4ec39f9af56a6dbd19d9-17"></a>
<a id="rest_code_01d392daf97c4ec39f9af56a6dbd19d9-18" name="rest_code_01d392daf97c4ec39f9af56a6dbd19d9-18" href="posts/2016/02/use-templight-and-templar-to-debug-cpp-templates.html#rest_code_01d392daf97c4ec39f9af56a6dbd19d9-18"></a><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(){</span>
<a id="rest_code_01d392daf97c4ec39f9af56a6dbd19d9-19" name="rest_code_01d392daf97c4ec39f9af56a6dbd19d9-19" href="posts/2016/02/use-templight-and-templar-to-debug-cpp-templates.html#rest_code_01d392daf97c4ec39f9af56a6dbd19d9-19"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">"Fibonacci&lt;5&gt;:"</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">Fibonacci</span><span class="o">&lt;</span><span class="mi">5</span><span class="o">&gt;::</span><span class="n">value</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<a id="rest_code_01d392daf97c4ec39f9af56a6dbd19d9-20" name="rest_code_01d392daf97c4ec39f9af56a6dbd19d9-20" href="posts/2016/02/use-templight-and-templar-to-debug-cpp-templates.html#rest_code_01d392daf97c4ec39f9af56a6dbd19d9-20"></a><span class="p">}</span>
</pre></div>
<p>Nothing fancy here, we're simply printing the fifth Fibonacci number on the console.</p>
<p>You can compile it with templight++:</p>
<div class="code"><pre class="code bash"><a id="rest_code_b385a39ea3894995a9f4559e0f7513c3-1" name="rest_code_b385a39ea3894995a9f4559e0f7513c3-1" href="posts/2016/02/use-templight-and-templar-to-debug-cpp-templates.html#rest_code_b385a39ea3894995a9f4559e0f7513c3-1"></a>templight++<span class="w"> </span>-Xtemplight<span class="w"> </span>-profiler<span class="w"> </span>-Xtemplight<span class="w"> </span>-memory<span class="w"> </span>-Xtemplight<span class="w"> </span>-ignore-system<span class="w"> </span>-std<span class="o">=</span>c++14<span class="w"> </span>main.cpp
</pre></div>
<p>All the templight options starts with -Xtemplight and then you can use any clang++ options. This will generate a <em>a.memory.trace.pbf</em> file in the current directory. You can then run Templar. use File &gt; Open Trace to open the trace file. This should open a window of this sort:</p>
<img alt="/images/templar.png" class="align-center" src="images/templar.png"><p>The top-left panel contains the source code of the application, automatically
refreshed whenever you move in the template tree. In the top right, there is
the template instantiation graph. In the bottom left, you'll see a list of list
of files to be able to filter them and in the bottom right, you'll see the list
of templates events. You can sort the list of template events by duration which
is really convenient. You can then select Fibonacci&lt;5&gt; by double clicking it in
the list (once sorted, it should be near the top). This should give you a tree
looking something like that:</p>
<img alt="/images/templar_tree.png" class="align-center" src="images/templar_tree.png"><p>The edgy nodes are template instantiations and the round nodes are template
memoization. We can directly see that each instantiation was only done once. I
think this graph view is really helpful if you need to debug computation done
at compile time. You can see that that not all nodes are displayed, this is
because there is a limit on the displayed depth. Simply click on Fibonacci&lt;3&gt;
and the remaining nodes will be shown.</p>
<p>I have already used this tool to find the most time-consuming templates in ETL
an DLL. This is a great tool to indicate where you should focus on improving
the template compile-time. I have also been able to find some unnecessary
instantiations that could be avoided (either with SFINAE or with refactorings).</p>
<p>templight also contains a fully-fledged debugger for template programs, but I haven't tested it.</p>
</section><section id="conclusion-3"><h2>Conclusion</h2>
<p>In conclusion, I would say that templight and Templar are really helping with
template debugging and profiling. There is a real lack of tools in this domain
and I hope to see more tools of this kind in the future. I hope this will help
you develop template-heavy programs or template metaprograms.</p>
</section>
</div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/2016/01/improve-dll-and-etl-compile-time-further.html" class="u-url">Improve DLL and ETL Compile Time further</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Baptiste Wicht
            </span></p>
            <p class="dateline">
            <a href="posts/2016/01/improve-dll-and-etl-compile-time-further.html" rel="bookmark">
            <time class="published dt-published" datetime="2016-01-29T17:02:34+01:00" itemprop="datePublished" title="2016-01-29 17:02">2016-01-29 17:02</time></a>
            </p>
                <p class="commentline">
    
    <a href="posts/2016/01/improve-dll-and-etl-compile-time-further.html#disqus_thread" data-disqus-identifier="cache/posts/2016/01/improve-dll-and-etl-compile-time-further.html">Comments</a>


        </p>
</div>
    </header><div class="p-summary entry-summary">
    <p>For a while, the compilation time of my matrix/vector computation library (ETL), based on Expression Templates has become more and more problematic. I've already worked on this problem <a class="reference external" href="http://baptiste-wicht.com/posts/2015/06/how-i-improved-a-bit-compile-time-of-etl.html">here</a> and <a class="reference external" href="http://baptiste-wicht.com/posts/2015/06/improve-etl-compile-time-with-precompiled-headers.html">there</a>, using some general techniques (pragmas, precompiled headers, header removals and so on). On this post, I'll talk about two major improvements I have been able to do directly in the code.</p>
<section id="use-of-static-if"><h2>Use of static_if</h2>
<p>Remember <a class="reference external" href="http://baptiste-wicht.com/posts/2015/07/simulate-static_if-with-c11c14.html">static_if</a> ? I was able to use it to really reduce the compile time of DLL.</p>
<p>I wrote a script to time each test case of the DLL project to find the test cases that took the longest to compile. Once I found the best candidate, I isolated the functions that took the longest to compile. It was quite tedious and I did it by hand, primarily by commenting parts of the code and going deeper and deeper in the code. I was quite suprised to find that a single function call (template function of course ;) ) was responsible for 60% of the compilation time of my candidate test case. The function was instantiating a whole bunch of expression templates (to compute the free energy of several models). The function itself was not really optimizable, but what was really interesting is that this function was only used in some very rare cases and that these cases were known at compile-time :) This was a perfect case to use a static_if. And once the call was inside the static_if, the test case was indeed about 60% faster. <strong>This reduced the overall compilation time of DLL by about 30%</strong>!</p>
<p>This could also of course also have been achieved by using two functions, one with the call, one empty and selected by SFINAE (Substitution Failure Is Not An Error). I prefer the statif_if version since this really shows the intent and hides SFINAE behind nicer syntax.</p>
<p>I was also able to use static_if at other places in the DLL code to avoid instantiating some templates, but the improvements were much less dramatic (about 1% of the total compilation time). I was very lucky to find a single function that accounted for so much compile time. After some more tests, I concluded that much of the compilation time of DLL was spent compiling the Expression Templates from my ETL library so I decided to delve into ETL code directly.</p>
</section><section id="removal-of-std-async"><h2>Removal of std::async</h2>
<p>The second improvement was very surprising. I was working on improving the compilation of ETL and found out that the sum and average reductions of matrices were dramatically slow, about an order of magnitude slower than standard operations on matrices. In parallel (but the two facts are linked), I also found out another weird fact when splitting a file into 10 parts (the file was comprised of 10 test cases). Compiling the 10 parts separarely (and sequentially, not multiple threads) was about 40% faster than compiling the complete file. There was no swapping so it was not a memory issue. This is not expected. Generally, it is faster to compile a big file than to compile its parts separately. The advantage of smaller files is that you can compile them in parallel and that incremental builds are faster (only compile a small part).</p>
<p>By elimination, I found out that most of the time was spent inside the function that was dispatching in parallel the work for accumulating the sum of a matrix. Here is the function:</p>
<div class="code"><pre class="code cpp"><a id="rest_code_81ad6613abd64e46934bd6d539691bae-1" name="rest_code_81ad6613abd64e46934bd6d539691bae-1" href="posts/2016/01/improve-dll-and-etl-compile-time-further.html#rest_code_81ad6613abd64e46934bd6d539691bae-1"></a><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">T</span><span class="p">,</span><span class="w"> </span><span class="k">typename</span><span class="w"> </span><span class="nc">Functor</span><span class="p">,</span><span class="w"> </span><span class="k">typename</span><span class="w"> </span><span class="nc">AccFunctor</span><span class="o">&gt;</span>
<a id="rest_code_81ad6613abd64e46934bd6d539691bae-2" name="rest_code_81ad6613abd64e46934bd6d539691bae-2" href="posts/2016/01/improve-dll-and-etl-compile-time-further.html#rest_code_81ad6613abd64e46934bd6d539691bae-2"></a><span class="kr">inline</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">dispatch_1d_acc</span><span class="p">(</span><span class="kt">bool</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">Functor</span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">functor</span><span class="p">,</span><span class="w"> </span><span class="n">AccFunctor</span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">acc_functor</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span><span class="w"> </span><span class="n">first</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span><span class="w"> </span><span class="n">last</span><span class="p">){</span>
<a id="rest_code_81ad6613abd64e46934bd6d539691bae-3" name="rest_code_81ad6613abd64e46934bd6d539691bae-3" href="posts/2016/01/improve-dll-and-etl-compile-time-further.html#rest_code_81ad6613abd64e46934bd6d539691bae-3"></a><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">p</span><span class="p">){</span>
<a id="rest_code_81ad6613abd64e46934bd6d539691bae-4" name="rest_code_81ad6613abd64e46934bd6d539691bae-4" href="posts/2016/01/improve-dll-and-etl-compile-time-further.html#rest_code_81ad6613abd64e46934bd6d539691bae-4"></a><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">future</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">futures</span><span class="p">(</span><span class="n">threads</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<a id="rest_code_81ad6613abd64e46934bd6d539691bae-5" name="rest_code_81ad6613abd64e46934bd6d539691bae-5" href="posts/2016/01/improve-dll-and-etl-compile-time-further.html#rest_code_81ad6613abd64e46934bd6d539691bae-5"></a>
<a id="rest_code_81ad6613abd64e46934bd6d539691bae-6" name="rest_code_81ad6613abd64e46934bd6d539691bae-6" href="posts/2016/01/improve-dll-and-etl-compile-time-further.html#rest_code_81ad6613abd64e46934bd6d539691bae-6"></a><span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">last</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">first</span><span class="p">;</span>
<a id="rest_code_81ad6613abd64e46934bd6d539691bae-7" name="rest_code_81ad6613abd64e46934bd6d539691bae-7" href="posts/2016/01/improve-dll-and-etl-compile-time-further.html#rest_code_81ad6613abd64e46934bd6d539691bae-7"></a><span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">batch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">threads</span><span class="p">;</span>
<a id="rest_code_81ad6613abd64e46934bd6d539691bae-8" name="rest_code_81ad6613abd64e46934bd6d539691bae-8" href="posts/2016/01/improve-dll-and-etl-compile-time-further.html#rest_code_81ad6613abd64e46934bd6d539691bae-8"></a>
<a id="rest_code_81ad6613abd64e46934bd6d539691bae-9" name="rest_code_81ad6613abd64e46934bd6d539691bae-9" href="posts/2016/01/improve-dll-and-etl-compile-time-further.html#rest_code_81ad6613abd64e46934bd6d539691bae-9"></a><span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">threads</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">t</span><span class="p">){</span>
<a id="rest_code_81ad6613abd64e46934bd6d539691bae-10" name="rest_code_81ad6613abd64e46934bd6d539691bae-10" href="posts/2016/01/improve-dll-and-etl-compile-time-further.html#rest_code_81ad6613abd64e46934bd6d539691bae-10"></a><span class="w">            </span><span class="n">futures</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">async</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">launch</span><span class="o">::</span><span class="n">async</span><span class="p">,</span><span class="w"> </span><span class="n">functor</span><span class="p">,</span><span class="w"> </span><span class="n">first</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">batch</span><span class="p">,</span><span class="w"> </span><span class="n">first</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">batch</span><span class="p">);</span>
<a id="rest_code_81ad6613abd64e46934bd6d539691bae-11" name="rest_code_81ad6613abd64e46934bd6d539691bae-11" href="posts/2016/01/improve-dll-and-etl-compile-time-further.html#rest_code_81ad6613abd64e46934bd6d539691bae-11"></a><span class="w">        </span><span class="p">}</span>
<a id="rest_code_81ad6613abd64e46934bd6d539691bae-12" name="rest_code_81ad6613abd64e46934bd6d539691bae-12" href="posts/2016/01/improve-dll-and-etl-compile-time-further.html#rest_code_81ad6613abd64e46934bd6d539691bae-12"></a>
<a id="rest_code_81ad6613abd64e46934bd6d539691bae-13" name="rest_code_81ad6613abd64e46934bd6d539691bae-13" href="posts/2016/01/improve-dll-and-etl-compile-time-further.html#rest_code_81ad6613abd64e46934bd6d539691bae-13"></a><span class="w">        </span><span class="n">acc_functor</span><span class="p">(</span><span class="n">functor</span><span class="p">(</span><span class="n">first</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">threads</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">batch</span><span class="p">,</span><span class="w"> </span><span class="n">last</span><span class="p">));</span>
<a id="rest_code_81ad6613abd64e46934bd6d539691bae-14" name="rest_code_81ad6613abd64e46934bd6d539691bae-14" href="posts/2016/01/improve-dll-and-etl-compile-time-further.html#rest_code_81ad6613abd64e46934bd6d539691bae-14"></a>
<a id="rest_code_81ad6613abd64e46934bd6d539691bae-15" name="rest_code_81ad6613abd64e46934bd6d539691bae-15" href="posts/2016/01/improve-dll-and-etl-compile-time-further.html#rest_code_81ad6613abd64e46934bd6d539691bae-15"></a><span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">fut</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">futures</span><span class="p">){</span>
<a id="rest_code_81ad6613abd64e46934bd6d539691bae-16" name="rest_code_81ad6613abd64e46934bd6d539691bae-16" href="posts/2016/01/improve-dll-and-etl-compile-time-further.html#rest_code_81ad6613abd64e46934bd6d539691bae-16"></a><span class="w">            </span><span class="n">acc_functor</span><span class="p">(</span><span class="n">fut</span><span class="p">.</span><span class="n">get</span><span class="p">());</span>
<a id="rest_code_81ad6613abd64e46934bd6d539691bae-17" name="rest_code_81ad6613abd64e46934bd6d539691bae-17" href="posts/2016/01/improve-dll-and-etl-compile-time-further.html#rest_code_81ad6613abd64e46934bd6d539691bae-17"></a><span class="w">        </span><span class="p">}</span>
<a id="rest_code_81ad6613abd64e46934bd6d539691bae-18" name="rest_code_81ad6613abd64e46934bd6d539691bae-18" href="posts/2016/01/improve-dll-and-etl-compile-time-further.html#rest_code_81ad6613abd64e46934bd6d539691bae-18"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="rest_code_81ad6613abd64e46934bd6d539691bae-19" name="rest_code_81ad6613abd64e46934bd6d539691bae-19" href="posts/2016/01/improve-dll-and-etl-compile-time-further.html#rest_code_81ad6613abd64e46934bd6d539691bae-19"></a><span class="w">        </span><span class="n">acc_functor</span><span class="p">(</span><span class="n">functor</span><span class="p">(</span><span class="n">first</span><span class="p">,</span><span class="w"> </span><span class="n">last</span><span class="p">));</span>
<a id="rest_code_81ad6613abd64e46934bd6d539691bae-20" name="rest_code_81ad6613abd64e46934bd6d539691bae-20" href="posts/2016/01/improve-dll-and-etl-compile-time-further.html#rest_code_81ad6613abd64e46934bd6d539691bae-20"></a><span class="w">    </span><span class="p">}</span>
<a id="rest_code_81ad6613abd64e46934bd6d539691bae-21" name="rest_code_81ad6613abd64e46934bd6d539691bae-21" href="posts/2016/01/improve-dll-and-etl-compile-time-further.html#rest_code_81ad6613abd64e46934bd6d539691bae-21"></a><span class="p">}</span>
</pre></div>
<p>There isn't anything really fancy about this function. This takes one functor that will be done in parallel and one function for accumulation.  It dispatches all the work in batch and then accumulates the results. I tried several things to optimize the compilation time of this function, but nothing worked. The line that was consuming all the time was the std::async line. This function was using std::async because the thread pool that I'm generally using does not support returning values from parallel functors. I decided to use a workaround and use my thread pool and I came out with this version:</p>
<div class="code"><pre class="code cpp"><a id="rest_code_b37008f623424063ab1d09c30e4b6e7e-1" name="rest_code_b37008f623424063ab1d09c30e4b6e7e-1" href="posts/2016/01/improve-dll-and-etl-compile-time-further.html#rest_code_b37008f623424063ab1d09c30e4b6e7e-1"></a><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">T</span><span class="p">,</span><span class="w"> </span><span class="k">typename</span><span class="w"> </span><span class="nc">Functor</span><span class="p">,</span><span class="w"> </span><span class="k">typename</span><span class="w"> </span><span class="nc">AccFunctor</span><span class="o">&gt;</span>
<a id="rest_code_b37008f623424063ab1d09c30e4b6e7e-2" name="rest_code_b37008f623424063ab1d09c30e4b6e7e-2" href="posts/2016/01/improve-dll-and-etl-compile-time-further.html#rest_code_b37008f623424063ab1d09c30e4b6e7e-2"></a><span class="kr">inline</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">dispatch_1d_acc</span><span class="p">(</span><span class="kt">bool</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">Functor</span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">functor</span><span class="p">,</span><span class="w"> </span><span class="n">AccFunctor</span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">acc_functor</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span><span class="w"> </span><span class="n">first</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span><span class="w"> </span><span class="n">last</span><span class="p">){</span>
<a id="rest_code_b37008f623424063ab1d09c30e4b6e7e-3" name="rest_code_b37008f623424063ab1d09c30e4b6e7e-3" href="posts/2016/01/improve-dll-and-etl-compile-time-further.html#rest_code_b37008f623424063ab1d09c30e4b6e7e-3"></a><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">p</span><span class="p">){</span>
<a id="rest_code_b37008f623424063ab1d09c30e4b6e7e-4" name="rest_code_b37008f623424063ab1d09c30e4b6e7e-4" href="posts/2016/01/improve-dll-and-etl-compile-time-further.html#rest_code_b37008f623424063ab1d09c30e4b6e7e-4"></a><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">futures</span><span class="p">(</span><span class="n">threads</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<a id="rest_code_b37008f623424063ab1d09c30e4b6e7e-5" name="rest_code_b37008f623424063ab1d09c30e4b6e7e-5" href="posts/2016/01/improve-dll-and-etl-compile-time-further.html#rest_code_b37008f623424063ab1d09c30e4b6e7e-5"></a><span class="w">        </span><span class="n">cpp</span><span class="o">::</span><span class="n">default_thread_pool</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">pool</span><span class="p">(</span><span class="n">threads</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<a id="rest_code_b37008f623424063ab1d09c30e4b6e7e-6" name="rest_code_b37008f623424063ab1d09c30e4b6e7e-6" href="posts/2016/01/improve-dll-and-etl-compile-time-further.html#rest_code_b37008f623424063ab1d09c30e4b6e7e-6"></a>
<a id="rest_code_b37008f623424063ab1d09c30e4b6e7e-7" name="rest_code_b37008f623424063ab1d09c30e4b6e7e-7" href="posts/2016/01/improve-dll-and-etl-compile-time-further.html#rest_code_b37008f623424063ab1d09c30e4b6e7e-7"></a><span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">last</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">first</span><span class="p">;</span>
<a id="rest_code_b37008f623424063ab1d09c30e4b6e7e-8" name="rest_code_b37008f623424063ab1d09c30e4b6e7e-8" href="posts/2016/01/improve-dll-and-etl-compile-time-further.html#rest_code_b37008f623424063ab1d09c30e4b6e7e-8"></a><span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">batch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">threads</span><span class="p">;</span>
<a id="rest_code_b37008f623424063ab1d09c30e4b6e7e-9" name="rest_code_b37008f623424063ab1d09c30e4b6e7e-9" href="posts/2016/01/improve-dll-and-etl-compile-time-further.html#rest_code_b37008f623424063ab1d09c30e4b6e7e-9"></a>
<a id="rest_code_b37008f623424063ab1d09c30e4b6e7e-10" name="rest_code_b37008f623424063ab1d09c30e4b6e7e-10" href="posts/2016/01/improve-dll-and-etl-compile-time-further.html#rest_code_b37008f623424063ab1d09c30e4b6e7e-10"></a><span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">sub_functor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="n">futures</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">functor</span><span class="p">](</span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span><span class="w"> </span><span class="n">t</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span><span class="w"> </span><span class="n">first</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span><span class="w"> </span><span class="n">last</span><span class="p">){</span>
<a id="rest_code_b37008f623424063ab1d09c30e4b6e7e-11" name="rest_code_b37008f623424063ab1d09c30e4b6e7e-11" href="posts/2016/01/improve-dll-and-etl-compile-time-further.html#rest_code_b37008f623424063ab1d09c30e4b6e7e-11"></a><span class="w">            </span><span class="n">futures</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">functor</span><span class="p">(</span><span class="n">first</span><span class="p">,</span><span class="w"> </span><span class="n">last</span><span class="p">);</span>
<a id="rest_code_b37008f623424063ab1d09c30e4b6e7e-12" name="rest_code_b37008f623424063ab1d09c30e4b6e7e-12" href="posts/2016/01/improve-dll-and-etl-compile-time-further.html#rest_code_b37008f623424063ab1d09c30e4b6e7e-12"></a><span class="w">        </span><span class="p">};</span>
<a id="rest_code_b37008f623424063ab1d09c30e4b6e7e-13" name="rest_code_b37008f623424063ab1d09c30e4b6e7e-13" href="posts/2016/01/improve-dll-and-etl-compile-time-further.html#rest_code_b37008f623424063ab1d09c30e4b6e7e-13"></a>
<a id="rest_code_b37008f623424063ab1d09c30e4b6e7e-14" name="rest_code_b37008f623424063ab1d09c30e4b6e7e-14" href="posts/2016/01/improve-dll-and-etl-compile-time-further.html#rest_code_b37008f623424063ab1d09c30e4b6e7e-14"></a><span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">threads</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">t</span><span class="p">){</span>
<a id="rest_code_b37008f623424063ab1d09c30e4b6e7e-15" name="rest_code_b37008f623424063ab1d09c30e4b6e7e-15" href="posts/2016/01/improve-dll-and-etl-compile-time-further.html#rest_code_b37008f623424063ab1d09c30e4b6e7e-15"></a><span class="w">            </span><span class="n">pool</span><span class="p">.</span><span class="n">do_task</span><span class="p">(</span><span class="n">sub_functor</span><span class="p">,</span><span class="w"> </span><span class="n">t</span><span class="p">,</span><span class="w"> </span><span class="n">first</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">batch</span><span class="p">,</span><span class="w"> </span><span class="n">first</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">batch</span><span class="p">);</span>
<a id="rest_code_b37008f623424063ab1d09c30e4b6e7e-16" name="rest_code_b37008f623424063ab1d09c30e4b6e7e-16" href="posts/2016/01/improve-dll-and-etl-compile-time-further.html#rest_code_b37008f623424063ab1d09c30e4b6e7e-16"></a><span class="w">        </span><span class="p">}</span>
<a id="rest_code_b37008f623424063ab1d09c30e4b6e7e-17" name="rest_code_b37008f623424063ab1d09c30e4b6e7e-17" href="posts/2016/01/improve-dll-and-etl-compile-time-further.html#rest_code_b37008f623424063ab1d09c30e4b6e7e-17"></a>
<a id="rest_code_b37008f623424063ab1d09c30e4b6e7e-18" name="rest_code_b37008f623424063ab1d09c30e4b6e7e-18" href="posts/2016/01/improve-dll-and-etl-compile-time-further.html#rest_code_b37008f623424063ab1d09c30e4b6e7e-18"></a><span class="w">        </span><span class="n">acc_functor</span><span class="p">(</span><span class="n">functor</span><span class="p">(</span><span class="n">first</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">threads</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">batch</span><span class="p">,</span><span class="w"> </span><span class="n">last</span><span class="p">));</span>
<a id="rest_code_b37008f623424063ab1d09c30e4b6e7e-19" name="rest_code_b37008f623424063ab1d09c30e4b6e7e-19" href="posts/2016/01/improve-dll-and-etl-compile-time-further.html#rest_code_b37008f623424063ab1d09c30e4b6e7e-19"></a>
<a id="rest_code_b37008f623424063ab1d09c30e4b6e7e-20" name="rest_code_b37008f623424063ab1d09c30e4b6e7e-20" href="posts/2016/01/improve-dll-and-etl-compile-time-further.html#rest_code_b37008f623424063ab1d09c30e4b6e7e-20"></a><span class="w">        </span><span class="n">pool</span><span class="p">.</span><span class="n">wait</span><span class="p">();</span>
<a id="rest_code_b37008f623424063ab1d09c30e4b6e7e-21" name="rest_code_b37008f623424063ab1d09c30e4b6e7e-21" href="posts/2016/01/improve-dll-and-etl-compile-time-further.html#rest_code_b37008f623424063ab1d09c30e4b6e7e-21"></a>
<a id="rest_code_b37008f623424063ab1d09c30e4b6e7e-22" name="rest_code_b37008f623424063ab1d09c30e4b6e7e-22" href="posts/2016/01/improve-dll-and-etl-compile-time-further.html#rest_code_b37008f623424063ab1d09c30e4b6e7e-22"></a><span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">fut</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">futures</span><span class="p">){</span>
<a id="rest_code_b37008f623424063ab1d09c30e4b6e7e-23" name="rest_code_b37008f623424063ab1d09c30e4b6e7e-23" href="posts/2016/01/improve-dll-and-etl-compile-time-further.html#rest_code_b37008f623424063ab1d09c30e4b6e7e-23"></a><span class="w">            </span><span class="n">acc_functor</span><span class="p">(</span><span class="n">fut</span><span class="p">);</span>
<a id="rest_code_b37008f623424063ab1d09c30e4b6e7e-24" name="rest_code_b37008f623424063ab1d09c30e4b6e7e-24" href="posts/2016/01/improve-dll-and-etl-compile-time-further.html#rest_code_b37008f623424063ab1d09c30e4b6e7e-24"></a><span class="w">        </span><span class="p">}</span>
<a id="rest_code_b37008f623424063ab1d09c30e4b6e7e-25" name="rest_code_b37008f623424063ab1d09c30e4b6e7e-25" href="posts/2016/01/improve-dll-and-etl-compile-time-further.html#rest_code_b37008f623424063ab1d09c30e4b6e7e-25"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="rest_code_b37008f623424063ab1d09c30e4b6e7e-26" name="rest_code_b37008f623424063ab1d09c30e4b6e7e-26" href="posts/2016/01/improve-dll-and-etl-compile-time-further.html#rest_code_b37008f623424063ab1d09c30e4b6e7e-26"></a><span class="w">        </span><span class="n">acc_functor</span><span class="p">(</span><span class="n">functor</span><span class="p">(</span><span class="n">first</span><span class="p">,</span><span class="w"> </span><span class="n">last</span><span class="p">));</span>
<a id="rest_code_b37008f623424063ab1d09c30e4b6e7e-27" name="rest_code_b37008f623424063ab1d09c30e4b6e7e-27" href="posts/2016/01/improve-dll-and-etl-compile-time-further.html#rest_code_b37008f623424063ab1d09c30e4b6e7e-27"></a><span class="w">    </span><span class="p">}</span>
<a id="rest_code_b37008f623424063ab1d09c30e4b6e7e-28" name="rest_code_b37008f623424063ab1d09c30e4b6e7e-28" href="posts/2016/01/improve-dll-and-etl-compile-time-further.html#rest_code_b37008f623424063ab1d09c30e4b6e7e-28"></a><span class="p">}</span>
</pre></div>
<p>I simply preallocate space for all the threads and create a new functor calling the input functor and saving its result inside the vector. It is less nice, but it works well. And it compiles MUCH faster. This <strong>reduced the compilation time</strong> of my biggest test case <strong>by a factor of 8</strong> (from 344 seconds to 44 seconds). This is really crazy. It also fixed the problem where splitting the test case was faster than big file (it is now twice faster to compile the big files than compiling all the small files separately). <strong>This reduced the total compilation time of dll by about 400%</strong>.</p>
<p>As of now, I still have no idea why this makes such a big difference. I have looked at the std::async code, but I haven't found a valid reason for this slowdown. If someone has any idea, I'd be very glad to discuss in the comments below.</p>
</section><section id="improving-the-template-instantiation-tree"><h2>Improving the template instantiation tree</h2>
<p>I recently discovered the templight tool that is a profiler for templates (pretty cool). After some time, I was able to build it and use it on ETL. For now, I haven't been able to reduce compile time a lot, but I have been able to reduce the template instantiation tree a lot seeing that some instantiations were completely useless and I optimized the code to remove them.</p>
<p>I won't be go into much details here because I plan to write a post on this subject in the coming days.</p>
</section><section id="conclusion-2"><h2>Conclusion</h2>
<p>In conclusion, I would say that it is pretty hard to improve the compile time of complex C++ programs once you have gone through all the standard methods. However, I was very happy to found that <strong>two optimizations in the source code reduced the overall compilation of DLL by almost 500%</strong>. I will continue working on this, but for now, the compilation time is much more reasonable.</p>
<p>I hope the two main facts in this article were interesting. If you have similar experience, comments or ideas for further improvements, I'd be glad to discuss them with you in the comments :)</p>
</section>
</div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/2015/11/detect-overflows-and-more-in-java-with-cojac.html" class="u-url">Detect overflows and more in Java with COJAC</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Baptiste Wicht
            </span></p>
            <p class="dateline">
            <a href="posts/2015/11/detect-overflows-and-more-in-java-with-cojac.html" rel="bookmark">
            <time class="published dt-published" datetime="2015-11-27T14:18:52+01:00" itemprop="datePublished" title="2015-11-27 14:18">2015-11-27 14:18</time></a>
            </p>
                <p class="commentline">
    
    <a href="posts/2015/11/detect-overflows-and-more-in-java-with-cojac.html#disqus_thread" data-disqus-identifier="cache/posts/2015/11/detect-overflows-and-more-in-java-with-cojac.html">Comments</a>


        </p>
</div>
    </header><div class="p-summary entry-summary">
    <p>Back at school, I worked on the COJAC project to detect numeric overflow in
Java programs automatically. Since then, this project has evolved a lot and has
now more features:</p>
<blockquote>
<ul class="simple">
<li><p>It can detect integer overflows</p></li>
<li><p>Detect smearing and cancellation with float and double types</p></li>
<li><p>Detect NaN and Infinite results from computations</p></li>
<li><p>Detect offending type casting</p></li>
</ul>
</blockquote>
<p>Moreover, all these features are available without any recompilation of your
program. You simply add an argument to the invocation of the Java virtual
machine and all these errors will be detected for you automatically!</p>
<p>Frédéric Bapst, the person in charge of the project has recently published two
videos about the project, don't hesitate to check them out:</p>
<p>The first video presents the automatic analysis features of the tool:</p>
<div class="youtube-video">
<iframe width="560" height="315" src="https://www.youtube-nocookie.com/embed/DqAFQfbWZOU?rel=0&amp;wmode=transparent" frameborder="0" allow="encrypted-media" allowfullscreen></iframe>
</div>
<p>And the second presents the numeric wrapper features of the tool for even more
features:</p>
<div class="youtube-video">
<iframe width="560" height="315" src="https://www.youtube-nocookie.com/embed/4x9mJEFjcGc?rel=0&amp;wmode=transparent" frameborder="0" allow="encrypted-media" allowfullscreen></iframe>
</div>
<p>If you have any question related to the project, you can add a comment to this
page or contact me directly be email.</p>
<p>If you want more information on the project you can also check out its
repository on Github: <a class="reference external" href="https://github.com/Cojac/Cojac">https://github.com/Cojac/Cojac</a></p>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/2015/11/aggregator-plugin-display-global-metrics-in-sonarqube.html" class="u-url">Aggregator Plugin : Display global metrics in Sonarqube</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Baptiste Wicht
            </span></p>
            <p class="dateline">
            <a href="posts/2015/11/aggregator-plugin-display-global-metrics-in-sonarqube.html" rel="bookmark">
            <time class="published dt-published" datetime="2015-11-20T11:37:55+01:00" itemprop="datePublished" title="2015-11-20 11:37">2015-11-20 11:37</time></a>
            </p>
                <p class="commentline">
    
    <a href="posts/2015/11/aggregator-plugin-display-global-metrics-in-sonarqube.html#disqus_thread" data-disqus-identifier="cache/posts/2015/11/aggregator-plugin-display-global-metrics-in-sonarqube.html">Comments</a>


        </p>
</div>
    </header><div class="p-summary entry-summary">
    <p>Recently, I wanted to know how many lines of code I had on my Sonar server with all my C++ projects. Sonarsource proposes a commercial plugins (Views) that allows to do that (and much more...), but I didn't wanted to pay thousands of dollars simply to get a total of my lines of code, therefore I wrote a very  simple Sonar plugin to compute some global metrics.</p>
<p>This plugin is very simple, it only provides a global widgets that aggregates some stats over all your projects. For instance, here is the results on my Sonar server:</p>
<img alt="/images/aggregator_widget.png" class="align-center" src="images/aggregator_widget.png"><p>The plugin is freely available on Github: <a class="reference external" href="https://github.com/wichtounet/aggregator-plugin">https://github.com/wichtounet/aggregator-plugin</a> . However, it has only be tested on my Sonar server (4.5.2) and it is my first Sonar plugin, so it may not work everywhere. If you experience issues, don't hesitate to open an issue on Github or to propose a Pull Request.</p>
<p>You can install the plugin by putting the .jar file (from the Github Releases page) into your sonar/extensions/plugins directory and restart Sonar. You should then have access to a new global widget that you can add to a dashboard.</p>
<p>I hope this plugin helps some of you.</p>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/2015/11/upgrade-to-nikola-7.html" class="u-url">Upgrade to Nikola 7</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Baptiste Wicht
            </span></p>
            <p class="dateline">
            <a href="posts/2015/11/upgrade-to-nikola-7.html" rel="bookmark">
            <time class="published dt-published" datetime="2015-11-20T10:56:32+01:00" itemprop="datePublished" title="2015-11-20 10:56">2015-11-20 10:56</time></a>
            </p>
                <p class="commentline">
    
    <a href="posts/2015/11/upgrade-to-nikola-7.html#disqus_thread" data-disqus-identifier="cache/posts/2015/11/upgrade-to-nikola-7.html">Comments</a>


        </p>
</div>
    </header><div class="p-summary entry-summary">
    <p>I've finally taken the time to upgrade the website to Nikola 7 (it is about time, I know...).</p>
<p>The migration worked flawlessly, I simply had to update configuration to migrate deprecated and renamed tags and it worked really well. I also had to add a comma to the COMPILERS list because of the use of Python 3.3 now.</p>
<p>As you may have seen, I haven't posted in a while. I had quite some work for my thesis as well as for the courses I give at my school and I started playing Path Of Exile with took quite a bit of my free time :) I'll try to give some updates on the project I'm working on to make this blog live again.</p>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/2015/07/simulate-static_if-with-c11c14.html" class="u-url">Simulate static_if with C++11/C++14</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Baptiste Wicht
            </span></p>
            <p class="dateline">
            <a href="posts/2015/07/simulate-static_if-with-c11c14.html" rel="bookmark">
            <time class="published dt-published" datetime="2015-07-12T15:23:34+02:00" itemprop="datePublished" title="2015-07-12 15:23">2015-07-12 15:23</time></a>
            </p>
                <p class="commentline">
    
    <a href="posts/2015/07/simulate-static_if-with-c11c14.html#disqus_thread" data-disqus-identifier="cache/posts/2015/07/simulate-static_if-with-c11c14.html">Comments</a>


        </p>
</div>
    </header><div class="p-summary entry-summary">
    <p>If you are doing a lot of template metaprogramming and other template magic stuff, you are likely to miss a <code>static_if</code> in the language. Unfortunately, it didn't make the cut for C++11 and it seems unlikely that it will make it in C++17.</p>
<section id="static-if"><h2>static_if</h2>
<p>As its name indicates, <code>static_if</code> is an if statement but that is done at compile-time. At first, it could seem that the main point is performance, but that is not the case. With recent compilers, if you have an if statement with a compile-time constant, it will never be executed at runtime and only the correct branch will be included in the final executable code. However, even if the compiler knows that a branch will never be executed, it still has to ensure that this branch compiles. This is not the case with <code>static_if</code>. With <code>static_if</code>, only the valid branch is compiled, the other can contains invalid code. The most common reason to use a <code>static_if</code> is inside a template where you perform a test on a template argument and execute code based on this test. <code>static_if</code> has another advantage on standard if. Since only one branch is instantiated, it may save quite a lot of compile-time.</p>
<p>Let's say we have to write a template function that, if the template argument is a string, removes the last character of the string argument, otherwise decrement the argument (I know, stupid example, but simple). With <code>static_if</code>, you can write it like this:</p>
<div class="code"><pre class="code cpp"><a id="rest_code_88752dce15cd471a9483a810ca562e7e-1" name="rest_code_88752dce15cd471a9483a810ca562e7e-1" href="posts/2015/07/simulate-static_if-with-c11c14.html#rest_code_88752dce15cd471a9483a810ca562e7e-1"></a><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">T</span><span class="o">&gt;</span>
<a id="rest_code_88752dce15cd471a9483a810ca562e7e-2" name="rest_code_88752dce15cd471a9483a810ca562e7e-2" href="posts/2015/07/simulate-static_if-with-c11c14.html#rest_code_88752dce15cd471a9483a810ca562e7e-2"></a><span class="kt">void</span><span class="w"> </span><span class="n">decrement_kindof</span><span class="p">(</span><span class="n">T</span><span class="o">&amp;</span><span class="w"> </span><span class="n">value</span><span class="p">){</span>
<a id="rest_code_88752dce15cd471a9483a810ca562e7e-3" name="rest_code_88752dce15cd471a9483a810ca562e7e-3" href="posts/2015/07/simulate-static_if-with-c11c14.html#rest_code_88752dce15cd471a9483a810ca562e7e-3"></a><span class="w">    </span><span class="n">static_if</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">is_same</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">){</span>
<a id="rest_code_88752dce15cd471a9483a810ca562e7e-4" name="rest_code_88752dce15cd471a9483a810ca562e7e-4" href="posts/2015/07/simulate-static_if-with-c11c14.html#rest_code_88752dce15cd471a9483a810ca562e7e-4"></a><span class="w">        </span><span class="n">value</span><span class="p">.</span><span class="n">pop_back</span><span class="p">();</span>
<a id="rest_code_88752dce15cd471a9483a810ca562e7e-5" name="rest_code_88752dce15cd471a9483a810ca562e7e-5" href="posts/2015/07/simulate-static_if-with-c11c14.html#rest_code_88752dce15cd471a9483a810ca562e7e-5"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="rest_code_88752dce15cd471a9483a810ca562e7e-6" name="rest_code_88752dce15cd471a9483a810ca562e7e-6" href="posts/2015/07/simulate-static_if-with-c11c14.html#rest_code_88752dce15cd471a9483a810ca562e7e-6"></a><span class="w">        </span><span class="o">--</span><span class="n">value</span><span class="p">;</span>
<a id="rest_code_88752dce15cd471a9483a810ca562e7e-7" name="rest_code_88752dce15cd471a9483a810ca562e7e-7" href="posts/2015/07/simulate-static_if-with-c11c14.html#rest_code_88752dce15cd471a9483a810ca562e7e-7"></a><span class="w">    </span><span class="p">}</span>
<a id="rest_code_88752dce15cd471a9483a810ca562e7e-8" name="rest_code_88752dce15cd471a9483a810ca562e7e-8" href="posts/2015/07/simulate-static_if-with-c11c14.html#rest_code_88752dce15cd471a9483a810ca562e7e-8"></a><span class="p">}</span>
</pre></div>
<p>I think it is quite elegant.</p>
</section><section id="the-problem"><h2>The problem</h2>
<p>Some may think, that we could do the same with C++ standard if statement:</p>
<div class="code"><pre class="code cpp"><a id="rest_code_0d3421b065f04399a2e3e05f2c50c464-1" name="rest_code_0d3421b065f04399a2e3e05f2c50c464-1" href="posts/2015/07/simulate-static_if-with-c11c14.html#rest_code_0d3421b065f04399a2e3e05f2c50c464-1"></a><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">T</span><span class="o">&gt;</span>
<a id="rest_code_0d3421b065f04399a2e3e05f2c50c464-2" name="rest_code_0d3421b065f04399a2e3e05f2c50c464-2" href="posts/2015/07/simulate-static_if-with-c11c14.html#rest_code_0d3421b065f04399a2e3e05f2c50c464-2"></a><span class="kt">void</span><span class="w"> </span><span class="n">decrement_kindof</span><span class="p">(</span><span class="n">T</span><span class="o">&amp;</span><span class="w"> </span><span class="n">value</span><span class="p">){</span>
<a id="rest_code_0d3421b065f04399a2e3e05f2c50c464-3" name="rest_code_0d3421b065f04399a2e3e05f2c50c464-3" href="posts/2015/07/simulate-static_if-with-c11c14.html#rest_code_0d3421b065f04399a2e3e05f2c50c464-3"></a><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">is_same</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">){</span>
<a id="rest_code_0d3421b065f04399a2e3e05f2c50c464-4" name="rest_code_0d3421b065f04399a2e3e05f2c50c464-4" href="posts/2015/07/simulate-static_if-with-c11c14.html#rest_code_0d3421b065f04399a2e3e05f2c50c464-4"></a><span class="w">        </span><span class="n">value</span><span class="p">.</span><span class="n">pop_back</span><span class="p">();</span>
<a id="rest_code_0d3421b065f04399a2e3e05f2c50c464-5" name="rest_code_0d3421b065f04399a2e3e05f2c50c464-5" href="posts/2015/07/simulate-static_if-with-c11c14.html#rest_code_0d3421b065f04399a2e3e05f2c50c464-5"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="rest_code_0d3421b065f04399a2e3e05f2c50c464-6" name="rest_code_0d3421b065f04399a2e3e05f2c50c464-6" href="posts/2015/07/simulate-static_if-with-c11c14.html#rest_code_0d3421b065f04399a2e3e05f2c50c464-6"></a><span class="w">        </span><span class="o">--</span><span class="n">value</span><span class="p">;</span>
<a id="rest_code_0d3421b065f04399a2e3e05f2c50c464-7" name="rest_code_0d3421b065f04399a2e3e05f2c50c464-7" href="posts/2015/07/simulate-static_if-with-c11c14.html#rest_code_0d3421b065f04399a2e3e05f2c50c464-7"></a><span class="w">    </span><span class="p">}</span>
<a id="rest_code_0d3421b065f04399a2e3e05f2c50c464-8" name="rest_code_0d3421b065f04399a2e3e05f2c50c464-8" href="posts/2015/07/simulate-static_if-with-c11c14.html#rest_code_0d3421b065f04399a2e3e05f2c50c464-8"></a><span class="p">}</span>
</pre></div>
<p>However, this won't work. This template cannot be instantiated for <code>std::string</code> since it doesn't have an operator -- and it cannot be instantiated for int since it doesn't have a <code>pop_back()</code> function.</p>
<p>There are two solutions in plain C++: specialization and SFINAE. Let's start with specialization:</p>
<div class="code"><pre class="code cpp"><a id="rest_code_0e8b0602695c4b86b1820fffb42e4a95-1" name="rest_code_0e8b0602695c4b86b1820fffb42e4a95-1" href="posts/2015/07/simulate-static_if-with-c11c14.html#rest_code_0e8b0602695c4b86b1820fffb42e4a95-1"></a><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">T</span><span class="o">&gt;</span>
<a id="rest_code_0e8b0602695c4b86b1820fffb42e4a95-2" name="rest_code_0e8b0602695c4b86b1820fffb42e4a95-2" href="posts/2015/07/simulate-static_if-with-c11c14.html#rest_code_0e8b0602695c4b86b1820fffb42e4a95-2"></a><span class="kt">void</span><span class="w"> </span><span class="n">decrement_kindof</span><span class="p">(</span><span class="n">T</span><span class="o">&amp;</span><span class="w"> </span><span class="n">value</span><span class="p">){</span>
<a id="rest_code_0e8b0602695c4b86b1820fffb42e4a95-3" name="rest_code_0e8b0602695c4b86b1820fffb42e4a95-3" href="posts/2015/07/simulate-static_if-with-c11c14.html#rest_code_0e8b0602695c4b86b1820fffb42e4a95-3"></a><span class="w">    </span><span class="o">--</span><span class="n">value</span><span class="p">;</span>
<a id="rest_code_0e8b0602695c4b86b1820fffb42e4a95-4" name="rest_code_0e8b0602695c4b86b1820fffb42e4a95-4" href="posts/2015/07/simulate-static_if-with-c11c14.html#rest_code_0e8b0602695c4b86b1820fffb42e4a95-4"></a><span class="p">}</span>
<a id="rest_code_0e8b0602695c4b86b1820fffb42e4a95-5" name="rest_code_0e8b0602695c4b86b1820fffb42e4a95-5" href="posts/2015/07/simulate-static_if-with-c11c14.html#rest_code_0e8b0602695c4b86b1820fffb42e4a95-5"></a>
<a id="rest_code_0e8b0602695c4b86b1820fffb42e4a95-6" name="rest_code_0e8b0602695c4b86b1820fffb42e4a95-6" href="posts/2015/07/simulate-static_if-with-c11c14.html#rest_code_0e8b0602695c4b86b1820fffb42e4a95-6"></a><span class="k">template</span><span class="o">&lt;&gt;</span>
<a id="rest_code_0e8b0602695c4b86b1820fffb42e4a95-7" name="rest_code_0e8b0602695c4b86b1820fffb42e4a95-7" href="posts/2015/07/simulate-static_if-with-c11c14.html#rest_code_0e8b0602695c4b86b1820fffb42e4a95-7"></a><span class="kt">void</span><span class="w"> </span><span class="n">decrement_kindof</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">value</span><span class="p">){</span>
<a id="rest_code_0e8b0602695c4b86b1820fffb42e4a95-8" name="rest_code_0e8b0602695c4b86b1820fffb42e4a95-8" href="posts/2015/07/simulate-static_if-with-c11c14.html#rest_code_0e8b0602695c4b86b1820fffb42e4a95-8"></a><span class="w">    </span><span class="n">value</span><span class="p">.</span><span class="n">pop_back</span><span class="p">();</span>
<a id="rest_code_0e8b0602695c4b86b1820fffb42e4a95-9" name="rest_code_0e8b0602695c4b86b1820fffb42e4a95-9" href="posts/2015/07/simulate-static_if-with-c11c14.html#rest_code_0e8b0602695c4b86b1820fffb42e4a95-9"></a><span class="p">}</span>
</pre></div>
<p>We do a specialization for <code>std::string</code> case so that in the general case it uses -- and in the <code>std::string</code> case, it uses <code>pop_back()</code>. And the SFINAE version:</p>
<div class="code"><pre class="code cpp"><a id="rest_code_c0d5df853d8b4a3a8635c4e13e15c338-1" name="rest_code_c0d5df853d8b4a3a8635c4e13e15c338-1" href="posts/2015/07/simulate-static_if-with-c11c14.html#rest_code_c0d5df853d8b4a3a8635c4e13e15c338-1"></a><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">T</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">enable_if_t</span><span class="o">&lt;!</span><span class="n">std</span><span class="o">::</span><span class="n">is_same</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">42</span><span class="o">&gt;</span>
<a id="rest_code_c0d5df853d8b4a3a8635c4e13e15c338-2" name="rest_code_c0d5df853d8b4a3a8635c4e13e15c338-2" href="posts/2015/07/simulate-static_if-with-c11c14.html#rest_code_c0d5df853d8b4a3a8635c4e13e15c338-2"></a><span class="kt">void</span><span class="w"> </span><span class="n">decrement_kindof</span><span class="p">(</span><span class="n">T</span><span class="o">&amp;</span><span class="w"> </span><span class="n">value</span><span class="p">){</span>
<a id="rest_code_c0d5df853d8b4a3a8635c4e13e15c338-3" name="rest_code_c0d5df853d8b4a3a8635c4e13e15c338-3" href="posts/2015/07/simulate-static_if-with-c11c14.html#rest_code_c0d5df853d8b4a3a8635c4e13e15c338-3"></a><span class="w">    </span><span class="o">--</span><span class="n">value</span><span class="p">;</span>
<a id="rest_code_c0d5df853d8b4a3a8635c4e13e15c338-4" name="rest_code_c0d5df853d8b4a3a8635c4e13e15c338-4" href="posts/2015/07/simulate-static_if-with-c11c14.html#rest_code_c0d5df853d8b4a3a8635c4e13e15c338-4"></a><span class="p">}</span>
<a id="rest_code_c0d5df853d8b4a3a8635c4e13e15c338-5" name="rest_code_c0d5df853d8b4a3a8635c4e13e15c338-5" href="posts/2015/07/simulate-static_if-with-c11c14.html#rest_code_c0d5df853d8b4a3a8635c4e13e15c338-5"></a>
<a id="rest_code_c0d5df853d8b4a3a8635c4e13e15c338-6" name="rest_code_c0d5df853d8b4a3a8635c4e13e15c338-6" href="posts/2015/07/simulate-static_if-with-c11c14.html#rest_code_c0d5df853d8b4a3a8635c4e13e15c338-6"></a><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">T</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">enable_if_t</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">is_same</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">42</span><span class="o">&gt;</span>
<a id="rest_code_c0d5df853d8b4a3a8635c4e13e15c338-7" name="rest_code_c0d5df853d8b4a3a8635c4e13e15c338-7" href="posts/2015/07/simulate-static_if-with-c11c14.html#rest_code_c0d5df853d8b4a3a8635c4e13e15c338-7"></a><span class="kt">void</span><span class="w"> </span><span class="n">decrement_kindof</span><span class="p">(</span><span class="n">T</span><span class="o">&amp;</span><span class="w"> </span><span class="n">value</span><span class="p">){</span>
<a id="rest_code_c0d5df853d8b4a3a8635c4e13e15c338-8" name="rest_code_c0d5df853d8b4a3a8635c4e13e15c338-8" href="posts/2015/07/simulate-static_if-with-c11c14.html#rest_code_c0d5df853d8b4a3a8635c4e13e15c338-8"></a><span class="w">    </span><span class="n">value</span><span class="p">.</span><span class="n">pop_back</span><span class="p">();</span>
<a id="rest_code_c0d5df853d8b4a3a8635c4e13e15c338-9" name="rest_code_c0d5df853d8b4a3a8635c4e13e15c338-9" href="posts/2015/07/simulate-static_if-with-c11c14.html#rest_code_c0d5df853d8b4a3a8635c4e13e15c338-9"></a><span class="p">}</span>
</pre></div>
<p>The first function is enabled when the type is not a <code>std::string</code> and the second function is enabled when the type is a <code>std::string</code>.</p>
<p>Both solutions needs two functions to make it work. In this particular case, specialization is easier since the condition states exactly one type. If the condition was more complex for instance testing that a constant inside the type is equals to some value, we could only do it with SFINAE.</p>
<p>Even if both solutions work, both solutions are more complicated than the static_if version and both solutions are creating more functions than what should be necessary.</p>
</section><section id="one-solution"><h2>One solution</h2>
<p>There is one way to emulate a kind of <code>static_if</code> with C++14 generic lambdas. It is kind of using anonymous template function to emulate what we did with the previous solutions but does it behind the scene. Here the code I'm using for this emulation:</p>
<div class="code"><pre class="code cpp"><a id="rest_code_d4f7d9e3782340c4906a6482e4e8699f-1" name="rest_code_d4f7d9e3782340c4906a6482e4e8699f-1" href="posts/2015/07/simulate-static_if-with-c11c14.html#rest_code_d4f7d9e3782340c4906a6482e4e8699f-1"></a><span class="k">namespace</span><span class="w"> </span><span class="nn">static_if_detail</span><span class="w"> </span><span class="p">{</span>
<a id="rest_code_d4f7d9e3782340c4906a6482e4e8699f-2" name="rest_code_d4f7d9e3782340c4906a6482e4e8699f-2" href="posts/2015/07/simulate-static_if-with-c11c14.html#rest_code_d4f7d9e3782340c4906a6482e4e8699f-2"></a>
<a id="rest_code_d4f7d9e3782340c4906a6482e4e8699f-3" name="rest_code_d4f7d9e3782340c4906a6482e4e8699f-3" href="posts/2015/07/simulate-static_if-with-c11c14.html#rest_code_d4f7d9e3782340c4906a6482e4e8699f-3"></a><span class="k">struct</span><span class="w"> </span><span class="nc">identity</span><span class="w"> </span><span class="p">{</span>
<a id="rest_code_d4f7d9e3782340c4906a6482e4e8699f-4" name="rest_code_d4f7d9e3782340c4906a6482e4e8699f-4" href="posts/2015/07/simulate-static_if-with-c11c14.html#rest_code_d4f7d9e3782340c4906a6482e4e8699f-4"></a><span class="w">    </span><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">T</span><span class="o">&gt;</span>
<a id="rest_code_d4f7d9e3782340c4906a6482e4e8699f-5" name="rest_code_d4f7d9e3782340c4906a6482e4e8699f-5" href="posts/2015/07/simulate-static_if-with-c11c14.html#rest_code_d4f7d9e3782340c4906a6482e4e8699f-5"></a><span class="w">    </span><span class="n">T</span><span class="w"> </span><span class="k">operator</span><span class="p">()(</span><span class="n">T</span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span>
<a id="rest_code_d4f7d9e3782340c4906a6482e4e8699f-6" name="rest_code_d4f7d9e3782340c4906a6482e4e8699f-6" href="posts/2015/07/simulate-static_if-with-c11c14.html#rest_code_d4f7d9e3782340c4906a6482e4e8699f-6"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">forward</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
<a id="rest_code_d4f7d9e3782340c4906a6482e4e8699f-7" name="rest_code_d4f7d9e3782340c4906a6482e4e8699f-7" href="posts/2015/07/simulate-static_if-with-c11c14.html#rest_code_d4f7d9e3782340c4906a6482e4e8699f-7"></a><span class="w">    </span><span class="p">}</span>
<a id="rest_code_d4f7d9e3782340c4906a6482e4e8699f-8" name="rest_code_d4f7d9e3782340c4906a6482e4e8699f-8" href="posts/2015/07/simulate-static_if-with-c11c14.html#rest_code_d4f7d9e3782340c4906a6482e4e8699f-8"></a><span class="p">};</span>
<a id="rest_code_d4f7d9e3782340c4906a6482e4e8699f-9" name="rest_code_d4f7d9e3782340c4906a6482e4e8699f-9" href="posts/2015/07/simulate-static_if-with-c11c14.html#rest_code_d4f7d9e3782340c4906a6482e4e8699f-9"></a>
<a id="rest_code_d4f7d9e3782340c4906a6482e4e8699f-10" name="rest_code_d4f7d9e3782340c4906a6482e4e8699f-10" href="posts/2015/07/simulate-static_if-with-c11c14.html#rest_code_d4f7d9e3782340c4906a6482e4e8699f-10"></a><span class="k">template</span><span class="o">&lt;</span><span class="kt">bool</span><span class="w"> </span><span class="n">Cond</span><span class="o">&gt;</span>
<a id="rest_code_d4f7d9e3782340c4906a6482e4e8699f-11" name="rest_code_d4f7d9e3782340c4906a6482e4e8699f-11" href="posts/2015/07/simulate-static_if-with-c11c14.html#rest_code_d4f7d9e3782340c4906a6482e4e8699f-11"></a><span class="k">struct</span><span class="w"> </span><span class="nc">statement</span><span class="w"> </span><span class="p">{</span>
<a id="rest_code_d4f7d9e3782340c4906a6482e4e8699f-12" name="rest_code_d4f7d9e3782340c4906a6482e4e8699f-12" href="posts/2015/07/simulate-static_if-with-c11c14.html#rest_code_d4f7d9e3782340c4906a6482e4e8699f-12"></a><span class="w">    </span><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">F</span><span class="o">&gt;</span>
<a id="rest_code_d4f7d9e3782340c4906a6482e4e8699f-13" name="rest_code_d4f7d9e3782340c4906a6482e4e8699f-13" href="posts/2015/07/simulate-static_if-with-c11c14.html#rest_code_d4f7d9e3782340c4906a6482e4e8699f-13"></a><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">then</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">F</span><span class="o">&amp;</span><span class="w"> </span><span class="n">f</span><span class="p">){</span>
<a id="rest_code_d4f7d9e3782340c4906a6482e4e8699f-14" name="rest_code_d4f7d9e3782340c4906a6482e4e8699f-14" href="posts/2015/07/simulate-static_if-with-c11c14.html#rest_code_d4f7d9e3782340c4906a6482e4e8699f-14"></a><span class="w">        </span><span class="n">f</span><span class="p">(</span><span class="n">identity</span><span class="p">());</span>
<a id="rest_code_d4f7d9e3782340c4906a6482e4e8699f-15" name="rest_code_d4f7d9e3782340c4906a6482e4e8699f-15" href="posts/2015/07/simulate-static_if-with-c11c14.html#rest_code_d4f7d9e3782340c4906a6482e4e8699f-15"></a><span class="w">    </span><span class="p">}</span>
<a id="rest_code_d4f7d9e3782340c4906a6482e4e8699f-16" name="rest_code_d4f7d9e3782340c4906a6482e4e8699f-16" href="posts/2015/07/simulate-static_if-with-c11c14.html#rest_code_d4f7d9e3782340c4906a6482e4e8699f-16"></a>
<a id="rest_code_d4f7d9e3782340c4906a6482e4e8699f-17" name="rest_code_d4f7d9e3782340c4906a6482e4e8699f-17" href="posts/2015/07/simulate-static_if-with-c11c14.html#rest_code_d4f7d9e3782340c4906a6482e4e8699f-17"></a><span class="w">    </span><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">F</span><span class="o">&gt;</span>
<a id="rest_code_d4f7d9e3782340c4906a6482e4e8699f-18" name="rest_code_d4f7d9e3782340c4906a6482e4e8699f-18" href="posts/2015/07/simulate-static_if-with-c11c14.html#rest_code_d4f7d9e3782340c4906a6482e4e8699f-18"></a><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">else_</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">F</span><span class="o">&amp;</span><span class="p">){}</span>
<a id="rest_code_d4f7d9e3782340c4906a6482e4e8699f-19" name="rest_code_d4f7d9e3782340c4906a6482e4e8699f-19" href="posts/2015/07/simulate-static_if-with-c11c14.html#rest_code_d4f7d9e3782340c4906a6482e4e8699f-19"></a><span class="p">};</span>
<a id="rest_code_d4f7d9e3782340c4906a6482e4e8699f-20" name="rest_code_d4f7d9e3782340c4906a6482e4e8699f-20" href="posts/2015/07/simulate-static_if-with-c11c14.html#rest_code_d4f7d9e3782340c4906a6482e4e8699f-20"></a>
<a id="rest_code_d4f7d9e3782340c4906a6482e4e8699f-21" name="rest_code_d4f7d9e3782340c4906a6482e4e8699f-21" href="posts/2015/07/simulate-static_if-with-c11c14.html#rest_code_d4f7d9e3782340c4906a6482e4e8699f-21"></a><span class="k">template</span><span class="o">&lt;&gt;</span>
<a id="rest_code_d4f7d9e3782340c4906a6482e4e8699f-22" name="rest_code_d4f7d9e3782340c4906a6482e4e8699f-22" href="posts/2015/07/simulate-static_if-with-c11c14.html#rest_code_d4f7d9e3782340c4906a6482e4e8699f-22"></a><span class="k">struct</span><span class="w"> </span><span class="nc">statement</span><span class="o">&lt;</span><span class="nb">false</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="rest_code_d4f7d9e3782340c4906a6482e4e8699f-23" name="rest_code_d4f7d9e3782340c4906a6482e4e8699f-23" href="posts/2015/07/simulate-static_if-with-c11c14.html#rest_code_d4f7d9e3782340c4906a6482e4e8699f-23"></a><span class="w">    </span><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">F</span><span class="o">&gt;</span>
<a id="rest_code_d4f7d9e3782340c4906a6482e4e8699f-24" name="rest_code_d4f7d9e3782340c4906a6482e4e8699f-24" href="posts/2015/07/simulate-static_if-with-c11c14.html#rest_code_d4f7d9e3782340c4906a6482e4e8699f-24"></a><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">then</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">F</span><span class="o">&amp;</span><span class="p">){}</span>
<a id="rest_code_d4f7d9e3782340c4906a6482e4e8699f-25" name="rest_code_d4f7d9e3782340c4906a6482e4e8699f-25" href="posts/2015/07/simulate-static_if-with-c11c14.html#rest_code_d4f7d9e3782340c4906a6482e4e8699f-25"></a>
<a id="rest_code_d4f7d9e3782340c4906a6482e4e8699f-26" name="rest_code_d4f7d9e3782340c4906a6482e4e8699f-26" href="posts/2015/07/simulate-static_if-with-c11c14.html#rest_code_d4f7d9e3782340c4906a6482e4e8699f-26"></a><span class="w">    </span><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">F</span><span class="o">&gt;</span>
<a id="rest_code_d4f7d9e3782340c4906a6482e4e8699f-27" name="rest_code_d4f7d9e3782340c4906a6482e4e8699f-27" href="posts/2015/07/simulate-static_if-with-c11c14.html#rest_code_d4f7d9e3782340c4906a6482e4e8699f-27"></a><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">else_</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">F</span><span class="o">&amp;</span><span class="w"> </span><span class="n">f</span><span class="p">){</span>
<a id="rest_code_d4f7d9e3782340c4906a6482e4e8699f-28" name="rest_code_d4f7d9e3782340c4906a6482e4e8699f-28" href="posts/2015/07/simulate-static_if-with-c11c14.html#rest_code_d4f7d9e3782340c4906a6482e4e8699f-28"></a><span class="w">        </span><span class="n">f</span><span class="p">(</span><span class="n">identity</span><span class="p">());</span>
<a id="rest_code_d4f7d9e3782340c4906a6482e4e8699f-29" name="rest_code_d4f7d9e3782340c4906a6482e4e8699f-29" href="posts/2015/07/simulate-static_if-with-c11c14.html#rest_code_d4f7d9e3782340c4906a6482e4e8699f-29"></a><span class="w">    </span><span class="p">}</span>
<a id="rest_code_d4f7d9e3782340c4906a6482e4e8699f-30" name="rest_code_d4f7d9e3782340c4906a6482e4e8699f-30" href="posts/2015/07/simulate-static_if-with-c11c14.html#rest_code_d4f7d9e3782340c4906a6482e4e8699f-30"></a><span class="p">};</span>
<a id="rest_code_d4f7d9e3782340c4906a6482e4e8699f-31" name="rest_code_d4f7d9e3782340c4906a6482e4e8699f-31" href="posts/2015/07/simulate-static_if-with-c11c14.html#rest_code_d4f7d9e3782340c4906a6482e4e8699f-31"></a>
<a id="rest_code_d4f7d9e3782340c4906a6482e4e8699f-32" name="rest_code_d4f7d9e3782340c4906a6482e4e8699f-32" href="posts/2015/07/simulate-static_if-with-c11c14.html#rest_code_d4f7d9e3782340c4906a6482e4e8699f-32"></a><span class="p">}</span><span class="w"> </span><span class="c1">//end of namespace static_if_detail</span>
<a id="rest_code_d4f7d9e3782340c4906a6482e4e8699f-33" name="rest_code_d4f7d9e3782340c4906a6482e4e8699f-33" href="posts/2015/07/simulate-static_if-with-c11c14.html#rest_code_d4f7d9e3782340c4906a6482e4e8699f-33"></a>
<a id="rest_code_d4f7d9e3782340c4906a6482e4e8699f-34" name="rest_code_d4f7d9e3782340c4906a6482e4e8699f-34" href="posts/2015/07/simulate-static_if-with-c11c14.html#rest_code_d4f7d9e3782340c4906a6482e4e8699f-34"></a><span class="k">template</span><span class="o">&lt;</span><span class="kt">bool</span><span class="w"> </span><span class="n">Cond</span><span class="p">,</span><span class="w"> </span><span class="k">typename</span><span class="w"> </span><span class="nc">F</span><span class="o">&gt;</span>
<a id="rest_code_d4f7d9e3782340c4906a6482e4e8699f-35" name="rest_code_d4f7d9e3782340c4906a6482e4e8699f-35" href="posts/2015/07/simulate-static_if-with-c11c14.html#rest_code_d4f7d9e3782340c4906a6482e4e8699f-35"></a><span class="n">static_if_detail</span><span class="o">::</span><span class="n">statement</span><span class="o">&lt;</span><span class="n">Cond</span><span class="o">&gt;</span><span class="w"> </span><span class="n">static_if</span><span class="p">(</span><span class="n">F</span><span class="w"> </span><span class="k">const</span><span class="o">&amp;</span><span class="w"> </span><span class="n">f</span><span class="p">){</span>
<a id="rest_code_d4f7d9e3782340c4906a6482e4e8699f-36" name="rest_code_d4f7d9e3782340c4906a6482e4e8699f-36" href="posts/2015/07/simulate-static_if-with-c11c14.html#rest_code_d4f7d9e3782340c4906a6482e4e8699f-36"></a><span class="w">    </span><span class="n">static_if_detail</span><span class="o">::</span><span class="n">statement</span><span class="o">&lt;</span><span class="n">Cond</span><span class="o">&gt;</span><span class="w"> </span><span class="n">if_</span><span class="p">;</span>
<a id="rest_code_d4f7d9e3782340c4906a6482e4e8699f-37" name="rest_code_d4f7d9e3782340c4906a6482e4e8699f-37" href="posts/2015/07/simulate-static_if-with-c11c14.html#rest_code_d4f7d9e3782340c4906a6482e4e8699f-37"></a><span class="w">    </span><span class="n">if_</span><span class="p">.</span><span class="n">then</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
<a id="rest_code_d4f7d9e3782340c4906a6482e4e8699f-38" name="rest_code_d4f7d9e3782340c4906a6482e4e8699f-38" href="posts/2015/07/simulate-static_if-with-c11c14.html#rest_code_d4f7d9e3782340c4906a6482e4e8699f-38"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">if_</span><span class="p">;</span>
<a id="rest_code_d4f7d9e3782340c4906a6482e4e8699f-39" name="rest_code_d4f7d9e3782340c4906a6482e4e8699f-39" href="posts/2015/07/simulate-static_if-with-c11c14.html#rest_code_d4f7d9e3782340c4906a6482e4e8699f-39"></a><span class="p">}</span>
</pre></div>
<p>Note: I got the idea (and most of the code) from the <a class="reference external" href="http://lists.boost.org/Archives/boost/2014/08/216607.php">Boost Mailing List</a>.</p>
<p>The condition is passed a non-type template parameter and the code for the branch is a passed a generic lambda functor. The <code>static_if</code> function returns a statement structure. We could avoid returning a struct and directly execute, or not, the functor based on the condition, but using a structure allows for the <code>else_</code> part which may be practical. The structure <code>statement</code> is specialized on the condition. If the condition is true, the right part will execute the functor while the false part will not execute anything. The specialization when the condition is false willl do the contrary. A special point here is the use of the identity function. The function is passed to the lambda. The user can then use this function to make non-dependent type dependent. This is necessary if we want to call functions on non-dependent types and these functions may not exist. For instance, you may want to call a function on <code>this</code>, which is not a dependent type.</p>
<p>Here is how the code will look using this solution:</p>
<div class="code"><pre class="code cpp"><a id="rest_code_de7268d54b35440db6c0b3334ef135cb-1" name="rest_code_de7268d54b35440db6c0b3334ef135cb-1" href="posts/2015/07/simulate-static_if-with-c11c14.html#rest_code_de7268d54b35440db6c0b3334ef135cb-1"></a><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">T</span><span class="o">&gt;</span>
<a id="rest_code_de7268d54b35440db6c0b3334ef135cb-2" name="rest_code_de7268d54b35440db6c0b3334ef135cb-2" href="posts/2015/07/simulate-static_if-with-c11c14.html#rest_code_de7268d54b35440db6c0b3334ef135cb-2"></a><span class="kt">void</span><span class="w"> </span><span class="n">decrement_kindof</span><span class="p">(</span><span class="n">T</span><span class="o">&amp;</span><span class="w"> </span><span class="n">value</span><span class="p">){</span>
<a id="rest_code_de7268d54b35440db6c0b3334ef135cb-3" name="rest_code_de7268d54b35440db6c0b3334ef135cb-3" href="posts/2015/07/simulate-static_if-with-c11c14.html#rest_code_de7268d54b35440db6c0b3334ef135cb-3"></a><span class="w">    </span><span class="n">static_if</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">is_same</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="o">&gt;::</span><span class="n">value</span><span class="o">&gt;</span><span class="p">([</span><span class="o">&amp;</span><span class="p">](</span><span class="k">auto</span><span class="w"> </span><span class="n">f</span><span class="p">){</span>
<a id="rest_code_de7268d54b35440db6c0b3334ef135cb-4" name="rest_code_de7268d54b35440db6c0b3334ef135cb-4" href="posts/2015/07/simulate-static_if-with-c11c14.html#rest_code_de7268d54b35440db6c0b3334ef135cb-4"></a><span class="w">        </span><span class="n">f</span><span class="p">(</span><span class="n">value</span><span class="p">).</span><span class="n">pop_back</span><span class="p">();</span>
<a id="rest_code_de7268d54b35440db6c0b3334ef135cb-5" name="rest_code_de7268d54b35440db6c0b3334ef135cb-5" href="posts/2015/07/simulate-static_if-with-c11c14.html#rest_code_de7268d54b35440db6c0b3334ef135cb-5"></a><span class="w">    </span><span class="p">}).</span><span class="n">else_</span><span class="p">([</span><span class="o">&amp;</span><span class="p">](</span><span class="k">auto</span><span class="w"> </span><span class="n">f</span><span class="p">){</span>
<a id="rest_code_de7268d54b35440db6c0b3334ef135cb-6" name="rest_code_de7268d54b35440db6c0b3334ef135cb-6" href="posts/2015/07/simulate-static_if-with-c11c14.html#rest_code_de7268d54b35440db6c0b3334ef135cb-6"></a><span class="w">        </span><span class="o">--</span><span class="n">f</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
<a id="rest_code_de7268d54b35440db6c0b3334ef135cb-7" name="rest_code_de7268d54b35440db6c0b3334ef135cb-7" href="posts/2015/07/simulate-static_if-with-c11c14.html#rest_code_de7268d54b35440db6c0b3334ef135cb-7"></a><span class="w">    </span><span class="p">});</span>
<a id="rest_code_de7268d54b35440db6c0b3334ef135cb-8" name="rest_code_de7268d54b35440db6c0b3334ef135cb-8" href="posts/2015/07/simulate-static_if-with-c11c14.html#rest_code_de7268d54b35440db6c0b3334ef135cb-8"></a><span class="p">}</span>
</pre></div>
<p>It is not as elegant as the "real" <code>static_if</code> version, but it is closer than the other solutions.</p>
<p>If you don't use the lazy identity function (f), it still works on g++, but not on clang for some reasons.</p>
</section><section id="conclusion"><h2>Conclusion</h2>
<p>We saw that there are some solutions to emulate <code>static_if</code> in C++ that you may use to make the code easier to read. I'm personally using this trick on branches with few lines of code and when I don't have to use the identity function too much, otherwise it is cleaner to use standard SFINAE functions to do the job. When you only have a if and no else, this trick is even better because that is where it saves the more code.</p>
<p>I hope this can be useful to some of you ;)</p>
<p>You can find my implementation <a class="reference external" href="https://github.com/wichtounet/cpp_utils/blob/master/static_if.hpp">on Github</a>.</p>
</section>
</div>
    </article>
</div>

        <nav class="postindexpager"><ul class="pager">
<li class="previous">
                <a href="index-29.html" rel="prev">Newer posts</a>
            </li>
            <li class="next">
                <a href="index-27.html" rel="next">Older posts</a>
            </li>
        </ul></nav><script>var disqus_shortname="blogwichtounet";(function(){var a=document.createElement("script");a.async=true;a.src="https://"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2023         <a href="mailto:baptistewicht@gmail.com">Baptiste Wicht</a> - Powered by         <a href="http://getnikola.com" rel="nofollow">Nikola</a>         - License: 
<a rel="license" href="http://creativecommons.org/licenses/by/4.0/"><img alt="Creative Commons License" style="padding-left:5px;border-width:0" src="assets/img/cc.png"></a>
            
        </footer>
</div>
</div>


            <script src="assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script>
</body>
</html>